<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento de Minimercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#37c0a0', 
                            hover: '#2a9d82',   
                            light: 'rgba(55, 192, 160, 0.1)' 
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .details-content.hidden {
            display: none;
        }
        .toggle-details-btn svg {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-details-btn.collapsed svg {
            transform: rotate(180deg);
        }
        .z-50 { z-index: 50; }
        .z-60 { z-index: 60; }
        .occ-actions { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 flex flex-col min-h-screen">

    <div class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-slate-100">Painel de Monitoramento</h1>
            <p class="text-slate-600 dark:text-slate-400 mt-2">Controle de backups, an√°lises e ocorr√™ncias de minimercados.</p>
        </header>

        <section id="dashboard-resumo" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Solicita√ß√µes Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-brand mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">PDVs Visualizados</h3>
                <p id="total-pdvs-unicos" class="text-3xl font-bold text-blue-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Backups Pendentes</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">An√°lises Pendentes</h3>
                <p id="analises-pendentes" class="text-3xl font-bold text-red-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Ocorr√™ncias (Semana)</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-slate-700 mt-1 dark:text-slate-100">0</p>
            </div>
        </section>

        <section class="bg-white p-4 rounded-xl shadow-md mb-8 dark:bg-slate-800 dark:shadow-xl">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4 flex-grow">
                    <input type="text" id="filtro-condominio" placeholder="Filtrar por condom√≠nio..." class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand flex-grow md:flex-grow-0 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    
                    <input type="date" id="filtro-data" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    
                    <select id="filtro-dia-semana" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Dia da Semana (Todos)</option>
                        <option value="1">Segunda-feira</option>
                        <option value="2">Ter√ßa-feira</option>
                        <option value="3">Quarta-feira</option>
                        <option value="4">Quinta-feira</option>
                        <option value="5">Sexta-feira</option>
                        <option value="6">S√°bado</option>
                        <option value="0">Domingo</option>
                    </select>

                    <input type="number" id="filtro-semana" placeholder="Semana (Ex: 43)" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand w-32 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    
                    <select id="filtro-backup" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Backup (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                    </select>
                    <select id="filtro-analise" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">An√°lise (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em An√°lise">Em An√°lise</option>
                        <option value="Conclu√≠da">Conclu√≠da</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="expand-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Expandir</button>
                        <button id="collapse-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Recolher</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button id="add-task-btn" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover transition-colors w-full sm:w-auto flex-grow">
                        + Adicionar
                    </button>
                    <div class="relative inline-block text-left" id="actions-menu-container">
                        <button type="button" id="actions-menu-btn" class="inline-flex justify-center w-full rounded-lg border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-100 focus:ring-brand dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600 dark:hover:bg-slate-600">
                            A√ß√µes
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="actions-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20 dark:bg-slate-700 dark:ring-slate-600">
                            <div class="py-1">
                                <button id="bulk-add-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Importar Planilha</button>
                                <button id="completed-report-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Relat√≥rio Conclu√≠das</button>
                                <button id="detailed-pdv-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600 font-semibold text-brand">An√°lise Detalhada PDV</button>
                                <button id="archive-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Arquivar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            </main>
        
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-center mb-8 text-slate-800 dark:text-slate-100">Ocorr√™ncias da Semana (por Condom√≠nio)</h2>
            <div class="flex justify-center">
                <div class="bg-white p-4 rounded-xl shadow-md w-full lg:w-1/2 dark:bg-slate-800 dark:shadow-xl">
                     <div class="chart-container">
                        <canvas id="ocorrenciasChart"></canvas>
                     </div>
                </div>
            </div>
             <div id="weekly-productivity" class="mt-8">
                 <div class="bg-white p-4 rounded-xl shadow-md text-center max-w-sm mx-auto dark:bg-slate-800 dark:shadow-xl">
                    <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Produtividade Semanal (Ocorr√™ncias / An√°lise)</h3>
                    <p id="produtividade-semanal" class="text-3xl font-bold text-emerald-600 mt-1">N/A</p>
                    <p class="text-xs text-slate-400 mt-1">M√©dia da semana atual</p>
                </div>
            </div>
        </section>
    </div>

    <footer class="p-4 text-center text-xs text-slate-400 dark:text-slate-600">
        v3.0 (Corrigido)
    </footer>

    <div id="pdv-detailed-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-60">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl flex flex-col dark:bg-slate-800 dark:shadow-xl max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100">An√°lise Detalhada por PDV</h2>
                <button id="pdv-detailed-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Selecione o Condom√≠nio:</label>
                <select id="pdv-analysis-select" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    <option value="">Escolha um PDV...</option>
                </select>
            </div>
            <div id="pdv-analysis-results" class="hidden flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-brand-light p-4 rounded-xl text-center border border-brand-light">
                        <h3 class="text-sm font-bold text-brand-dark uppercase tracking-wider">Dia Cr√≠tico</h3>
                        <p id="pdv-critical-day" class="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-2">-</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Maior incid√™ncia de ocorr√™ncias</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl text-center border border-red-100 dark:bg-red-900/20 dark:border-red-800/30">
                        <h3 class="text-sm font-bold text-red-600 uppercase tracking-wider dark:text-red-400">Hor√°rio Cr√≠tico</h3>
                        <p id="pdv-critical-time" class="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-2">-</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Pico de atividade suspeita</p>
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-900 border border-slate-200 dark:border-slate-700 mb-4">
                    <h3 class="text-center font-semibold mb-4 text-slate-700 dark:text-slate-300">Ocorr√™ncias por Dia da Semana</h3>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="pdvAnalysisChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="mt-auto flex justify-end pt-4 border-t border-slate-200 dark:border-slate-700">
                <button id="pdv-detailed-footer-close-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-60">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center dark:bg-slate-800 dark:shadow-xl border border-slate-200 dark:border-slate-700">
            <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-brand mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2" id="confirm-modal-title">Tem certeza?</h2>
            <p class="text-slate-600 dark:text-slate-300 mb-6 text-sm" id="confirm-modal-msg">Essa a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-modal-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 flex-1">Cancelar</button>
                <button id="confirm-modal-yes-btn" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover flex-1">Sim, confirmar</button>
            </div>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova An√°lise</h2>
            <form id="task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Condom√≠nio</label>
                        <div class="relative">
                            <input type="text" id="form-condominio" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" required autocomplete="off">
                            <div id="autocomplete-list" class="absolute z-10 w-full bg-white border border-slate-300 rounded-lg mt-1 hidden max-h-40 overflow-y-auto shadow-lg dark:bg-slate-700 dark:border-slate-600"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data</label>
                        <input type="date" id="form-data-analise" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" required>
                    </div>
                </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Semana (N¬∫)</label>
                    <input type="number" id="form-semana-trabalho" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                 </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Observa√ß√µes</label>
                    <textarea id="form-observacoes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></textarea>
                 </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ocorrencia-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Ocorr√™ncias</h2>
            <form id="ocorrencia-form" class="flex-grow flex flex-col min-h-0">
                <input type="hidden" id="ocorrencia-task-id">
                
                <div class="flex-grow overflow-y-auto mb-4 bg-slate-50 rounded-lg p-2 dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                    <div id="ocorrencia-list" class="space-y-2"></div>
                </div>
                
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <h3 class="font-semibold mb-2 text-sm text-slate-600 dark:text-slate-300">Adicionar / Editar Item</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Categoria</label>
                            <select id="add-ocorrencia-categoria" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></select>
                         </div>
                        <div>
                           <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Descri√ß√£o</label>
                           <input type="text" id="add-ocorrencia-desc" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">In√≠cio</label>
                            <input type="time" id="add-horario-inicial" step="1" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Fim</label>
                            <input type="time" id="add-horario-final" step="1" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                    </div>
                     <div class="mt-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="add-ocorrencia-inconclusiva" class="h-4 w-4 text-brand border-gray-300 rounded focus:ring-brand dark:bg-slate-700 dark:border-slate-600">
                            <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">Inconclusiva</span>
                        </label>
                    </div>
                     <button type="button" id="add-ocorrencia-btn" class="mt-3 w-full bg-brand-light text-brand-dark font-semibold px-4 py-2 rounded-lg hover:bg-slate-200 text-sm border border-brand-light">+ Adicionar √† Lista</button>
                </div>
                <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                    <button type="button" id="ocorrencia-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Importar Planilha</h2>
            <p class="text-sm text-slate-600 mb-4 dark:text-slate-300">Cole os dados do Excel. Formato:<br><strong>Semana | Data | Unidade | OC | Colaborador | Status</strong></p>
            <form id="bulk-add-form">
                <textarea id="bulk-input-area" rows="10" class="w-full border border-slate-300 rounded-lg p-2 mb-4 text-xs font-mono dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" placeholder="Cole aqui..."></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" id="bulk-cancel-btn" class="bg-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-brand text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-brand-hover">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="completed-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl h-5/6 flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100">Relat√≥rio de An√°lises Conclu√≠das</h2>
                <button id="completed-report-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
            <div class="mb-4">
                 <input type="text" id="completed-report-search" placeholder="Filtrar relat√≥rio (nome, data)..." class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
            </div>
            <div class="flex-grow overflow-y-auto bg-slate-50 p-4 rounded-lg dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100 dark:bg-slate-700 dark:text-slate-400 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3 rounded-tl-lg">Condom√≠nio</th>
                            <th scope="col" class="px-4 py-3">Data</th>
                            <th scope="col" class="px-4 py-3 text-center">Ocorr√™ncias</th>
                            <th scope="col" class="px-4 py-3 text-right rounded-tr-lg">Status</th>
                        </tr>
                    </thead>
                    <tbody id="completed-report-list"></tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end gap-3">
                 <button id="export-report-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                    Copiar Relat√≥rio
                 </button>
                 <button id="completed-report-footer-close-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[70]"><div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm text-center dark:bg-slate-800 dark:shadow-xl"><p id="notification-message" class="mb-4 text-lg text-slate-700 dark:text-slate-300"></p><button id="notification-close-btn" class="bg-brand text-white px-6 py-2 rounded-lg">OK</button></div></div>
    
    <div id="archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800 dark:shadow-xl"><h2 class="text-2xl font-bold mb-4">Arquivar</h2><form id="archive-form"><div class="space-y-2 mb-4"><button type="button" id="view-archive-btn" class="w-full bg-slate-500 text-white px-4 py-2 rounded-lg mb-4">Ver Arquivo</button><div class="flex gap-2"><button type="button" id="archive-cancel-btn" class="bg-slate-200 w-full px-4 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Cancelar</button></div></div></form></div></div>
    
    <div id="view-archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">An√°lises Arquivadas</h2>
                <button id="view-archive-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
             <div class="mb-4">
                <input type="text" id="archive-search-input" placeholder="Buscar em arquivadas..." class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
             </div>
            <div id="view-archive-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-lg min-h-[200px] dark:bg-slate-900">
                <p class="text-center text-slate-500">Nenhuma an√°lise arquivada.</p>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                 <button id="view-archive-close-footer-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <input type="file" id="restore-input" class="hidden" accept=".json">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CORRE√á√ÉO 1: In√≠cio correto do bloco try
            try {
                console.log("Painel de Monitoramento v3.0 - Corrigido."); 

                // --- 1. VARI√ÅVEIS GLOBAIS ---
                let ocorrenciasChart;
                let pdvAnalysisChart;
                let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
                let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
                let categories = JSON.parse(localStorage.getItem('monitoramentoCategorias')) || ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Outros'];
                let currentEditingTaskOcorrencias = [];

                const statusClasses = {
                    'Pendente': 'bg-amber-100 text-amber-600',
                    'Em Andamento': 'bg-orange-100 text-orange-600',
                    'Em An√°lise': 'bg-orange-100 text-orange-600',
                    'Conclu√≠do': 'bg-emerald-100 text-emerald-600',
                    'Conclu√≠da': 'bg-emerald-100 text-emerald-600',
                    'N√£o visualizar': 'bg-slate-100 text-slate-500'
                };

                // --- 2. FUN√á√ïES ---

                function saveTasks() {
                    localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                    localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
                }

                function showNotification(message) {
                    const elMsg = document.getElementById('notification-message');
                    const elModal = document.getElementById('notification-modal');
                    if (elMsg && elModal) {
                        elMsg.textContent = message;
                        elModal.classList.remove('hidden');
                    }
                }

                function formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const parts = dateString.split('-');
                    if(parts.length === 3) {
                        return `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }
                    return dateString;
                }
                
                function formatDateForInput(date) { 
                    const offset = date.getTimezoneOffset() * 60000; 
                    const localISOTime = (new Date(date - offset)).toISOString().slice(0, 10);
                    return localISOTime;
                }

                function getDayName(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T12:00:00');
                    if(isNaN(date.getTime())) return '';
                    const dayName = date.toLocaleDateString('pt-BR', { weekday: 'long' });
                    return dayName.charAt(0).toUpperCase() + dayName.slice(1);
                }
                
                function populateCategorySelect(selectElement) {
                    if (!selectElement) return;
                    selectElement.innerHTML = '';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        selectElement.appendChild(option);
                    });
                }

                // CORRE√á√ÉO 2: Implementa√ß√£o da fun√ß√£o que faltava
                function populatePdvAnalysisSelect() {
                    const select = document.getElementById('pdv-analysis-select');
                    if (!select) return;
                    select.innerHTML = '<option value="">Escolha um PDV...</option>';
                    
                    // Une condom√≠nios ativos e arquivados para listar todos
                    const allCondos = [...tasks, ...archivedTasks].map(t => t.condominio.trim());
                    // Remove duplicatas e ordena
                    const uniqueCondos = [...new Set(allCondos)].sort();

                    uniqueCondos.forEach(name => {
                        if(name) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            select.appendChild(option);
                        }
                    });
                }

                function getCondoHighRiskCount(name) {
                    const all = [...tasks, ...archivedTasks];
                    return all
                        .filter(t => t.condominio.trim().toLowerCase() === name.trim().toLowerCase())
                        .reduce((count, t) => {
                            if (t.ocorrencias && t.ocorrencias.length >= 3) {
                                return count + 1;
                            }
                            return count;
                        }, 0);
                }

                function exportCompletedReport() {
                    const completed = tasks.filter(t => t.statusAnalise === 'Conclu√≠da');
                    completed.sort((a, b) => a.condominio.localeCompare(b.condominio));

                    if (completed.length === 0) {
                        showNotification('N√£o h√° an√°lises conclu√≠das para exportar.');
                        return;
                    }

                    let report = `*RELAT√ìRIO DE AN√ÅLISES CONCLU√çDAS - ${new Date().toLocaleDateString('pt-BR')}*\n`;
                    report += `--------------------------------------------------\n\n`;

                    completed.forEach((task, index) => {
                        report += `*${index + 1}. ${task.condominio}* - ${formatDate(task.dataAnalise)} (${getDayName(task.dataAnalise)})\n`;
                        
                        if (task.ocorrencias && task.ocorrencias.length > 0) {
                            report += `üö® *Ocorr√™ncias:* ${task.ocorrencias.length}\n`;
                            task.ocorrencias.forEach((oc, idx) => {
                                const inconcl = oc.inconclusiva ? ' (INCONCLUSIVA)' : '';
                                report += `   - [${oc.categoria}] ${oc.desc} (${oc.horarioInicial} - ${oc.horarioFinal})${inconcl}\n`;
                            });
                        } else {
                            report += `‚úÖ Sem ocorr√™ncias registradas.\n`;
                        }
                        
                        if (task.observacoes) {
                            report += `üìù *Obs:* ${task.observacoes}\n`;
                        }
                        report += `\n--------------------------------------------------\n\n`;
                    });

                    const el = document.createElement('textarea');
                    el.value = report;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    
                    showNotification('Relat√≥rio completo copiado para a √°rea de transfer√™ncia!');
                }

                function renderCompletedReport() {
                    const tbody = document.getElementById('completed-report-list');
                    const search = document.getElementById('completed-report-search').value.toLowerCase();
                    
                    const completed = tasks.filter(t => 
                        t.statusAnalise === 'Conclu√≠da' && 
                        (t.condominio.toLowerCase().includes(search) || t.dataAnalise.includes(search))
                    );

                    completed.sort((a, b) => a.condominio.localeCompare(b.condominio));

                    tbody.innerHTML = '';

                    if (completed.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-center">Nenhuma an√°lise conclu√≠da encontrada.</td></tr>`;
                        return;
                    }

                    completed.forEach(t => {
                        const ocCount = t.ocorrencias ? t.ocorrencias.length : 0;
                        const row = `
                            <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                <td class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap dark:text-white">${t.condominio}</td>
                                <td class="px-4 py-3">${formatDate(t.dataAnalise)}</td>
                                <td class="px-4 py-3 text-center">${ocCount}</td>
                                <td class="px-4 py-3 text-right text-emerald-500 font-bold">Conclu√≠da</td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                }

                function updateDashboard() {
                    const ft = tasks.filter(t => t.statusAnalise !== 'Arquivado');
                    
                    const elTotal = document.getElementById('total-solicitacoes');
                    if (elTotal) elTotal.textContent = ft.length;
                    
                    const elUniquePdv = document.getElementById('total-pdvs-unicos');
                    if (elUniquePdv) {
                        const concludedTasks = ft.filter(t => t.statusAnalise === 'Conclu√≠da');
                        const uniquePdvs = new Set(concludedTasks.map(t => t.condominio.trim())).size;
                        elUniquePdv.textContent = uniquePdvs;
                    }

                    const elBackups = document.getElementById('backups-pendentes');
                    if (elBackups) elBackups.textContent = ft.filter(t => t.statusBackup === 'Pendente').length;
                    
                    const elAnalises = document.getElementById('analises-pendentes');
                    if (elAnalises) elAnalises.textContent = ft.filter(t => t.statusAnalise === 'Pendente').length;
                    
                    const ct = ft.filter(t => t.statusAnalise === 'Conclu√≠da');
                    const totOc = ct.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                    
                    const elOcorrencias = document.getElementById('total-ocorrencias-semana');
                    if (elOcorrencias) elOcorrencias.textContent = totOc;
                    
                    const elProd = document.getElementById('produtividade-semanal');
                    if (elProd) elProd.textContent = ct.length > 0 ? (totOc / ct.length).toFixed(1) : '0.0';
                }

                function updateCharts() {
                    const dataByCondo = tasks.reduce((acc, task) => {
                        if (task.ocorrencia === 'Sim' && task.ocorrencias) {
                            if (!acc[task.condominio]) acc[task.condominio] = 0;
                            acc[task.condominio] += task.ocorrencias.length;
                        }
                        return acc;
                    }, {});
                    
                    const labels = Object.keys(dataByCondo);
                    const data = Object.values(dataByCondo);
                    
                    if (ocorrenciasChart) {
                        ocorrenciasChart.data.labels = labels;
                        ocorrenciasChart.data.datasets[0].data = data;
                        ocorrenciasChart.update();
                    }
                }
                
                function updateChartsTheme() {
                    const isDark = true; 
                    const fontColor = '#f1f5f9'; 
                    const commonOptions = { scales: { y: { ticks: { color: fontColor }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, title: { color: fontColor } }, x: { ticks: { color: fontColor }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, title: { color: fontColor } } }, plugins: { legend: { labels: { color: fontColor } } } };
                    if (ocorrenciasChart) { Object.assign(ocorrenciasChart.options, commonOptions); ocorrenciasChart.update(); }
                }

                function renderTasks() {
                    const list = document.getElementById('task-list');
                    if (!list) return;
                    
                    const filtroCond = document.getElementById('filtro-condominio').value.toLowerCase();
                    const filtroBackup = document.getElementById('filtro-backup').value;
                    const filtroAnalise = document.getElementById('filtro-analise').value;
                    const filtroData = document.getElementById('filtro-data').value;
                    const filtroSemana = document.getElementById('filtro-semana').value;
                    const filtroDiaSemana = document.getElementById('filtro-dia-semana').value;

                    let filtered = tasks.filter(t => t.condominio.toLowerCase().includes(filtroCond));
                    
                    if (filtroBackup) filtered = filtered.filter(t => t.statusBackup === filtroBackup);
                    if (filtroAnalise) filtered = filtered.filter(t => t.statusAnalise === filtroAnalise);
                    if (filtroData) filtered = filtered.filter(t => t.dataAnalise === filtroData);
                    if (filtroSemana) filtered = filtered.filter(t => t.semanaDeTrabalho == filtroSemana);
                    
                    if (filtroDiaSemana !== "") {
                        filtered = filtered.filter(t => {
                            if (!t.dataAnalise) return false;
                            const d = new Date(t.dataAnalise + 'T12:00:00');
                            return d.getDay().toString() === filtroDiaSemana;
                        });
                    }

                    filtered.sort((a, b) => a.condominio.localeCompare(b.condominio));

                    list.innerHTML = '';
                    if(filtered.length === 0) { list.innerHTML = `<p class="text-slate-500 text-center col-span-full">Nenhuma tarefa encontrada.</p>`; return; }

                    filtered.forEach(task => {
                        const card = document.createElement('div');
                        let color = task.statusAnalise === 'Conclu√≠da' ? '#10b981' : (task.statusAnalise === 'Em An√°lise' ? '#f97316' : '#f59e0b');
                        card.className = 'bg-white p-4 rounded-xl shadow-md border-l-4 dark:bg-slate-800 dark:shadow-xl';
                        card.style.borderLeftColor = color;
                        
                        const ocCount = task.ocorrencias ? task.ocorrencias.length : 0;
                        const badge = ocCount > 0 ? `<div class="mt-1"><span class="px-2 py-0.5 text-xs font-bold text-red-700 bg-red-100 rounded-lg border border-red-300 dark:bg-red-900 dark:text-red-100 dark:border-red-700">OCs: ${ocCount}</span></div>` : '';
                        
                        const highRiskDays = getCondoHighRiskCount(task.condominio);
                        let riskBadge = '';
                        if (highRiskDays > 0) {
                            riskBadge = `<span class="ml-2 text-lg" title="PDV Cr√≠tico">üî•</span>`;
                        }

                        const isCollapsed = !task.isExpanded;
                        let editBtnHTML = (task.statusAnalise !== 'Arquivado') ? `<button data-id="${task.id}" class="edit-ocorrencia-btn mt-4 w-full bg-slate-200 text-slate-800 font-bold py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">${task.statusAnalise === 'Conclu√≠da' ? 'Ver/Editar Ocorr√™ncias' : 'Registrar Ocorr√™ncias'}</button>` : '';
                        let obsHTML = task.observacoes ? `<div class="mt-4 border-t pt-2 space-y-2 dark:border-slate-700"><p class="text-sm font-semibold text-slate-600 dark:text-slate-300">Obs:</p><p class="text-sm text-slate-500 dark:text-slate-400">${task.observacoes}</p></div>` : '';

                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg flex-1 flex items-center flex-wrap">
                                    ${task.condominio}
                                    ${riskBadge}
                                </h3>
                                <div class="flex items-center gap-2">
                                    <button data-id="${task.id}" class="archive-single-btn text-slate-400 hover:text-brand font-bold text-lg p-1" title="Arquivar"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></button>
                                    <button data-id="${task.id}" class="delete-task-btn text-slate-400 hover:text-red-600 font-bold text-lg p-1" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">
                                        Data: <strong>${formatDate(task.dataAnalise)}</strong> 
                                        <span class="text-xs text-slate-400 ml-1 font-semibold">(${getDayName(task.dataAnalise)})</span>
                                    </p>
                                    ${badge}
                                </div>
                                <button data-id="${task.id}" class="toggle-details-btn p-1 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-100">${isCollapsed ? '&#9660;' : '&#9650;'}</button>
                            </div>
                            <div class="${isCollapsed ? 'hidden' : ''} mt-4 details-content">
                                <div class="space-y-3 text-sm mt-4">
                                    <div class="flex justify-between items-center text-sm mb-1"><span class="font-semibold text-slate-600 dark:text-slate-300">Backup:</span> <select data-id="${task.id}" data-type="backup" class="status-select border-none text-right font-semibold text-sm rounded-lg p-1 ${statusClasses[task.statusBackup]}"><option value="Pendente" ${task.statusBackup === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Andamento" ${task.statusBackup === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option><option value="Conclu√≠do" ${task.statusBackup === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option></select></div>
                                    <div class="flex justify-between items-center text-sm"><span class="font-semibold text-slate-600 dark:text-slate-300">An√°lise:</span> <select data-id="${task.id}" data-type="analise" class="status-select border-none text-right font-semibold text-sm rounded-lg p-1 ${statusClasses[task.statusAnalise]}"><option value="Pendente" ${task.statusAnalise === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em An√°lise" ${task.statusAnalise === 'Em An√°lise' ? 'selected' : ''}>Em An√°lise</option><option value="Conclu√≠da" ${task.statusAnalise === 'Conclu√≠da' ? 'selected' : ''}>Conclu√≠da</option></select></div>
                                </div>
                                ${obsHTML}
                                ${editBtnHTML}
                            </div>
                        `;
                        list.appendChild(card);
                    });
                }

                function renderArchivedList() {
                    const container = document.getElementById('view-archive-list-container');
                    const filter = document.getElementById('archive-search-input').value.toLowerCase();
                    const filtered = archivedTasks.filter(t => t.condominio.toLowerCase().includes(filter) || (t.dataAnalise && t.dataAnalise.includes(filter)));

                    if (filtered.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-500 mt-4">Nenhuma an√°lise arquivada.</p>';
                        return;
                    }

                    container.innerHTML = filtered.map(t => `
                        <div class="flex justify-between items-center p-3 border-b border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                            <div>
                                <p class="font-bold text-slate-700 dark:text-slate-200">${t.condominio}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${formatDate(t.dataAnalise)}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-id="${t.id}" class="unarchive-btn text-xs font-semibold bg-orange-100 text-orange-700 px-3 py-1.5 rounded-lg hover:bg-orange-200 dark:bg-orange-900 dark:text-orange-100 dark:hover:bg-orange-800 transition-colors">Desarquivar</button>
                                <button data-id="${t.id}" class="delete-archive-btn text-xs font-semibold bg-red-100 text-red-700 px-3 py-1.5 rounded-lg hover:bg-red-200 dark:bg-red-900 dark:text-red-100 dark:hover:bg-red-800 transition-colors">Excluir</button>
                            </div>
                        </div>
                    `).join('');
                }

                function renderModalOcorrenciasList() {
                    const list = document.getElementById('ocorrencia-list');
                    list.innerHTML = '';
                    if (currentEditingTaskOcorrencias.length === 0) {
                        list.innerHTML = '<p class="text-center text-sm text-slate-500 py-4">Nenhuma ocorr√™ncia registrada.</p>';
                        return;
                    }
                    currentEditingTaskOcorrencias.forEach((ocor, index) => {
                        const div = document.createElement('div');
                        div.className = 'ocorrencia-item-row p-3 bg-white border border-slate-200 rounded-lg flex justify-between items-center group dark:bg-slate-800 dark:border-slate-700';
                        
                        const inconclusivaBadge = ocor.inconclusiva 
                            ? `<span class="ml-2 text-[10px] font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded-full border border-red-200 dark:bg-red-900 dark:text-red-100 dark:border-red-800">INCONCLUSIVA</span>` 
                            : '';

                        div.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-bold text-sm text-slate-800 dark:text-slate-100 flex items-center flex-wrap">
                                    ${ocor.categoria}
                                    ${inconclusivaBadge}
                                </p>
                                <p class="text-xs text-slate-600 dark:text-slate-400">${ocor.desc}</p>
                                <p class="text-xs text-slate-400 dark:text-slate-500 font-mono mt-1">${ocor.horarioInicial} - ${ocor.horarioFinal}</p>
                            </div>
                            <div class="flex gap-2 occ-actions">
                                <button type="button" data-index="${index}" class="edit-item-btn text-blue-500 hover:text-blue-700" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                                <button type="button" data-index="${index}" class="delete-item-btn text-red-500 hover:text-red-700" title="Remover"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }

                function handleTaskSubmit(e) {
                    e.preventDefault();
                    const condominio = document.getElementById('form-condominio').value;
                    const dataAnalise = document.getElementById('form-data-analise').value;
                    if (tasks.some(t => t.condominio === condominio && t.dataAnalise === dataAnalise)) {
                        showNotification('An√°lise j√° existe.'); return; 
                    }
                    tasks.unshift({
                        id: Date.now(),
                        condominio: condominio,
                        dataAnalise: dataAnalise,
                        semanaDeTrabalho: parseInt(document.getElementById('form-semana-trabalho').value) || 0,
                        observacoes: document.getElementById('form-observacoes').value,
                        statusBackup: 'Pendente', statusAnalise: 'Pendente', ocorrencia: 'Pendente', isExpanded: true, ocorrencias: []
                    });
                    refreshUI();
                    document.getElementById('task-modal').classList.add('hidden');
                    showNotification('Nova an√°lise adicionada.');
                }

                function handleBulkAddSubmit(e) {
                    e.preventDefault();
                    const inputArea = document.getElementById('bulk-input-area').value.trim();
                    if (!inputArea) { showNotification('Cole os dados.'); return; }
                    const lines = inputArea.split('\n').filter(line => line.trim().length > 0);
                    const newTasks = [];
                    let ignoredCount = 0;

                    lines.forEach((line, index) => {
                        const lineLower = line.toLowerCase();
                        if ((lineLower.includes('semana') || lineLower.includes('data')) && (lineLower.includes('unidade') || lineLower.includes('status'))) return;

                        let parts = line.split(/\s{2,}|\t/).map(p => p.trim()).filter(p => p.length > 0);
                        if (parts.length < 5) { ignoredCount++; return; }
                        
                        let unidadeRaw = parts[2] || '';
                        let statusRaw = parts[parts.length - 1] || 'Pendente';
                        let isoDate = '';
                        if (parts[1] && parts[1].includes('/')) {
                            const [d, m, y] = parts[1].split('/');
                            if (d && m && y) isoDate = `${y}-${m}-${d}`;
                        } else {
                            isoDate = new Date().toISOString().split('T')[0];
                        }

                        const existsInDb = tasks.some(t => t.condominio.toLowerCase().trim() === unidadeRaw.toLowerCase().trim() && t.dataAnalise === isoDate);
                        const existsInBatch = newTasks.some(t => t.condominio.toLowerCase().trim() === unidadeRaw.toLowerCase().trim() && t.dataAnalise === isoDate);

                        if (existsInDb || existsInBatch) { ignoredCount++; return; }

                        newTasks.push({
                            id: Date.now() + index,
                            condominio: unidadeRaw,
                            dataAnalise: isoDate,
                            semanaDeTrabalho: parseInt(parts[0].replace(/\D/g,'')) || 0,
                            observacoes: '',
                            statusBackup: statusRaw.toLowerCase().includes('finalizado') ? 'Conclu√≠do' : 'Pendente',
                            statusAnalise: statusRaw.toLowerCase().includes('finalizado') ? 'Conclu√≠da' : 'Pendente',
                            ocorrencia: 'N√£o', isExpanded: true, ocorrencias: []
                        });
                    });

                    if (newTasks.length > 0) { 
                        tasks.unshift(...newTasks); refreshUI(); 
                        document.getElementById('bulk-add-modal').classList.add('hidden'); 
                        document.getElementById('bulk-input-area').value = ''; 
                        showNotification(`${newTasks.length} an√°lises importadas. (${ignoredCount} duplicadas/ignoradas)`); 
                    } else {
                        showNotification('Nenhum dado importado.');
                    }
                }

                function generatePdvReport(pdvName) {
                    if (!pdvName) return;

                    const allTasks = [...tasks, ...archivedTasks].filter(t => t.condominio.trim() === pdvName);
                    
                    if (allTasks.length === 0) return;

                    const daysCount = {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; 
                    const hoursCount = {};

                    allTasks.forEach(t => {
                        if (t.ocorrencias && t.ocorrencias.length > 0) {
                            if (t.dataAnalise) {
                                const d = new Date(t.dataAnalise + 'T12:00:00');
                                const dayIndex = d.getDay();
                                daysCount[dayIndex] += t.ocorrencias.length; 
                            }

                            t.ocorrencias.forEach(oc => {
                                if (oc.horarioInicial) {
                                    const hour = parseInt(oc.horarioInicial.split(':')[0]);
                                    if (!isNaN(hour)) {
                                        hoursCount[hour] = (hoursCount[hour] || 0) + 1;
                                    }
                                }
                            });
                        }
                    });

                    let maxDay = -1;
                    let maxDayCount = -1;
                    for (let d = 0; d <= 6; d++) {
                        if (daysCount[d] > maxDayCount) {
                            maxDayCount = daysCount[d];
                            maxDay = d;
                        }
                    }
                    const dayNames = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
                    document.getElementById('pdv-critical-day').textContent = maxDayCount > 0 ? dayNames[maxDay] : "N/A";

                    let maxHour = -1;
                    let maxHourCount = -1;
                    Object.keys(hoursCount).forEach(h => {
                        if (hoursCount[h] > maxHourCount) {
                            maxHourCount = hoursCount[h];
                            maxHour = h;
                        }
                    });
                    document.getElementById('pdv-critical-time').textContent = maxHourCount > 0 ? `${maxHour}h - ${parseInt(maxHour)+1}h` : "N/A";

                    const ctx = document.getElementById('pdvAnalysisChart').getContext('2d');
                    
                    if (pdvAnalysisChart) {
                        pdvAnalysisChart.destroy();
                    }

                    pdvAnalysisChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: dayNames,
                            datasets: [{
                                label: 'Total de Ocorr√™ncias',
                                data: [0, 1, 2, 3, 4, 5, 6].map(d => daysCount[d]),
                                backgroundColor: 'rgba(55, 192, 160, 0.6)',
                                borderColor: '#37c0a0',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });

                    document.getElementById('pdv-analysis-results').classList.remove('hidden');
                }

                function setupCharts() {
                    const el = document.getElementById('ocorrenciasChart');
                    if(!el) return;
                    const ctx = el.getContext('2d');
                    ocorrenciasChart = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: [], datasets: [{ label: '# de Ocorr√™ncias', data: [], backgroundColor: 'rgba(55, 192, 160, 0.6)' }] },
                        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                }

                function showConfirm(title, msg, callback) {
                    const confirmModal = document.getElementById('custom-confirm-modal');
                    const confirmTitle = document.getElementById('confirm-modal-title');
                    const confirmMsg = document.getElementById('confirm-modal-msg');
                    const confirmYesBtn = document.getElementById('confirm-modal-yes-btn');
                    const confirmCancelBtn = document.getElementById('confirm-modal-cancel-btn');

                    confirmTitle.textContent = title;
                    confirmMsg.textContent = msg;
                    
                    const newYesBtn = confirmYesBtn.cloneNode(true);
                    confirmYesBtn.parentNode.replaceChild(newYesBtn, confirmYesBtn);
                    
                    const newCancelBtn = confirmCancelBtn.cloneNode(true);
                    confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);

                    newYesBtn.addEventListener('click', () => {
                        if (callback) callback();
                        confirmModal.classList.add('hidden');
                    });

                    newCancelBtn.addEventListener('click', () => {
                        confirmModal.classList.add('hidden');
                    });

                    confirmModal.classList.remove('hidden');
                }

                function refreshUI() {
                    saveTasks();
                    renderTasks();
                    updateDashboard();
                    updateCharts();
                }

                // --- 3. LISTENERS ---

                document.getElementById('filtro-condominio').addEventListener('input', refreshUI);
                document.getElementById('filtro-data').addEventListener('change', refreshUI); 
                document.getElementById('filtro-semana').addEventListener('input', refreshUI);
                document.getElementById('filtro-dia-semana').addEventListener('change', refreshUI); 
                document.getElementById('filtro-backup').addEventListener('change', refreshUI); 
                document.getElementById('filtro-analise').addEventListener('change', refreshUI); 
                
                document.getElementById('expand-all-btn').addEventListener('click', () => { tasks.forEach(t => t.isExpanded = true); refreshUI(); });
                document.getElementById('collapse-all-btn').addEventListener('click', () => { tasks.forEach(t => t.isExpanded = false); refreshUI(); });
                document.getElementById('add-task-btn').addEventListener('click', () => {
                    document.getElementById('task-form').reset();
                    document.getElementById('form-data-analise').value = formatDateForInput(new Date());
                    document.getElementById('task-modal').classList.remove('hidden');
                });
                document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('task-modal').classList.add('hidden'));
                document.getElementById('task-form').addEventListener('submit', handleTaskSubmit);
                document.getElementById('bulk-add-form').addEventListener('submit', handleBulkAddSubmit);
                
                const actionsMenu = document.getElementById('actions-menu');
                document.getElementById('actions-menu-btn').addEventListener('click', (e) => { e.stopPropagation(); actionsMenu.classList.toggle('hidden'); });
                document.addEventListener('click', (event) => { if (!document.getElementById('actions-menu-container').contains(event.target)) actionsMenu.classList.add('hidden'); });
                
                const modals = { 
                    'bulk-add-btn': 'bulk-add-modal', 
                    'archive-btn': 'archive-modal',
                    'completed-report-btn': 'completed-report-modal',
                    'detailed-pdv-btn': 'pdv-detailed-modal' 
                };
                
                Object.keys(modals).forEach(k => {
                    const el = document.getElementById(k);
                    if(el) {
                        el.addEventListener('click', () => { 
                            actionsMenu.classList.add('hidden'); 
                            document.getElementById(modals[k]).classList.remove('hidden');
                            
                            if (k === 'completed-report-btn') {
                                document.getElementById('completed-report-search').value = '';
                                renderCompletedReport();
                            }
                            if (k === 'detailed-pdv-btn') {
                                populatePdvAnalysisSelect(); // Chamada para fun√ß√£o corrigida
                                document.getElementById('pdv-analysis-results').classList.add('hidden');
                                if(pdvAnalysisChart) pdvAnalysisChart.destroy();
                            }
                        });
                    }
                });
                
                const reportSearch = document.getElementById('completed-report-search');
                if (reportSearch) reportSearch.addEventListener('input', renderCompletedReport);

                const exportReportBtn = document.getElementById('export-report-btn');
                if(exportReportBtn) exportReportBtn.addEventListener('click', exportCompletedReport);

                const pdvSelect = document.getElementById('pdv-analysis-select');
                if(pdvSelect) {
                    pdvSelect.addEventListener('change', (e) => {
                        generatePdvReport(e.target.value);
                    });
                }
                
                const closePdvModalBtn = document.getElementById('pdv-detailed-close-btn');
                if(closePdvModalBtn) closePdvModalBtn.addEventListener('click', () => document.getElementById('pdv-detailed-modal').classList.add('hidden'));
                
                const closePdvFooterBtn = document.getElementById('pdv-detailed-footer-close-btn');
                if(closePdvFooterBtn) closePdvFooterBtn.addEventListener('click', () => document.getElementById('pdv-detailed-modal').classList.add('hidden'));

                const closeIds = ['bulk-cancel-btn', 'archive-cancel-btn', 'view-archive-close-btn', 'view-archive-close-footer-btn', 'notification-close-btn', 'ocorrencia-cancel-btn', 'completed-report-close-btn', 'completed-report-footer-close-btn'];
                closeIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener('click', () => el.closest('.fixed').classList.add('hidden'));
                });

                document.getElementById('view-archive-btn').addEventListener('click', () => {
                    document.getElementById('archive-modal').classList.add('hidden');
                    document.getElementById('view-archive-modal').classList.remove('hidden');
                    document.getElementById('archive-search-input').value = '';
                    renderArchivedList();
                });
                document.getElementById('archive-search-input').addEventListener('input', renderArchivedList);
                
                document.getElementById('view-archive-list-container').addEventListener('click', (e) => {
                    const unarchiveBtn = e.target.closest('.unarchive-btn');
                    const deleteArchiveBtn = e.target.closest('.delete-archive-btn');

                    if (unarchiveBtn) {
                        const id = unarchiveBtn.dataset.id;
                        showConfirm('Desarquivar', 'Restaurar esta an√°lise para o quadro principal?', () => {
                            const index = archivedTasks.findIndex(t => t.id == id);
                            if (index > -1) {
                                const taskToRestore = archivedTasks[index];
                                archivedTasks.splice(index, 1);
                                tasks.unshift(taskToRestore); 
                                saveTasks();
                                refreshUI(); 
                                renderArchivedList(); 
                                showNotification('An√°lise restaurada.');
                            }
                        });
                    } else if (deleteArchiveBtn) {
                        const id = deleteArchiveBtn.dataset.id;
                        showConfirm('Excluir do Arquivo', 'Excluir permanentemente esta an√°lise?', () => {
                            archivedTasks = archivedTasks.filter(t => t.id != id);
                            saveTasks();
                            renderArchivedList();
                        });
                    }
                });

                document.getElementById('task-list').addEventListener('click', (e) => {
                    const target = e.target;
                    const delBtn = target.closest('.delete-task-btn');
                    const archBtn = target.closest('.archive-single-btn');
                    const toggleBtn = target.closest('.toggle-details-btn');
                    const editOcBtn = target.closest('.edit-ocorrencia-btn');

                    if (delBtn) {
                        showConfirm('Excluir An√°lise', 'Tem certeza que deseja excluir esta an√°lise?', () => {
                            tasks = tasks.filter(t => t.id != delBtn.dataset.id);
                            refreshUI();
                            showNotification('An√°lise exclu√≠da.');
                        });
                    } else if (archBtn) {
                        showConfirm('Arquivar An√°lise', 'Mover esta an√°lise para o arquivo?', () => {
                            const idx = tasks.findIndex(t => t.id == archBtn.dataset.id);
                            if(idx > -1) {
                                archivedTasks.push(tasks[idx]);
                                tasks.splice(idx, 1);
                                refreshUI();
                                showNotification('An√°lise arquivada.');
                            }
                        });
                    } else if (toggleBtn) {
                        const t = tasks.find(x => x.id == toggleBtn.dataset.id);
                        if(t) { t.isExpanded = !t.isExpanded; refreshUI(); }
                    } else if (editOcBtn) {
                        const t = tasks.find(x => x.id == editOcBtn.dataset.id);
                        if(t) {
                            document.getElementById('ocorrencia-task-id').value = t.id;
                            const list = document.getElementById('ocorrencia-list');
                            list.innerHTML = '';
                            currentEditingTaskOcorrencias = JSON.parse(JSON.stringify(t.ocorrencias || []));
                            renderModalOcorrenciasList();
                            populateCategorySelect(document.getElementById('add-ocorrencia-categoria'));
                            document.getElementById('add-ocorrencia-desc').value = ''; 
                            document.getElementById('ocorrencia-modal').classList.remove('hidden');
                        }
                    }
                });

                document.getElementById('task-list').addEventListener('change', (e) => {
                    if (e.target.classList.contains('status-select')) {
                        const t = tasks.find(x => x.id == e.target.dataset.id);
                        if (t) {
                            if (e.target.dataset.type === 'backup') t.statusBackup = e.target.value;
                            if (e.target.dataset.type === 'analise') t.statusAnalise = e.target.value;
                            refreshUI();
                        }
                    }
                });

                document.getElementById('add-ocorrencia-btn').addEventListener('click', () => {
                    const desc = document.getElementById('add-ocorrencia-desc').value;
                    const cat = document.getElementById('add-ocorrencia-categoria').value;
                    const ini = document.getElementById('add-horario-inicial').value;
                    const fim = document.getElementById('add-horario-final').value;
                    const isInconclusiva = document.getElementById('add-ocorrencia-inconclusiva').checked;
                    
                    if (desc) {
                        currentEditingTaskOcorrencias.push({ 
                            categoria: cat, 
                            desc: desc, 
                            horarioInicial: ini, 
                            horarioFinal: fim,
                            inconclusiva: isInconclusiva 
                        });
                        renderModalOcorrenciasList();
                        
                        document.getElementById('add-ocorrencia-desc').value = '';
                        document.getElementById('add-horario-inicial').value = '';
                        document.getElementById('add-horario-final').value = '';
                        document.getElementById('add-ocorrencia-inconclusiva').checked = false;
                    }
                });

                document.getElementById('ocorrencia-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const taskId = document.getElementById('ocorrencia-task-id').value;
                    const task = tasks.find(t => t.id == taskId);
                    if (task) {
                        task.ocorrencias = [...currentEditingTaskOcorrencias];
                        task.ocorrencia = task.ocorrencias.length > 0 ? 'Sim' : 'N√£o';
                        refreshUI();
                        document.getElementById('ocorrencia-modal').classList.add('hidden');
                        showNotification('Ocorr√™ncias atualizadas com sucesso.');
                    }
                });
                
                document.getElementById('ocorrencia-cancel-btn').addEventListener('click', () => document.getElementById('ocorrencia-modal').classList.add('hidden'));
                
                document.getElementById('ocorrencia-list').addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-item-btn');
                    const editBtn = e.target.closest('.edit-item-btn');

                    if (deleteBtn) {
                        const index = parseInt(deleteBtn.dataset.index);
                        currentEditingTaskOcorrencias.splice(index, 1);
                        renderModalOcorrenciasList();
                    } else if (editBtn) {
                        const index = parseInt(editBtn.dataset.index);
                        const item = currentEditingTaskOcorrencias[index];
                        document.getElementById('add-ocorrencia-categoria').value = item.categoria;
                        document.getElementById('add-ocorrencia-desc').value = item.desc;
                        document.getElementById('add-horario-inicial').value = item.horarioInicial;
                        document.getElementById('add-horario-final').value = item.horarioFinal;
                        document.getElementById('add-ocorrencia-inconclusiva').checked = item.inconclusiva || false;
                        currentEditingTaskOcorrencias.splice(index, 1);
                        renderModalOcorrenciasList();
                    }
                });

                // CORRE√á√ÉO 3: L√≥gica de Autocomplete Adicionada
                const condoInput = document.getElementById('form-condominio');
                const autoList = document.getElementById('autocomplete-list');

                if (condoInput && autoList) {
                    condoInput.addEventListener('input', function() {
                        const val = this.value.toLowerCase();
                        autoList.innerHTML = '';
                        if (!val) {
                            autoList.classList.add('hidden');
                            return;
                        }

                        // Busca hist√≥rico de condom√≠nios j√° cadastrados
                        const history = [...new Set([...tasks, ...archivedTasks].map(t => t.condominio))];
                        const matches = history.filter(h => h.toLowerCase().includes(val));

                        if (matches.length > 0) {
                            autoList.classList.remove('hidden');
                            matches.forEach(m => {
                                const div = document.createElement('div');
                                div.className = "p-2 hover:bg-slate-100 cursor-pointer text-sm dark:hover:bg-slate-600 dark:text-slate-100";
                                div.textContent = m;
                                div.addEventListener('click', () => {
                                    condoInput.value = m;
                                    autoList.classList.add('hidden');
                                });
                                autoList.appendChild(div);
                            });
                        } else {
                            autoList.classList.add('hidden');
                        }
                    });

                    document.addEventListener('click', (e) => {
                        if (e.target !== condoInput) {
                            autoList.classList.add('hidden');
                        }
                    });
                }

                // Inicializa√ß√£o
                setupCharts();
                refreshUI();

            } catch (error) {
                console.error("Erro cr√≠tico na inicializa√ß√£o:", error);
                alert("Ocorreu um erro ao carregar o painel. Verifique o console para mais detalhes. Erro: " + error.message);
            }
        });
    </script>
</body>
</html>