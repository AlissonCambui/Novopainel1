<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento de Minimercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Slate & Sky -->
    <!-- Application Structure Plan: A single-page dashboard designed for operational efficiency. The structure prioritizes immediate insight with key metrics (stat cards) at the top. Below, an interactive task management section allows for filtering and direct status updates on individual 'task cards', which is more modern and usable than a spreadsheet table. A modal is used for structured data entry of new tasks. Finally, two dynamic charts are placed at the bottom to provide analytical insights into incident patterns and financial impact across locations. This structure was chosen to mirror a typical workflow: 1) See the overall status, 2) Identify and work on specific tasks, 3) Analyze trends. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Dashboard Metrics -> Goal: Inform (at a glance) -> Viz/Method: Stat Cards (HTML/CSS) -> Interaction: None, auto-updates -> Justification: Provides immediate, high-level summary of the workload and results.
        - Report Info: Main control table (all columns) -> Goal: Organize & Manage -> Viz/Method: Interactive Task Cards (HTML/CSS) -> Interaction: Filtering by status/condo, direct status updates via dropdowns -> Justification: A card-based layout is more responsive and less overwhelming than a wide table. Direct interaction reduces clicks and speeds up the workflow.
        - Report Info: Occurrences & Loss Value -> Goal: Compare & Analyze -> Viz/Method: Bar Charts (Chart.js/Canvas) -> Interaction: Tooltips on hover, updates based on filters -> Justification: Visualizing this data helps identify problematic locations quickly, a task that is difficult with a simple table.
        - Report Info: New Task Entry -> Goal: Standardize Input -> Viz/Method: Modal Form (HTML/CSS) -> Interaction: Form submission -> Justification: A dedicated form reduces data entry errors compared to typing directly into a spreadsheet row. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .details-content.hidden {
            display: none;
        }
        .toggle-details-btn svg {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-details-btn.collapsed svg {
            transform: rotate(180deg);
        }
        .ocorrencia-item.editing .view-mode { display: none; }
        .ocorrencia-item:not(.editing) .edit-mode { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Painel de Monitoramento</h1>
            <p class="text-slate-600 mt-2">Controle de backups, análises e ocorrências de minimercados.</p>
        </header>

        <!-- Dashboard Resumo -->
        <section id="dashboard-resumo" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Solicitações Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-sky-600 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Backups Pendentes</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Análises Pendentes</h3>
                <p id="analises-pendentes" class="text-3xl font-bold text-red-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Ocorrências (Semana)</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-slate-700 mt-1">0</p>
            </div>
        </section>

        <!-- Produtividade Semanal -->
        <section id="weekly-productivity" class="mb-8">
             <div class="bg-white p-4 rounded-lg shadow-md text-center max-w-sm mx-auto">
                <h3 class="text-sm font-semibold text-slate-500">Produtividade Semanal (Ocorrências / Análise)</h3>
                <p id="produtividade-semanal" class="text-3xl font-bold text-emerald-600 mt-1">N/A</p>
                <p class="text-xs text-slate-400 mt-1">Média da semana atual</p>
            </div>
        </section>


        <!-- Controles e Filtros -->
        <section class="bg-white p-4 rounded-lg shadow-md mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4 flex-grow">
                    <input type="text" id="filtro-condominio" placeholder="Filtrar por condomínio..." class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 flex-grow md:flex-grow-0">
                    <input type="date" id="filtro-data" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    <input type="number" id="filtro-semana" placeholder="Semana de Análise (Ex: 43)" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 w-40">
                    <select id="filtro-backup" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        <option value="">Status do Backup (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Não visualizar">Não visualizar</option>
                    </select>
                    <select id="filtro-analise" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        <option value="">Status da Análise (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Análise">Em Análise</option>
                        <option value="Concluída">Concluída</option>
                        <option value="Não visualizar">Não visualizar</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="expand-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-300">Expandir Todos</button>
                        <button id="collapse-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-300">Recolher Todos</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button id="priority-btn" class="bg-purple-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-purple-700 transition-colors w-full sm:w-auto flex-grow">
                        Prioridades
                    </button>
                    <button id="period-analysis-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors w-full sm:w-auto flex-grow">
                        Análise por Período
                    </button>
                    <button id="add-task-btn" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700 transition-colors w-full sm:w-auto flex-grow">
                        + Adicionar Análise
                    </button>
                </div>
            </div>
             <div class="flex flex-wrap gap-2 w-full sm:w-auto mt-4 justify-end">
                <div class="relative inline-block text-left" id="actions-menu-container">
                    <div>
                        <button type="button" id="actions-menu-btn" class="inline-flex justify-center w-full rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-100 focus:ring-indigo-500" aria-haspopup="true" aria-expanded="true">
                            Ações
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
    
                    <div id="actions-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="actions-menu-btn">
                            <button id="bulk-add-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Importar da Planilha</button>
                            <button id="rename-condo-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Renomear Condomínio</button>
                            <button id="archive-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Arquivar Análises</button>
                            <div class="border-t border-slate-100 my-1"></div>
                            <!-- <button id="backup-btn" class="w-full text-left text-green-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Fazer Backup</button> -->
                            <button id="restore-btn" class="w-full text-left text-orange-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Restaurar Backup</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Tarefas -->
        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Cards de tarefas serão inseridos aqui -->
        </main>
        
        <!-- Seção de Gráficos -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-center mb-8 text-slate-800">Análise de Ocorrências (Geral - Histórico Completo)</h2>
            <div class="flex justify-center">
                <div class="bg-white p-4 rounded-lg shadow-md w-full lg:w-1/2">
                     <h3 class="text-center font-semibold mb-4">Ocorrências por Condomínio</h3>
                     <div class="chart-container">
                        <canvas id="ocorrenciasChart"></canvas>
                     </div>
                </div>
            </div>
        </section>
    </div>
    
    <input type="file" id="restore-input" class="hidden" accept=".json">

    <!-- Modal de Prioridades -->
    <div id="priority-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Por Onde Começar? (Prioridades)</h2>
                <button id="priority-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            <p class="text-slate-600 mb-6">Esta é uma lista sugerida de suas análises, priorizando condomínios com maior histórico de ocorrências e as datas mais antigas.</p>
            <div class="flex-grow overflow-y-auto">
                <ul id="priority-task-list" class="space-y-3">
                    <!-- Itens da lista de prioridades serão inseridos aqui -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Modal de Arquivamento -->
    <div id="archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Arquivar Análises Concluídas</h2>
            <form id="archive-form">
                <p class="text-slate-600 mb-4">Selecione o período para arquivar análises concluídas. Isso irá removê-las da tela principal, mas elas não serão excluídas.</p>
                <div class="space-y-2 mb-6">
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-sky-50 has-[:checked]:border-sky-300">
                        <input type="radio" name="archive_period" value="7" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-3 text-sm font-medium text-slate-700">Mais antigas que 1 semana</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-sky-50 has-[:checked]:border-sky-300">
                        <input type="radio" name="archive_period" value="30" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500" checked>
                        <span class="ml-3 text-sm font-medium text-slate-700">Mais antigas que 1 mês</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-sky-50 has-[:checked]:border-sky-300">
                        <input type="radio" name="archive_period" value="90" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-3 text-sm font-medium text-slate-700">Mais antigas que 3 meses</span>
                    </label>
                </div>
                <div class="flex justify-between items-center gap-3">
                    <button type="button" id="view-archive-btn" class="bg-slate-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-slate-600">Ver Arquivadas</button>
                    <div class="flex gap-3">
                        <button type="button" id="archive-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                        <button type="submit" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700">Arquivar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Visualizar Arquivadas -->
    <div id="view-archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análises Arquivadas</h2>
                <button id="view-archive-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="view-archive-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-md min-h-[200px]">
                <p class="text-center text-slate-500">Nenhuma análise arquivada.</p>
            </div>
            <div class="mt-4 text-right">
                 <button id="unarchive-selected-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Desarquivar Selecionadas</button>
            </div>
        </div>
    </div>


    <!-- Modal para Análise por Período -->
    <div id="period-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análise por Período</h2>
                <button id="period-analysis-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4 mb-4">
                <div>
                    <label for="period-start-date" class="block text-sm font-medium text-slate-700">Data de Início</label>
                    <input type="date" id="period-start-date" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="period-end-date" class="block text-sm font-medium text-slate-700">Data de Fim</label>
                    <input type="date" id="period-end-date" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="flex items-end">
                    <button id="generate-report-btn" class="bg-indigo-600 text-white font-semibold w-full px-4 py-2 rounded-md hover:bg-indigo-700">Gerar Relatório</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-2">Analisar por:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="analysis_type" value="dataAnalise" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500" checked>
                        <span class="ml-2 text-sm text-slate-700">Data da Análise</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="analysis_type" value="dataConclusao" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-2 text-sm text-slate-700">Data da Conclusão</span>
                    </label>
                </div>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
                <button data-period="this-week" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Esta Semana</button>
                <button data-period="last-week" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Semana Passada</button>
                <button data-period="this-month" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Este Mês</button>
                <button data-period="last-month" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Mês Passado</button>
            </div>

            <div id="period-results-content" class="flex-grow overflow-y-auto hidden">
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">Dias (Análises)</h3>
                        <p id="period-dias" class="text-3xl font-bold text-sky-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">PDV (Condomínios)</h3>
                        <p id="period-pdv" class="text-3xl font-bold text-indigo-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">OC (Ocorrências)</h3>
                        <p id="period-oc" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                </section>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg"><h3 class="text-center font-semibold mb-4">Ocorrências por Condomínio no Período</h3><div class="chart-container"><canvas id="periodChart"></canvas></div></div>
                    <div><h3 class="font-semibold mb-2 text-center lg:text-left">Lista de Análises no Período</h3><ul id="period-task-list" class="space-y-2 max-h-80 overflow-y-auto pr-2"></ul></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionar Tarefa -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova Análise</h2>
            <form id="task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="form-condominio" class="block text-sm font-medium text-slate-700">Condomínio</label>
                        <div class="relative">
                            <input type="text" id="form-condominio" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" required autocomplete="off">
                            <div id="autocomplete-list" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 hidden max-h-40 overflow-y-auto shadow-lg"></div>
                        </div>
                    </div>
                    <div>
                        <label for="form-data-analise" class="block text-sm font-medium text-slate-700">Data para Análise</label>
                        <input type="date" id="form-data-analise" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="form-observacoes" class="block text-sm font-medium text-slate-700">Observações</label>
                    <textarea id="form-observacoes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Adicionar em Lote -->
    <div id="bulk-add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Importar Análises da Planilha</h2>
            <form id="bulk-add-form">
                <div class="text-sm text-slate-600 space-y-3 mb-6">
                     <p>Copie os dados da sua planilha online e cole no campo abaixo para adicionar tarefas em massa.</p>
                     <ol class="list-decimal list-inside space-y-2 pl-4">
                         <li>Na planilha, selecione e copie (Ctrl+C) as linhas que contêm as tarefas. Certifique-se de incluir as colunas com a <strong>data</strong> e o <strong>nome da unidade</strong>.</li>
                         <li>Cole os dados (Ctrl+V) na área de texto abaixo e clique em "Importar".</li>
                     </ol>
                     <p class="text-xs text-slate-500 mt-2"><strong>Obs:</strong> Tarefas com a mesma data e condomínio que já existem no painel serão ignoradas para evitar duplicatas.</p>
                </div>
                <div>
                    <label for="bulk-input-area" class="block text-sm font-medium text-slate-700">Cole os dados da planilha aqui:</label>
                    <textarea id="bulk-input-area" rows="10" class="mt-1 w-full border border-slate-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="bulk-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-teal-700">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Detalhes da Ocorrência -->
    <div id="ocorrencia-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Registrar Detalhes da Ocorrência</h2>
            <form id="ocorrencia-form" class="flex-grow flex flex-col min-h-0">
                <input type="hidden" id="ocorrencia-task-id">
                <div id="ocorrencia-list" class="flex-grow overflow-y-auto pr-2 -mr-2 mb-4 space-y-3"></div>
                <div class="flex-shrink-0 pt-4 border-t">
                    <h3 class="font-semibold mb-2">Adicionar Nova Ocorrência</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                           <label for="add-ocorrencia-desc" class="block text-sm font-medium text-slate-700">Descrição</label>
                           <textarea id="add-ocorrencia-desc" rows="2" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500"></textarea>
                        </div>
                        <div>
                            <label for="add-horario-inicial" class="block text-sm font-medium text-slate-700">Horário Inicial</label>
                            <input type="time" id="add-horario-inicial" step="1" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="add-horario-final" class="block text-sm font-medium text-slate-700">Horário Final</label>
                            <input type="time" id="add-horario-final" step="1" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                    </div>
                     <button type="button" id="add-ocorrencia-btn" class="mt-3 w-full bg-sky-100 text-sky-800 font-semibold px-4 py-2 rounded-md hover:bg-sky-200">+ Adicionar à Lista</button>
                </div>
                <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                    <button type="button" id="ocorrencia-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700">Salvar Ocorrências</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Renomear Condomínio -->
    <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Renomear Condomínio</h2>
            <form id="rename-form">
                <div class="space-y-4">
                    <div>
                        <label for="form-old-name" class="block text-sm font-medium text-slate-700">Nome Antigo do Condomínio</label>
                        <select id="form-old-name" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" required></select>
                    </div>
                    <div>
                        <label for="form-new-name" class="block text-sm font-medium text-slate-700">Novo Nome do Condomínio</label>
                        <input type="text" id="form-new-name" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="rename-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700">Salvar Alteração</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Confirmação de Restauração -->
    <div id="restore-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 text-orange-600">Atenção!</h2>
            <p class="text-slate-600">Restaurar um backup irá <strong>substituir todos os dados atuais</strong>. Esta ação não pode ser desfeita. Deseja continuar?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="restore-confirm-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                <button type="button" id="restore-confirm-proceed-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-600">Sim, Restaurar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificação Genérica -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="text-slate-700 text-lg"></p>
            <button id="notification-close-btn" class="mt-6 bg-sky-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-sky-700">OK</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
            let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];

            tasks.forEach(t => {
                if (t.isExpanded === undefined) {
                    t.isExpanded = true;
                }
            });

            const taskList = document.getElementById('task-list');
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const cancelBtn = document.getElementById('cancel-btn');
            const formCondominioInput = document.getElementById('form-condominio');
            const autocompleteList = document.getElementById('autocomplete-list');
            
            const bulkAddBtn = document.getElementById('bulk-add-btn');
            const bulkAddModal = document.getElementById('bulk-add-modal');
            const bulkAddForm = document.getElementById('bulk-add-form');
            const bulkCancelBtn = document.getElementById('bulk-cancel-btn');
            const bulkInputArea = document.getElementById('bulk-input-area');

            const ocorrenciaModal = document.getElementById('ocorrencia-modal');
            const ocorrenciaForm = document.getElementById('ocorrencia-form');
            const ocorrenciaCancelBtn = document.getElementById('ocorrencia-cancel-btn');
            const ocorrenciaListDiv = document.getElementById('ocorrencia-list');
            const addOcorrenciaBtn = document.getElementById('add-ocorrencia-btn');

            const renameCondoBtn = document.getElementById('rename-condo-btn');
            const renameModal = document.getElementById('rename-modal');
            const renameForm = document.getElementById('rename-form');
            const renameCancelBtn = document.getElementById('rename-cancel-btn');
            const oldNameSelect = document.getElementById('form-old-name');
            const newNameInput = document.getElementById('form-new-name');

            const filtroCondominio = document.getElementById('filtro-condominio');
            const filtroData = document.getElementById('filtro-data');
            const filtroSemana = document.getElementById('filtro-semana'); // Novo filtro
            const filtroBackup = document.getElementById('filtro-backup');
            const filtroAnalise = document.getElementById('filtro-analise');

            const expandAllBtn = document.getElementById('expand-all-btn');
            const collapseAllBtn = document.getElementById('collapse-all-btn');
            
            //const backupBtn = document.getElementById('backup-btn'); // No longer needed for manual action
            const restoreBtn = document.getElementById('restore-btn');
            const restoreInput = document.getElementById('restore-input');
            const restoreConfirmModal = document.getElementById('restore-confirm-modal');
            const restoreConfirmCancelBtn = document.getElementById('restore-confirm-cancel-btn');
            const restoreConfirmProceedBtn = document.getElementById('restore-confirm-proceed-btn');
            let fileToRestore = null;
            
            const notificationModal = document.getElementById('notification-modal');
            const notificationMessage = document.getElementById('notification-message');
            const notificationCloseBtn = document.getElementById('notification-close-btn');

            const periodAnalysisBtn = document.getElementById('period-analysis-btn');
            const periodAnalysisModal = document.getElementById('period-analysis-modal');
            const periodAnalysisCloseBtn = document.getElementById('period-analysis-close-btn');
            const periodStartDateInput = document.getElementById('period-start-date');
            const periodEndDateInput = document.getElementById('period-end-date');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const periodResultsContent = document.getElementById('period-results-content');
            const periodTaskList = document.getElementById('period-task-list');
            
            const priorityBtn = document.getElementById('priority-btn');
            const priorityModal = document.getElementById('priority-modal');
            const priorityCloseBtn = document.getElementById('priority-close-btn');
            const priorityTaskList = document.getElementById('priority-task-list');
            
            const archiveBtn = document.getElementById('archive-btn');
            const archiveModal = document.getElementById('archive-modal');
            const archiveForm = document.getElementById('archive-form');
            const archiveCancelBtn = document.getElementById('archive-cancel-btn');
            const viewArchiveBtn = document.getElementById('view-archive-btn');
            const viewArchiveModal = document.getElementById('view-archive-modal');
            const viewArchiveCloseBtn = document.getElementById('view-archive-close-btn');
            const viewArchiveListContainer = document.getElementById('view-archive-list-container');
            const unarchiveSelectedBtn = document.getElementById('unarchive-selected-btn');


            const actionsMenuContainer = document.getElementById('actions-menu-container');
            const actionsMenuBtn = document.getElementById('actions-menu-btn');
            const actionsMenu = document.getElementById('actions-menu');

            let ocorrenciasChart;
            let periodChart;

            const saveTasks = () => {
                localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            };
            
            const showNotification = (message) => {
                notificationMessage.textContent = message;
                notificationModal.classList.remove('hidden');
            };

            notificationCloseBtn.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });
            
            const statusClasses = {
                Pendente: 'bg-amber-100 text-amber-800', 'Em Andamento': 'bg-sky-100 text-sky-800', Concluído: 'bg-emerald-100 text-emerald-800',
                'Em Análise': 'bg-sky-100 text-sky-800', Concluída: 'bg-emerald-100 text-emerald-800',
                'Não visualizar': 'bg-slate-200 text-slate-700',
            };

            const formatDate = (dateString, options = {}) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString + 'T00:00:00'); // Ensure correct timezone interpretation
                return date.toLocaleDateString('pt-BR', options);
            };
            
            const formatDateForInput = (date) => {
                 return date.toISOString().split('T')[0];
            };

            // Function to get ISO week number (Monday as the first day)
            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); // Adjust to make Monday day 1
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return weekNo;
            };

            const renderTasks = () => {
                 const currentWeekFilter = filtroSemana.value ? parseInt(filtroSemana.value) : null;
                const filteredTasks = tasks.filter(task => {
                    const matchCondominio = task.condominio.toLowerCase().includes(filtroCondominio.value.toLowerCase());
                    const matchData = !filtroData.value || task.dataAnalise === filtroData.value;
                    const matchBackup = !filtroBackup.value || task.statusBackup === filtroBackup.value;
                    const matchAnalise = !filtroAnalise.value || task.statusAnalise === filtroAnalise.value;
                    
                    let matchSemana = true;
                    if (currentWeekFilter && task.dataAnalise) {
                        const taskDate = new Date(task.dataAnalise + 'T00:00:00');
                        const taskWeek = getWeekNumber(taskDate);
                        // Filter by the PREVIOUS week based on the input
                        matchSemana = taskWeek === (currentWeekFilter - 1); 
                    } else if (currentWeekFilter && !task.dataAnalise) {
                        matchSemana = false; // Cannot match week if date is missing
                    }

                    return matchCondominio && matchData && matchBackup && matchAnalise && matchSemana;
                });

                taskList.innerHTML = '';
                if(filteredTasks.length === 0) {
                    taskList.innerHTML = `<p class="text-slate-500 text-center col-span-full">Nenhuma tarefa encontrada.</p>`;
                } else {
                    filteredTasks.forEach(task => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow-md border-l-4';
                        card.style.borderColor = task.statusAnalise === 'Pendente' ? '#f59e0b' : (task.statusAnalise === 'Em Análise' ? '#0ea5e9' : '#10b981');
                        
                        const isCollapsed = !task.isExpanded;

                        let ocorrenciaDetailsHTML = '';
                        if (task.ocorrencia === 'Sim' && task.ocorrencias && task.ocorrencias.length > 0) {
                           ocorrenciaDetailsHTML += `<div class="mt-4 pt-3 border-t border-slate-200 space-y-2">`;
                           task.ocorrencias.forEach(ocor => {
                               ocorrenciaDetailsHTML += `
                                <div class="p-2 bg-red-50 rounded-md">
                                    <p class="text-sm text-red-700"><strong>Ocorrência:</strong> ${ocor.desc}</p>
                                    ${ocor.horarioInicial ? `<p class="text-xs text-red-600 mt-1"><strong>Horário:</strong> ${ocor.horarioInicial} - ${ocor.horarioFinal}</p>` : ''}
                                </div>
                               `;
                           });
                           ocorrenciaDetailsHTML += `</div>`;
                        }
                        
                        let detailsButtonHTML = '';
                        if (task.statusAnalise === 'Em Análise') {
                             detailsButtonHTML = `<button data-id="${task.id}" class="edit-ocorrencia-btn mt-4 w-full text-sm bg-slate-200 text-slate-700 font-semibold py-2 rounded-md hover:bg-slate-300 transition-colors">Registrar Ocorrências</button>`;
                        }

                        let occurrenceCountHTML = '';
                        let completionDateHTML = '';
                        if (task.statusAnalise === 'Concluída') {
                            const count = task.ocorrencias ? task.ocorrencias.length : 0;
                            occurrenceCountHTML = `<div class="mt-2 text-sm font-bold ${count > 0 ? 'text-red-600' : 'text-emerald-600'}">Ocorrências: ${count}</div>`;
                            if (task.dataConclusao) {
                                completionDateHTML = `<div class="text-xs text-emerald-600 font-medium mt-1">Concluído em: ${formatDate(task.dataConclusao)}</div>`;
                            }
                        }


                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg text-slate-800 flex-1 pr-2">${task.condominio}</h3>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${task.ocorrencia === 'Sim' ? 'bg-red-100 text-red-800' : (task.ocorrencia === 'Não' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-500')}">${task.ocorrencia || 'Pendente'}</span>
                                    <button data-id="${task.id}" class="archive-single-btn text-slate-400 hover:text-sky-600 font-bold text-lg leading-none flex-shrink-0" title="Arquivar esta análise">&#128450;</button>
                                    <button data-id="${task.id}" class="delete-task-btn text-slate-400 hover:text-red-600 font-bold text-xl leading-none flex-shrink-0" title="Excluir esta análise">&times;</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-slate-500 mb-2">Analisar data: <strong>${formatDate(task.dataAnalise)}</strong></p>
                                <button data-id="${task.id}" class="toggle-details-btn p-1 rounded-full hover:bg-slate-200 ${isCollapsed ? 'collapsed' : ''}">
                                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                            <div class="details-content ${isCollapsed ? 'hidden' : ''}">
                                ${occurrenceCountHTML}
                                ${completionDateHTML}
                                
                                <div class="space-y-3 text-sm mt-4">
                                    <div class="flex items-center justify-between"><span class="font-semibold text-slate-600">Backup:</span><select data-id="${task.id}" data-type="backup" class="status-select border-none text-right font-semibold text-sm rounded-md p-1 ${statusClasses[task.statusBackup]}"><option value="Pendente" ${task.statusBackup === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Andamento" ${task.statusBackup === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option><option value="Concluído" ${task.statusBackup === 'Concluído' ? 'selected' : ''}>Concluído</option><option value="Não visualizar" ${task.statusBackup === 'Não visualizar' ? 'selected' : ''}>Não visualizar</option></select></div>
                                    <div class="flex items-center justify-between"><span class="font-semibold text-slate-600">Análise:</span><select data-id="${task.id}" data-type="analise" class="status-select border-none text-right font-semibold text-sm rounded-md p-1 ${statusClasses[task.statusAnalise]}"><option value="Pendente" ${task.statusAnalise === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Análise" ${task.statusAnalise === 'Em Análise' ? 'selected' : ''}>Em Análise</option><option value="Concluída" ${task.statusAnalise === 'Concluída' ? 'selected' : ''}>Concluída</option><option value="Não visualizar" ${task.statusAnalise === 'Não visualizar' ? 'selected' : ''}>Não visualizar</option></select></div>
                                </div>
                                ${ocorrenciaDetailsHTML}
                                ${detailsButtonHTML}
                            </div>
                        `;
                        taskList.appendChild(card);
                    });
                }
            };
            
            const updateDashboard = () => {
                const currentWeekFilter = filtroSemana.value ? parseInt(filtroSemana.value) : null;
                const filteredTasks = tasks.filter(task => {
                    const matchCondominio = task.condominio.toLowerCase().includes(filtroCondominio.value.toLowerCase());
                    const matchData = !filtroData.value || task.dataAnalise === filtroData.value;
                    const matchBackup = !filtroBackup.value || task.statusBackup === filtroBackup.value;
                    const matchAnalise = !filtroAnalise.value || task.statusAnalise === filtroAnalise.value;
                    let matchSemana = true;
                     if (currentWeekFilter && task.dataAnalise) {
                        const taskDate = new Date(task.dataAnalise + 'T00:00:00');
                        const taskWeek = getWeekNumber(taskDate);
                         matchSemana = taskWeek === (currentWeekFilter -1);
                    } else if (currentWeekFilter && !task.dataAnalise) {
                         matchSemana = false;
                    }
                    return matchCondominio && matchData && matchBackup && matchAnalise && matchSemana;
                });
                
                document.getElementById('total-solicitacoes').textContent = filteredTasks.length;
                document.getElementById('backups-pendentes').textContent = filteredTasks.filter(t => t.statusBackup === 'Pendente').length;
                document.getElementById('analises-pendentes').textContent = filteredTasks.filter(t => t.statusAnalise === 'Pendente').length;
                
                // Weekly Performance Update & Weekly Occurrence Count
                const today = new Date();
                const dayOfWeek = today.getDay() || 7; // Sunday = 0, make it 7
                const monday = new Date(today);
                monday.setDate(today.getDate() - dayOfWeek + 1);
                monday.setHours(0, 0, 0, 0);
                
                const currentDay = new Date();
                currentDay.setHours(23, 59, 59, 999);

                // Use ONLY active tasks for weekly stats
                const completedThisWeek = tasks.filter(task => 
                    task.dataConclusao && 
                    new Date(task.dataConclusao + 'T00:00:00') >= monday &&
                    new Date(task.dataConclusao + 'T00:00:00') <= currentDay
                );

                const totalCompleted = completedThisWeek.length;
                const totalOccurrencesWeek = completedThisWeek.reduce((acc, task) => acc + (task.ocorrencias ? task.ocorrencias.length : 0), 0);

                // Update Weekly Occurrence Card
                document.getElementById('total-ocorrencias-semana').textContent = totalOccurrencesWeek;

                // Calculate Ocorrências / Análises for Weekly Productivity
                const productivityMetric = totalCompleted > 0 ? (totalOccurrencesWeek / totalCompleted).toFixed(1) : '0.0'; 
                document.getElementById('produtividade-semanal').textContent = productivityMetric; 
            };
            
            const updateCharts = () => {
                const allTasks = [...tasks, ...archivedTasks]; // Use all tasks for overall chart
                const dataByCondo = allTasks.reduce((acc, task) => {
                    if (!acc[task.condominio]) acc[task.condominio] = { ocorrencias: 0 };
                    if (task.ocorrencia === 'Sim' && task.ocorrencias) acc[task.condominio].ocorrencias += task.ocorrencias.length;
                    return acc;
                }, {});

                const labels = Object.keys(dataByCondo);
                const ocorrenciasData = labels.map(label => dataByCondo[label].ocorrencias);
                if (ocorrenciasChart) {
                    ocorrenciasChart.data.labels = labels;
                    ocorrenciasChart.data.datasets[0].data = ocorrenciasData;
                    ocorrenciasChart.update();
                }
            };

            const setupCharts = () => {
                const ocorrenciasCtx = document.getElementById('ocorrenciasChart').getContext('2d');
                ocorrenciasChart = new Chart(ocorrenciasCtx, {
                    type: 'bar', data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
                const periodCtx = document.getElementById('periodChart').getContext('2d');
                periodChart = new Chart(periodCtx, {
                    type: 'bar', data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(79, 70, 229, 0.6)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
            };

            const refreshUI = () => {
                saveTasks();
                renderTasks();
                updateDashboard();
                updateCharts();
            };
            
            [filtroCondominio, filtroData, filtroSemana, filtroBackup, filtroAnalise].forEach(el => el.addEventListener('input', refreshUI));

            addTaskBtn.addEventListener('click', () => taskModal.classList.remove('hidden'));
            cancelBtn.addEventListener('click', () => {
                taskModal.classList.add('hidden');
                autocompleteList.classList.add('hidden');
            });
            ocorrenciaCancelBtn.addEventListener('click', () => {
                 // Ensure edits are cancelled if modal is closed without saving form
                const editingItem = ocorrenciaListDiv.querySelector('.ocorrencia-item.editing');
                if (editingItem) {
                    const cancelBtn = editingItem.querySelector('.cancel-edit-ocorrencia-btn');
                    if(cancelBtn) cancelBtn.click();
                }
                ocorrenciaModal.classList.add('hidden');
            });


            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const today = new Date().toISOString().split('T')[0];
                const newTask = {
                    id: Date.now(), dataSolicitacao: today, condominio: document.getElementById('form-condominio').value,
                    dataAnalise: document.getElementById('form-data-analise').value, statusBackup: 'Pendente', dataBackup: '',
                    statusAnalise: 'Pendente', ocorrencia: null, ocorrencias: [], acao: '',
                    obs: document.getElementById('form-observacoes').value,
                    isExpanded: true,
                    dataConclusao: null,
                };
                tasks.push(newTask);
                taskForm.reset();
                taskModal.classList.add('hidden');
                autocompleteList.classList.add('hidden');
                refreshUI();
            });

            bulkAddBtn.addEventListener('click', () => {
                bulkAddModal.classList.remove('hidden');
            });

            bulkCancelBtn.addEventListener('click', () => {
                bulkAddModal.classList.add('hidden');
            });

            bulkAddForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const inputText = bulkInputArea.value.trim();

                if (!inputText) {
                     showNotification("Por favor, cole os dados da planilha.");
                    return;
                }

                const lines = inputText.split('\n');
                const today = new Date().toISOString().split('T')[0];
                let newTasksCount = 0;
                let skippedCount = 0;

                lines.forEach((line, index) => {
                    const columns = line.split('\t'); // Split by tab for Excel copy-paste
                    
                    let dateStr = null;
                    let condominio = null;
                    const dateRegex = /\d{1,2}\/\d{1,2}\/\d{4}/;

                    const dateColumnIndex = columns.findIndex(col => dateRegex.test(col.trim()));

                    if (dateColumnIndex !== -1) {
                        dateStr = columns[dateColumnIndex].trim();
                        // Look for the next column that is not empty
                        for (let i = dateColumnIndex + 1; i < columns.length; i++) {
                            if (columns[i].trim()) {
                                condominio = columns[i].trim();
                                break;
                            }
                        }
                    }

                    if (!dateStr || !condominio) {
                        console.warn(`Linha ignorada (não foi possível encontrar data e condomínio válidos): "${line}"`);
                        return;
                    }

                    const dateParts = dateStr.split('/');
                    if (dateParts.length !== 3 || dateParts[2].length < 4 || isNaN(parseInt(dateParts[0])) || isNaN(parseInt(dateParts[1])) || isNaN(parseInt(dateParts[2]))) {
                       console.warn(`Linha ignorada (formato de data inválido): "${line}"`);
                       return; // Skip if date format is wrong
                    }
                    const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    
                    const isDuplicate = tasks.some(task => task.condominio === condominio && task.dataAnalise === formattedDate);

                    if (isDuplicate) {
                        skippedCount++;
                        return;
                    }

                    const newTask = {
                        id: Date.now() + index,
                        dataSolicitacao: today,
                        condominio: condominio,
                        dataAnalise: formattedDate,
                        statusBackup: 'Pendente',
                        dataBackup: '',
                        statusAnalise: 'Pendente',
                        ocorrencia: null,
                        ocorrencias: [],
                        acao: '',
                        obs: '',
                        isExpanded: true,
                        dataConclusao: null,
                    };
                    tasks.push(newTask);
                    newTasksCount++;
                });
                
                bulkAddModal.classList.add('hidden');
                bulkAddForm.reset();

                if (newTasksCount > 0 || skippedCount > 0) {
                    refreshUI();
                    showNotification(`${newTasksCount} análises importadas. ${skippedCount} duplicadas foram ignoradas.`);
                } else {
                    showNotification('Nenhuma análise nova foi encontrada nos dados colados. Verifique o formato ou se as tarefas já existem.');
                }
            });

            ocorrenciaForm.addEventListener('submit', (e) => {
                e.preventDefault();
                 // Save edits if any item is in edit mode before submitting
                const editingItem = ocorrenciaListDiv.querySelector('.ocorrencia-item.editing');
                if (editingItem) {
                    const saveBtn = editingItem.querySelector('.save-edit-ocorrencia-btn');
                    if(saveBtn) saveBtn.click(); // Trigger save for the currently edited item
                }

                const taskId = parseInt(document.getElementById('ocorrencia-task-id').value);
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const newOcorrencias = Array.from(ocorrenciaListDiv.querySelectorAll('.ocorrencia-item')).map(item => ({
                        id: item.dataset.id,
                        desc: item.querySelector('.view-mode .desc-text').textContent,
                        horarioInicial: item.querySelector('.view-mode .time-text').dataset.start,
                        horarioFinal: item.querySelector('.view-mode .time-text').dataset.end,
                    }));
                    task.ocorrencias = newOcorrencias;
                    task.ocorrencia = newOcorrencias.length > 0 ? 'Sim' : 'Não';
                }
                ocorrenciaModal.classList.add('hidden');
                refreshUI();
            });
            
            taskList.addEventListener('change', (e) => {
                if (e.target.classList.contains('status-select')) {
                    const taskId = parseInt(e.target.dataset.id);
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        if (e.target.dataset.type === 'backup') {
                            task.statusBackup = e.target.value;
                        }
                        if (e.target.dataset.type === 'analise') {
                            const oldStatus = task.statusAnalise;
                            task.statusAnalise = e.target.value;
                            
                            if (task.statusAnalise === 'Concluída' && oldStatus !== 'Concluída') {
                                task.dataConclusao = new Date().toISOString().split('T')[0];
                            } else if (task.statusAnalise !== 'Concluída') {
                                task.dataConclusao = null;
                            }
                        }
                        refreshUI();
                    }
                }
            });

            const renderOcorrenciaItemInModal = (ocor) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ocorrencia-item p-3 bg-slate-100 rounded-md';
                itemDiv.dataset.id = ocor.id || Date.now(); // Ensure ID exists

                itemDiv.innerHTML = `
                    <div class="view-mode">
                        <div class="flex items-start justify-between">
                            <div class="flex-grow mr-2">
                                <p class="desc-text font-medium text-slate-800">${ocor.desc}</p>
                                <p class="time-text text-sm text-slate-500" data-start="${ocor.horarioInicial || ''}" data-end="${ocor.horarioFinal || ''}">Horário: ${ocor.horarioInicial || 'N/A'} - ${ocor.horarioFinal || 'N/A'}</p>
                            </div>
                             <div class="flex flex-col items-end flex-shrink-0 space-y-1">
                                <button type="button" class="edit-ocorrencia-item-btn text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded hover:bg-blue-200">Editar</button>
                                <button type="button" class="remove-ocorrencia-btn text-red-500 hover:text-red-700 font-bold text-xl leading-none">&times;</button>
                             </div>
                        </div>
                    </div>
                    <div class="edit-mode hidden">
                        <textarea class="edit-desc w-full border border-slate-300 rounded-md p-1 mb-2 text-sm">${ocor.desc}</textarea>
                        <div class="flex gap-2">
                            <input type="time" step="1" class="edit-start border border-slate-300 rounded-md p-1 text-sm w-full" value="${ocor.horarioInicial || ''}">
                            <input type="time" step="1" class="edit-end border border-slate-300 rounded-md p-1 text-sm w-full" value="${ocor.horarioFinal || ''}">
                        </div>
                        <div class="mt-2 text-right">
                             <button type="button" class="cancel-edit-ocorrencia-btn text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded hover:bg-slate-300 mr-1">Cancelar</button>
                            <button type="button" class="save-edit-ocorrencia-btn text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Salvar Edição</button>
                        </div>
                    </div>
                `;
                ocorrenciaListDiv.appendChild(itemDiv);
            }


            addOcorrenciaBtn.addEventListener('click', () => {
                const descInput = document.getElementById('add-ocorrencia-desc');
                const startInput = document.getElementById('add-horario-inicial');
                const endInput = document.getElementById('add-horario-final');
                if (!descInput.value.trim()) {
                    descInput.classList.add('border-red-500');
                    setTimeout(() => descInput.classList.remove('border-red-500'), 2000);
                    return;
                }
                renderOcorrenciaItemInModal({
                    id: Date.now(), desc: descInput.value, horarioInicial: startInput.value, horarioFinal: endInput.value
                });
                descInput.value = ''; startInput.value = ''; endInput.value = '';
            });
            
             ocorrenciaListDiv.addEventListener('click', (e) => {
                const itemDiv = e.target.closest('.ocorrencia-item');
                if (!itemDiv) return;

                if (e.target.classList.contains('remove-ocorrencia-btn')) {
                    itemDiv.remove();
                } else if (e.target.classList.contains('edit-ocorrencia-item-btn')) {
                     // Ensure only one item is editable at a time
                    ocorrenciaListDiv.querySelectorAll('.ocorrencia-item.editing').forEach(el => {
                         const cancelBtn = el.querySelector('.cancel-edit-ocorrencia-btn');
                         if(cancelBtn) cancelBtn.click(); // Cancel existing edits
                    });
                    itemDiv.classList.add('editing');
                    itemDiv.querySelector('.view-mode').classList.add('hidden');
                    itemDiv.querySelector('.edit-mode').classList.remove('hidden');
                } else if (e.target.classList.contains('save-edit-ocorrencia-btn')) {
                    const newDesc = itemDiv.querySelector('.edit-desc').value;
                    const newStart = itemDiv.querySelector('.edit-start').value;
                    const newEnd = itemDiv.querySelector('.edit-end').value;

                    // Update view mode elements
                    const descText = itemDiv.querySelector('.view-mode .desc-text');
                    const timeText = itemDiv.querySelector('.view-mode .time-text');
                    descText.textContent = newDesc;
                    timeText.dataset.start = newStart;
                    timeText.dataset.end = newEnd;
                    timeText.textContent = `Horário: ${newStart || 'N/A'} - ${newEnd || 'N/A'}`;

                    // Switch back to view mode
                    itemDiv.classList.remove('editing');
                    itemDiv.querySelector('.view-mode').classList.remove('hidden');
                    itemDiv.querySelector('.edit-mode').classList.add('hidden');
                } else if (e.target.classList.contains('cancel-edit-ocorrencia-btn')) {
                     // Reset input values to original before canceling
                    const descText = itemDiv.querySelector('.view-mode .desc-text').textContent;
                    const timeText = itemDiv.querySelector('.view-mode .time-text');
                    itemDiv.querySelector('.edit-desc').value = descText;
                    itemDiv.querySelector('.edit-start').value = timeText.dataset.start;
                    itemDiv.querySelector('.edit-end').value = timeText.dataset.end;

                    // Switch back to view mode
                    itemDiv.classList.remove('editing');
                    itemDiv.querySelector('.view-mode').classList.remove('hidden');
                    itemDiv.querySelector('.edit-mode').classList.add('hidden');
                }
            });

            taskList.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.toggle-details-btn, .edit-ocorrencia-btn, .delete-task-btn, .archive-single-btn');
                if (!targetButton) return;
                
                const taskId = parseInt(targetButton.dataset.id);

                if (targetButton.classList.contains('toggle-details-btn')) {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.isExpanded = !task.isExpanded;
                        refreshUI();
                    }
                }
                
                if (targetButton.classList.contains('edit-ocorrencia-btn')) {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        document.getElementById('ocorrencia-task-id').value = task.id;
                        ocorrenciaListDiv.innerHTML = ''; // Clear previous items
                        // Ensure all items are rendered correctly
                         if (task.ocorrencias) {
                            task.ocorrencias.forEach(ocor => renderOcorrenciaItemInModal(ocor));
                        }
                         // Reset add form
                        document.getElementById('add-ocorrencia-desc').value = '';
                        document.getElementById('add-horario-inicial').value = '';
                        document.getElementById('add-horario-final').value = '';
                        ocorrenciaModal.classList.remove('hidden');
                    }
                }

                if (targetButton.classList.contains('archive-single-btn')) {
                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                    
                    if (taskIndex > -1) {
                        const [taskToArchive] = tasks.splice(taskIndex, 1); // Remove from active tasks
                        taskToArchive.archivedReason = 'manual'; // Add reason
                        archivedTasks.push(taskToArchive); // Add to archived tasks
                        
                        refreshUI(); // Update the UI
                        showNotification('Análise arquivada manualmente.');
                    }
                }

                if (targetButton.classList.contains('delete-task-btn')) {
                    tasks = tasks.filter(t => t.id !== taskId);
                    refreshUI();
                }
            });

            formCondominioInput.addEventListener('input', () => {
                const inputValue = formCondominioInput.value.toLowerCase();
                autocompleteList.innerHTML = '';
                if (inputValue.length === 0) {
                    autocompleteList.classList.add('hidden');
                    return;
                }
                const uniqueCondominios = [...new Set(tasks.map(task => task.condominio))];
                const suggestions = uniqueCondominios.filter(condo => condo.toLowerCase().startsWith(inputValue));
                if (suggestions.length > 0) {
                    suggestions.forEach(suggestion => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-sky-100 cursor-pointer text-sm';
                        item.textContent = suggestion;
                        item.addEventListener('click', () => {
                            formCondominioInput.value = suggestion;
                            autocompleteList.classList.add('hidden');
                        });
                        autocompleteList.appendChild(item);
                    });
                    autocompleteList.classList.remove('hidden');
                } else {
                    autocompleteList.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!formCondominioInput.contains(e.target) && !autocompleteList.contains(e.target)) {
                    autocompleteList.classList.add('hidden');
                }
            });

            renameCondoBtn.addEventListener('click', () => {
                const uniqueCondominios = [...new Set([...tasks, ...archivedTasks].map(task => task.condominio))].sort(); // Use all tasks
                oldNameSelect.innerHTML = '<option value="">Selecione um condomínio</option>';
                uniqueCondominios.forEach(condo => {
                    const option = document.createElement('option');
                    option.value = condo;
                    option.textContent = condo;
                    oldNameSelect.appendChild(option);
                });
                newNameInput.value = '';
                renameModal.classList.remove('hidden');
            });


            renameCancelBtn.addEventListener('click', () => renameModal.classList.add('hidden'));

            renameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldName = oldNameSelect.value;
                const newName = newNameInput.value.trim();
                if (!oldName || !newName || oldName === newName) {
                    renameModal.classList.add('hidden');
                    return;
                }
                tasks.forEach(task => {
                    if (task.condominio === oldName) {
                        task.condominio = newName;
                    }
                });
                 archivedTasks.forEach(task => { // Rename in archive too
                    if (task.condominio === oldName) {
                        task.condominio = newName;
                    }
                });
                renameModal.classList.add('hidden');
                refreshUI();
            });
            
            expandAllBtn.addEventListener('click', () => {
                tasks.forEach(t => t.isExpanded = true);
                refreshUI();
            });

            collapseAllBtn.addEventListener('click', () => {
                tasks.forEach(t => t.isExpanded = false);
                refreshUI();
            });
            
            const performAutoBackup = () => {
                const today = new Date().toISOString().split('T')[0];
                const lastBackupDate = localStorage.getItem('lastBackupDate');

                if (today !== lastBackupDate) {
                     try {
                        const allData = {
                            tasks: JSON.parse(localStorage.getItem('monitoramentoTasks')) || [],
                            archivedTasks: JSON.parse(localStorage.getItem('archivedTasks')) || []
                        };
                        if (allData.tasks.length === 0 && allData.archivedTasks.length === 0) return;
                        
                        const dataStr = JSON.stringify(allData, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.download = `backup_automatico_${today}.json`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                        localStorage.setItem('lastBackupDate', today);
                        console.log('Backup automático realizado com sucesso.');
                    } catch (error) {
                        console.error('Falha no backup automático:', error);
                    }
                }
            };

            const performWeeklyArchive = () => {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const lastResetStr = localStorage.getItem('lastResetDate');
                let shouldReset = false;

                if (!lastResetStr) {
                    shouldReset = true; // First time running
                } else {
                    const lastResetDate = new Date(lastResetStr + 'T00:00:00');
                    const nextResetDate = new Date(lastResetDate);
                    nextResetDate.setDate(lastResetDate.getDate() + 7);
                    
                    if (today >= nextResetDate) {
                        shouldReset = true;
                    }
                }

                if (shouldReset) {
                    console.log("Realizando arquivamento semanal automático...");
                    const currentDayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday...
                    const diffToMonday = today.getDate() - currentDayOfWeek + (currentDayOfWeek === 0 ? -6 : 1); // Adjust to get Monday
                    const mondayOfCurrentWeek = new Date(today.setDate(diffToMonday));
                    mondayOfCurrentWeek.setHours(0, 0, 0, 0);

                    let tasksToArchive = [];
                    let remainingTasks = [];
                    let count = 0;

                    tasks.forEach(task => {
                         // Check if dataAnalise is valid before creating Date object
                         if (task.dataAnalise && !isNaN(new Date(task.dataAnalise + 'T00:00:00'))) {
                            const taskDate = new Date(task.dataAnalise + 'T00:00:00');
                            if (taskDate < mondayOfCurrentWeek) {
                                task.archivedReason = 'auto-weekly'; // Add reason
                                tasksToArchive.push(task);
                                count++;
                            } else {
                                remainingTasks.push(task);
                            }
                        } else {
                             remainingTasks.push(task); // Keep tasks with invalid or missing dates
                             console.warn(`Tarefa ${task.id} mantida pois a data de análise é inválida ou ausente.`);
                        }
                    });

                    if (count > 0) {
                        archivedTasks.push(...tasksToArchive);
                        tasks = remainingTasks;
                        saveTasks(); // Save immediately after archiving
                        showNotification(`${count} análises de semanas anteriores foram arquivadas automaticamente.`);
                        refreshUI(); // Update UI after saving and notification
                    } else {
                         console.log("Nenhuma análise anterior à semana atual encontrada para arquivamento automático.");
                    }

                    localStorage.setItem('lastResetDate', todayStr);
                }
            };


            restoreBtn.addEventListener('click', () => {
                restoreInput.click();
            });

            restoreInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                fileToRestore = file;
                restoreConfirmModal.classList.remove('hidden');
                restoreInput.value = ''; 
            });

            restoreConfirmCancelBtn.addEventListener('click', () => {
                fileToRestore = null;
                restoreConfirmModal.classList.add('hidden');
            });

            restoreConfirmProceedBtn.addEventListener('click', () => {
                if (!fileToRestore) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data && Array.isArray(data.tasks) && Array.isArray(data.archivedTasks)) {
                            tasks = data.tasks;
                            archivedTasks = data.archivedTasks;
                        } else if (Array.isArray(data)) { // For old backup format
                            tasks = data;
                            archivedTasks = [];
                        } else {
                             throw new Error('Formato de arquivo inválido.');
                        }
                        refreshUI();
                        showNotification('Backup restaurado com sucesso!');
                    } catch (error) {
                        console.error('Erro ao restaurar backup:', error);
                        showNotification('Erro ao ler o arquivo de backup. Verifique se o arquivo é válido.');
                    } finally {
                        fileToRestore = null;
                        restoreConfirmModal.classList.add('hidden');
                    }
                };
                reader.onerror = () => {
                    showNotification('Não foi possível ler o arquivo selecionado.');
                    fileToRestore = null;
                    restoreConfirmModal.classList.add('hidden');
                };
                reader.readAsText(fileToRestore);
            });
            
            periodAnalysisBtn.addEventListener('click', () => periodAnalysisModal.classList.remove('hidden'));
            periodAnalysisCloseBtn.addEventListener('click', () => periodAnalysisModal.classList.add('hidden'));
            
            actionsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                actionsMenu.classList.toggle('hidden');
            });

            window.addEventListener('click', (e) => {
                if (!actionsMenu.classList.contains('hidden') && !actionsMenuContainer.contains(e.target)) {
                    actionsMenu.classList.add('hidden');
                }
            });
            
            actionsMenu.addEventListener('click', () => {
                actionsMenu.classList.add('hidden');
            });

            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const period = e.target.dataset.period;
                    const today = new Date();
                    let startDate, endDate;

                    if (period === 'this-week') {
                        const dayOfWeek = today.getDay();
                        const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Sunday being 0
                        startDate = new Date(today.setDate(diff));
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                    } else if (period === 'last-week') {
                        const beforeOneWeek = new Date();
                        beforeOneWeek.setDate(today.getDate() - 7);
                        const dayOfWeek = beforeOneWeek.getDay();
                        const diff = beforeOneWeek.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Sunday being 0
                        startDate = new Date(beforeOneWeek.setDate(diff));
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                    } else if (period === 'this-month') {
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    } else if (period === 'last-month') {
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    }
                    periodStartDateInput.value = formatDateForInput(startDate);
                    periodEndDateInput.value = formatDateForInput(endDate);
                });
            });

            generateReportBtn.addEventListener('click', () => {
                const startDate = periodStartDateInput.value;
                const endDate = periodEndDateInput.value;
                if (!startDate || !endDate) {
                    showNotification("Por favor, selecione as datas de início e fim.");
                    return;
                }
                const analysisType = document.querySelector('input[name="analysis_type"]:checked').value;
                const allTasksForReport = [...tasks, ...archivedTasks];

                const filteredTasks = allTasksForReport.filter(task => {
                    const dateToCompare = analysisType === 'dataConclusao' ? task.dataConclusao : task.dataAnalise;
                    if (!dateToCompare) return false;
                    return dateToCompare >= startDate && dateToCompare <= endDate;
                });
                
                const totalDias = filteredTasks.length;
                const uniquePdvs = new Set(filteredTasks.map(task => task.condominio)).size;
                const totalOcorrencias = filteredTasks.reduce((acc, task) => acc + (task.ocorrencias ? task.ocorrencias.length : 0), 0);

                document.getElementById('period-dias').textContent = totalDias;
                document.getElementById('period-pdv').textContent = uniquePdvs;
                document.getElementById('period-oc').textContent = totalOcorrencias;

                const dataByCondo = filteredTasks.reduce((acc, task) => {
                    if (!acc[task.condominio]) acc[task.condominio] = { ocorrencias: 0 };
                    if (task.ocorrencia === 'Sim' && task.ocorrencias) acc[task.condominio].ocorrencias += task.ocorrencias.length;
                    return acc;
                }, {});

                periodChart.data.labels = Object.keys(dataByCondo);
                periodChart.data.datasets[0].data = Object.values(dataByCondo).map(d => d.ocorrencias);
                periodChart.update();
                
                periodTaskList.innerHTML = '';
                if(filteredTasks.length > 0){
                    filteredTasks.sort((a, b) => new Date(a.dataAnalise) - new Date(b.dataAnalise));
                    filteredTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = 'text-sm p-2 bg-slate-100 rounded-md flex justify-between items-center';
                        li.innerHTML = `
                           <span><strong>${task.condominio}</strong> - ${formatDate(task.dataAnalise)}</span>
                           <span class="font-bold ${task.ocorrencias && task.ocorrencias.length > 0 ? 'text-red-600' : 'text-emerald-600'}">${task.ocorrencias ? task.ocorrencias.length : 0} ocorr.</span>
                        `;
                        periodTaskList.appendChild(li);
                    });
                } else {
                    periodTaskList.innerHTML = '<li class="text-sm text-slate-500 text-center">Nenhuma análise encontrada para o período.</li>';
                }

                periodResultsContent.classList.remove('hidden');
            });

            const renderPriorityView = () => {
                const allTasks = [...tasks, ...archivedTasks];
                const occurrenceMap = allTasks.reduce((acc, task) => {
                    if (!acc[task.condominio]) {
                        acc[task.condominio] = 0;
                    }
                    if (task.ocorrencias && task.ocorrencias.length > 0) {
                        acc[task.condominio] += task.ocorrencias.length;
                    }
                    return acc;
                }, {});

                const pendingTasks = tasks.filter(task => task.statusBackup === 'Pendente' || task.statusAnalise === 'Pendente');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                pendingTasks.forEach(task => {
                    const taskDate = new Date(task.dataAnalise + 'T00:00:00');
                    const timeDiff = today.getTime() - taskDate.getTime();
                    task.daysOverdue = Math.ceil(timeDiff / (1000 * 3600 * 24));
                });

                pendingTasks.sort((a, b) => {
                    const scoreA = occurrenceMap[a.condominio] || 0;
                    const scoreB = occurrenceMap[b.condominio] || 0;
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                    return new Date(a.dataAnalise) - new Date(b.dataAnalise);
                });

                priorityTaskList.innerHTML = '';

                if (pendingTasks.length === 0) {
                    priorityTaskList.innerHTML = '<li class="text-center text-slate-500 p-4 bg-emerald-50 rounded-md">Parabéns! Você está em dia com todas as análises.</li>';
                    return;
                }

                pendingTasks.forEach(task => {
                    let urgencyHTML = '';
                    if (task.daysOverdue > 0) {
                        urgencyHTML = `<span class="font-bold text-red-600">Atrasado ${task.daysOverdue} dia(s)</span>`;
                    } else if (task.daysOverdue === 0) {
                        urgencyHTML = `<span class="font-bold text-amber-600">Para Hoje</span>`;
                    } else {
                        urgencyHTML = `<span class="font-semibold text-sky-600">Futuro (${formatDate(task.dataAnalise)})</span>`;
                    }
                    
                    const historyScore = occurrenceMap[task.condominio] || 0;

                    const li = document.createElement('li');
                    li.className = 'p-3 bg-slate-100 rounded-md flex justify-between items-center';
                    li.innerHTML = `
                        <div>
                            <p class="font-bold text-slate-800">${task.condominio}</p>
                            <p class="text-xs text-slate-500">Histórico: <strong>${historyScore}</strong> ocorrências</p>
                        </div>
                        <div class="text-right">
                            ${urgencyHTML}
                        </div>
                    `;
                    priorityTaskList.appendChild(li);
                });
            };
            
            priorityBtn.addEventListener('click', () => {
                renderPriorityView();
                priorityModal.classList.remove('hidden');
            });

            priorityCloseBtn.addEventListener('click', () => {
                priorityModal.classList.add('hidden');
            });
            
            archiveBtn.addEventListener('click', () => archiveModal.classList.remove('hidden'));
            archiveCancelBtn.addEventListener('click', () => archiveModal.classList.add('hidden'));

            archiveForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const days = parseInt(document.querySelector('input[name="archive_period"]:checked').value);
                const thresholdDate = new Date();
                thresholdDate.setDate(thresholdDate.getDate() - days);

                let tasksToArchive = [];
                let remainingTasks = [];

                tasks.forEach(task => {
                    if (task.statusAnalise === 'Concluída' && task.dataConclusao && new Date(task.dataConclusao) < thresholdDate) {
                        tasksToArchive.push(task);
                    } else {
                        remainingTasks.push(task);
                    }
                });

                if (tasksToArchive.length > 0) {
                    archivedTasks.push(...tasksToArchive);
                    tasks = remainingTasks;
                    refreshUI();
                    showNotification(`${tasksToArchive.length} análises foram arquivadas.`);
                } else {
                    showNotification("Nenhuma análise concluída encontrada para o período selecionado.");
                }
                archiveModal.classList.add('hidden');
            });

            viewArchiveBtn.addEventListener('click', () => {
                 viewArchiveListContainer.innerHTML = ''; // Clear previous content
                 unarchiveSelectedBtn.disabled = true; // Disable button initially

                if (archivedTasks.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    archivedTasks.sort((a,b) => new Date(b.dataConclusao || b.dataAnalise) - new Date(a.dataConclusao || a.dataAnalise));
                    archivedTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = 'p-2 bg-white rounded-md text-sm flex justify-between items-center';
                        li.innerHTML = `
                            <label class="flex items-center flex-grow mr-4">
                                <input type="checkbox" value="${task.id}" class="h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500 archive-checkbox mr-3">
                                <span><strong>${task.condominio}</strong> - Análise de ${formatDate(task.dataAnalise)}</span>
                            </label>
                            <span class="text-slate-500 text-xs flex-shrink-0">Concluído em: ${formatDate(task.dataConclusao)}</span>
                             <button data-id="${task.id}" class="unarchive-single-btn ml-4 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded hover:bg-orange-200">Desarquivar</button>
                        `;
                        list.appendChild(li);
                    });
                    viewArchiveListContainer.appendChild(list);

                    // Add event listener for checkboxes after rendering
                    viewArchiveListContainer.querySelectorAll('.archive-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            const anyChecked = viewArchiveListContainer.querySelector('.archive-checkbox:checked');
                            unarchiveSelectedBtn.disabled = !anyChecked;
                        });
                    });

                } else {
                     viewArchiveListContainer.innerHTML = '<p class="text-center text-slate-500">Nenhuma análise arquivada.</p>';
                }
                viewArchiveModal.classList.remove('hidden');
            });

            viewArchiveCloseBtn.addEventListener('click', () => viewArchiveModal.classList.add('hidden'));

             // Event listener for single unarchive buttons
             viewArchiveListContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('unarchive-single-btn')) {
                    const taskId = parseInt(e.target.dataset.id);
                    const taskIndex = archivedTasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        const [taskToUnarchive] = archivedTasks.splice(taskIndex, 1);
                        tasks.push(taskToUnarchive);
                        
                        // Re-render the archive list
                        const listItems = viewArchiveListContainer.querySelectorAll('li');
                        listItems.forEach(li => {
                             const checkbox = li.querySelector('.archive-checkbox');
                             if (checkbox && parseInt(checkbox.value) === taskId) {
                                 li.remove();
                             }
                        });
                        
                        // Update UI if list becomes empty
                        if (archivedTasks.length === 0) {
                             viewArchiveListContainer.innerHTML = '<p class="text-center text-slate-500">Nenhuma análise arquivada.</p>';
                        }
                         unarchiveSelectedBtn.disabled = !viewArchiveListContainer.querySelector('.archive-checkbox:checked'); // Re-check button state

                        refreshUI(); // Refresh main UI
                        showNotification(`Análise desarquivada.`);
                    }
                }
            });


            unarchiveSelectedBtn.addEventListener('click', () => {
                const selectedIds = Array.from(viewArchiveListContainer.querySelectorAll('.archive-checkbox:checked'))
                                         .map(cb => parseInt(cb.value));
                
                if (selectedIds.length === 0) return;

                let tasksToUnarchive = [];
                let remainingArchived = [];

                archivedTasks.forEach(task => {
                    if (selectedIds.includes(task.id)) {
                        tasksToUnarchive.push(task);
                    } else {
                        remainingArchived.push(task);
                    }
                });

                if (tasksToUnarchive.length > 0) {
                    tasks.push(...tasksToUnarchive);
                    archivedTasks = remainingArchived;
                    refreshUI();
                    viewArchiveModal.classList.add('hidden'); // Close modal after action
                    showNotification(`${tasksToUnarchive.length} análises foram desarquivadas.`);
                }
            });


            setupCharts();
            performWeeklyArchive(); // Run weekly archive check on load
            refreshUI(); // Initial render after potential archive
            performAutoBackup(); // Perform auto-backup after initial setup and potential archive
        });
    </script>
</body>
</html>

