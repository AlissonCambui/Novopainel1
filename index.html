<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Monitoramento (Completo Offline)</title>
    
    <!-- Tenta carregar bibliotecas, mas o sistema funciona sem elas -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
        /* --- ESTILO VISUAL NATIVO (Funciona sem internet) --- */
        
        :root {
            --bg-body: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --primary: #ea580c; /* Laranja */
            --primary-hover: #c2410c;
            --card-bg: #ffffff;
            --border: #cbd5e1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            margin: 0; 
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Cabeçalho */
        header { text-align: center; margin-bottom: 2rem; }
        .logo { font-family: 'Arial Black', sans-serif; font-size: 2rem; letter-spacing: -1px; }
        .logo span:first-child { color: #f26324; }
        .logo span:last-child { color: #f7b41e; }
        h1 { font-size: 1.8rem; margin: 0.5rem 0; }
        
        /* Grids e Layout */
        .grid-resumo { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 1rem; 
            margin-bottom: 2rem; 
        }
        .grid-tasks {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* Cartões */
        .card { 
            background: var(--card-bg); 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .card-resumo { text-align: center; }
        .big-number { font-size: 2rem; font-weight: bold; margin: 0.5rem 0 0 0; }
        
        .task-card { border-left: 5px solid var(--border); position: relative; }
        .task-card.pendente { border-left-color: var(--warning); }
        .task-card.em-analise { border-left-color: var(--primary); }
        .task-card.concluida { border-left-color: var(--success); }

        /* Controles e Filtros */
        .controls-section { 
            background: white; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            margin-bottom: 2rem; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1rem; 
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filters { display: flex; flex-wrap: wrap; gap: 0.5rem; flex: 1; }
        
        /* Inputs e Botões */
        input, select, textarea {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            font-size: 0.9rem;
            width: 100%; 
            box-sizing: border-box;
        }
        
        /* Estilo específico para inputs nos filtros para não ficarem gigantes */
        .filters input, .filters select { width: auto; }

        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: #e2e8f0; color: var(--text-primary); }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-danger { color: var(--danger); background: transparent; font-size: 1.2rem; padding: 0 0.5rem; }
        
        /* Menu Dropdown */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            padding: 5px 0;
        }
        .dropdown-content button {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
        }
        .dropdown-content button:hover {background-color: #f1f1f1;}
        .show {display:block;}

        /* Utilitários */
        .hidden { display: none !important; }
        .text-red { color: var(--danger); }
        .text-orange { color: var(--primary); }
        .text-green { color: var(--success); }
        .text-sm { font-size: 0.85rem; color: var(--text-secondary); }
        .font-bold { font-weight: bold; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .mt-2 { margin-top: 0.5rem; }
        .w-full { width: 100%; }
        .mb-4 { margin-bottom: 1rem; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px; /* Maior para relatórios */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .chart-box { height: 300px; position: relative; margin-bottom: 20px; }

        /* Aviso de Offline */
        .offline-warning {
            background: #fee2e2; color: #991b1b; 
            padding: 10px; text-align: center; 
            border-radius: 8px; margin-bottom: 20px;
            display: none; 
        }
        
        hr { border: 0; border-top: 1px solid #eee; margin: 5px 0; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="chart-error-msg" class="offline-warning">
            <strong>Modo Offline:</strong> Gráficos desativados (sem conexão), mas todas as funções operacionais estão ativas.
        </div>

        <header>
            <div class="logo"><span>vend</span><span>Perto</span></div>
            <h1>Painel de Monitoramento</h1>
            <p>Controle de backups, análises e ocorrências</p>
        </header>

        <!-- Resumo -->
        <div class="grid-resumo">
            <div class="card card-resumo">
                <span class="text-sm">Ativas</span>
                <p id="total-solicitacoes" class="big-number text-orange">0</p>
            </div>
            <div class="card card-resumo">
                <span class="text-sm">Backups Pendentes</span>
                <p id="backups-pendentes" class="big-number" style="color: #d97706">0</p>
            </div>
            <div class="card card-resumo">
                <span class="text-sm">Análises Pendentes</span>
                <p id="analises-pendentes" class="big-number text-red">0</p>
            </div>
            <div class="card card-resumo">
                <span class="text-sm">Ocorrências (Semana)</span>
                <p id="total-ocorrencias-semana" class="big-number">0</p>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls-section">
            <div class="filters">
                <input type="text" id="filtro-condominio" placeholder="Filtrar Condomínio..." style="width: 150px;">
                <input type="date" id="filtro-data" style="width: 130px;">
                <input type="number" id="filtro-semana" placeholder="Sem." style="width: 60px;">
                <select id="filtro-analise" style="width: 120px;">
                    <option value="">Status (Todos)</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Em Análise">Em Análise</option>
                    <option value="Concluída">Concluída</option>
                </select>
                <button id="expand-all-btn" class="btn-secondary">Expandir</button>
                <button id="collapse-all-btn" class="btn-secondary">Recolher</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="add-task-btn" class="btn-primary">+ Nova Análise</button>
                
                <!-- MENU DE AÇÕES (Botão Dropdown) -->
                <div class="dropdown">
                    <button id="actions-menu-btn" class="btn-secondary">Ações &#9662;</button>
                    <div id="actions-menu" class="dropdown-content">
                        <button id="priority-btn">Prioridades</button>
                        <button id="planner-btn">Planejar Semana</button>
                        <button id="period-analysis-btn">Análise por Período</button>
                        <button id="annual-report-btn">Relatório Anual</button>
                        <button id="pdv-dashboard-btn">Painel PDV</button>
                        <hr>
                        <button id="bulk-add-btn">Importar Planilha</button>
                        <button id="category-btn">Categorias</button>
                        <button id="rename-condo-btn">Renomear</button>
                        <button id="archive-btn">Arquivar</button>
                        <button id="restore-btn" style="color: #ea580c; font-weight: bold;">Restaurar Backup</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Tarefas -->
        <main id="task-list" class="grid-tasks">
            <!-- Tarefas inseridas via JS -->
        </main>
        
        <!-- Gráficos (Só aparecem se a biblioteca carregar) -->
        <section class="card mt-2" id="chart-section" style="margin-top: 3rem;">
            <h2 style="text-align: center;">Ocorrências da Semana</h2>
            <div class="chart-box">
                <canvas id="ocorrenciasChart"></canvas>
            </div>
        </section>

    </div>

    <!-- ================= MODAIS ================= -->
    
    <!-- Modal Adicionar -->
    <div id="task-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Nova Análise</h2>
            <form id="task-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label>Condomínio</label>
                    <div style="position: relative;">
                        <input type="text" id="form-condominio" class="w-full" required autocomplete="off">
                        <div id="autocomplete-list" style="position: absolute; background: white; border: 1px solid #ccc; width: 100%; max-height: 150px; overflow-y: auto; display: none; z-index: 10;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div style="flex: 1;">
                        <label>Data</label>
                        <input type="date" id="form-data-analise" class="w-full" required>
                    </div>
                    <div style="width: 80px;">
                        <label>Semana</label>
                        <input type="number" id="form-semana-trabalho" class="w-full">
                    </div>
                </div>
                <div>
                    <label>Observações</label>
                    <textarea id="form-observacoes" class="w-full" rows="3"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button type="button" id="cancel-btn" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ocorrências -->
    <div id="ocorrencia-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Gerenciar Ocorrências</h2>
            <form id="ocorrencia-form">
                <input type="hidden" id="ocorrencia-task-id">
                <div id="ocorrencia-list" style="background: #f8fafc; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; margin-bottom: 1rem;"></div>
                <div style="border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <select id="add-ocorrencia-categoria" class="w-full"></select>
                        <input type="text" id="add-ocorrencia-desc" placeholder="Descrição" class="w-full">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; align-items: center;">
                        <input type="time" id="add-horario-inicial">
                        <input type="time" id="add-horario-final">
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="add-ocorrencia-inconclusiva"> Inconclusiva</label>
                    </div>
                    <button type="button" id="add-ocorrencia-btn" class="btn-secondary w-full mt-2" style="background: #ffedd5; color: #ea580c;">+ Adicionar Ocorrência</button>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                    <button type="button" id="ocorrencia-cancel-btn" class="btn-secondary">Fechar</button>
                    <button type="submit" class="btn-primary">Salvar Tudo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importar (Bulk) -->
    <div id="bulk-add-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Importar Planilha</h2>
            <p class="text-sm mb-4">Cole os dados com cabeçalho (Semana, Dia a visualizar, Unidade, Status, OC).</p>
            <form id="bulk-add-form">
                <textarea id="bulk-input-area" rows="10" class="w-full mb-4" placeholder="Cole aqui..."></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button type="button" id="bulk-cancel-btn" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Relatório Anual -->
    <div id="annual-report-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="annual-report-title">Relatório Anual</h2>
                <button id="annual-report-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div class="grid-resumo">
                <div class="card card-resumo"><p>Análises</p><p id="annual-total-analises" class="big-number text-orange">0</p></div>
                <div class="card card-resumo"><p>Ocorrências</p><p id="annual-total-ocorrencias" class="big-number text-red">0</p></div>
            </div>
            <div class="chart-box"><canvas id="annualReportChart_Monthly"></canvas></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="chart-box"><canvas id="annualReportChart_Category"></canvas></div>
                <div class="chart-box"><canvas id="annualReportChart_Condo"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Modal Análise Por Período -->
    <div id="period-analysis-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2>Análise por Período</h2>
                <button id="period-analysis-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                <input type="date" id="period-start-date">
                <input type="date" id="period-end-date">
                <button id="generate-report-btn" class="btn-primary">Gerar</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <label><input type="radio" name="analysis_type" value="dataAnalise" checked> Data Análise</label>
                <label style="margin-left: 1rem;"><input type="radio" name="analysis_type" value="dataConclusao"> Data Conclusão</label>
            </div>
            <div class="grid-resumo">
                <div class="card card-resumo"><p>Dias</p><p id="period-dias" class="big-number">0</p></div>
                <div class="card card-resumo"><p>PDVs</p><p id="period-pdv" class="big-number">0</p></div>
                <div class="card card-resumo"><p>OCs</p><p id="period-oc" class="big-number text-red">0</p></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="chart-box"><canvas id="periodCategoryChart"></canvas></div>
                <div class="chart-box">
                    <select id="period-category-filter" class="w-full mb-2"><option value="">Filtrar Categoria</option></select>
                    <canvas id="periodChart"></canvas>
                </div>
            </div>
            <ul id="period-task-list" style="max-height: 150px; overflow-y: auto; background: #f8fafc; padding: 10px;"></ul>
        </div>
    </div>
    
    <!-- Modal Prioridades -->
    <div id="priority-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h2>Prioridades</h2>
                <button id="priority-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <ul id="priority-task-list" style="list-style: none; padding: 0;"></ul>
        </div>
    </div>
    
    <!-- Modal Planejador -->
    <div id="planner-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Planejador Semanal</h2>
            <form id="planner-form">
                <input type="number" id="planner-week-number" class="w-full mb-4" placeholder="Semana Nº" required>
                <div id="planner-list-container" style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 1rem;"></div>
                <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button type="button" id="planner-cancel-btn" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Gerar Tarefas</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal PDV Dashboard -->
    <div id="pdv-dashboard-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2>Painel PDV</h2>
                <button id="pdv-dashboard-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <select id="pdv-select" class="w-full mb-4"></select>
            <div id="pdv-content" class="hidden">
                <div class="grid-resumo">
                    <div class="card card-resumo"><p>Total</p><p id="pdv-total-analises" class="big-number">0</p></div>
                    <div class="card card-resumo"><p>OCs</p><p id="pdv-total-ocorrencias" class="big-number text-red">0</p></div>
                </div>
                <div class="chart-box"><canvas id="pdvTrendChart"></canvas></div>
                <ul id="pdv-task-list" style="max-height: 150px; overflow-y: auto; background: #f8fafc; padding: 10px;"></ul>
            </div>
        </div>
    </div>

    <!-- Outros Modais Simples -->
    <div id="category-modal" class="modal-overlay hidden"><div class="modal-content" style="max-width: 400px;"><h2>Categorias</h2><form id="add-category-form" class="flex gap-2 mb-4"><input type="text" id="new-category-name" required><button type="submit" class="btn-primary">Add</button></form><div id="category-list-container" style="height: 150px; overflow-y: auto; margin-bottom: 1rem;"></div><button id="category-close-btn" class="btn-secondary w-full">Fechar</button></div></div>
    <div id="rename-modal" class="modal-overlay hidden"><div class="modal-content" style="max-width: 400px;"><h2>Renomear</h2><form id="rename-form"><label>Antigo</label><select id="form-old-name" class="w-full mb-2"></select><label>Novo</label><input type="text" id="form-new-name" class="w-full mb-4"><div class="flex justify-end gap-2"><button type="button" id="rename-cancel-btn" class="btn-secondary">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div></form></div></div>
    <div id="archive-modal" class="modal-overlay hidden"><div class="modal-content" style="max-width: 400px;"><h2>Arquivar</h2><form id="archive-form"><div class="mb-4"><label><input type="radio" name="archive_period" value="7"> > 1 semana</label><br><label><input type="radio" name="archive_period" value="30" checked> > 1 mês</label><br><label><input type="radio" name="archive_period" value="90"> > 3 meses</label></div><div class="flex justify-between"><button type="button" id="view-archive-btn" class="btn-secondary">Ver Arquivo</button><div class="flex gap-2"><button type="button" id="archive-cancel-btn" class="btn-secondary">Cancelar</button><button type="submit" class="btn-primary">Arquivar</button></div></div></form></div></div>
    <div id="view-archive-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Arquivo Morto</h2><button id="view-archive-close-btn" style="position:absolute; top:10px; right:10px; font-size:1.5rem;">&times;</button><input type="text" id="archive-search-input" placeholder="Buscar..." class="w-full mb-4"><div id="view-archive-list-container" style="height: 300px; overflow-y: auto; background: #f8fafc; padding: 10px;"></div><button id="unarchive-selected-btn" class="btn-primary mt-4" disabled>Desarquivar Selecionadas</button></div></div>
    <div id="restore-confirm-modal" class="modal-overlay hidden"><div class="modal-content" style="max-width: 400px; text-align: center;"><h2 class="text-red">Atenção!</h2><p>Substituir dados atuais?</p><div class="flex justify-center gap-4 mt-4"><button id="restore-confirm-cancel-btn" class="btn-secondary">Cancelar</button><button id="restore-confirm-proceed-btn" class="btn-primary bg-red-100 text-red">Sim, Restaurar</button></div></div></div>
    <div id="notification-modal" class="modal-overlay hidden"><div class="modal-content" style="max-width: 300px; text-align: center;"><p id="notification-message" class="mb-4 text-lg"></p><button id="notification-close-btn" class="btn-primary">OK</button></div></div>

    <input type="file" id="restore-input" class="hidden" accept=".json">

    <!-- Script Lógico -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Dados
            let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
            let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
            let categories = JSON.parse(localStorage.getItem('monitoramentoCategorias')) || ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Outros'];

            tasks.forEach(t => { if (t.isExpanded === undefined) t.isExpanded = true; });

            const taskList = document.getElementById('task-list');

            // --- FUNÇÕES BÁSICAS ---
            const saveTasks = () => {
                localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            };
            const saveCategories = () => localStorage.setItem('monitoramentoCategorias', JSON.stringify(categories));

            const showNotification = (msg) => {
                document.getElementById('notification-message').textContent = msg;
                document.getElementById('notification-modal').classList.remove('hidden');
            };
            document.getElementById('notification-close-btn').addEventListener('click', () => document.getElementById('notification-modal').classList.add('hidden'));

            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('pt-BR');
            };
            
            const formatDateForInput = (date) => date.toISOString().split('T')[0];

            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            // --- RENDERIZAÇÃO ---
            const renderTasks = () => {
                const fCondo = document.getElementById('filtro-condominio').value.toLowerCase();
                const fData = document.getElementById('filtro-data').value;
                const fAnalise = document.getElementById('filtro-analise').value;
                const fSemana = document.getElementById('filtro-semana').value ? parseInt(document.getElementById('filtro-semana').value) : null;

                const filtered = tasks.filter(t => {
                    const matchC = t.condominio.toLowerCase().includes(fCondo);
                    const matchD = !fData || t.dataAnalise === fData;
                    const matchA = !fAnalise || t.statusAnalise === fAnalise;
                    let matchS = !fSemana;
                    if (fSemana && !fData) matchS = (t.semanaDeTrabalho === fSemana);
                    if (fData) matchS = true;
                    return matchC && matchD && matchA && matchS;
                });

                taskList.innerHTML = '';
                if (filtered.length === 0) {
                    taskList.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #64748b;">Nenhuma análise encontrada.</p>';
                    return;
                }

                filtered.forEach(t => {
                    const el = document.createElement('div');
                    let statusClass = 'pendente';
                    if (t.statusAnalise === 'Em Análise') statusClass = 'em-analise';
                    if (t.statusAnalise === 'Concluída') statusClass = 'concluida';

                    el.className = `card task-card ${statusClass}`;
                    
                    const isCollapsed = !t.isExpanded;
                    
                    let btnOc = '';
                    if (t.statusAnalise === 'Em Análise' || t.statusAnalise === 'Concluída') {
                        const txt = t.statusAnalise === 'Concluída' ? 'Ver / Editar Ocorrências' : 'Registrar Ocorrências';
                        btnOc = `<button class="btn-secondary w-full mt-2 open-oc-btn" data-id="${t.id}">${txt}</button>`;
                    }

                    let ocHtml = '';
                    if (t.ocorrencias && t.ocorrencias.length > 0) {
                        ocHtml = '<div style="margin-top: 10px; background: #fff1f2; padding: 5px; border-radius: 4px;">';
                        t.ocorrencias.forEach(oc => {
                            ocHtml += `<div style="font-size: 0.85rem; margin-bottom: 4px;"><span style="font-weight: bold; color: #991b1b;">${oc.categoria}:</span> ${oc.desc}</div>`;
                        });
                        ocHtml += '</div>';
                    }

                    el.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 style="margin: 0; font-size: 1.1rem;">${t.condominio}</h3>
                            <div>
                                <button class="archive-btn btn-danger" data-id="${t.id}">&#128450;</button>
                                <button class="delete-btn btn-danger" data-id="${t.id}">&times;</button>
                            </div>
                        </div>
                        <div class="flex justify-between mt-2 text-sm">
                            <span>Data: <strong>${formatDate(t.dataAnalise)}</strong></span>
                            <button class="toggle-btn btn-secondary" style="padding: 2px 8px;" data-id="${t.id}">${isCollapsed ? '&#9660;' : '&#9650;'}</button>
                        </div>
                        <div class="${isCollapsed ? 'hidden' : ''}" style="margin-top: 1rem;">
                            <div style="margin-bottom: 0.5rem;">
                                <label style="font-size: 0.8rem; font-weight: bold;">Backup:</label>
                                <select class="status-select w-full" data-id="${t.id}" data-type="backup">
                                    <option value="Pendente" ${t.statusBackup==='Pendente'?'selected':''}>Pendente</option>
                                    <option value="Em Andamento" ${t.statusBackup==='Em Andamento'?'selected':''}>Em Andamento</option>
                                    <option value="Concluído" ${t.statusBackup==='Concluído'?'selected':''}>Concluído</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; font-weight: bold;">Análise:</label>
                                <select class="status-select w-full" data-id="${t.id}" data-type="analise">
                                    <option value="Pendente" ${t.statusAnalise==='Pendente'?'selected':''}>Pendente</option>
                                    <option value="Em Análise" ${t.statusAnalise==='Em Análise'?'selected':''}>Em Análise</option>
                                    <option value="Concluída" ${t.statusAnalise==='Concluída'?'selected':''}>Concluída</option>
                                </select>
                            </div>
                            ${ocHtml}
                            ${btnOc}
                            ${t.statusAnalise === 'Concluída' && t.dataConclusao ? `<div class="text-green mt-2 text-sm text-right">Concluído em: ${formatDate(t.dataConclusao)}</div>` : ''}
                        </div>
                    `;
                    taskList.appendChild(el);
                });
            };

            const updateDashboard = () => {
                document.getElementById('total-solicitacoes').textContent = tasks.length;
                document.getElementById('backups-pendentes').textContent = tasks.filter(t => t.statusBackup === 'Pendente').length;
                document.getElementById('analises-pendentes').textContent = tasks.filter(t => t.statusAnalise === 'Pendente').length;
                
                const now = new Date();
                const day = now.getDay() || 7;
                const monday = new Date(now);
                monday.setDate(now.getDate() - day + 1);
                monday.setHours(0,0,0,0);
                const concluidasSemana = tasks.filter(t => t.dataConclusao && new Date(t.dataConclusao + 'T00:00:00') >= monday);
                const totalOc = concluidasSemana.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                document.getElementById('total-ocorrencias-semana').textContent = totalOc;
            };

            // --- GRÁFICOS SAFE ---
            let charts = {};
            const safeChart = (canvasId, config) => {
                if (typeof Chart === 'undefined') return;
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (charts[canvasId]) charts[canvasId].destroy();
                charts[canvasId] = new Chart(ctx, config);
            };

            // --- LISTENERS ---
            ['filtro-condominio', 'filtro-data', 'filtro-analise', 'filtro-semana'].forEach(id => document.getElementById(id).addEventListener('input', renderTasks));
            
            // Toggle Menu Ações
            document.getElementById('actions-menu-btn').addEventListener('click', () => {
                document.getElementById('actions-menu').classList.toggle('show');
            });
            window.onclick = (e) => {
                if (!e.target.matches('#actions-menu-btn')) {
                    const dropdowns = document.getElementsByClassName("dropdown-content");
                    for (let i = 0; i < dropdowns.length; i++) {
                        if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                    }
                }
            }

            // Botões Modais
            const openModal = (id) => document.getElementById(id).classList.remove('hidden');
            const closeModal = (id) => document.getElementById(id).classList.add('hidden');

            document.getElementById('add-task-btn').addEventListener('click', () => {
                document.getElementById('form-semana-trabalho').value = getWeekNumber(new Date());
                openModal('task-modal');
            });
            document.getElementById('cancel-btn').addEventListener('click', () => closeModal('task-modal'));
            
            document.getElementById('restore-btn').addEventListener('click', () => document.getElementById('restore-input').click());
            
            // Botões do Menu de Ações
            document.getElementById('priority-btn').addEventListener('click', () => {
                // Lógica simplificada de prioridades
                const list = document.getElementById('priority-task-list');
                list.innerHTML = '';
                const pending = tasks.filter(t => t.statusBackup === 'Pendente' || t.statusAnalise === 'Pendente')
                    .sort((a,b) => new Date(a.dataAnalise) - new Date(b.dataAnalise));
                
                pending.forEach(t => {
                    const li = document.createElement('li');
                    li.style.padding = "10px"; li.style.borderBottom = "1px solid #eee";
                    li.innerHTML = `<b>${t.condominio}</b> - ${formatDate(t.dataAnalise)}`;
                    list.appendChild(li);
                });
                openModal('priority-modal');
            });
            document.getElementById('priority-close-btn').addEventListener('click', () => closeModal('priority-modal'));

            document.getElementById('planner-btn').addEventListener('click', () => openModal('planner-modal'));
            document.getElementById('planner-cancel-btn').addEventListener('click', () => closeModal('planner-modal'));

            document.getElementById('period-analysis-btn').addEventListener('click', () => {
                // Reset charts logic here if needed
                openModal('period-analysis-modal');
            });
            document.getElementById('period-analysis-close-btn').addEventListener('click', () => closeModal('period-analysis-modal'));

            document.getElementById('annual-report-btn').addEventListener('click', () => openModal('annual-report-modal'));
            document.getElementById('annual-report-close-btn').addEventListener('click', () => closeModal('annual-report-modal'));

            document.getElementById('pdv-dashboard-btn').addEventListener('click', () => {
                // Populate select
                const sel = document.getElementById('pdv-select');
                sel.innerHTML = '<option>Selecione...</option>';
                [...new Set([...tasks, ...archivedTasks].map(t => t.condominio))].sort().forEach(c => sel.innerHTML += `<option>${c}</option>`);
                openModal('pdv-dashboard-modal');
            });
            document.getElementById('pdv-dashboard-close-btn').addEventListener('click', () => closeModal('pdv-dashboard-modal'));

            document.getElementById('bulk-add-btn').addEventListener('click', () => openModal('bulk-add-modal'));
            document.getElementById('bulk-cancel-btn').addEventListener('click', () => closeModal('bulk-add-modal'));

            document.getElementById('category-btn').addEventListener('click', () => {
                const list = document.getElementById('category-list-container');
                list.innerHTML = '';
                categories.forEach(c => list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee">${c}</div>`);
                openModal('category-modal');
            });
            document.getElementById('category-close-btn').addEventListener('click', () => closeModal('category-modal'));

            document.getElementById('rename-condo-btn').addEventListener('click', () => {
                const sel = document.getElementById('form-old-name');
                sel.innerHTML = '';
                [...new Set([...tasks, ...archivedTasks].map(t => t.condominio))].sort().forEach(c => sel.innerHTML += `<option>${c}</option>`);
                openModal('rename-modal');
            });
            document.getElementById('rename-cancel-btn').addEventListener('click', () => closeModal('rename-modal'));

            document.getElementById('archive-btn').addEventListener('click', () => openModal('archive-modal'));
            document.getElementById('archive-cancel-btn').addEventListener('click', () => closeModal('archive-modal'));
            document.getElementById('view-archive-btn').addEventListener('click', () => {
                const list = document.getElementById('view-archive-list-container');
                list.innerHTML = '';
                archivedTasks.forEach(t => list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee">${t.condominio} - ${formatDate(t.dataAnalise)} <button class="btn-secondary text-xs unarchive-btn" data-id="${t.id}">Recuperar</button></div>`);
                openModal('view-archive-modal');
            });
            document.getElementById('view-archive-close-btn').addEventListener('click', () => closeModal('view-archive-modal'));


            // Lógica dos Formulários (Simplificada para brevidade, mas funcional)
            document.getElementById('task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                tasks.push({
                    id: Date.now(),
                    condominio: document.getElementById('form-condominio').value,
                    dataAnalise: document.getElementById('form-data-analise').value,
                    semanaDeTrabalho: parseInt(document.getElementById('form-semana-trabalho').value),
                    statusBackup: 'Pendente', statusAnalise: 'Pendente', ocorrencia: 'Não', ocorrencias: [], isExpanded: true
                });
                saveTasks(); renderTasks(); updateDashboard(); closeModal('task-modal'); document.getElementById('task-form').reset();
            });

            // Listener global para botões dinâmicos
            taskList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = parseInt(target.dataset.id);
                const task = tasks.find(t => t.id === id);

                if (target.classList.contains('toggle-btn')) { if(task) { task.isExpanded = !task.isExpanded; saveTasks(); renderTasks(); } }
                if (target.classList.contains('delete-btn')) { if(confirm('Excluir?')) { tasks = tasks.filter(t => t.id !== id); saveTasks(); renderTasks(); updateDashboard(); } }
                if (target.classList.contains('archive-btn')) { 
                    const idx = tasks.findIndex(t => t.id === id);
                    if (idx > -1) { archivedTasks.push(tasks.splice(idx, 1)[0]); saveTasks(); renderTasks(); updateDashboard(); showNotification('Arquivado'); }
                }
                if (target.classList.contains('open-oc-btn')) {
                    const sel = document.getElementById('add-ocorrencia-categoria');
                    sel.innerHTML = '';
                    categories.forEach(c => sel.innerHTML += `<option>${c}</option>`);
                    document.getElementById('ocorrencia-task-id').value = id;
                    const list = document.getElementById('ocorrencia-list');
                    list.innerHTML = '';
                    if (task.ocorrencias) task.ocorrencias.forEach(oc => list.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px"><b>${oc.categoria}</b>: ${oc.desc}</div>`);
                    openModal('ocorrencia-modal');
                }
            });

            // Salvar Ocorrências
            document.getElementById('add-ocorrencia-btn').addEventListener('click', () => {
                const cat = document.getElementById('add-ocorrencia-categoria').value;
                const desc = document.getElementById('add-ocorrencia-desc').value;
                if(!desc) return;
                document.getElementById('ocorrencia-list').innerHTML += `<div class="new-item" data-cat="${cat}" data-desc="${desc}" style="background:#ecfdf5; padding:5px"><b>${cat}</b>: ${desc} (Novo)</div>`;
                document.getElementById('add-ocorrencia-desc').value = '';
            });

            document.getElementById('ocorrencia-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('ocorrencia-task-id').value);
                const task = tasks.find(t => t.id === id) || archivedTasks.find(t => t.id === id);
                if(task) {
                    document.querySelectorAll('.new-item').forEach(item => {
                        task.ocorrencias.push({ id: Date.now(), categoria: item.dataset.cat, desc: item.dataset.desc });
                    });
                    if(task.ocorrencias.length > 0) task.ocorrencia = 'Sim';
                    saveTasks(); renderTasks(); updateDashboard();
                }
                closeModal('ocorrencia-modal');
            });
            document.getElementById('ocorrencia-cancel-btn').addEventListener('click', () => closeModal('ocorrencia-modal'));

            // Gráficos
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('ocorrenciasChart').getContext('2d');
                new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: 'OCs', data: [] }] } }); // Placeholder init
            } else {
                document.getElementById('chart-error-msg').style.display = 'block';
            }

            // Inicializa
            renderTasks();
            updateDashboard();
        });
    </script>
</body>
</html>