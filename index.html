<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento - Modo Gestor</title>
    
    <!-- ================================================================== -->
    <!-- BIBLIOTECAS EXTERNAS -->
    <!-- ================================================================== -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configurações Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { orange: '#f26324', yellow: '#f7b41e', dark: '#1e293b' }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Ícones -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- ================================================================== -->
    <!-- ÁREA DE CSS (ESTILOS) -->
    <!-- ================================================================== -->
    <style>
        /* Transições Globais */
        body { transition: background-color 0.3s, color 0.3s; }
        
        /* Efeitos de Card */
        .card-transition { transition: transform 0.2s, box-shadow 0.2s; }
        .card-transition:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Containers de Gráficos */
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        
        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Animações */
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #f26324; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animação do Badge de Gestor */
        .manager-pulse { animation: managerPulse 2s infinite; }
        @keyframes managerPulse { 
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } 
        }

        /* Estilos de Impressão */
        @media print {
            body { background-color: white !important; color: black !important; }
            #login-view, nav, #toolbar-section, #actions-menu-container, button:not(.hidden), .no-print { display: none !important; }
            #dashboard-view, #view-monitoring, #view-reports, #report-content { display: block !important; }
            .card-transition { box-shadow: none !important; border: 1px solid #ccc !important; break-inside: avoid; }
            .chart-container { height: 250px !important; }
        }
        
        /* Classe de erro para inputs */
        .input-error { border-color: #ef4444 !important; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important; }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-slate-100 font-sans antialiased min-h-screen flex flex-col transition-colors duration-300 overflow-x-hidden">

    <!-- ================================================================== -->
    <!-- ÁREA DE HTML (ESTRUTURA) -->
    <!-- ================================================================== -->

    <!-- TELA DE LOGIN (PORTARIA) -->
    <section id="login-view" class="fixed inset-0 z-50 bg-slate-100 dark:bg-slate-900 flex flex-col items-center justify-center p-4 transition-opacity duration-500">
        <div class="absolute top-4 right-4 flex gap-2">
             <button onclick="App.openModalUI('cloud-config-modal')" class="text-slate-400 hover:text-brand-orange transition p-2" title="Configuração Técnica">
                <i class="ph ph-gear text-2xl"></i>
            </button>
        </div>

        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-brand-orange animate-fade-in flex flex-col">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 bg-orange-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-brand-orange text-3xl shadow-inner">
                    <i class="ph ph-user-focus"></i>
                </div>
            </div>
            
            <div class="text-center mb-6">
                <h1 class="text-2xl font-extrabold tracking-tight select-none text-brand-orange uppercase">
                    Painel de Monitoramento
                </h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Acesso Seguro</p>
            </div>

            <!-- FORMULÁRIO DE LOGIN -->
            <div id="login-form-container" class="space-y-4">
                <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg mb-4">
                    <button id="tab-login" class="flex-1 py-2 text-xs font-bold rounded-md bg-white dark:bg-slate-600 text-brand-orange shadow-sm transition-all" onclick="App.toggleAuthMode('login')">Entrar</button>
                    <button id="tab-register" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 transition-all" onclick="App.toggleAuthMode('register')">Primeiro Acesso</button>
                </div>

                <div id="auth-title" class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Acesso ao Sistema</div>

                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Nome Completo</label>
                    <div class="relative">
                        <i class="ph ph-user absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="text" id="login-username" class="w-full pl-10 pr-4 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition uppercase" placeholder="EX: LUIZ SILVA">
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label id="lbl-password" class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Sua Senha</label>
                    </div>
                    <div class="relative">
                        <i class="ph ph-lock absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="password" id="login-password" class="w-full pl-10 pr-4 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition" placeholder="••••••••">
                    </div>
                </div>

                <div id="auth-error-msg" class="hidden text-red-500 text-xs text-center bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-100 dark:border-red-800 flex items-center justify-center gap-2">
                    <i class="ph ph-warning-circle"></i> <span id="error-text-content">Erro ao autenticar.</span>
                </div>

                <button id="action-btn" type="button" class="w-full bg-brand-orange hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-orange-500/30 flex items-center justify-center gap-2">
                    Acessar Painel
                </button>
            </div>

            <div id="login-loading" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-3"></div>
                <p class="text-xs text-slate-400 animate-pulse">Validando acesso...</p>
            </div>

            <p class="mt-6 text-[10px] text-center text-slate-400 leading-relaxed">
                <span id="conn-status-icon" class="text-green-500 font-bold flex items-center justify-center gap-1"><i class="ph ph-shield-check"></i> Conexão Segura</span>
                <span id="system-status">Inicializando...</span>
            </p>
        </div>
    </section>

    <!-- PAINEL PRINCIPAL (DASHBOARD) -->
    <div id="dashboard-view" class="hidden flex-col min-h-screen w-full">
        
        <!-- Navbar -->
        <nav class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-40 border-b dark:border-slate-700">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="text-xl font-extrabold tracking-tight select-none flex items-center gap-1 cursor-pointer" onclick="window.location.reload()">
                        <i class="ph ph-video-camera text-brand-orange"></i>
                        <span class="hidden md:inline text-brand-orange">Painel de Monitoramento</span>
                    </div>
                    <span id="app-mode-badge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-bold uppercase tracking-wider flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 animate-pulse"></div> Conectando...
                    </span>
                    <!-- Botão Visão Global do Gestor -->
                    <button id="manager-global-btn" onclick="App.toggleManagerGlobalMode()" class="hidden ml-2 bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-1 hover:bg-purple-200 transition-all border border-purple-300">
                        <i class="ph ph-globe-hemisphere-west"></i> <span id="manager-btn-text">Minha Visão</span>
                    </button>
                </div>
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="text-right hidden lg:block mr-2">
                        <p class="text-xs text-slate-500 dark:text-slate-400 capitalize" id="current-date">...</p>
                    </div>
                    <button id="admin-panel-btn" onclick="App.openAdminPanel()" class="hidden bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-brand-orange p-2 rounded-lg transition relative" title="Painel do Administrador">
                        <i class="ph ph-lock-key text-lg"></i>
                        <div id="admin-indicator" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white dark:border-slate-800"></div>
                    </button>
                    <button onclick="App.openMyAccountModal()" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 hover:bg-brand-orange hover:text-white px-3 py-1.5 rounded-lg transition group">
                         <div class="hidden md:block leading-tight text-right">
                            <p class="text-[10px] uppercase font-bold opacity-70">Olá,</p>
                            <p id="user-display-name" class="text-xs font-bold uppercase truncate max-w-[100px]">Utilizador</p>
                        </div>
                        <div id="user-avatar" class="w-8 h-8 rounded-full bg-white text-brand-orange flex items-center justify-center font-bold text-sm border border-slate-200 dark:border-slate-600 shadow-sm group-hover:text-brand-orange">U</div>
                    </button>
                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                    <button id="theme-toggle" class="hidden md:flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                        <i class="ph ph-sun"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- BANNER DE ERRO DE CONEXÃO -->
        <div id="db-error-banner" class="hidden bg-red-500 text-white p-4 text-center shadow-lg">
            <p class="font-bold flex items-center justify-center gap-2">
                <i class="ph ph-warning-circle text-xl"></i>
                Acesso ao Banco de Dados Bloqueado!
            </p>
            <p class="text-xs mt-1 opacity-90">Verifique a conexão de internet ou permissões.</p>
            <button onclick="window.location.reload()" class="mt-2 bg-white text-red-500 px-4 py-1 rounded text-xs font-bold hover:bg-slate-100 transition">
                Tentar Novamente
            </button>
        </div>
        
        <!-- BANNER MODO GESTOR -->
        <div id="manager-banner" class="hidden bg-purple-600 text-white py-2 px-4 text-center shadow-md animate-fade-in sticky top-[60px] z-30">
            <p class="text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2">
                <i class="ph ph-eye text-lg"></i> Modo Gestor Ativo: Visualizando dados de toda a equipe
            </p>
        </div>

        <!-- CONTEÚDO PRINCIPAL -->
        <div class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow animate-fade-in flex flex-col">
            
            <!-- HEADER DA PÁGINA COM ABAS -->
            <header class="mb-6">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Painel de Monitoramento</h1>
                        <p id="welcome-msg" class="text-slate-600 dark:text-slate-400 mt-1 text-sm">Gerencie as suas ocorrências com segurança.</p>
                    </div>
                    <div id="sync-status" class="text-xs font-mono text-slate-400 flex items-center gap-1 hidden">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="sync-text" class="hidden md:inline">Sincronizando...</span>
                    </div>
                </div>

                <!-- MENU DE ABAS -->
                <div class="mt-6 flex gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg w-full md:w-auto inline-flex overflow-x-auto no-print">
                    <button onclick="App.switchMainView('monitoring')" id="btn-view-monitoring" class="flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all bg-white dark:bg-slate-600 text-brand-orange shadow-sm flex items-center gap-2 justify-center whitespace-nowrap">
                        <i class="ph ph-video-camera"></i> Monitoramento
                    </button>
                    <button onclick="App.switchMainView('productivity')" id="btn-view-productivity" class="flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white flex items-center gap-2 justify-center whitespace-nowrap">
                        <i class="ph ph-chart-line-up"></i> Produtividade
                    </button>
                    <button onclick="App.switchMainView('reports')" id="btn-view-reports" class="flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white flex items-center gap-2 justify-center whitespace-nowrap">
                        <i class="ph ph-file-text"></i> Relatórios
                    </button>
                </div>
            </header>

            <!-- VIEW: MONITORAMENTO -->
            <div id="view-monitoring" class="flex flex-col gap-6">
                <!-- KPIs -->
                <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-4">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Ativas</h3>
                        <p id="total-solicitacoes" class="text-3xl font-bold text-slate-800 dark:text-white">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-amber-600 dark:text-amber-500">Backups Pend.</h3>
                        <p id="backups-pendentes" class="text-3xl font-bold text-amber-500">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-emerald-600 dark:text-emerald-400">Quantidade de Dias Visualizados</h3>
                        <p id="analises-concluidas" class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">0</p>
                        <p class="text-xs text-slate-400 text-right">Estatística Semanal</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-blue-600 dark:text-blue-400">Quantidade de PDVs visualizados</h3>
                        <p id="total-pdvs" class="text-3xl font-bold text-blue-500">0</p>
                        <p class="text-xs text-slate-400 text-right">Únicos na Semana</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-red-600 dark:text-red-400">Ocorrências</h3>
                        <p id="total-ocorrencias-semana" class="text-3xl font-bold text-red-500">0</p>
                        <p class="text-xs text-slate-400 text-right">Estatística Semanal</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-purple-600 dark:text-purple-400">Média (Oc/Análise)</h3>
                        <p id="media-ocorrencias" class="text-3xl font-bold text-purple-500">0.0</p>
                        <p class="text-xs text-slate-400 text-right">Por Concluída</p>
                    </div>
                </section>

                <!-- Toolbar -->
                <section id="toolbar-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-4 border border-slate-100 dark:border-slate-700">
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                            <input type="text" id="filtro-condominio" placeholder="Buscar condomínio..." class="pl-3 w-full lg:w-64 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition">
                            <select id="filtro-analise" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                                <option value="">Status Análise: Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Em Análise">Em Análise</option>
                                <option value="Concluída">Concluída</option>
                            </select>
                            <select id="filtro-backup" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                                <option value="">Status Backup: Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluído">Concluído</option>
                            </select>
                            <input type="text" id="filtro-usuario" placeholder="Filtrar por usuário..." class="hidden pl-3 w-full lg:w-48 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-purple-500 outline-none transition">
                        </div>
                        <div class="flex items-center gap-3 w-full lg:w-auto justify-end">
                            <button id="add-task-btn" class="bg-brand-orange hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2 shadow-lg shadow-orange-500/20">
                                <i class="ph ph-plus-circle text-lg"></i> Nova Análise
                            </button>
                            
                            <div class="relative" id="actions-menu-container">
                                <button id="actions-menu-btn" class="bg-slate-100 dark:bg-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-white flex items-center gap-2 transition-colors">
                                    Ações <i class="ph ph-caret-down"></i>
                                </button>
                                <div id="actions-menu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-100 dark:border-slate-700 z-50 overflow-hidden">
                                    <div class="border-t border-slate-100 dark:border-slate-700 my-0"></div>
                                    <button id="excel-import-btn" onclick="App.openImport(event)" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-200 transition-colors">
                                        <i class="ph ph-file-csv text-lg text-green-600"></i> Importar (Excel)
                                    </button>
                                    <button id="archive-btn" onclick="App.openArchive(event)" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                        <i class="ph ph-archive-box text-lg text-purple-500"></i> Arquivo Morto
                                    </button>
                                    <div class="border-t border-slate-100 dark:border-slate-700 my-0"></div>
                                    <button id="export-data-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                        <i class="ph ph-download-simple text-lg text-slate-500"></i> Backup Local (JSON)
                                    </button>
                                    <button id="import-data-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                        <i class="ph ph-upload-simple text-lg text-slate-500"></i> Restaurar Backup (JSON)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Lista de Tarefas -->
                <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- JS preenche aqui -->
                </main>
                
                <!-- Gráficos -->
                <section class="mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h2 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="ph ph-map-pin"></i> Ocorrências por Local</h2>
                        <div class="chart-container"><canvas id="ocorrenciasChart"></canvas></div>
                    </div>
                </section>
            </div>

            <!-- VIEW: PRODUTIVIDADE (NOVA VERSÃO) -->
            <div id="view-productivity" class="hidden flex-col gap-6 animate-fade-in">
                <!-- TOTAIS GERAIS -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                        <h3 class="text-xs font-bold uppercase text-blue-600 dark:text-blue-400 mb-1">Dias Visualizados</h3>
                        <p id="prod-total-dias" class="text-3xl font-extrabold text-slate-800 dark:text-white">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                        <h3 class="text-xs font-bold uppercase text-brand-orange mb-1">PDVs Analisados</h3>
                        <p id="prod-total-pdvs" class="text-3xl font-extrabold text-slate-800 dark:text-white">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                        <h3 class="text-xs font-bold uppercase text-red-600 dark:text-red-400 mb-1">Ocorrências</h3>
                        <p id="prod-total-oc" class="text-3xl font-extrabold text-slate-800 dark:text-white">0</p>
                    </div>
                </div>

                <!-- LISTA DE REGISTROS -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold dark:text-white flex items-center gap-2">
                            <i class="ph ph-table"></i> Registros Manuais
                        </h2>
                        <button onclick="App.openProductivityModal()" class="bg-brand-orange hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2 shadow-lg shadow-orange-500/20">
                            <i class="ph ph-plus"></i> Novo Registro
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-300">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Referência</th>
                                    <th scope="col" class="px-6 py-3 text-center">Dias</th>
                                    <th scope="col" class="px-6 py-3 text-center">PDVs</th>
                                    <th scope="col" class="px-6 py-3 text-center">Ocorrências</th>
                                    <th scope="col" class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="productivity-table-body">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                        <div id="productivity-empty-state" class="hidden text-center py-8 text-slate-400 text-xs">
                            Nenhum registro encontrado. Adicione dados manualmente.
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RELATÓRIOS -->
            <div id="view-reports" class="hidden flex-col gap-6 animate-fade-in">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-4 flex flex-col md:flex-row gap-4 items-center justify-between no-print">
                    <div>
                        <h2 class="text-lg font-bold dark:text-white flex items-center gap-2"><i class="ph ph-files text-brand-orange"></i> Relatórios Detalhados</h2>
                        <p class="text-xs text-slate-500">Análise profunda por PDV/Condomínio</p>
                    </div>
                    <div class="w-full md:w-72">
                        <select id="report-condo-select" onchange="App.generateReport(this.value)" class="w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                            <option value="">Selecione um Condomínio...</option>
                        </select>
                    </div>
                </div>

                <!-- Conteúdo do Relatório -->
                <div id="report-content" class="hidden flex-col gap-6">
                    <div class="flex justify-center mb-4">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700 text-center w-full max-w-md">
                            <h3 class="text-sm font-bold uppercase text-slate-500 dark:text-slate-400 mb-2">Total de Ocorrências</h3>
                            <p id="rep-total-oc" class="text-5xl font-extrabold text-red-600 dark:text-red-500">0</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <div class="chart-container h-80">
                            <canvas id="reportDayChart"></canvas>
                        </div>
                    </div>
                </div>
                <div id="report-empty" class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="ph ph-magnifying-glass text-6xl mb-4 opacity-20"></i>
                    <p class="text-sm">Selecione um condomínio acima para gerar o relatório.</p>
                </div>
            </div>

            <footer class="text-center text-xs text-slate-400 py-4 mt-auto border-t dark:border-slate-700 no-print">
                <p id="footer-msg"><i class="ph ph-hard-drives"></i> Modo Seguro.</p>
                <p class="mt-1">© 2025 Painel de Monitoramento - vGestor 4.0</p>
            </footer>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- MODAIS E COMPONENTES AUXILIARES -->
    <!-- ================================================================== -->

    <!-- Novo Modal de Produtividade -->
    <div id="productivity-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[80]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm border dark:border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 dark:text-white" id="prod-modal-title">Novo Registro</h2>
            <form id="prod-form" onsubmit="event.preventDefault(); App.saveProductivity();">
                <input type="hidden" id="prod-id">
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Referência (Data/Semana)</label>
                        <input type="text" id="prod-ref" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Ex: Semana 42 ou 10/10/2025" required>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Dias</label>
                            <input type="number" id="prod-dias" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">PDVs</label>
                            <input type="number" id="prod-pdvs" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Ocorrências</label>
                            <input type="number" id="prod-ocs" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="0">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="App.closeModalUI('productivity-modal')" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white hover:bg-slate-300 transition-colors text-sm font-bold">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-brand-orange text-white font-bold hover:bg-orange-700 transition-colors text-sm shadow-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="excel-import-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl border dark:border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-2 dark:text-white">Importar Dados (Excel)</h2>
            <p class="text-xs text-slate-500 mb-4">Cole as linhas do Excel aqui para importar em massa (Formato: Condomínio | Data | Obs).</p>
            <textarea id="excel-paste-area" rows="10" class="w-full p-3 text-sm font-mono bg-slate-100 dark:bg-slate-900 border rounded dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Exemplo:
Condomínio A	2025-10-01	Observação 1
Condomínio B	2025-10-02	Observação 2"></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="App.closeModalUI('excel-import-modal')" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white transition-colors">Cancelar</button>
                <button id="process-import-btn" class="px-4 py-2 rounded bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition-colors">Processar Dados</button>
            </div>
        </div>
    </div>
    
    <div id="archive-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[75]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl border dark:border-slate-700">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-2">
                <div class="flex items-center gap-3">
                    <h2 class="text-2xl font-bold dark:text-white flex items-center gap-2">
                        <i class="ph ph-archive-box"></i> Arquivo Morto
                        <span id="archive-count-badge" class="text-sm bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-white px-2 py-0.5 rounded-full ml-2">0</span>
                    </h2>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.recoverLostData()" class="text-xs font-bold text-blue-500 hover:text-white hover:bg-blue-500 border border-blue-500 px-3 py-1.5 rounded transition-all flex items-center gap-1 shadow-sm" title="Buscar em backups locais">
                        <i class="ph ph-magnifying-glass"></i> Cofre de Segurança
                    </button>
                    <button onclick="App.closeModalUI('archive-modal')" class="text-2xl text-slate-400 hover:text-slate-600 ml-2">&times;</button>
                </div>
            </div>
            
            <input type="text" id="archive-search" placeholder="Pesquisar no arquivo..." class="mb-3 w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white outline-none focus:ring-2 focus:ring-brand-orange">
            <div id="archive-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
        </div>
    </div>

    <div id="recovery-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[90]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl border-2 border-blue-500 dark:border-blue-700">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-2">
                <h2 class="text-xl font-bold dark:text-white flex items-center gap-2 text-blue-600 dark:text-blue-400">
                    <i class="ph ph-shield-check text-2xl"></i> Cofre de Segurança (Backup Local)
                </h2>
                <button onclick="App.closeModalUI('recovery-modal')" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg mb-4 text-xs text-blue-800 dark:text-blue-200 border border-blue-100 dark:border-blue-800">
                <i class="ph ph-info"></i> Estes itens foram encontrados nos backups internos do seu navegador. Se algo sumiu, provavelmente está aqui.
            </div>
            <input type="text" id="recovery-search" placeholder="Pesquisar no cofre (Nome do condomínio...)" class="mb-3 w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
            <div id="recovery-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
        </div>
    </div>

    <div id="my-account-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm border dark:border-slate-700 shadow-2xl">
             <div class="flex justify-between items-start mb-4">
                 <div>
                     <h2 class="text-lg font-bold dark:text-white">Minha Conta</h2>
                     <p id="account-modal-name" class="text-sm text-slate-500 uppercase"></p>
                 </div>
                 <div class="w-10 h-10 rounded-full bg-brand-orange text-white flex items-center justify-center font-bold text-lg">U</div>
             </div>
             <div class="space-y-2">
                 <button onclick="App.openChangePasswordModal()" class="w-full flex items-center gap-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 transition text-slate-700 dark:text-white">
                     <i class="ph ph-key"></i> Alterar Senha
                 </button>
                 <button onclick="App.logout()" class="w-full flex items-center gap-3 p-3 rounded-lg bg-red-50 dark:bg-red-900/10 hover:bg-red-100 dark:hover:bg-red-900/20 transition text-red-600">
                     <i class="ph ph-sign-out"></i> Sair do Sistema
                 </button>
             </div>
             <button onclick="document.getElementById('my-account-modal').classList.add('hidden')" class="w-full mt-4 py-2 text-xs text-slate-400 hover:text-slate-600">Fechar</button>
        </div>
    </div>
    
    <div id="admin-panel-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl border dark:border-slate-700 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-4">
                <h2 class="text-xl font-bold dark:text-white flex items-center gap-2"><i class="ph ph-users-three text-brand-orange"></i> Gestão de Equipe</h2>
                <button onclick="document.getElementById('admin-panel-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 text-2xl transition">&times;</button>
            </div>
            <div class="mb-6 bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border border-slate-200 dark:border-slate-600">
                <h3 class="text-sm font-bold text-slate-700 dark:text-white mb-3 flex items-center gap-2"><i class="ph ph-user-plus text-blue-500"></i> Autorizar Novo Acesso</h3>
                <div class="flex flex-col gap-2">
                    <input type="text" id="new-user-name" class="w-full p-3 rounded border dark:bg-slate-800 dark:border-slate-600 dark:text-white text-sm uppercase focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome Completo do Funcionário">
                    <button onclick="App.authorizeNewUser()" class="bg-blue-600 text-white py-2.5 rounded text-sm font-bold hover:bg-blue-700 transition shadow-sm">
                        Autorizar Cadastro
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto pr-1">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">Equipe Autorizada</h3>
                <ul id="admin-users-list" class="space-y-2 text-sm"></ul>
            </div>
        </div>
    </div>

    <!-- Outros modais essenciais (Delete, Senha, Cloud, Task, Ocorrencia) -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[80]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm border border-red-200 dark:border-red-900 shadow-2xl text-center">
             <h2 class="text-lg font-bold dark:text-white mb-2">Excluir Análise?</h2>
             <div class="flex gap-2 justify-center mt-4">
                 <button onclick="App.closeModalUI('delete-confirmation-modal')" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white font-bold text-sm transition-colors">Cancelar</button>
                 <button onclick="App.confirmDeleteTask()" class="px-4 py-2 rounded bg-red-500 text-white font-bold text-sm hover:bg-red-600 shadow-lg transition-colors">Sim, Excluir</button>
             </div>
        </div>
    </div>

    <div id="change-password-modal" class="hidden fixed inset-0 bg-black/60 z-[65] flex items-center justify-center p-4">
         <div class="bg-white dark:bg-slate-800 p-6 rounded-xl w-full max-w-sm shadow-xl">
             <h2 class="font-bold mb-4 dark:text-white">Nova Senha</h2>
             <input type="password" id="new-password-input" class="w-full border p-2 rounded mb-4 dark:bg-slate-700 dark:text-white" placeholder="Digite a nova senha">
             <button onclick="App.changeUserPassword()" class="w-full bg-brand-orange text-white py-2 rounded font-bold">Salvar</button>
             <button onclick="document.getElementById('change-password-modal').classList.add('hidden')" class="w-full mt-2 text-slate-500 text-xs">Cancelar</button>
         </div>
    </div>

    <div id="cloud-config-modal" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl w-full max-w-lg shadow-xl">
            <h2 class="font-bold mb-2 dark:text-white">Configuração</h2>
            <textarea id="firebase-config-input" class="w-full h-32 text-xs bg-slate-100 p-2 mb-4" readonly>Configuração interna ativa.</textarea>
            <button onclick="document.getElementById('cloud-config-modal').classList.add('hidden')" class="text-slate-500 text-sm">Fechar</button>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md border dark:border-slate-700 shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 dark:text-white" id="task-modal-title">Nova Análise</h2>
            <form id="task-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Condomínio</label>
                    <input type="text" id="form-condominio" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Data</label>
                    <input type="date" id="form-data-analise" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Semana (Opcional)</label>
                    <input type="text" id="form-semana" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Ex: Semana 47">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Observações</label>
                    <textarea id="form-observacoes" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-brand-orange text-white font-bold hover:bg-orange-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ocorrencia-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl h-[90vh] flex flex-col border dark:border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-white">Ocorrências: <span id="modal-condo-name" class="text-brand-orange"></span></h2>
                <button id="ocorrencia-cancel-btn" class="text-slate-400 hover:text-red-500 text-2xl transition-colors">&times;</button>
            </div>
            <div id="ocorrencia-list" class="flex-grow overflow-y-auto mb-4 space-y-2 p-2 bg-slate-50 dark:bg-slate-900 rounded border dark:border-slate-700 shadow-inner"></div>
            <div class="pt-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2">
                    <select id="add-ocorrencia-categoria" class="md:col-span-4 border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none"></select>
                    <input type="text" id="add-ocorrencia-desc" placeholder="Descrição da ocorrência..." class="md:col-span-8 border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">Início</label>
                        <input type="time" id="add-horario-inicial" step="1" class="border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none">
                    </div>
                    <div class="flex flex-col">
                         <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">Fim</label>
                         <input type="time" id="add-horario-final" step="1" class="border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" onclick="App.addOccurrence()" id="add-ocorrencia-btn" class="flex-1 bg-orange-100 text-brand-orange font-bold py-2 rounded hover:bg-orange-200 transition-colors border border-orange-200">+ Adicionar Item</button>
                    <button type="button" onclick="App.saveAndCloseOcorrencias()" id="save-ocorrencias-btn" class="flex-1 bg-brand-orange text-white font-bold py-2 rounded hover:bg-orange-700 transition-colors shadow-lg shadow-orange-500/20">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notificação -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center gap-2">
        <i class="ph ph-check-circle text-green-400 text-xl"></i>
        <span id="toast-msg">Ação realizada</span>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".json">
    <input type="hidden" id="ocorrencia-current-task-id">

    <!-- ================================================================== -->
    <!-- ÁREA DE JAVASCRIPT (LÓGICA) -->
    <!-- ================================================================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, deleteDoc, collection, getDocs, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração segura (obtida do ambiente)
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Variáveis globais
        let auth, db, appFirebase;

        const App = {
            data: {
                tasks: [],
                archived: [],
                productivity: [],
                categories: ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Defeito Técnico', 'Procedimento Incorreto', 'Outros'],
                authMode: 'login',
                currentView: 'monitoring',
                user: null,
                isLoading: false,
                adminEmail: 'alisson.cambui@vendperto.local',
                isManagerMode: false,
                globalTasks: [],
                unsubscribeGlobal: null,
                unsubscribePersonal: null,
                editingId: null,
                pendingDeleteId: null,
                editingTaskId: null,
                recoveryList: []
            },
            charts: {},
            statusColors: {
                'Pendente': 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-400',
                'Em Andamento': 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-400',
                'Em Análise': 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-400',
                'Concluído': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400',
                'Concluída': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400',
            },

            // --- INIT ---
            async init() {
                this.setupTheme();
                this.setupDate();
                this.setupEvents();
                
                const savedUser = localStorage.getItem('mon_user');
                if (savedUser) {
                    try {
                        this.data.user = JSON.parse(savedUser);
                        if (this.data.user.name === 'ALISSON CAMBUI' || this.data.user.email === this.data.adminEmail || this.data.user.name === 'GESTOR') this.data.user.isAdmin = true;
                        this.updateUserInfo(this.data.user);
                        this.toggleAuthMode('login'); 
                        this.switchToDashboardView();
                    } catch(e) { console.error(e); localStorage.removeItem('mon_user'); }
                }

                await this.initFirebase();
                if (!this.data.user) this.toggleAuthMode('login');
                
                // Inicializa gráficos com delay para garantir que o DOM renderizou
                setTimeout(() => this.setupCharts(), 500);
            },

            // Função Segura para Gerar IDs
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            // --- FIREBASE CORE ---
            async initFirebase() {
                try {
                    appFirebase = initializeApp(firebaseConfig);
                    auth = getAuth(appFirebase);
                    db = getFirestore(appFirebase);

                    // Tentar habilitar persistência (cache)
                    try {
                        await enableIndexedDbPersistence(db);
                        console.log("Persistência offline ativada.");
                    } catch (err) {
                        // Ignora erros de persistência (ex: abas duplicadas)
                    }

                    // Autenticação Robusta
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch(e) {
                            console.warn("Token falhou, usando anônimo", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                         await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user && this.data.user && this.data.user.uid && !this.data.isManagerMode) { 
                            this.subscribeToUserData(this.data.user.uid); 
                            document.getElementById('system-status').textContent = "Conectado";
                        }
                    });

                } catch(e) { 
                    console.error("Falha Firebase", e);
                    const errorDiv = document.getElementById('auth-error-msg');
                    const errorText = document.getElementById('error-text-content');
                    if (errorDiv) {
                        errorDiv.classList.remove('hidden');
                        errorText.textContent = "Erro de conexão: " + e.message;
                    }
                }
            },
            
            // --- HELPER FUNCTIONS ---
            formatDate(d) {
                if (!d) return '-';
                try {
                    const [y, m, day] = d.split('-');
                    return `${day}/${m}`;
                } catch (e) { return d; }
            },

            showToast(msg, isError = false) {
                const t = document.getElementById('toast');
                const tm = document.getElementById('toast-msg');
                const icon = t.querySelector('i');
                
                if (t && tm) {
                    tm.textContent = msg;
                    if (isError) {
                        icon.className = "ph ph-warning-circle text-red-400 text-xl";
                    } else {
                        icon.className = "ph ph-check-circle text-green-400 text-xl";
                    }
                    
                    t.classList.remove('opacity-0', 'translate-y-20');
                    setTimeout(() => t.classList.add('opacity-0', 'translate-y-20'), 3000);
                }
            },

            // --- LÓGICA DE GESTÃO ---
            toggleManagerGlobalMode() {
                if (!this.data.user || !this.data.user.isAdmin) return alert("Acesso restrito.");
                
                this.data.isManagerMode = !this.data.isManagerMode;
                const btn = document.getElementById('manager-global-btn');
                const btnText = document.getElementById('manager-btn-text');
                const banner = document.getElementById('manager-banner');
                const userFilter = document.getElementById('filtro-usuario');
                
                if (this.data.isManagerMode) {
                    btn.className = "ml-2 bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-1 hover:bg-purple-700 transition-all shadow-lg manager-pulse";
                    btnText.textContent = "Visão Global Ativa";
                    banner.classList.remove('hidden');
                    userFilter.classList.remove('hidden');
                    
                    if(this.data.unsubscribePersonal) this.data.unsubscribePersonal();
                    this.subscribeToGlobalData();
                } else {
                    btn.className = "ml-2 bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-1 hover:bg-purple-200 transition-all border border-purple-300";
                    btnText.textContent = "Visão Gestor";
                    banner.classList.add('hidden');
                    userFilter.classList.add('hidden');
                    userFilter.value = '';
                    
                    if(this.data.unsubscribeGlobal) this.data.unsubscribeGlobal();
                    this.data.globalTasks = [];
                    this.subscribeToUserData(this.data.user.uid);
                }
            },

            subscribeToGlobalData() {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_records');
                this.data.unsubscribeGlobal = onSnapshot(colRef, (snapshot) => {
                    let allTasks = [];
                    let allArchived = [];
                    
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        let ownerName = "Usuário";
                        if(d.ownerEmail) ownerName = d.ownerEmail.split('@')[0].replace('.', ' ').toUpperCase();
                        
                        if(d.tasks) {
                            const userTasks = d.tasks.map(t => ({...t, _ownerName: ownerName, _ownerUid: doc.id.replace('app_user_data_', '')}));
                            allTasks = [...allTasks, ...userTasks];
                        }
                        if(d.archived) {
                             const userArchived = d.archived.map(t => ({...t, _ownerName: ownerName, _ownerUid: doc.id.replace('app_user_data_', '')}));
                             allArchived = [...allArchived, ...userArchived];
                        }
                    });

                    this.data.tasks = allTasks;
                    this.data.archived = allArchived;
                    this.render();
                    this.updateCharts();
                });
            },

            async saveData() {
                if (this.data.isManagerMode) {
                    await this.saveAsManager();
                    return;
                }

                 const cleanTasks = JSON.parse(JSON.stringify(this.data.tasks));
                 const cleanArchived = JSON.parse(JSON.stringify(this.data.archived));
                 const cleanProd = JSON.parse(JSON.stringify(this.data.productivity || [])); 
                 
                 if (cleanTasks.length > 0 || cleanArchived.length > 0) {
                     localStorage.setItem('mon_safe_backup', JSON.stringify({t: cleanTasks, a: cleanArchived}));
                 }

                 if (this.data.user && auth.currentUser) {
                    try {
                        const safeId = this.data.user.uid;
                        const dataRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_records', 'app_user_data_' + safeId);
                        await setDoc(dataRef, { 
                            tasks: cleanTasks, archived: cleanArchived, 
                            productivity: cleanProd, lastUpdate: new Date().toISOString(), ownerEmail: this.data.user.email 
                        }, { merge: true });
                    } catch(e) { console.error("Erro save cloud", e); }
                 }
                 this.render(); 
                 this.updateCharts();
            },

            async saveAsManager() {
                const tasksByOwner = {};
                this.data.tasks.forEach(t => {
                    const uid = t._ownerUid || this.data.user.uid; 
                    if(!tasksByOwner[uid]) tasksByOwner[uid] = [];
                    const cleanTask = {...t};
                    delete cleanTask._ownerName;
                    delete cleanTask._ownerUid;
                    tasksByOwner[uid].push(cleanTask);
                });

                for (const uid of Object.keys(tasksByOwner)) {
                    try {
                        const dataRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_records', 'app_user_data_' + uid);
                        await setDoc(dataRef, { tasks: tasksByOwner[uid], lastUpdate: new Date().toISOString() }, { merge: true });
                    } catch(e) { console.error("Erro ao salvar dados do usuário " + uid, e); }
                }
                this.showToast('Dados globais sincronizados.');
                this.render();
            },

            setupTheme() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            setupDate() {
                const dateEl = document.getElementById('current-date');
                if (dateEl) {
                    dateEl.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                }
            },

            setupCharts() {
                 if (typeof Chart === 'undefined') return; 
                 const isDark = document.documentElement.classList.contains('dark');
                 Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
                 Chart.defaults.font.family = "'Inter', sans-serif";
                 Chart.defaults.scale.grid.color = isDark ? '#334155' : '#e2e8f0'; 
                 Chart.defaults.scale.grid.borderColor = 'transparent'; 

                 // Gráfico Principal
                 const c1 = document.getElementById('ocorrenciasChart');
                 if(c1) {
                     if(this.charts.oc) this.charts.oc.destroy();
                     const ctx1 = c1.getContext('2d');
                     this.charts.oc = new Chart(ctx1, { 
                        type: 'bar', 
                        data: { labels:[], datasets:[{ label: 'Ocorrências', data:[], backgroundColor: '#f97316', borderRadius: 4 }] }, 
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
                     });
                 }
                 
                 // Gráfico de Relatório
                 const c2 = document.getElementById('reportDayChart');
                 if(c2) {
                     if(this.charts.report) this.charts.report.destroy();
                     const ctx2 = c2.getContext('2d');
                     this.charts.report = new Chart(ctx2, {
                        type: 'line',
                        data: { labels: [], datasets: [{ label: 'Ocorrências por Dia', data: [], borderColor: '#f26324', tension: 0.3, fill: true, backgroundColor: 'rgba(242, 99, 36, 0.1)' }] }, 
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                     });
                 }
                 this.updateCharts();
            },

            updateCharts() {
                // Atualiza Gráfico Principal
                if (this.charts.oc && this.data.tasks) {
                    const counts = {};
                    this.data.tasks.forEach(t => {
                        const qtd = t.ocorrencias ? t.ocorrencias.length : 0;
                        if(qtd > 0) counts[t.condominio] = (counts[t.condominio] || 0) + qtd;
                    });
                    
                    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                    this.charts.oc.data.labels = sorted.map(i => i[0]);
                    this.charts.oc.data.datasets[0].data = sorted.map(i => i[1]);
                    this.charts.oc.update();
                }
            },
            
            setupEvents() {
                const addListener = (id, event, handler) => { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); };
                
                ['filtro-condominio', 'filtro-backup', 'filtro-analise', 'filtro-usuario'].forEach(id => addListener(id, 'input', () => App.render()));
                
                addListener('add-task-btn', 'click', () => { 
                    App.data.editingTaskId = null;
                    document.getElementById('task-modal-title').textContent = "Nova Análise";
                    document.getElementById('task-form').reset(); 
                    document.getElementById('form-data-analise').value = new Date().toISOString().split('T')[0];
                    App.openModalUI('task-modal'); 
                });
                addListener('cancel-btn', 'click', () => App.closeModalUI('task-modal'));
                addListener('task-form', 'submit', (e) => { 
                    e.preventDefault(); 
                    App.saveTaskFromForm();
                });
                
                addListener('actions-menu-btn', 'click', (e) => { e.stopPropagation(); document.getElementById('actions-menu').classList.toggle('hidden'); });
                document.body.addEventListener('click', () => { const m = document.getElementById('actions-menu'); if(m) m.classList.add('hidden'); });
                
                addListener('excel-import-btn', 'click', () => { App.openModalUI('excel-import-modal'); });
                addListener('process-import-btn', 'click', () => App.processExcel());
                
                addListener('archive-search', 'input', () => App.renderArchiveList());
                addListener('recovery-search', 'input', () => App.renderRecoveryList());

                addListener('export-data-btn', 'click', () => App.exportData());
                addListener('import-data-btn', 'click', () => document.getElementById('file-input').click());
                addListener('file-input', 'change', (e) => { 
                    if(e.target.files[0]) { 
                        const r = new FileReader(); 
                        r.onload = ev => { 
                            try {
                                const j = JSON.parse(ev.target.result); 
                                App.data.tasks=j.tasks||[]; 
                                App.data.archived=j.archived||[]; 
                                if(j.productivity) App.data.productivity = j.productivity;
                                App.saveData(); 
                                App.showToast('Restaurado'); 
                                setTimeout(()=>window.location.reload(), 500); 
                            } catch(e) { alert("Erro ao ler arquivo."); }
                        }; 
                        r.readAsText(e.target.files[0]); 
                    } 
                });
                
                addListener('ocorrencia-cancel-btn', 'click', () => { App.closeModalUI('ocorrencia-modal'); App.resetOcorrenciaForm(); });

                addListener('theme-toggle', 'click', () => { 
                    document.documentElement.classList.toggle('dark'); 
                    localStorage.theme = document.documentElement.classList.contains('dark')?'dark':'light'; 
                    App.setupCharts();
                });
            },

            // --- RESTORED FUNCTIONS ---
            switchMainView(viewName) {
                this.data.currentView = viewName;
                const views = ['monitoring', 'productivity', 'reports'];
                views.forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    const btn = document.getElementById(`btn-view-${v}`);
                    if(viewName === v) {
                        el.classList.remove('hidden'); el.classList.add('flex');
                        btn.classList.add('bg-white', 'dark:bg-slate-600', 'text-brand-orange', 'shadow-sm');
                        btn.classList.remove('text-slate-500', 'dark:text-slate-400');
                    } else {
                        el.classList.add('hidden'); el.classList.remove('flex');
                        btn.classList.remove('bg-white', 'dark:bg-slate-600', 'text-brand-orange', 'shadow-sm');
                        btn.classList.add('text-slate-500', 'dark:text-slate-400');
                    }
                });
                
                if(viewName === 'monitoring') this.updateCharts();
                if(viewName === 'productivity') this.renderProductivity();
                if(viewName === 'reports') {
                    // Popula o select de condomínios
                    const sel = document.getElementById('report-condo-select');
                    if (sel && this.data.tasks) {
                        const condos = [...new Set(this.data.tasks.map(t => t.condominio))].sort();
                        sel.innerHTML = '<option value="">Selecione um Condomínio...</option>' + 
                                        condos.map(c => `<option value="${c}">${c}</option>`).join('');
                    }
                }
            },

            // --- PRODUTIVIDADE (RESTORED) ---
            renderProductivity() {
                if (!this.data.productivity) this.data.productivity = [];
                const list = this.data.productivity;
                
                const totalDias = list.reduce((acc, item) => acc + parseInt(item.dias || 0), 0);
                const totalPdvs = list.reduce((acc, item) => acc + parseInt(item.pdvs || 0), 0);
                const totalOc = list.reduce((acc, item) => acc + parseInt(item.ocorrencias || 0), 0);

                document.getElementById('prod-total-dias').textContent = totalDias;
                document.getElementById('prod-total-pdvs').textContent = totalPdvs;
                document.getElementById('prod-total-oc').textContent = totalOc;

                const tableBody = document.getElementById('productivity-table-body');
                const emptyState = document.getElementById('productivity-empty-state');

                if (list.length === 0) {
                    tableBody.innerHTML = '';
                    if(emptyState) emptyState.classList.remove('hidden');
                } else {
                    if(emptyState) emptyState.classList.add('hidden');
                    tableBody.innerHTML = list.map((item) => `
                        <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap dark:text-white uppercase">
                                ${item.ref}
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600 dark:text-blue-400">
                                ${item.dias}
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-brand-orange">
                                ${item.pdvs}
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-red-600 dark:text-red-400">
                                ${item.ocorrencias}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="App.openProductivityModal('${item.id}')" class="font-medium text-blue-600 dark:text-blue-500 hover:underline mr-2">Editar</button>
                                <button onclick="App.deleteProductivity('${item.id}')" class="font-medium text-red-600 dark:text-red-500 hover:underline">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                }
            },

            openProductivityModal(id = null) {
                const modalTitle = document.getElementById('prod-modal-title');
                const inpId = document.getElementById('prod-id');
                const inpRef = document.getElementById('prod-ref');
                const inpDias = document.getElementById('prod-dias');
                const inpPdvs = document.getElementById('prod-pdvs');
                const inpOcs = document.getElementById('prod-ocs');

                if (id) {
                    const item = this.data.productivity.find(p => p.id === id);
                    if (item) {
                        modalTitle.textContent = "Editar Registro";
                        inpId.value = item.id;
                        inpRef.value = item.ref;
                        inpDias.value = item.dias;
                        inpPdvs.value = item.pdvs;
                        inpOcs.value = item.ocorrencias;
                    }
                } else {
                    modalTitle.textContent = "Novo Registro";
                    inpId.value = "";
                    inpRef.value = "";
                    inpDias.value = "";
                    inpPdvs.value = "";
                    inpOcs.value = "";
                }
                this.openModalUI('productivity-modal');
            },

            saveProductivity() {
                const id = document.getElementById('prod-id').value;
                const ref = document.getElementById('prod-ref').value;
                const dias = parseInt(document.getElementById('prod-dias').value) || 0;
                const pdvs = parseInt(document.getElementById('prod-pdvs').value) || 0;
                const ocs = parseInt(document.getElementById('prod-ocs').value) || 0;

                if (!ref) return alert("Preencha a referência (Data/Semana).");

                if (!this.data.productivity) this.data.productivity = [];

                if (id) {
                    const item = this.data.productivity.find(p => p.id === id);
                    if (item) {
                        item.ref = ref;
                        item.dias = dias;
                        item.pdvs = pdvs;
                        item.ocorrencias = ocs;
                        this.showToast("Registro atualizado!");
                    }
                } else {
                    this.data.productivity.unshift({
                        id: this.generateId(),
                        ref: ref,
                        dias: dias,
                        pdvs: pdvs,
                        ocorrencias: ocs,
                        createdAt: new Date().toISOString()
                    });
                    this.showToast("Registro adicionado!");
                }

                this.saveData();
                this.renderProductivity();
                this.closeModalUI('productivity-modal');
            },

            deleteProductivity(id) {
                if(confirm("Tem certeza que deseja excluir este registro?")) {
                    this.data.productivity = this.data.productivity.filter(p => p.id !== id);
                    this.saveData();
                    this.renderProductivity();
                    this.showToast("Registro excluído.");
                }
            },

            // COFRE DE SEGURANÇA (RECUPERAÇÃO)
            recoverLostData() {
                const candidates = new Map();
                const process = (key) => {
                    try {
                        const raw = localStorage.getItem(key); if (!raw) return; const parsed = JSON.parse(raw);
                        let arr = []; if (Array.isArray(parsed)) arr = parsed; else if (parsed.a) arr = parsed.a.concat(parsed.t || []); 
                        arr.forEach(t => { if (t && t.id) candidates.set(t.id, t); });
                    } catch(e) { console.error("Error reading " + key, e); }
                };
                process('mon_archived'); 
                process('mon_tasks'); 
                process('mon_safe_backup'); 
                
                const currentIds = new Set([...this.data.tasks.map(t => t.id), ...this.data.archived.map(t => t.id)]);
                this.data.recoveryList = [];
                for (const [id, task] of candidates) { 
                    if (!currentIds.has(id)) this.data.recoveryList.push(task); 
                }
                
                if (this.data.recoveryList.length === 0) { 
                    alert("O Cofre está vazio. Nenhum dado perdido foi encontrado nos backups locais."); 
                } else { 
                    this.openModalUI('recovery-modal'); 
                    this.renderRecoveryList(); 
                }
            },

            renderRecoveryList() {
                const list = document.getElementById('recovery-list');
                const search = document.getElementById('recovery-search').value.toLowerCase();
                const filtered = this.data.recoveryList.filter(t => (t.condominio || '').toLowerCase().includes(search));
                
                if (filtered.length === 0) { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Nenhum item correspondente encontrado.</p>'; return; }
                
                list.innerHTML = filtered.map(t => `
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-900 rounded border border-blue-100 dark:border-blue-900 hover:shadow-md transition-all">
                        <div>
                            <p class="font-bold text-sm dark:text-white uppercase text-blue-900 dark:text-blue-100">${t.condominio || 'Sem Nome'}</p>
                            <p class="text-[10px] text-slate-500 flex items-center gap-1"><i class="ph ph-calendar"></i> ${this.formatDate(t.dataAnalise)} <span class="mx-1">•</span> ${t.semana || '-'}</p>
                        </div>
                        <button onclick="App.restoreSingleFromRecovery('${t.id}')" class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-2 rounded shadow-lg transition-colors">
                            <i class="ph ph-download-simple"></i> Recuperar Este
                        </button>
                    </div>`).join('');
            },

            restoreSingleFromRecovery(id) {
                const idx = this.data.recoveryList.findIndex(t => t.id === id);
                if (idx > -1) {
                    const item = this.data.recoveryList[idx];
                    this.data.recoveryList.splice(idx, 1);
                    item.manualRestore = true; 
                    item.carimboSemanaAtual = true; 
                    
                    this.data.tasks.unshift(item);
                    this.saveData(); 
                    this.renderRecoveryList(); 
                    this.render(); 
                    this.showToast('Item recuperado do Cofre!');
                    
                    if (this.data.recoveryList.length === 0) this.closeModalUI('recovery-modal');
                }
            },

            // AUTH & USER
            generateEmail(name) { 
                const cleanName = name.trim().toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, "") 
                    .replace(/\s+/g, '.') 
                    .replace(/[^a-z0-9.]/g, ''); 
                return `${cleanName}@vendperto.local`; 
            },
            
            async loginWithUser() { 
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { return alert("Erro de conexão: Verifique sua internet."); }
                }

                const name = document.getElementById('login-username').value.trim().toUpperCase();
                const pass = document.getElementById('login-password').value;
                if(!name || !pass) return alert("Preencha os dados.");
                
                const email = this.generateEmail(name);
                const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
                
                document.getElementById('login-loading').classList.remove('hidden');
                document.getElementById('login-form-container').classList.add('hidden');

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    
                    // Timeout manual de 10s
                    const fetchPromise = getDoc(docRef);
                    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
                    const docSnap = await Promise.race([fetchPromise, timeoutPromise]);

                    if (docSnap.exists()) {
                        const u = docSnap.data();
                        if (u.authorized === false) {
                            alert("Acesso pendente de aprovação ou bloqueado pelo gestor.");
                            this.resetLoginUI();
                            return;
                        }

                        if (u.password === pass) {
                            let isAdmin = u.isAdmin || name === 'GESTOR' || name === 'ALISSON CAMBUI';
                            this.data.user = { ...u, uid: safeId, displayName: u.name, isAdmin: isAdmin };
                            localStorage.setItem('mon_user', JSON.stringify(this.data.user));
                            this.updateUserInfo(this.data.user);
                            this.switchToDashboardView();
                            this.subscribeToUserData(safeId);
                        } else { 
                            alert("Senha incorreta."); 
                            this.resetLoginUI();
                        }
                    } else { 
                        alert("Usuário não encontrado. Crie um cadastro primeiro."); 
                        this.resetLoginUI();
                    }
                } catch(e) { 
                    if (e.message === "Timeout") {
                        alert("Erro: O servidor demorou muito para responder. Verifique sua conexão.");
                    } else {
                        alert("Erro de conexão: " + e.message); 
                    }
                    this.resetLoginUI();
                }
            },
            
            resetLoginUI() {
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('login-form-container').classList.remove('hidden');
            },

            async registerWithUser() {
                if (!auth.currentUser) return alert("Aguardando conexão...");
                const name = document.getElementById('login-username').value.trim().toUpperCase();
                const pass = document.getElementById('login-password').value;
                if (!name || pass.length < 6) return alert('Senha deve ter no mínimo 6 caracteres.');
                const email = this.generateEmail(name);
                const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
                
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    const snap = await getDoc(ref);
                    
                    if (snap.exists() && snap.data().password) return alert('Usuário já existe. Tente fazer login.');
                    
                    const isSuperUser = name === 'GESTOR' || name === 'ALISSON CAMBUI';
                    const isAuthorized = snap.exists() ? snap.data().authorized : isSuperUser;
                    
                    if (!isAuthorized) alert("Seu cadastro foi enviado, mas precisa ser aprovado pelo gestor.");
                    else alert('Cadastro realizado! Faça login.');

                    await setDoc(ref, { 
                        name, email, password: pass, isAdmin: isSuperUser, authorized: isAuthorized, createdAt: new Date().toISOString() 
                    }, { merge: true });
                    
                    this.toggleAuthMode('login');
                } catch (e) { alert('Erro: ' + e.message); }
            },

            async authorizeNewUser() {
                 const name = document.getElementById('new-user-name').value.trim().toUpperCase();
                 if (!name) return;
                 const email = this.generateEmail(name);
                 const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId), { 
                     name, email, password: '', authorized: true, isAdmin: false 
                 }, { merge: true });
                 alert('Autorizado.');
                 document.getElementById('new-user-name').value = ''; 
                 this.loadAuthorizedUsers();
            },

            async loadAuthorizedUsers() {
                 const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'auth_users'));
                 const list = document.getElementById('admin-users-list');
                 list.innerHTML = '';
                 q.forEach((docSnap) => {
                     const u = docSnap.data();
                     const isGestor = u.isAdmin === true;
                     const docId = docSnap.id;
                     const isMe = docId === 'app_users_' + this.data.user.uid;
                     const isAuth = u.authorized !== false; 
                     
                     list.innerHTML += `
                        <li class="flex justify-between items-center py-3 border-b dark:border-slate-700 dark:text-slate-300">
                            <div>
                                <div class="font-bold text-sm flex items-center gap-2">
                                    ${u.name}
                                    ${isGestor ? '<span class="bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 text-[10px] px-1.5 py-0.5 rounded border border-purple-200 dark:border-purple-800 uppercase font-bold">Gestor</span>' : ''}
                                </div>
                                <div class="text-[10px] text-slate-400">${u.email}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] ${u.password?'text-green-500':'text-amber-500'} font-bold">${u.password?'Ativo':'Pendente'}</span>
                                ${!isMe ? `
                                <div class="flex gap-1">
                                    <button onclick="App.toggleAuthStatus('${docId}', ${!isAuth})" class="p-2 rounded-lg ${isAuth ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} hover:opacity-80 transition"><i class="ph ${isAuth ? 'ph-check' : 'ph-x'} text-lg"></i></button>
                                    <button onclick="App.toggleAdminStatus('${docId}', ${!isGestor})" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition text-slate-500"><i class="ph ${isGestor ? 'ph-shield-slash text-red-500' : 'ph-shield-check text-blue-500'} text-lg"></i></button>
                                </div>` : ''}
                            </div>
                        </li>`;
                 });
            },
            
            async toggleAuthStatus(docId, makeAuth) {
                if(!confirm(makeAuth ? "Autorizar acesso?" : "Bloquear acesso?")) return;
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', docId);
                    await updateDoc(ref, { authorized: makeAuth });
                    this.showToast(makeAuth ? "Autorizado!" : "Bloqueado.");
                    this.loadAuthorizedUsers(); 
                } catch(e) { alert("Erro: " + e.message); }
            },

            async toggleAdminStatus(docId, makeAdmin) {
                if(!confirm(makeAdmin ? "Promover a Gestor?" : "Remover Gestor?")) return;
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', docId);
                    await updateDoc(ref, { isAdmin: makeAdmin });
                    this.showToast(makeAdmin ? "Promovido!" : "Removido.");
                    this.loadAuthorizedUsers(); 
                } catch(e) { alert("Erro: " + e.message); }
            },

            // UI HELPERS & TASK CRUD
            updateUserInfo(u) { 
                let dn = u.name;
                if (u.isAdmin) {
                    dn += ' (GESTOR)';
                    document.getElementById('manager-global-btn').classList.remove('hidden');
                    document.getElementById('admin-panel-btn').classList.remove('hidden');
                }
                document.getElementById('user-display-name').textContent = dn; 
                document.getElementById('account-modal-name').textContent = dn;
            },
            
            toggleAuthMode(mode) {
                this.data.authMode = mode;
                const els = { login: document.getElementById('tab-login'), reg: document.getElementById('tab-register'), btn: document.getElementById('action-btn') };
                if (mode === 'login') {
                    els.login.classList.add('bg-white', 'text-brand-orange'); els.login.classList.remove('text-slate-500');
                    els.reg.classList.remove('bg-white', 'text-brand-orange'); els.reg.classList.add('text-slate-500');
                    els.btn.textContent = "Acessar Painel"; els.btn.onclick = () => App.loginWithUser();
                } else {
                    els.reg.classList.add('bg-white', 'text-brand-orange'); els.reg.classList.remove('text-slate-500');
                    els.login.classList.remove('bg-white', 'text-brand-orange'); els.login.classList.add('text-slate-500');
                    els.btn.textContent = "Criar Senha"; els.btn.onclick = () => App.registerWithUser();
                }
            },
            
            openModalUI(id) { document.getElementById(id).classList.remove('hidden'); },
            closeModalUI(id) { document.getElementById(id).classList.add('hidden'); },
            openMyAccountModal() { document.getElementById('my-account-modal').classList.remove('hidden'); },
            openAdminPanel() { if(this.data.user?.isAdmin) { this.openModalUI('admin-panel-modal'); this.loadAuthorizedUsers(); } },
            openArchive(e) { if(e) e.stopPropagation(); document.getElementById('actions-menu').classList.add('hidden'); document.getElementById('archive-search').value = ''; this.renderArchiveList(); this.openModalUI('archive-modal'); },
            openImport(e) { if(e) e.stopPropagation(); document.getElementById('actions-menu').classList.add('hidden'); this.openModalUI('excel-import-modal'); },
            openChangePasswordModal() { this.openModalUI('change-password-modal'); },

            switchToDashboardView() { 
                document.getElementById('login-view').classList.add('hidden'); 
                document.getElementById('dashboard-view').classList.remove('hidden'); 
                document.getElementById('dashboard-view').classList.add('flex');
            },

            async logout() { 
                this.data.user = null; 
                localStorage.removeItem('mon_user'); 
                localStorage.removeItem('mon_safe_backup'); 
                if(this.data.unsubscribeGlobal) this.data.unsubscribeGlobal();
                window.location.reload(); 
            },

            addTask(task) {
                const t = { 
                    id: this.generateId(), ...task, 
                    dataAnalise: task.dataAnalise || new Date().toISOString().split('T')[0],
                    statusBackup: 'Pendente', statusAnalise: 'Pendente', ocorrencias: [], createdAt: new Date().toISOString(),
                    _ownerUid: this.data.user.uid 
                };
                this.data.tasks.unshift(t);
                this.saveData();
                this.showToast('Análise criada!');
            },

            editTask(id) {
                const task = this.data.tasks.find(t => t.id === id);
                if (!task) return;
                this.data.editingTaskId = id;
                document.getElementById('task-modal-title').textContent = "Editar Análise";
                document.getElementById('form-condominio').value = task.condominio;
                document.getElementById('form-data-analise').value = task.dataAnalise;
                document.getElementById('form-semana').value = task.semana || '';
                document.getElementById('form-observacoes').value = task.observacoes || '';
                App.openModalUI('task-modal');
            },

            saveTaskFromForm() {
                const id = this.data.editingTaskId;
                const newData = {
                    condominio: document.getElementById('form-condominio').value,
                    dataAnalise: document.getElementById('form-data-analise').value,
                    semana: document.getElementById('form-semana').value,
                    observacoes: document.getElementById('form-observacoes').value
                };
                if (id) {
                    const taskIndex = this.data.tasks.findIndex(t => t.id === id);
                    if (taskIndex > -1) { 
                        const originalTask = this.data.tasks[taskIndex];
                        this.data.tasks[taskIndex] = { ...originalTask, ...newData };
                        this.showToast('Atualizado!'); 
                    }
                } else { this.addTask(newData); }
                this.saveData();
                this.closeModalUI('task-modal');
            },

            updateStatus(id, field, val) {
                const t = this.data.tasks.find(x => x.id === id);
                if (t) { t[field] = val; this.saveData(); }
            },
            
            requestDeleteTask(id) { this.data.pendingDeleteId = id; document.getElementById('delete-confirmation-modal').classList.remove('hidden'); },
            confirmDeleteTask() { this.data.tasks = this.data.tasks.filter(t => t.id !== this.data.pendingDeleteId); this.saveData(); this.closeModalUI('delete-confirmation-modal'); },
            archiveTask(id) { const idx = this.data.tasks.findIndex(t => t.id === id); if(idx>-1) { this.data.archived.push(this.data.tasks.splice(idx,1)[0]); this.saveData(); } },

            // --- LÓGICA DE FUNÇÕES FALTANTES ---
            processExcel() {
                const text = document.getElementById('excel-paste-area').value;
                if (!text.trim()) return alert("Cole os dados primeiro.");
                
                const lines = text.split('\n');
                let count = 0;
                
                lines.forEach(line => {
                    let parts = line.split('\t');
                    if(parts.length < 2) return; 
                    
                    const condominio = parts[0].trim();
                    let dataAnalise = parts[1].trim();
                    const observacoes = parts[2] ? parts[2].trim() : '';
                    
                    if(dataAnalise.includes('/')) {
                        const d = dataAnalise.split('/');
                        if(d.length === 3) dataAnalise = `${d[2]}-${d[1]}-${d[0]}`;
                    }

                    if(condominio && dataAnalise) {
                        this.addTask({ condominio, dataAnalise, observacoes });
                        count++;
                    }
                });
                
                this.closeModalUI('excel-import-modal');
                this.showToast(`${count} itens importados!`);
            },

            renderArchiveList() {
                const list = document.getElementById('archive-list');
                const badge = document.getElementById('archive-count-badge');
                if(!this.data.archived) this.data.archived = [];
                
                badge.textContent = this.data.archived.length;
                
                const search = document.getElementById('archive-search').value.toLowerCase();
                const filtered = this.data.archived.filter(t => (t.condominio || '').toLowerCase().includes(search));
                
                if(filtered.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-400 py-4 text-xs">Arquivo vazio ou sem resultados.</p>';
                    return;
                }
                
                list.innerHTML = filtered.map(t => `
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700">
                        <div>
                            <p class="font-bold text-sm dark:text-white">${t.condominio}</p>
                            <p class="text-[10px] text-slate-500">${this.formatDate(t.dataAnalise)} • ${t.semana||'-'}</p>
                        </div>
                        <button onclick="App.restoreFromArchive('${t.id}')" class="text-xs text-blue-500 font-bold hover:underline">Restaurar</button>
                    </div>
                `).join('');
            },

            restoreFromArchive(id) {
                const idx = this.data.archived.findIndex(t => t.id === id);
                if(idx > -1) {
                    const t = this.data.archived.splice(idx, 1)[0];
                    t.manualRestore = true;
                    this.data.tasks.unshift(t);
                    this.saveData();
                    this.renderArchiveList();
                    this.render();
                    this.showToast('Item restaurado!');
                }
            },

            generateReport(condo) {
                const content = document.getElementById('report-content');
                const empty = document.getElementById('report-empty');
                
                if (!condo) {
                    content.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                empty.classList.add('hidden');
                
                const tasks = this.data.tasks.filter(t => t.condominio === condo);
                const totalOc = tasks.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                
                document.getElementById('rep-total-oc').textContent = totalOc;
                
                // Atualiza gráfico de linha
                if (this.charts.report) {
                    const days = {};
                    tasks.forEach(t => {
                        const date = this.formatDate(t.dataAnalise);
                        const qtd = t.ocorrencias ? t.ocorrencias.length : 0;
                        days[date] = (days[date] || 0) + qtd;
                    });
                    
                    // Ordenar datas
                    const sortedDays = Object.entries(days).sort((a,b) => a[0].localeCompare(b[0])); // Simples string sort para dia/mes
                    
                    this.charts.report.data.labels = sortedDays.map(d => d[0]);
                    this.charts.report.data.datasets[0].data = sortedDays.map(d => d[1]);
                    this.charts.report.update();
                }
            },

            async changeUserPassword() {
                const newPass = document.getElementById('new-password-input').value;
                if (!newPass || newPass.length < 6) return alert("Senha deve ter no mínimo 6 caracteres.");
                
                try {
                    // Atualiza no documento do usuário (sistema customizado)
                    const safeId = this.data.user.uid;
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    await updateDoc(ref, { password: newPass });
                    
                    alert("Senha alterada com sucesso!");
                    this.closeModalUI('change-password-modal');
                } catch(e) {
                    alert("Erro ao alterar senha: " + e.message);
                }
            },
            
            exportData() {
                const dataStr = JSON.stringify({
                    tasks: this.data.tasks,
                    archived: this.data.archived,
                    productivity: this.data.productivity,
                    exportedAt: new Date().toISOString()
                });
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_monitoramento_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            // --- OCORRÊNCIAS ---
            openOcorrenciaModal(id) {
                document.getElementById('ocorrencia-current-task-id').value = id;
                const t = this.data.tasks.find(x => x.id === id);
                if(!t) return;
                document.getElementById('modal-condo-name').textContent = t.condominio;
                const sel = document.getElementById('add-ocorrencia-categoria');
                sel.innerHTML = this.data.categories.map(c => `<option>${c}</option>`).join('');
                this.renderOcorrenciasList(t);
                this.openModalUI('ocorrencia-modal');
            },
            
            // FUNÇÃO REFEITA E BLINDADA
            addOccurrence() {
                try {
                    const taskId = document.getElementById('ocorrencia-current-task-id').value;
                    if (!taskId) throw new Error("ID da análise não encontrado.");

                    const t = this.data.tasks.find(x => x.id === taskId);
                    if(!t) throw new Error("Análise não encontrada na lista ativa.");

                    if (!t.ocorrencias) t.ocorrencias = [];

                    const catEl = document.getElementById('add-ocorrencia-categoria');
                    const descEl = document.getElementById('add-ocorrencia-desc');
                    const iniEl = document.getElementById('add-horario-inicial');
                    const fimEl = document.getElementById('add-horario-final');

                    const cat = catEl.value;
                    const desc = descEl.value;
                    const ini = iniEl.value;
                    const fim = fimEl.value;

                    // CORREÇÃO: Substituição do alert por feedback visual
                    if(!desc || desc.trim() === "") {
                        this.showToast("Erro: Descrição obrigatória!", true);
                        descEl.focus();
                        descEl.classList.add('input-error');
                        setTimeout(() => descEl.classList.remove('input-error'), 2000);
                        return;
                    }

                    if (this.data.editingId) {
                        const oc = t.ocorrencias.find(o => o.id === this.data.editingId);
                        if (oc) {
                            oc.categoria = cat; oc.descricao = desc; oc.inicio = ini; oc.fim = fim;
                            this.showToast('Item atualizado!');
                        }
                        this.data.editingId = null;
                        this.resetOcorrenciaFormUI();
                    } else {
                        const newId = (typeof this.generateId === 'function') ? this.generateId() : Date.now().toString();
                        t.ocorrencias.push({ id: newId, categoria: cat, descricao: desc, inicio: ini, fim: fim });
                        this.showToast('Item adicionado!');
                    }
                    
                    // Limpar campos
                    descEl.value = '';
                    iniEl.value = '';
                    fimEl.value = '';
                    descEl.focus(); // Focar novamente para adicionar mais itens rapidamente

                    this.saveData();
                    this.renderOcorrenciasList(t);
                } catch(e) {
                    console.error(e);
                    alert("Erro ao adicionar: " + e.message);
                }
            },

            saveAndCloseOcorrencias() {
                 const desc = document.getElementById('add-ocorrencia-desc').value;
                 // CORREÇÃO: Se houver texto, tenta salvar antes de fechar para não perder dados
                 if (desc && desc.trim() !== "") {
                     this.addOccurrence(); 
                 }
                 this.saveData();
                 this.closeModalUI('ocorrencia-modal');
                 this.resetOcorrenciaForm(); 
                 this.showToast('Alterações salvas');
            },

            prepareEditOcorrencia(taskId, ocId) {
                const t = this.data.tasks.find(x => x.id === taskId);
                if(!t) return;
                const oc = t.ocorrencias.find(o => o.id === ocId);
                if(!oc) return;
                document.getElementById('add-ocorrencia-categoria').value = oc.categoria;
                document.getElementById('add-ocorrencia-desc').value = oc.descricao;
                document.getElementById('add-horario-inicial').value = oc.inicio || '';
                document.getElementById('add-horario-final').value = oc.fim || '';
                this.data.editingId = ocId;
                const btn = document.getElementById('add-ocorrencia-btn');
                btn.innerHTML = `<i class="ph ph-floppy-disk text-lg"></i> Salvar Edição`;
                btn.className = "flex-1 bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition-colors shadow-lg";
            },

            removeOcorrencia(taskId, ocId) {
                if(!confirm("Remover este item da lista?")) return;
                const t = this.data.tasks.find(x => x.id === taskId);
                if(t) {
                    t.ocorrencias = t.ocorrencias.filter(o => o.id !== ocId);
                    this.saveData();
                    this.renderOcorrenciasList(t);
                    this.showToast('Item removido.');
                }
            },

            resetOcorrenciaFormUI() {
                const btn = document.getElementById('add-ocorrencia-btn');
                btn.innerHTML = `+ Adicionar Item`;
                btn.className = "flex-1 bg-orange-100 text-brand-orange font-bold py-2 rounded hover:bg-orange-200 transition-colors border border-orange-200";
            },

            resetOcorrenciaForm() {
                this.data.editingId = null;
                document.getElementById('add-ocorrencia-desc').value = '';
                document.getElementById('add-horario-inicial').value = '';
                document.getElementById('add-horario-final').value = '';
                this.resetOcorrenciaFormUI();
            },
            
            renderOcorrenciasList(task) {
                const list = document.getElementById('ocorrencia-list');
                if (!task.ocorrencias || task.ocorrencias.length === 0) {
                    list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Nenhuma ocorrência registrada.</p>';
                    return;
                }
                const sorted = [...task.ocorrencias].sort((a,b) => (a.inicio || '').localeCompare(b.inicio || ''));

                list.innerHTML = sorted.map(o => `
                    <div class="p-2 border-b dark:border-slate-700 flex justify-between items-center group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <div>
                            <span class="text-[10px] font-bold bg-orange-100 text-orange-700 px-1 rounded border border-orange-200">${o.inicio||'--:--'} a ${o.fim||'--:--'}</span>
                            <span class="text-xs font-bold text-slate-700 dark:text-white ml-2 uppercase">${o.categoria}</span>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${o.descricao}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="App.prepareEditOcorrencia('${task.id}', '${o.id}')" class="p-2 text-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded transition" title="Editar">
                                <i class="ph ph-pencil-simple text-lg"></i>
                            </button>
                            <button onclick="App.removeOcorrencia('${task.id}', '${o.id}')" class="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition" title="Excluir">
                                <i class="ph ph-trash text-lg"></i>
                            </button>
                        </div>
                    </div>`).join('');
            },

            // --- RENDER ---
            render() { 
                const list = document.getElementById('task-list');
                const fCondo = document.getElementById('filtro-condominio').value.toLowerCase();
                const fAnalise = document.getElementById('filtro-analise').value;
                const fBackup = document.getElementById('filtro-backup').value;
                const fUser = document.getElementById('filtro-usuario').value.toLowerCase();

                // Segurança contra tasks nulas
                if (!this.data.tasks) this.data.tasks = [];

                const filtered = this.data.tasks.filter(t => {
                    if (!t) return false;
                    const matchUser = this.data.isManagerMode ? (t._ownerName || '').toLowerCase().includes(fUser) : true;
                    return (t.condominio || '').toLowerCase().includes(fCondo) &&
                           (fAnalise === '' || t.statusAnalise === fAnalise) &&
                           (fBackup === '' || t.statusBackup === fBackup) && matchUser;
                });
                
                document.getElementById('total-solicitacoes').textContent = this.data.tasks.length;
                document.getElementById('backups-pendentes').textContent = this.data.tasks.filter(t => t.statusBackup === 'Pendente').length;
                
                const statTasks = this.data.tasks.filter(t => !t.manualRestore || t.carimboSemanaAtual);
                const concluidas = statTasks.filter(t => t.statusAnalise === 'Concluída');
                const concluidasCount = concluidas.length;
                
                document.getElementById('analises-concluidas').textContent = concluidasCount;
                
                const uniquePdvs = new Set(concluidas.map(t => (t.condominio || '').trim().toUpperCase()));
                document.getElementById('total-pdvs').textContent = uniquePdvs.size;

                const totalOc = statTasks.reduce((acc, t) => acc + (t.ocorrencias?.length||0), 0);
                document.getElementById('total-ocorrencias-semana').textContent = totalOc;

                const media = concluidasCount > 0 ? (totalOc / concluidasCount).toFixed(1) : "0.0";
                const elMedia = document.getElementById('media-ocorrencias');
                if(elMedia) elMedia.textContent = media;

                list.innerHTML = filtered.map(t => {
                    const ocCount = t.ocorrencias ? t.ocorrencias.length : 0;
                    const ownerBadge = this.data.isManagerMode ? 
                        `<div class="mb-2 inline-block bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-[10px] font-bold px-2 py-0.5 rounded-full border border-purple-200 dark:border-purple-800 uppercase">
                            <i class="ph ph-user"></i> ${t._ownerName || 'Desconhecido'}
                         </div>` : '';

                    const optionsAnalise = ['Pendente', 'Em Análise', 'Concluída'].map(opt => `<option value="${opt}" ${t.statusAnalise === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    const optionsBackup = ['Pendente', 'Em Andamento', 'Concluído'].map(opt => `<option value="${opt}" ${t.statusBackup === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    
                    return `
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border border-slate-100 dark:border-slate-700 card-transition relative group">
                        ${ownerBadge}
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-lg text-slate-800 dark:text-white uppercase tracking-tight">${t.condominio}</h3>
                                    <button onclick="App.editTask('${t.id}')" class="text-blue-400 hover:text-blue-600" title="Editar Dados"><i class="ph ph-pencil-simple"></i></button>
                                </div>
                                <p class="text-xs text-slate-500 flex items-center gap-1"><i class="ph ph-calendar"></i> ${this.formatDate(t.dataAnalise)} <span class="bg-slate-100 dark:bg-slate-700 px-1.5 rounded ml-2">${t.semana||'-'}</span></p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="App.openOcorrenciaModal('${t.id}')" class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-brand-orange hover:bg-orange-100 dark:hover:bg-orange-900/40 transition relative">
                                    <i class="ph ph-list-checks text-xl"></i>
                                    ${ocCount > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold shadow-sm">${ocCount}</span>` : ''}
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Análise</label>
                                <select onchange="App.updateStatus('${t.id}', 'statusAnalise', this.value)" class="w-full text-xs font-bold rounded p-1.5 border dark:border-slate-600 dark:bg-slate-700 outline-none ${this.statusColors[t.statusAnalise]}">
                                    ${optionsAnalise}
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Backup</label>
                                <select onchange="App.updateStatus('${t.id}', 'statusBackup', this.value)" class="w-full text-xs font-bold rounded p-1.5 border dark:border-slate-600 dark:bg-slate-700 outline-none ${this.statusColors[t.statusBackup]}">
                                    ${optionsBackup}
                                </select>
                            </div>
                        </div>
                        ${t.observacoes ? `<p class="text-xs text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900 p-2 rounded mb-3 italic border-l-2 border-slate-300 dark:border-slate-600 line-clamp-2">"${t.observacoes}"</p>` : ''}
                        <div class="flex justify-end gap-2 mt-2 pt-3 border-t dark:border-slate-700 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button onclick="App.archiveTask('${t.id}')" class="text-xs text-purple-500 hover:text-purple-700 font-bold flex items-center gap-1"><i class="ph ph-archive"></i> Arquivar</button>
                             <button onclick="App.requestDeleteTask('${t.id}')" class="text-xs text-red-400 hover:text-red-600 font-bold ml-2 flex items-center gap-1"><i class="ph ph-trash"></i> Excluir</button>
                        </div>
                    </div>`}).join('');
            }
        };
        
        window.App = App; 
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Sistema carregado com sucesso.");
            App.init();
        });
    </script>
</body>
</html>