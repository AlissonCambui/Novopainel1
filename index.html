<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vendPerto - Monitoramento Inteligente</title>
    
    <!-- 1. Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configura o Dark Mode e Cores -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            orange: '#f26324',
                            yellow: '#f7b41e',
                            dark: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Ícones (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Estilos Globais */
        body { transition: background-color 0.3s, color 0.3s; }
        .card-transition { transition: transform 0.2s, box-shadow 0.2s; }
        .card-transition:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 font-sans antialiased min-h-screen flex flex-col transition-colors duration-300">

    <!-- Navbar -->
    <nav class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-40 border-b dark:border-slate-700">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="text-2xl font-extrabold tracking-tight select-none">
                    <span class="text-brand-orange">vend</span><span class="text-brand-yellow">Perto</span>
                </div>
                <span class="hidden md:inline-block text-xs bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 dark:text-slate-400 font-medium ml-2">Monitor</span>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-brand-orange">
                    <i class="ph ph-sun text-lg"></i>
                    <span class="text-sm font-semibold hidden sm:inline">Tema</span>
                </button>
                <div class="text-right hidden sm:block">
                    <p class="text-xs text-slate-500 dark:text-slate-400" id="current-date">...</p>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow">
        <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Painel de Controle</h1>
                <p class="text-slate-600 dark:text-slate-400 mt-1">Visão geral do monitoramento e ocorrências.</p>
            </div>
        </header>

        <!-- KPIs -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                <h3 class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-slate-800 dark:text-white">0</p>
            </div>
            <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                <h3 class="text-xs font-bold uppercase text-amber-600 dark:text-amber-500">Backups Pend.</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-500">0</p>
            </div>
            <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                <h3 class="text-xs font-bold uppercase text-emerald-600 dark:text-emerald-400">Concluídas</h3>
                <p id="analises-concluidas" class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">0</p>
            </div>
            <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                <h3 class="text-xs font-bold uppercase text-red-600 dark:text-red-400">Ocorrências</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-red-500">0</p>
                <p class="text-xs text-slate-400 text-right">Total Painel</p>
            </div>
        </section>

        <!-- Toolbar -->
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-8 border border-slate-100 dark:border-slate-700">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                    <input type="text" id="filtro-condominio" placeholder="Buscar condomínio..." class="pl-3 w-full lg:w-64 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition">
                    
                    <select id="filtro-analise" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                        <option value="">Status Análise: Todos</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Análise">Em Análise</option>
                        <option value="Concluída">Concluída</option>
                    </select>
                    
                    <select id="filtro-backup" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                         <option value="">Status Backup: Todos</option>
                         <option value="Pendente">Pendente</option>
                         <option value="Em Andamento">Em Andamento</option>
                         <option value="Concluído">Concluído</option>
                    </select>
                </div>
                <div class="flex items-center gap-3 w-full lg:w-auto justify-end">
                    <button id="add-task-btn" class="bg-brand-orange hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2 shadow-lg shadow-orange-500/20">
                        <i class="ph ph-plus-circle text-lg"></i> Nova Análise
                    </button>
                    
                    <div class="relative" id="actions-menu-container">
                        <button id="actions-menu-btn" class="bg-slate-100 dark:bg-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-white flex items-center gap-2 transition-colors">
                            Ações <i class="ph ph-caret-down"></i>
                        </button>
                        <div id="actions-menu" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-100 dark:border-slate-700 z-50 overflow-hidden">
                            <button id="excel-import-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-200 transition-colors">
                                <i class="ph ph-file-csv text-lg text-green-600"></i> Importar (Excel)
                            </button>
                            <button id="period-analysis-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <i class="ph ph-chart-bar text-lg text-blue-500"></i> Relatório por Período
                            </button>
                            <button id="archive-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <i class="ph ph-archive-box text-lg text-purple-500"></i> Arquivo Morto
                            </button>
                            <div class="border-t border-slate-100 dark:border-slate-700 my-0"></div>
                            <button id="export-data-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <i class="ph ph-download-simple text-lg text-slate-500"></i> Backup (Salvar Dados)
                            </button>
                            <button id="import-data-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <i class="ph ph-upload-simple text-lg text-slate-500"></i> Restaurar Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Tarefas -->
        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            <!-- JS preenche aqui -->
        </main>
        
        <!-- Gráficos -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
             <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                <h2 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="ph ph-map-pin"></i> Ocorrências por Local</h2>
                <div class="chart-container"><canvas id="ocorrenciasChart"></canvas></div>
             </div>
             <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-center items-center">
                 <h2 class="text-lg font-bold mb-2 dark:text-white flex items-center gap-2"><i class="ph ph-lightning"></i> Produtividade Média</h2>
                 <div class="text-center py-8">
                     <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold">Média de Ocorrências por Condomínio</p>
                     <p id="produtividade-semanal" class="text-6xl font-extrabold text-emerald-500 mt-4">0.0</p>
                     <p class="text-xs text-slate-400 mt-2">Baseado nas análises concluídas</p>
                 </div>
             </div>
        </section>
    </div>

    <!-- Modais -->
    
    <!-- Modal Adicionar Tarefa -->
    <div id="task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md border dark:border-slate-700 shadow-2xl transform scale-100 transition-transform">
            <h2 class="text-2xl font-bold mb-4 dark:text-white">Nova Análise</h2>
            <form id="task-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Condomínio</label>
                    <input type="text" id="form-condominio" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Data</label>
                    <input type="date" id="form-data-analise" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Semana</label>
                    <input type="text" id="form-semana" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Ex: Semana 47">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Observações</label>
                    <textarea id="form-observacoes" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-brand-orange text-white font-bold hover:bg-orange-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ocorrências -->
    <div id="ocorrencia-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl h-[90vh] flex flex-col border dark:border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-white">Ocorrências: <span id="modal-condo-name" class="text-brand-orange"></span></h2>
                <button id="ocorrencia-cancel-btn" class="text-slate-400 hover:text-red-500 text-2xl transition-colors">&times;</button>
            </div>
            
            <div id="ocorrencia-list" class="flex-grow overflow-y-auto mb-4 space-y-2 p-2 bg-slate-50 dark:bg-slate-900 rounded border dark:border-slate-700 shadow-inner">
                <!-- Lista JS -->
            </div>
            
            <div class="pt-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2">
                    <select id="add-ocorrencia-categoria" class="md:col-span-4 border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600"></select>
                    <input type="text" id="add-ocorrencia-desc" placeholder="Descrição da ocorrência..." class="md:col-span-8 border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">Início</label>
                        <input type="time" id="add-horario-inicial" step="1" class="border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600">
                    </div>
                    <div class="flex flex-col">
                         <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">Fim</label>
                         <input type="time" id="add-horario-final" step="1" class="border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="add-ocorrencia-btn" class="flex-1 bg-orange-100 text-brand-orange font-bold py-2 rounded hover:bg-orange-200 transition-colors border border-orange-200">+ Adicionar Item</button>
                    <button id="save-ocorrencias-btn" class="flex-1 bg-brand-orange text-white font-bold py-2 rounded hover:bg-orange-700 transition-colors shadow-lg shadow-orange-500/20">Salvar Tudo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Importar -->
    <div id="excel-import-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl border dark:border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-2 dark:text-white">Importar Dados (Excel)</h2>
            <p class="text-xs text-slate-500 mb-4">Cole as linhas do Excel aqui. Formato esperado: Semana | Data | Condomínio | ...</p>
            <textarea id="excel-paste-area" rows="10" class="w-full p-3 text-sm font-mono bg-slate-100 dark:bg-slate-900 border rounded dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Cole os dados aqui..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button id="excel-import-close-btn" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white transition-colors">Cancelar</button>
                <button id="process-import-btn" class="px-4 py-2 rounded bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition-colors">Processar Dados</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Arquivo Morto -->
    <div id="archive-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl border dark:border-slate-700">
            <div class="flex justify-between mb-4 border-b dark:border-slate-700 pb-2">
                <h2 class="text-2xl font-bold dark:text-white flex items-center gap-2"><i class="ph ph-archive-box"></i> Arquivo Morto</h2>
                <button id="archive-close-btn" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div id="archive-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
            <div class="mt-4 pt-2 border-t dark:border-slate-700 text-right">
                <button id="clear-archive-btn" class="text-red-500 text-sm font-bold hover:text-red-700 px-3 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">Limpar Arquivo Definitivamente</button>
            </div>
        </div>
    </div>

    <!-- Modal Relatório Período -->
    <div id="period-analysis-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 animate-fade-in">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-4xl h-5/6 flex flex-col border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold dark:text-white flex items-center gap-2"><i class="ph ph-chart-line-up"></i> Relatório por Período</h2>
                <button id="period-analysis-close-btn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <!-- Filtros de Data e Atalhos -->
            <div class="mb-4 space-y-4 border-b dark:border-slate-700 pb-4">
                <div class="flex gap-2 justify-center md:justify-start overflow-x-auto pb-2">
                    <button id="preset-week-btn" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-brand-orange hover:text-white text-sm font-medium transition-colors whitespace-nowrap">Esta Semana</button>
                    <button id="preset-month-btn" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-brand-orange hover:text-white text-sm font-medium transition-colors whitespace-nowrap">Este Mês</button>
                    <button id="preset-year-btn" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-brand-orange hover:text-white text-sm font-medium transition-colors whitespace-nowrap">Este Ano</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="date" id="period-start-date" class="bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-2 dark:text-white">
                    <input type="date" id="period-end-date" class="bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-2 dark:text-white">
                    <button id="generate-report-btn" class="bg-brand-orange text-white font-bold rounded-lg hover:bg-orange-700 shadow-md transition-colors">Gerar Relatório</button>
                </div>
            </div>

            <div id="period-results-content" class="flex-grow overflow-y-auto hidden pr-2">
                <section class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg text-center border border-slate-200 dark:border-slate-600">
                        <h3 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Total no Período</h3>
                        <p id="period-total" class="text-xl font-bold text-slate-800 dark:text-white">0</p>
                    </div>
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg text-center border border-emerald-200 dark:border-emerald-800">
                        <h3 class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase">Concluídas</h3>
                        <p id="period-concluidas" class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">0</p>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg text-center border border-red-200 dark:border-red-800">
                        <h3 class="text-xs font-bold text-red-600 dark:text-red-400 uppercase">Ocorrências</h3>
                        <p id="period-oc" class="text-xl font-bold text-red-600 dark:text-red-400">0</p>
                    </div>
                </section>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 mb-4">
                        <h3 class="text-center font-bold mb-4 dark:text-white">Ocorrências por Condomínio</h3>
                        <div class="chart-container h-64">
                            <canvas id="periodChart"></canvas>
                        </div>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 mb-4">
                        <h3 class="text-center font-bold mb-4 dark:text-white">Por Categoria</h3>
                        <div class="chart-container h-64">
                            <canvas id="periodCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
                 <div class="mt-6">
                    <h3 class="font-bold mb-2 dark:text-white">Detalhamento das Análises</h3>
                    <ul id="period-task-list" class="space-y-2 max-h-40 overflow-y-auto bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-200 dark:border-slate-700 text-sm dark:text-slate-300"></ul>
                 </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2">
        <i class="ph ph-check-circle text-green-400 text-xl"></i>
        <span id="toast-msg">Ação realizada</span>
    </div>

    <!-- Inputs Ocultos -->
    <input type="file" id="file-input" class="hidden" accept=".json">
    <input type="hidden" id="ocorrencia-current-task-id">

    <script>
        // --- ESTADO CENTRALIZADO ---
        const App = {
            data: {
                tasks: [],
                archived: [],
                categories: ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Defeito Técnico', 'Procedimento Incorreto', 'Outros']
            },
            
            // Inicializador para objetos chart
            charts: {},

            // Cores fixas
            statusColors: {
                'Pendente': 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-400',
                'Em Andamento': 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-400',
                'Em Análise': 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-400',
                'Concluído': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400',
                'Concluída': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400',
            },

            init() {
                this.loadData();
                this.setupTheme();
                this.setupDate();
                this.autoArchiveOldTasks();
                this.setupCharts();
                this.render();
                this.events.setup();
            },

            // --- PERSISTÊNCIA (LocalStorage) ---
            loadData() {
                try {
                    const t = localStorage.getItem('mon_tasks');
                    const a = localStorage.getItem('mon_archived');
                    if (t) this.data.tasks = JSON.parse(t);
                    if (a) this.data.archived = JSON.parse(a);
                } catch (e) { console.error("Erro load", e); }
            },

            saveData() {
                localStorage.setItem('mon_tasks', JSON.stringify(this.data.tasks));
                localStorage.setItem('mon_archived', JSON.stringify(this.data.archived));
                this.render();
            },
            
            // Exportar dados para JSON (Backup)
            exportData() {
                const dataStr = JSON.stringify(this.data);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `backup_monitoramento_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                this.showToast('Backup baixado com sucesso!');
            },

            // Importar dados de JSON (Restaurar)
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.tasks && Array.isArray(json.tasks)) {
                            if(confirm('Isso irá substituir os dados atuais pelos do arquivo. Deseja continuar?')) {
                                this.data = json;
                                this.saveData();
                                this.showToast('Dados restaurados com sucesso!');
                                window.location.reload(); // Recarrega para limpar gráficos e estados
                            }
                        } else {
                            alert('Arquivo de backup inválido.');
                        }
                    } catch (err) {
                        alert('Erro ao ler o arquivo.');
                    }
                };
                reader.readAsText(file);
                // Limpa o input para permitir selecionar o mesmo arquivo novamente
                event.target.value = '';
            },

            // --- UTILITÁRIOS ---
            generateId() {
                // CORREÇÃO: Uso de crypto.randomUUID para evitar colisões em loops rápidos
                return crypto.randomUUID();
            },
            
            normalize(str) {
                return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "").toLowerCase() : "";
            },
            
            // CORREÇÃO DE DATA: Formata string YYYY-MM-DD para DD/MM/YYYY sem alterar fuso horário
            formatDate(dateString) {
                if (!dateString) return '--/--/----';
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                const [y, m, d] = parts;
                return `${d}/${m}/${y}`;
            },
            
            clearFilters() {
                document.getElementById('filtro-condominio').value = '';
                document.getElementById('filtro-analise').value = '';
                document.getElementById('filtro-backup').value = '';
                this.render();
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
            },

            // Arquiva tarefas concluídas há mais de 30 dias automaticamente
            autoArchiveOldTasks() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                let archivedCount = 0;
                // Itera de trás para frente para remover com segurança
                for (let i = this.data.tasks.length - 1; i >= 0; i--) {
                    const task = this.data.tasks[i];
                    const taskDate = new Date(task.dataAnalise);
                    
                    if (task.statusAnalise === 'Concluída' && taskDate < thirtyDaysAgo) {
                        task.archivedDate = new Date().toISOString();
                        this.data.archived.unshift(task);
                        this.data.tasks.splice(i, 1);
                        archivedCount++;
                    }
                }
                
                if (archivedCount > 0) {
                    this.saveData();
                    console.log(`${archivedCount} tarefas antigas arquivadas automaticamente.`);
                }
            },

            // --- UI MODAL HANDLERS (Genéricos) ---
            openModalUI(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
            },
            
            closeModalUI(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            },

            // --- RENDERIZAÇÃO ---
            render() {
                // Atualiza KPIs
                document.getElementById('total-solicitacoes').textContent = this.data.tasks.length;
                document.getElementById('backups-pendentes').textContent = this.data.tasks.filter(t => t.statusBackup === 'Pendente').length;
                document.getElementById('analises-concluidas').textContent = this.data.tasks.filter(t => t.statusAnalise === 'Concluída').length;
                
                const totalOcc = this.data.tasks.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                document.getElementById('total-ocorrencias-semana').textContent = totalOcc;
                
                const concluded = this.data.tasks.filter(t => t.statusAnalise === 'Concluída');
                const occInConcluded = concluded.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                const avg = concluded.length ? (occInConcluded / concluded.length).toFixed(1) : "0.0";
                document.getElementById('produtividade-semanal').textContent = avg;

                // Renderiza Lista
                const filterCondo = document.getElementById('filtro-condominio').value.toLowerCase();
                const filterBackup = document.getElementById('filtro-backup').value;
                const filterAnalise = document.getElementById('filtro-analise').value;
                
                const container = document.getElementById('task-list');
                container.innerHTML = '';

                // CORREÇÃO: .trim() remove espaços invisíveis que quebram o filtro
                let filtered = this.data.tasks.filter(t => {
                    const sBackup = t.statusBackup ? t.statusBackup.trim() : '';
                    const sAnalise = t.statusAnalise ? t.statusAnalise.trim() : '';

                    return t.condominio.toLowerCase().includes(filterCondo) &&
                           (!filterBackup || sBackup === filterBackup) &&
                           (!filterAnalise || sAnalise === filterAnalise);
                });

                // CORREÇÃO: Ordenação (Data mais recente primeiro)
                filtered.sort((a, b) => {
                    if (a.dataAnalise > b.dataAnalise) return -1;
                    if (a.dataAnalise < b.dataAnalise) return 1;
                    return 0;
                });

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center text-slate-500 py-12 flex flex-col items-center">
                            <i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50"></i>
                            <p class="mb-4">Nenhuma análise encontrada com estes filtros.</p>
                            <button onclick="App.clearFilters()" class="text-brand-orange font-bold hover:underline text-sm border border-brand-orange px-4 py-2 rounded hover:bg-orange-50 dark:hover:bg-slate-800 transition-colors">Limpar Filtros</button>
                        </div>`;
                    return;
                }

                filtered.forEach(task => {
                    const div = document.createElement('div');
                    div.className = 'bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition relative overflow-hidden group';
                    
                    const borderClass = task.statusAnalise === 'Concluída' ? 'bg-emerald-500' : (task.statusAnalise === 'Pendente' ? 'bg-slate-300' : 'bg-orange-500');
                    const badge = task.semana ? `<span class="absolute top-3 right-3 text-[10px] font-bold bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500 dark:text-slate-400">${task.semana}</span>` : '';
                    const obsHtml = task.observacoes ? `<span class="text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded ml-2 cursor-help" title="${task.observacoes}">Obs</span>` : '';

                    // Lista de Ocorrências Simplificada no Card
                    let occHtml = '';
                    if (task.ocorrencias && task.ocorrencias.length > 0) {
                        occHtml = '<div class="mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 space-y-1">';
                        // Mostra apenas as 3 primeiras
                        task.ocorrencias.slice(0, 3).forEach(oc => {
                            occHtml += `<div class="text-xs text-slate-600 dark:text-slate-400 flex justify-between">
                                <span class="truncate pr-2">• ${oc.desc}</span>
                                <span class="font-mono text-brand-orange whitespace-nowrap">${oc.horarioInicial || '--:--'}</span>
                            </div>`;
                        });
                        if(task.ocorrencias.length > 3) {
                             occHtml += `<div class="text-[10px] text-center text-slate-400 mt-1">+ ${task.ocorrencias.length - 3} outras</div>`
                        }
                        occHtml += '</div>';
                    }

                    div.innerHTML = `
                        <div class="absolute top-0 left-0 w-1.5 h-full ${borderClass}"></div>
                        ${badge}
                        <div class="pl-2">
                            <div class="flex justify-between items-start mb-2 pr-10">
                                <h3 class="font-bold text-lg dark:text-white leading-tight">${task.condominio}${obsHtml}</h3>
                            </div>
                            <p class="text-sm text-slate-500 mb-4 flex items-center gap-1"><i class="ph ph-calendar-blank"></i> ${this.formatDate(task.dataAnalise)}</p>
                            
                            <div class="space-y-2 mb-4 bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="dark:text-slate-400 text-xs uppercase font-bold">Backup</span>
                                    <select onchange="App.updateStatus('${task.id}', 'statusBackup', this.value)" class="text-xs font-bold rounded px-2 py-1 border-0 cursor-pointer outline-none ${this.statusColors[task.statusBackup] || 'bg-slate-100 text-slate-600'}">
                                        <option value="Pendente" ${task.statusBackup==='Pendente'?'selected':''}>Pendente</option>
                                        <option value="Em Andamento" ${task.statusBackup==='Em Andamento'?'selected':''}>Baixando</option>
                                        <option value="Concluído" ${task.statusBackup==='Concluído'?'selected':''}>Salvo</option>
                                    </select>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="dark:text-slate-400 text-xs uppercase font-bold">Análise</span>
                                    <select onchange="App.updateStatus('${task.id}', 'statusAnalise', this.value)" class="text-xs font-bold rounded px-2 py-1 border-0 cursor-pointer outline-none ${this.statusColors[task.statusAnalise] || 'bg-slate-100 text-slate-600'}">
                                        <option value="Pendente" ${task.statusAnalise==='Pendente'?'selected':''}>Pendente</option>
                                        <option value="Em Análise" ${task.statusAnalise==='Em Análise'?'selected':''}>Em Análise</option>
                                        <option value="Concluída" ${task.statusAnalise==='Concluída'?'selected':''}>Concluída</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${occHtml}

                            <div class="flex justify-between items-center mt-4 pt-2 border-t dark:border-slate-700">
                                <span class="text-xs text-slate-400">${task.ocorrencias?.length||0} Ocorrências</span>
                                <div class="flex gap-2">
                                    <button onclick="App.openOccurrenceModal('${task.id}')" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded hover:bg-brand-orange hover:text-white transition font-medium flex items-center gap-1"><i class="ph ph-pencil-simple"></i> Detalhes</button>
                                    <button onclick="App.archiveTask('${task.id}')" class="text-slate-400 hover:text-purple-500 p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Arquivar"><i class="ph ph-archive-box text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                this.updateCharts();
            },

            // --- AÇÕES ---
            addTask(data) {
                this.data.tasks.unshift({
                    id: this.generateId(),
                    ...data,
                    statusBackup: 'Pendente',
                    statusAnalise: 'Pendente',
                    ocorrencias: []
                });
                this.saveData();
                this.showToast('Adicionado!');
            },

            updateStatus(id, field, value) {
                const t = this.data.tasks.find(x => x.id === id);
                if (t) { 
                    t[field] = value; 
                    this.saveData(); 
                }
            },

            archiveTask(id) {
                const idx = this.data.tasks.findIndex(x => x.id === id);
                if (idx > -1) {
                    const t = this.data.tasks[idx];
                    t.archivedDate = new Date().toISOString();
                    this.data.archived.unshift(t);
                    this.data.tasks.splice(idx, 1);
                    this.saveData();
                    this.showToast('Análise arquivada');
                }
            },
            
            restoreTask(id) {
                const idx = this.data.archived.findIndex(x => x.id === id);
                if (idx > -1) {
                    this.data.tasks.unshift(this.data.archived[idx]);
                    this.data.archived.splice(idx, 1);
                    this.saveData();
                    this.renderArchiveList(); // Atualiza lista do modal
                    this.showToast('Análise restaurada');
                }
            },

            // --- MODAL OCORRÊNCIAS (Específico) ---
            openOccurrenceModal(id) {
                // Procura em ativos ou arquivados
                let t = this.data.tasks.find(x => x.id === id) || this.data.archived.find(x => x.id === id);
                if(!t) return;
                
                document.getElementById('ocorrencia-current-task-id').value = id;
                document.getElementById('modal-condo-name').textContent = t.condominio;
                
                // Preenche Select
                const sel = document.getElementById('add-ocorrencia-categoria');
                sel.innerHTML = '';
                this.data.categories.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
                });

                this.renderModalList(t);
                this.openModalUI('ocorrencia-modal');
            },

            renderModalList(task) {
                const list = document.getElementById('ocorrencia-list');
                list.innerHTML = '';
                if(!task.ocorrencias) task.ocorrencias = [];
                
                if(task.ocorrencias.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-slate-400 italic">Nenhuma ocorrência registrada nesta data.</div>';
                }
                
                task.ocorrencias.forEach((oc, idx) => {
                    const el = document.createElement('div');
                    el.className = 'p-3 bg-white dark:bg-slate-800 rounded border-l-4 border-l-brand-orange border dark:border-slate-600 flex justify-between group shadow-sm';
                    el.innerHTML = `
                        <div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-slate-200 dark:border-slate-600 px-1 rounded">${oc.categoria}</span>
                            <p class="text-sm dark:text-white mt-1 font-medium">${oc.desc}</p>
                            <p class="text-xs text-slate-500 mt-1 font-mono flex items-center gap-1"><i class="ph ph-clock"></i> ${oc.horarioInicial} - ${oc.horarioFinal}</p>
                        </div>
                        <div class="flex items-start gap-2 ml-2">
                            <button onclick="App.editOccurrence('${task.id}', ${idx})" class="text-blue-400 hover:text-blue-600 p-1"><i class="ph ph-pencil-simple"></i></button>
                            <button onclick="App.deleteOccurrence('${task.id}', ${idx})" class="text-slate-400 hover:text-red-500 p-1"><i class="ph ph-x"></i></button>
                        </div>
                    `;
                    list.appendChild(el);
                });
            },

            addOccurrence() {
                const cat = document.getElementById('add-ocorrencia-categoria').value;
                const desc = document.getElementById('add-ocorrencia-desc').value;
                const ini = document.getElementById('add-horario-inicial').value || '00:00:00';
                const fim = document.getElementById('add-horario-final').value || '00:00:00';
                
                if(!desc) return alert('Preencha a descrição');
                
                const id = document.getElementById('ocorrencia-current-task-id').value;
                const t = this.data.tasks.find(x => x.id === id) || this.data.archived.find(x => x.id === id);
                
                if(t) {
                    if(!t.ocorrencias) t.ocorrencias = [];
                    t.ocorrencias.push({ categoria: cat, desc, horarioInicial: ini, horarioFinal: fim });
                    // Auto update status if not concluded
                    if(t.statusAnalise !== 'Concluída') t.statusAnalise = 'Em Análise';
                    
                    this.saveData();
                    this.renderModalList(t);
                    
                    // Limpa campos
                    document.getElementById('add-ocorrencia-desc').value = '';
                    document.getElementById('add-horario-inicial').value = '';
                    document.getElementById('add-horario-final').value = '';
                    document.getElementById('add-ocorrencia-desc').focus();
                }
            },
            
            deleteOccurrence(taskId, occIdx) {
                const t = this.data.tasks.find(x => x.id === taskId) || this.data.archived.find(x => x.id === taskId);
                if(t && t.ocorrencias) {
                    if(confirm('Deletar esta ocorrência?')) {
                        t.ocorrencias.splice(occIdx, 1);
                        this.saveData();
                        this.renderModalList(t);
                    }
                }
            },

            editOccurrence(taskId, occIdx) {
                const t = this.data.tasks.find(x => x.id === taskId) || this.data.archived.find(x => x.id === taskId);
                if(t && t.ocorrencias[occIdx]) {
                    const item = t.ocorrencias[occIdx];
                    document.getElementById('add-ocorrencia-categoria').value = item.categoria;
                    document.getElementById('add-ocorrencia-desc').value = item.desc;
                    document.getElementById('add-horario-inicial').value = item.horarioInicial;
                    document.getElementById('add-horario-final').value = item.horarioFinal;
                    // Remove para re-adicionar editado (padrão simples)
                    t.ocorrencias.splice(occIdx, 1);
                    this.saveData();
                    this.renderModalList(t);
                }
            },

            // --- IMPORTAÇÃO INTELIGENTE ---
            processExcel() {
                const text = document.getElementById('excel-paste-area').value;
                if(!text.trim()) return alert('Cole os dados no campo!');
                
                const rows = text.split('\n');
                let countNew = 0, countUpd = 0;

                rows.forEach(row => {
                    if(!row.trim()) return;
                    let cols = row.split('\t');
                    if(cols.length < 3) cols = row.split(/ {2,}/); // Tenta espaço duplo se tab falhar

                    // Validação básica da linha
                    const colData = cols[1]?.trim();
                    if(!colData || !colData.includes('/')) return; // Pula cabeçalhos ou lixo

                    // Extração e LIMPEZA (trim)
                    const week = cols[0]?.trim();
                    const dateRaw = cols[1]?.trim();
                    const condo = cols[2]?.trim();
                    
                    // Lógica para colunas variáveis (OC/Colaborador)
                    let oc = '0', colab = '', statusRaw = '';
                    const col3 = cols[3]?.trim();
                    
                    // Tenta adivinhar onde estão os dados baseado se é número ou texto
                    if(col3 && !isNaN(col3)) { 
                        oc = col3;
                        colab = cols[4]?.trim() || '';
                        statusRaw = cols[5]?.trim();
                    } else {
                        colab = col3;
                        statusRaw = cols[4]?.trim();
                    }

                    // Define status padrão se vazio
                    let status = statusRaw || 'Pendente';

                    if(status && status.includes('Finalizado')) status = 'Concluída';
                    
                    // Formata Data (dd/mm/yyyy -> yyyy-mm-dd)
                    const parts = dateRaw.split('/');
                    if(parts.length !== 3) return;
                    const dateIso = `${parts[2]}-${parts[1]}-${parts[0]}`;

                    // BUSCA EXISTENTE (Ignora Acentos/Case)
                    const existing = this.data.tasks.find(t => 
                        this.normalize(t.condominio) === this.normalize(condo) && 
                        t.dataAnalise === dateIso
                    );

                    if(existing) {
                        // ATUALIZA
                        existing.semana = week;
                        if(status === 'Concluída') existing.statusAnalise = 'Concluída';
                        
                        // Adiciona placeholders de ocorrências se o número importado for maior que o atual
                        const qtd = parseInt(oc);
                        const currentQtd = existing.ocorrencias ? existing.ocorrencias.length : 0;
                        if(qtd > currentQtd) {
                            for(let i=0; i < (qtd - currentQtd); i++) {
                                existing.ocorrencias.push({
                                    categoria: 'Importada', 
                                    desc: 'Ocorrência importada via Excel (pendente de preenchimento)', 
                                    horarioInicial: '00:00:00', 
                                    horarioFinal: '00:00:00'
                                });
                            }
                        }
                        countUpd++;
                    } else {
                        // CRIA NOVO
                        const newOcs = [];
                        const qtd = parseInt(oc);
                        if(qtd > 0) {
                            for(let i=0; i<qtd; i++) {
                                newOcs.push({
                                    categoria: 'Importada', 
                                    desc: 'Ocorrência importada via Excel', 
                                    horarioInicial: '00:00:00', 
                                    horarioFinal: '00:00:00'
                                });
                            }
                        }
                        
                        this.data.tasks.unshift({
                            id: this.generateId(),
                            condominio: condo,
                            dataAnalise: dateIso,
                            semana: week,
                            statusBackup: 'Pendente',
                            statusAnalise: status,
                            ocorrencias: newOcs,
                            observacoes: colab ? `Colab: ${colab}` : ''
                        });
                        countNew++;
                    }
                });

                this.saveData();
                this.closeModalUI('excel-import-modal');
                document.getElementById('excel-paste-area').value = '';
                this.showToast(`${countNew} criadas, ${countUpd} atualizadas`);
            },
            
            renderArchiveList() {
                 const list = document.getElementById('archive-list');
                 list.innerHTML = this.data.archived.map(t => `
                    <div class="flex justify-between items-center p-3 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                        <div>
                            <p class="font-bold dark:text-white text-sm">${t.condominio} <span class="text-xs font-normal text-slate-400 ml-2">(${t.semana||'N/A'})</span></p>
                            <p class="text-xs text-slate-500">${this.formatDate(t.dataAnalise)} - ${t.ocorrencias?.length||0} ocorrências</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="App.openOccurrenceModal('${t.id}')" class="text-xs text-brand-orange border border-brand-orange px-2 py-1 rounded hover:bg-orange-50 dark:hover:bg-slate-800">Ver</button>
                             <button onclick="App.restoreTask('${t.id}')" class="text-xs text-blue-500 border border-blue-500 px-2 py-1 rounded hover:bg-blue-50 dark:hover:bg-slate-800">Restaurar</button>
                        </div>
                    </div>
                 `).join('') || '<div class="text-center text-slate-400 py-4">O arquivo morto está vazio.</div>';
            },
            
            // --- CHARTS ---
            setupCharts() {
                Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#475569';
                
                const ctx = document.getElementById('ocorrenciasChart').getContext('2d');
                this.charts.oc = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Ocorrências', data: [], backgroundColor: '#f26324', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
                
                const ctxPeriod = document.getElementById('periodChart').getContext('2d');
                this.charts.period = new Chart(ctxPeriod, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Ocorrências', data: [], backgroundColor: '#f26324', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } }
                });
                
                const ctxCat = document.getElementById('periodCategoryChart').getContext('2d');
                this.charts.periodCategory = new Chart(ctxCat, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ label: 'Ocorrências', data: [], backgroundColor: ['#f26324', '#f7b41e', '#1e293b', '#10b981', '#6366f1', '#ef4444', '#8b5cf6'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            },

            updateCharts() {
                // CORREÇÃO: Evita atualizar gráficos que não existem
                if(!this.charts.oc || !this.charts.oc.canvas) return;
                
                const counts = {};
                this.data.tasks.forEach(t => {
                    if(t.ocorrencias?.length) counts[t.condominio] = (counts[t.condominio] || 0) + t.ocorrencias.length;
                });
                // Top 5 condomínios
                const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
                this.charts.oc.data.labels = sorted.map(x => x[0]);
                this.charts.oc.data.datasets[0].data = sorted.map(x => x[1]);
                this.charts.oc.update();
            },

            // --- EVENTOS ---
            setupTheme() {
                 if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                 }
            },
            setupDate() {
                 document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
            },
            
            events: {
                setup() {
                    // Filtros
                    ['filtro-condominio', 'filtro-backup', 'filtro-analise'].forEach(id => 
                        document.getElementById(id).addEventListener('input', () => App.render())
                    );

                    // Modal Adicionar Tarefa
                    document.getElementById('add-task-btn').addEventListener('click', () => {
                        document.getElementById('task-form').reset();
                        document.getElementById('form-data-analise').valueAsDate = new Date();
                        App.openModalUI('task-modal');
                    });
                    document.getElementById('cancel-btn').addEventListener('click', () => App.closeModalUI('task-modal'));
                    
                    document.getElementById('task-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        App.addTask({
                            condominio: document.getElementById('form-condominio').value,
                            dataAnalise: document.getElementById('form-data-analise').value,
                            semana: document.getElementById('form-semana').value,
                            observacoes: document.getElementById('form-observacoes').value
                        });
                        App.closeModalUI('task-modal');
                    });

                    // Menu Ações
                    document.getElementById('actions-menu-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.getElementById('actions-menu').classList.toggle('hidden');
                    });
                    document.body.addEventListener('click', () => document.getElementById('actions-menu').classList.add('hidden'));

                    // Importar Excel
                    document.getElementById('excel-import-btn').addEventListener('click', () => App.openModalUI('excel-import-modal'));
                    document.getElementById('excel-import-close-btn').addEventListener('click', () => App.closeModalUI('excel-import-modal'));
                    document.getElementById('process-import-btn').addEventListener('click', () => App.processExcel());

                    // Ocorrências
                    document.getElementById('add-ocorrencia-btn').addEventListener('click', () => App.addOccurrence());
                    document.getElementById('save-ocorrencias-btn').addEventListener('click', () => {
                        App.saveData();
                        App.closeModalUI('ocorrencia-modal');
                        App.showToast('Ocorrências salvas!');
                    });
                    document.getElementById('ocorrencia-cancel-btn').addEventListener('click', () => App.closeModalUI('ocorrencia-modal'));

                    // Arquivo Morto
                    document.getElementById('archive-btn').addEventListener('click', () => {
                        App.renderArchiveList();
                        App.openModalUI('archive-modal');
                    });
                    document.getElementById('archive-close-btn').addEventListener('click', () => App.closeModalUI('archive-modal'));
                    document.getElementById('clear-archive-btn').addEventListener('click', () => {
                        if(confirm('Tem certeza? Isso apagará todo o histórico antigo permanentemente.')) {
                            App.data.archived = [];
                            App.saveData();
                            App.renderArchiveList();
                            App.showToast('Histórico limpo.');
                        }
                    });

                    // Backup (JSON)
                    document.getElementById('export-data-btn').addEventListener('click', () => App.exportData());
                    document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('file-input').click());
                    document.getElementById('file-input').addEventListener('change', (e) => App.importData(e));

                    // Theme Toggle
                    document.getElementById('theme-toggle').addEventListener('click', () => {
                        document.documentElement.classList.toggle('dark');
                        localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                        // Update chart colors
                        Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#475569';
                        App.updateCharts();
                    });

                    // Period Report - Lógica do relatório
                    document.getElementById('period-analysis-btn').addEventListener('click', () => App.openModalUI('period-analysis-modal'));
                    document.getElementById('period-analysis-close-btn').addEventListener('click', () => App.closeModalUI('period-analysis-modal'));
                    
                    // Date presets
                    const setPeriodDates = (type) => {
                        const today = new Date();
                        let start = new Date(today), end = new Date(today);
                        if(type==='week') { 
                            const day = today.getDay() || 7; 
                            if(day !== 1) start.setHours(-24 * (day - 1)); 
                            end.setHours(24 * (7 - day));
                        }
                        if(type==='month') { start.setDate(1); end = new Date(today.getFullYear(), today.getMonth()+1, 0); }
                        if(type==='year') { start.setMonth(0,1); end.setMonth(11,31); }
                        
                        document.getElementById('period-start-date').value = start.toISOString().split('T')[0];
                        document.getElementById('period-end-date').value = end.toISOString().split('T')[0];
                    };
                    document.getElementById('preset-week-btn').addEventListener('click', ()=>setPeriodDates('week'));
                    document.getElementById('preset-month-btn').addEventListener('click', ()=>setPeriodDates('month'));
                    document.getElementById('preset-year-btn').addEventListener('click', ()=>setPeriodDates('year'));

                    document.getElementById('generate-report-btn').addEventListener('click', () => {
                        const s = document.getElementById('period-start-date').value;
                        const e = document.getElementById('period-end-date').value;
                        if(!s || !e) return alert('Selecione as datas de início e fim');
                        
                        // Filtra tarefas (inclusive arquivadas para relatório completo)
                        const allTasks = [...App.data.tasks, ...App.data.archived];
                        const filtered = allTasks.filter(t => t.dataAnalise >= s && t.dataAnalise <= e);
                        const concl = filtered.filter(t => t.statusAnalise === 'Concluída');
                        
                        document.getElementById('period-results-content').classList.remove('hidden');
                        document.getElementById('period-total').textContent = filtered.length;
                        document.getElementById('period-concluidas').textContent = concl.length;
                        document.getElementById('period-oc').textContent = filtered.reduce((acc,t)=>acc+(t.ocorrencias?.length||0),0);

                        // Atualiza gráficos do modal
                        const counts = {}, cats = {};
                        filtered.forEach(t => {
                            if(t.ocorrencias?.length) {
                                counts[t.condominio] = (counts[t.condominio]||0) + t.ocorrencias.length;
                                t.ocorrencias.forEach(o => cats[o.categoria] = (cats[o.categoria]||0)+1);
                            }
                        });
                        
                        App.charts.period.data.labels = Object.keys(counts);
                        App.charts.period.data.datasets[0].data = Object.values(counts);
                        App.charts.period.update();
                        
                        App.charts.periodCategory.data.labels = Object.keys(cats);
                        App.charts.periodCategory.data.datasets[0].data = Object.values(cats);
                        App.charts.periodCategory.update();
                        
                        document.getElementById('period-task-list').innerHTML = filtered.length > 0 ? filtered.map(t => 
                            `<li class="border-b border-slate-200 dark:border-slate-700 pb-1 flex justify-between items-center">
                                <span>${t.condominio} <span class="text-xs text-slate-400 ml-1">(${App.formatDate(t.dataAnalise)})</span></span> 
                                <span class="font-bold ${t.ocorrencias?.length > 0 ? 'text-red-500' : 'text-green-500'}">${t.ocorrencias?.length||0} Ocs</span>
                            </li>`
                        ).join('') : '<li class="text-center text-slate-400">Nenhum dado neste período.</li>';
                    });
                }
            }
        };

        // Start
        window.App = App; // Expor para onclicks inline
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
