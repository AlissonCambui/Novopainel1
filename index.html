<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento</title>
    
    <!-- Fonte Inter (Padr√£o Moderno) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com" onerror="handleResourceError('Tailwind CSS')"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="handleResourceError('Chart.js')"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns" onerror="handleResourceError('Date Adapter')"></script>
    
    <style>
        /* Estilo Global Refinado */
        body { 
            background-color: #0f172a; 
            color: #cbd5e1; 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estiliza√ß√£o dos Selects */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }

        /* Classes de Privacidade */
        .privacy-active .sensitive-data { filter: blur(5px); transition: filter 0.3s; }
        .privacy-active .sensitive-data:hover { filter: blur(0); }
        
        /* Modal de Erro */
        #resource-error-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
        .error-content { background: #1e293b; padding: 2rem; border-radius: 16px; border: 1px solid #ef4444; text-align: center; max-width: 400px; }
    </style>

    <script>
        function handleResourceError(res) {
            const m = document.getElementById('resource-error-modal');
            if(m) { m.style.display = 'flex'; document.getElementById('err-msg').innerText = res; }
        }
    </script>
</head>
<body class="bg-slate-950 antialiased selection:bg-indigo-500 selection:text-white">

    <div id="resource-error-modal"><div class="error-content"><h2 class="text-red-500 text-xl font-bold mb-2">Erro de Carregamento</h2><p class="text-slate-300 mb-4">Falha ao carregar: <span id="err-msg"></span>. Desative bloqueadores de an√∫ncio.</p><button onclick="location.reload()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold">Recarregar</button></div></div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        
        <!-- Header Moderno -->
        <header class="mb-10 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight flex items-center gap-2">
                    <span class="text-indigo-500">vend</span><span class="text-amber-400">Perto</span>
                    <span class="text-slate-600 text-sm font-normal ml-2 bg-slate-900 px-2 py-1 rounded-full border border-slate-800">v3.0</span>
                </h1>
                <p class="text-slate-400 mt-1 font-medium">Painel de Monitoramento Inteligente</p>
            </div>
            
            <div class="flex gap-3">
                <button id="privacy-toggle-btn" class="flex items-center gap-2 bg-slate-900/50 border border-slate-700/50 text-slate-300 px-4 py-2 rounded-full hover:bg-slate-800 hover:border-slate-600 transition-all active:scale-95">
                    <span id="privacy-icon">üëÅÔ∏è</span> <span class="text-sm font-semibold">Privacidade</span>
                </button>
            </div>
        </header>

        <!-- Dashboard KPIs -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
            <div class="bg-slate-800/40 p-5 rounded-2xl border border-slate-700/50 backdrop-blur-sm hover:bg-slate-800/60 transition-colors">
                <h3 class="text-[11px] font-bold uppercase tracking-wider text-slate-400 mb-1">An√°lises Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-white">0</p>
            </div>
            <div class="bg-slate-800/40 p-5 rounded-2xl border border-slate-700/50 backdrop-blur-sm hover:bg-slate-800/60 transition-colors">
                <h3 class="text-[11px] font-bold uppercase tracking-wider text-slate-400 mb-1">Backups Pendentes</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-400">0</p>
            </div>
            <div class="bg-slate-800/40 p-5 rounded-2xl border border-slate-700/50 backdrop-blur-sm hover:bg-slate-800/60 transition-colors relative overflow-hidden">
                <div class="absolute top-0 right-0 w-16 h-16 bg-emerald-500/10 rounded-bl-full -mr-4 -mt-4"></div>
                <h3 class="text-[11px] font-bold uppercase tracking-wider text-slate-400 mb-1">Conclu√≠das (Semana)</h3>
                <p id="analises-concluidas" class="text-3xl font-bold text-emerald-400">0</p>
            </div>
            <div class="bg-slate-800/40 p-5 rounded-2xl border border-slate-700/50 backdrop-blur-sm hover:bg-slate-800/60 transition-colors">
                <h3 class="text-[11px] font-bold uppercase tracking-wider text-slate-400 mb-1">Ocorr√™ncias (Semana)</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-white">0</p>
            </div>
        </section>

        <!-- Barra de Ferramentas -->
        <section class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800 mb-8 backdrop-blur-sm sticky top-2 z-30 shadow-2xl shadow-black/20">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Filtros -->
                <div class="flex flex-wrap items-center gap-3 flex-grow">
                    <div class="relative flex-grow md:flex-grow-0 md:w-64">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">üîé</span>
                        <input type="text" id="filtro-condominio" placeholder="Buscar Unidade..." class="w-full bg-slate-950 border border-slate-700 rounded-xl py-2 pl-9 pr-3 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                    </div>
                    <input type="number" id="filtro-semana" placeholder="Semana" class="w-24 bg-slate-950 border border-slate-700 rounded-xl py-2 px-3 text-sm text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-center">
                    <select id="filtro-analise" class="bg-slate-950 border border-slate-700 rounded-xl py-2 pl-3 pr-8 text-sm text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all cursor-pointer">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Conclu√≠da">Conclu√≠da</option>
                    </select>
                </div>
                
                <!-- Bot√µes Principais -->
                <div class="flex gap-3 w-full md:w-auto">
                    <button id="add-task-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-5 py-2 rounded-xl transition-all shadow-lg shadow-indigo-900/30 active:scale-95 flex items-center justify-center gap-2 flex-grow md:flex-grow-0">
                        <span class="text-lg leading-none">+</span> Nova
                    </button>
                    
                    <div class="relative" id="actions-menu-container">
                        <button id="actions-menu-btn" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200 font-medium px-4 py-2 rounded-xl transition-all flex items-center gap-2 h-full">
                            <span>A√ß√µes</span> <span class="text-xs opacity-50">‚ñº</span>
                        </button>
                        <!-- Dropdown -->
                        <div id="actions-menu" class="absolute right-0 mt-2 w-56 bg-slate-800 rounded-xl border border-slate-700 shadow-2xl hidden z-50 overflow-hidden">
                            <button id="archive-week-btn" class="w-full text-left px-4 py-3 text-sm font-semibold text-amber-400 hover:bg-slate-700 transition-colors">üì¶ Fechar Semana</button>
                            <div class="h-px bg-slate-700 mx-2"></div>
                            <button id="period-analysis-btn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">üìä An√°lise Per√≠odo</button>
                            <button id="annual-report-btn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">üìà Relat√≥rio Anual</button>
                            <div class="h-px bg-slate-700 mx-2"></div>
                            <button id="bulk-add-btn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">üìë Importar Excel</button>
                            <button id="rename-condo-btn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">‚úèÔ∏è Renomear</button>
                            <button id="archive-btn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">üìÇ Arquivos</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Tarefas -->
        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-12"></main>
        
        <!-- Gr√°fico -->
        <section class="bg-slate-800/40 p-6 rounded-3xl border border-slate-700/50">
            <h2 class="text-xl font-bold text-center mb-6 text-white">Ocorr√™ncias da Semana</h2>
            <div class="flex justify-center">
                <div class="chart-container w-full max-w-2xl"><canvas id="ocorrenciasChart"></canvas></div>
            </div>
        </section>
    </div>

    <!-- MODAIS -->
    
    <!-- Nova An√°lise -->
    <div id="task-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-slate-900 rounded-2xl border border-slate-700 w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-5">Nova An√°lise</h2>
            <form id="task-form" class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Condom√≠nio</label><input type="text" id="form-condominio" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Data do V√≠deo</label><input type="date" id="form-data-analise" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none" required></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Semana</label><input type="number" id="form-semana-trabalho" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Observa√ß√µes</label><textarea id="form-observacoes" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none"></textarea></div>
                <div class="flex justify-end gap-2 pt-2"><button type="button" id="cancel-btn" class="px-4 py-2 bg-slate-800 text-slate-300 rounded-xl hover:bg-slate-700 font-medium">Cancelar</button><button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 font-bold shadow-lg shadow-indigo-900/50">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Ocorr√™ncias -->
    <div id="ocorrencia-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
        <div class="bg-slate-900 rounded-2xl border border-slate-700 w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b border-slate-800"><h2 class="text-xl font-bold text-white">Registrar Ocorr√™ncias</h2></div>
            <div id="ocorrencia-list" class="flex-grow overflow-y-auto p-6 space-y-3"></div>
            <div class="p-6 bg-slate-800/50 border-t border-slate-800">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                    <div class="md:col-span-4"><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Tipo</label><select id="add-ocorrencia-categoria" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"></select></div>
                    <div class="md:col-span-4"><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Descri√ß√£o</label><input type="text" id="add-ocorrencia-desc" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">In√≠cio</label><input type="time" id="add-horario-inicial" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-sm text-white"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Fim</label><input type="time" id="add-horario-final" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-sm text-white"></div>
                </div>
                <button type="button" id="add-ocorrencia-btn" class="w-full bg-slate-700 border border-slate-600 text-white font-semibold py-2.5 rounded-xl hover:bg-slate-600 transition-colors flex justify-center items-center gap-2"><span>+</span> Adicionar</button>
                <div class="flex justify-end gap-3 mt-6"><button type="button" id="ocorrencia-cancel-btn" class="px-5 py-2.5 bg-slate-800 text-slate-300 rounded-xl hover:bg-slate-700">Fechar</button><button type="submit" form="ocorrencia-form" class="px-6 py-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-500 font-bold shadow-lg">Salvar Altera√ß√µes</button></div>
            </div>
            <form id="ocorrencia-form" class="hidden"></form>
        </div>
    </div>

    <!-- Importar -->
    <div id="bulk-add-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
        <div class="bg-slate-900 rounded-2xl border border-slate-700 w-full max-w-xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-2">Importar Planilha</h2>
            <p class="text-sm text-slate-400 mb-4">Copie do Excel e cole abaixo. Ordem: <br><code class="bg-slate-800 px-1 rounded text-xs">Semana | Data | Unidade | OC | Colaborador | Status</code></p>
            <form id="bulk-add-form">
                <textarea id="bulk-input-area" rows="8" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs font-mono text-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none placeholder-slate-600" placeholder="Cole aqui os dados..."></textarea>
                <div class="flex justify-end gap-3 mt-4"><button type="button" id="bulk-cancel-btn" class="px-4 py-2 bg-slate-800 text-slate-300 rounded-xl hover:bg-slate-700">Cancelar</button><button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 font-bold">Importar Dados</button></div>
            </form>
        </div>
    </div>

    <!-- Utilit√°rios -->
    <div id="notification-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-4 hidden z-[60]"><div class="bg-slate-800 p-8 rounded-2xl border border-slate-600 text-center max-w-sm"><div class="text-4xl mb-4">üîî</div><p id="notification-message" class="mb-6 text-white text-lg font-medium"></p><button id="notification-close-btn" class="bg-indigo-600 text-white px-8 py-2.5 rounded-xl font-bold hover:bg-indigo-500 w-full">Entendi</button></div></div>
    <div id="archive-week-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-96 shadow-2xl"><h2 class="text-xl font-bold text-white mb-2">Fechar Semana</h2><p class="text-sm text-slate-400 mb-6">Isso move as an√°lises da semana escolhida para o arquivo morto.</p><div class="mb-6"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Semana</label><input type="number" id="archive-week-input" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white font-bold text-xl text-center focus:ring-2 focus:ring-indigo-500 outline-none"></div><div class="flex gap-2"><button id="archive-week-cancel-btn" class="flex-1 bg-slate-800 text-slate-300 py-2.5 rounded-xl hover:bg-slate-700">Cancelar</button><button id="archive-week-confirm-btn" class="flex-1 bg-amber-600 text-white py-2.5 rounded-xl hover:bg-amber-500 font-bold">Arquivar</button></div></div></div>
    
    <!-- An√°lise por Per√≠odo -->
    <div id="period-analysis-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-full max-w-4xl h-[85vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-white">Relat√≥rio por Per√≠odo</h2><button id="period-analysis-close-btn" class="text-slate-400 hover:text-white text-2xl">&times;</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div><label class="text-xs font-bold text-slate-500 uppercase">In√≠cio</label><input type="date" id="period-start-date" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white mt-1"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Fim</label><input type="date" id="period-end-date" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white mt-1"></div><div class="flex items-end"><button id="generate-report-btn" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-xl hover:bg-indigo-500">Filtrar</button></div></div><div class="flex gap-6 mb-4 px-2"><label class="flex items-center cursor-pointer gap-2"><input type="radio" name="analysis_type" value="dataAnalise" class="accent-indigo-500" checked><span class="text-sm text-slate-300">Data do V√≠deo</span></label><label class="flex items-center cursor-pointer gap-2"><input type="radio" name="analysis_type" value="dataConclusao" class="accent-indigo-500"><span class="text-sm text-slate-300">Data da Conclus√£o</span></label></div><div class="flex gap-2 mb-6 overflow-x-auto pb-2"><button data-period="today" class="period-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Hoje</button><button data-period="yesterday" class="period-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Ontem</button><button data-period="this-week" class="period-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Esta Semana</button><button data-period="this-month" class="period-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Este M√™s</button></div><div id="period-results-content" class="hidden flex-grow overflow-y-auto pr-2"><div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 text-center"><div class="text-xs font-bold text-slate-500 uppercase">Dias</div><div id="period-dias" class="text-2xl font-bold text-indigo-400">0</div></div><div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 text-center"><div class="text-xs font-bold text-slate-500 uppercase">Unidades</div><div id="period-pdv" class="text-2xl font-bold text-amber-400">0</div></div><div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 text-center"><div class="text-xs font-bold text-slate-500 uppercase">Ocorr√™ncias</div><div id="period-oc" class="text-2xl font-bold text-red-400">0</div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700"><div class="chart-container" style="height: 200px;"><canvas id="periodChart"></canvas></div></div><div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700"><div class="chart-container" style="height: 200px;"><canvas id="periodCategoryChart"></canvas></div></div></div><h3 class="text-white font-bold mb-3 pl-1">Extrato Detalhado</h3><ul id="period-task-list" class="bg-slate-800 rounded-2xl p-2 space-y-1 border border-slate-700"></ul></div></div></div>

    <!-- Modais Extras -->
    <div id="archive-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-80"><h2 class="text-white font-bold mb-4">Arquivos</h2><button id="view-archive-btn" class="w-full bg-slate-800 text-white py-3 rounded-xl mb-2 hover:bg-slate-700">Ver Arquivo Morto</button><button id="archive-cancel-btn" class="w-full border border-slate-700 text-slate-400 py-2 rounded-xl">Fechar</button></div></div>
    <div id="view-archive-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-full max-w-2xl h-4/5 flex flex-col"><div class="flex justify-between mb-4"><h2 class="text-white font-bold">Arquivo Morto</h2><button id="view-archive-close-btn" class="text-white text-2xl">&times;</button></div><input id="archive-search-input" class="bg-slate-800 border-slate-700 text-white p-3 rounded-xl mb-4 outline-none" placeholder="Buscar no arquivo..."><div id="view-archive-list-container" class="flex-grow overflow-y-auto bg-slate-950 p-2 rounded-xl border border-slate-800"></div></div></div>
    <div id="rename-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-96"><h2 class="text-white font-bold mb-4">Renomear</h2><form id="rename-form" class="space-y-3"><select id="form-old-name" class="w-full bg-slate-800 text-white p-3 rounded-xl border border-slate-700"></select><input id="form-new-name" class="w-full bg-slate-800 text-white p-3 rounded-xl border border-slate-700" placeholder="Novo nome"><div class="flex gap-2 justify-end pt-2"><button type="button" id="rename-cancel-btn" class="bg-slate-800 text-slate-300 px-4 py-2 rounded-xl">Cancelar</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold">Salvar</button></div></form></div></div>
    <div id="restore-confirm-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-80 text-center"><h2 class="text-red-500 text-xl font-bold mb-2">Cuidado!</h2><p class="text-slate-400 text-sm mb-4">Isso substituir√° TODOS os dados atuais pelos do backup. Continuar?</p><div class="flex gap-2 justify-center"><button id="restore-confirm-cancel-btn" class="bg-slate-800 text-white px-4 py-2 rounded-xl">N√£o</button><button id="restore-confirm-proceed-btn" class="bg-red-600 text-white px-4 py-2 rounded-xl font-bold">Sim</button></div></div></div>
    <div id="annual-report-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-full max-w-5xl h-5/6 flex flex-col"><div class="flex justify-between mb-4"><h2 class="text-white font-bold text-xl">Relat√≥rio Anual</h2><button id="annual-report-close-btn" class="text-white text-2xl">&times;</button></div><div class="chart-container flex-grow"><canvas id="annualReportChart_Monthly"></canvas></div></div></div>

    <input type="file" id="restore-input" class="hidden" accept=".json">

    <script>
        Chart.defaults.color = '#94a3b8'; 
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'Inter', sans-serif";

        const statusClasses = {
            'Pendente': 'bg-slate-800 text-slate-400 border border-slate-700',
            'Em Andamento': 'bg-amber-500/10 text-amber-400 border border-amber-500/20',
            'Em An√°lise': 'bg-blue-500/10 text-blue-400 border border-blue-500/20',
            'Conclu√≠do': 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20',
            'Conclu√≠da': 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20'
        };

        document.addEventListener('DOMContentLoaded', () => {
            let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
            let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
            let categories = JSON.parse(localStorage.getItem('monitoramentoCategorias')) || ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Outros'];
            let ocorrenciasChart, annualMonthlyChart, periodChart, periodCategoryChart;

            // FUN√á√ïES AUXILIARES
            const saveTasks = () => {
                localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            };

            const showNotification = (msg) => {
                document.getElementById('notification-message').textContent = msg;
                document.getElementById('notification-modal').classList.remove('hidden');
            };

            const escapeHtml = (unsafe) => (unsafe || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            const formatDate = (dStr) => { if(!dStr) return '-'; const d = new Date(dStr + 'T00:00:00'); d.setDate(d.getDate()+1); return d.toLocaleDateString('pt-BR'); };
            const formatDateForInput = (d) => d.toISOString().split('T')[0];
            
            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            const safeSetText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };

            const checkAndRunAutoArchive = () => {
                const currentWeek = getWeekNumber(new Date());
                const lastArchiveWeek = localStorage.getItem('lastAutoArchiveWeek');
                if (lastArchiveWeek != currentWeek) {
                    const targetWeek = currentWeek === 1 ? 52 : currentWeek - 1; 
                    const tasksToArchive = tasks.filter(t => t.semanaDeTrabalho === targetWeek);
                    if (tasksToArchive.length > 0) {
                        archivedTasks.push(...tasksToArchive);
                        tasks = tasks.filter(t => t.semanaDeTrabalho !== targetWeek);
                        saveTasks();
                        showNotification(`üîÑ Virada de Semana!\n${tasksToArchive.length} an√°lises da Semana ${targetWeek} foram arquivadas.`);
                    }
                    localStorage.setItem('lastAutoArchiveWeek', currentWeek);
                }
            };

            const renderOcorrenciaItemInModal = (ocor, container) => {
                const d = document.createElement('div');
                d.className = 'occ-data-item p-3 bg-slate-800 rounded-xl border border-slate-700 flex justify-between items-center';
                d.dataset.json = JSON.stringify(ocor);
                d.innerHTML = `<div><span class="text-amber-400 font-bold text-xs uppercase">${escapeHtml(ocor.categoria)}</span><p class="text-slate-300 text-sm sensitive-data">${escapeHtml(ocor.desc)}</p><span class="text-slate-500 text-[10px] font-mono">${escapeHtml(ocor.horarioInicial)} - ${escapeHtml(ocor.horarioFinal)}</span></div><button class="text-slate-500 hover:text-red-400 p-2" onclick="this.parentElement.remove()">‚úï</button>`;
                container.appendChild(d);
            };

            const populateCategorySelect = (sel) => {
                sel.innerHTML = '';
                categories.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
            };

            // RENDER E UPDATE (Definidos antes do uso)
            const renderTasks = () => {
                const filter = document.getElementById('filtro-condominio')?.value.toLowerCase() || '';
                const weekFilter = document.getElementById('filtro-semana')?.value;
                const statusFilter = document.getElementById('filtro-analise')?.value;
                const list = document.getElementById('task-list');
                if(!list) return;
                list.innerHTML = '';

                const filtered = tasks.filter(t => {
                    return t.condominio.toLowerCase().includes(filter) &&
                           (!weekFilter || t.semanaDeTrabalho == weekFilter) &&
                           (!statusFilter || t.statusAnalise === statusFilter || (statusFilter==='Conclu√≠da' && t.statusAnalise==='Conclu√≠da'));
                });

                if(!filtered.length) { list.innerHTML = '<div class="col-span-full py-12 text-center"><div class="text-4xl mb-2">üì≠</div><p class="text-slate-500">Nenhuma an√°lise encontrada.</p></div>'; return; }

                filtered.forEach(t => {
                    const card = document.createElement('div');
                    let borderColor = 'border-l-slate-600'; 
                    if(t.statusAnalise === 'Em An√°lise') borderColor = 'border-l-indigo-500';
                    if(t.statusAnalise === 'Conclu√≠da') borderColor = 'border-l-emerald-500';

                    card.className = `bg-slate-800/60 backdrop-blur-md rounded-2xl p-5 shadow-lg border border-slate-700/50 ${borderColor} border-l-4 hover:bg-slate-800/80 transition-all group`;
                    
                    const ocHtml = t.ocorrencias?.length 
                        ? `<div class="mt-4 space-y-2 bg-slate-900/50 p-3 rounded-xl border border-slate-700/50">${t.ocorrencias.map(o=>`<div class="flex gap-2 text-xs"><span class="text-red-400 font-bold">‚Ä¢</span><span class="text-slate-300 sensitive-data">${escapeHtml(o.categoria)}: ${escapeHtml(o.desc)}</span></div>`).join('')}</div>` 
                        : '';
                    
                    const btnHtml = (t.statusAnalise === 'Em An√°lise' || t.statusAnalise === 'Conclu√≠da')
                        ? `<button data-id="${t.id}" class="edit-oc-btn mt-4 w-full py-2.5 rounded-xl bg-slate-700/50 hover:bg-slate-700 text-indigo-300 text-xs font-bold uppercase tracking-wider border border-slate-600 transition-all flex items-center justify-center gap-2 group-hover:border-indigo-500/30">${t.statusAnalise==='Conclu√≠da'?'Ver Ocorr√™ncias':'Registrar Ocorr√™ncias'} <span>‚Ä∫</span></button>`
                        : '';
                    
                    const makeOption = (val, current, label) => `<option value="${val}" class="bg-slate-900" ${current === val ? 'selected' : ''}>${label}</option>`;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg text-white sensitive-data tracking-tight leading-tight" title="${escapeHtml(t.condominio)}">${escapeHtml(t.condominio)}</h3>
                                <div class="flex items-center gap-2 mt-1.5">
                                    <span class="text-[10px] font-mono bg-slate-900/80 text-slate-400 px-2 py-1 rounded-md border border-slate-700">${formatDate(t.dataAnalise)}</span>
                                    <span class="text-[10px] font-bold bg-indigo-500/10 text-indigo-300 px-2 py-1 rounded-md border border-indigo-500/20">SEM ${t.semanaDeTrabalho}</span>
                                </div>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button data-id="${t.id}" class="archive-btn p-1.5 text-slate-500 hover:text-indigo-400 hover:bg-slate-700 rounded-lg transition-colors" title="Arquivar">üì•</button>
                                <button data-id="${t.id}" class="del-btn p-1.5 text-slate-500 hover:text-red-400 hover:bg-slate-700 rounded-lg transition-colors" title="Excluir">‚úï</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Backup</label><select data-id="${t.id}" data-type="backup" class="status-sel w-full text-xs font-medium bg-slate-900/50 rounded-lg px-2 py-2 border border-slate-700 outline-none focus:border-indigo-500 transition-colors cursor-pointer ${statusClasses[t.statusBackup]}">${makeOption('Pendente', t.statusBackup, 'Pendente')}${makeOption('Em Andamento', t.statusBackup, 'Baixando')}${makeOption('Conclu√≠do', t.statusBackup, 'Conclu√≠do')}</select></div>
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">An√°lise</label><select data-id="${t.id}" data-type="analise" class="status-sel w-full text-xs font-medium bg-slate-900/50 rounded-lg px-2 py-2 border border-slate-700 outline-none focus:border-indigo-500 transition-colors cursor-pointer ${statusClasses[t.statusAnalise]}">${makeOption('Pendente', t.statusAnalise, 'Pendente')}${makeOption('Em An√°lise', t.statusAnalise, 'Analisando')}${makeOption('Conclu√≠da', t.statusAnalise, 'Conclu√≠da')}</select></div>
                        </div>
                        <div class="${!t.isExpanded?'hidden':''} transition-all duration-300">${ocHtml}${btnHtml}</div>
                        <button data-id="${t.id}" class="toggle-btn w-full mt-3 pt-2 border-t border-slate-700/50 text-[10px] font-bold text-slate-500 hover:text-slate-300 uppercase tracking-widest transition-colors">${t.isExpanded?'Menos ‚ñ≤':'Mais ‚ñº'}</button>
                    `;
                    list.appendChild(card);
                });
            };

            const updateDashboard = () => {
                const active = tasks.filter(t => t.statusAnalise !== 'Arquivado');
                safeSetText('total-solicitacoes', active.length);
                safeSetText('backups-pendentes', active.filter(t => t.statusBackup === 'Pendente').length);
                
                const now = new Date();
                const currentWeekNum = getWeekNumber(now);
                const currentYear = now.getFullYear();
                const doneThisWeek = active.filter(t => {
                    if(t.statusAnalise !== 'Conclu√≠da' || !t.completedAt) return false;
                    const dDate = new Date(t.completedAt);
                    return getWeekNumber(dDate) === currentWeekNum && dDate.getFullYear() === currentYear;
                });
                safeSetText('analises-concluidas', doneThisWeek.length);
                
                const ocsThisWeek = active.filter(t => t.semanaDeTrabalho === currentWeekNum).reduce((acc, t) => acc + (t.ocorrencias?.length||0), 0);
                safeSetText('total-ocorrencias-semana', ocsThisWeek);
            };

            const refreshUI = () => {
                saveTasks();
                renderTasks();
                updateDashboard();
                const data = tasks.reduce((acc, t) => { if(t.ocorrencias?.length) acc[t.condominio] = (acc[t.condominio]||0) + t.ocorrencias.length; return acc; }, {});
                if(ocorrenciasChart) {
                    ocorrenciasChart.data.labels = Object.keys(data);
                    ocorrenciasChart.data.datasets[0].data = Object.values(data);
                    ocorrenciasChart.update();
                }
            };

            // LISTENERS & HANDLERS
            function handleTaskSubmit(e) {
                e.preventDefault();
                const newTask = { id: Date.now(), condominio: document.getElementById('form-condominio').value, dataAnalise: document.getElementById('form-data-analise').value, semanaDeTrabalho: parseInt(document.getElementById('form-semana-trabalho').value) || getWeekNumber(new Date()), observacoes: document.getElementById('form-observacoes').value, statusBackup: 'Pendente', statusAnalise: 'Pendente', ocorrencia: 'Pendente', completedAt: null, isExpanded: true, ocorrencias: [] };
                tasks.unshift(newTask); refreshUI(); document.getElementById('task-modal').classList.add('hidden'); showNotification('An√°lise criada.');
            }

            function handleBulkAddSubmit(e) {
                e.preventDefault();
                const input = document.getElementById('bulk-input-area').value.trim();
                if(!input) return showNotification('Cole os dados.');
                const lines = input.split('\n').filter(l => l.trim().length > 0);
                const newTasks = [];
                const fallbackRegex = /^(Semana\s+\d+)\s+([0-9]{1,2}\/[0-9]{1,2}\/[0-9]{4})\s+(.+?)\s*(\d*)\s*([A-Za-z\s]+?)\s*(Finalizado|Pendente|Sem grava√ß√£o.*)?$/i;
                lines.forEach((line, i) => {
                    let p = line.split('\t');
                    if(p.length < 3) { const m = line.match(fallbackRegex); if(m) p = [m[1],m[2],m[3],m[4],m[5],m[6]]; else p = line.split(/\s{2,}/); }
                    if(p.length < 3 || (p[0]||'').toLowerCase().includes('semana')) return;
                    let isoDate = new Date().toISOString().split('T')[0];
                    if((p[1]||'').includes('/')) { const [d,m,y] = p[1].split('/'); isoDate = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`; }
                    if(tasks.some(t => t.condominio.toLowerCase() === (p[2]||'').trim().toLowerCase() && t.dataAnalise === isoDate)) return;
                    const stRaw = (p[5]||'Pendente').trim();
                    const isDone = stRaw.toLowerCase().includes('finalizado') || stRaw.toLowerCase().includes('concluid');
                    const ocNum = parseInt(p[3]||'0');
                    newTasks.push({ id: Date.now() + i + Math.floor(Math.random()*1000), condominio: (p[2]||'').trim(), dataAnalise: isoDate, semanaDeTrabalho: parseInt((p[0]||'').match(/\d+/)?.[0] || getWeekNumber(new Date())), observacoes: `Imp: ${p[4]||''} - Status Orig: ${stRaw}`, statusBackup: isDone ? 'Conclu√≠do' : 'Pendente', statusAnalise: isDone ? 'Conclu√≠da' : 'Pendente', completedAt: isDone ? new Date().toISOString() : null, ocorrencia: ocNum > 0 ? 'Sim' : 'N√£o', isExpanded: true, ocorrencias: ocNum > 0 ? [{ categoria: 'Importado', desc: `OC ${ocNum} - ${p[4]||''}`, horarioInicial:'00:00', horarioFinal:'00:00' }] : [] });
                });
                if(newTasks.length) { tasks.unshift(...newTasks); refreshUI(); document.getElementById('bulk-add-modal').classList.add('hidden'); showNotification(`${newTasks.length} an√°lises importadas!`); } 
                else { showNotification('Nenhum dado v√°lido.'); }
            }

            // FILTROS (Safely Attached)
            ['filtro-condominio','filtro-data','filtro-semana','filtro-analise'].forEach(id => document.getElementById(id)?.addEventListener('input', refreshUI));

            // A√ß√µes Gerais
            document.getElementById('privacy-toggle-btn').addEventListener('click', () => {
                document.body.classList.toggle('privacy-active');
                const btn = document.getElementById('privacy-icon');
                const txt = document.querySelector('#privacy-toggle-btn span:last-child');
                if(document.body.classList.contains('privacy-active')) { btn.innerText='üîí'; txt.innerText='Oculto'; txt.classList.add('text-amber-400'); }
                else { btn.innerText='üëÅÔ∏è'; txt.innerText='Privacidade'; txt.classList.remove('text-amber-400'); }
            });

            document.getElementById('actions-menu-btn').addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('actions-menu').classList.toggle('hidden'); });
            document.addEventListener('click', (e)=>{ if(!e.target.closest('#actions-menu-container')) document.getElementById('actions-menu').classList.add('hidden'); });

            const showModal = (id) => { document.getElementById('actions-menu').classList.add('hidden'); document.getElementById(id).classList.remove('hidden'); };
            const btnMap = { 'add-task-btn': 'task-modal', 'bulk-add-btn': 'bulk-add-modal', 'archive-week-btn': 'archive-week-modal', 'period-analysis-btn': 'period-analysis-modal', 'annual-report-btn': 'annual-report-modal', 'rename-condo-btn': 'rename-modal', 'archive-btn': 'archive-modal' };
            Object.keys(btnMap).forEach(k => document.getElementById(k)?.addEventListener('click', () => showModal(btnMap[k])));
            
            document.querySelectorAll('[id$="-cancel-btn"], [id$="-close-btn"]').forEach(b => b.addEventListener('click', (e) => e.target.closest('div[id$="-modal"]').classList.add('hidden')));

            document.getElementById('task-form').addEventListener('submit', handleTaskSubmit);
            document.getElementById('bulk-add-form').addEventListener('submit', handleBulkAddSubmit);

            // Card Events
            document.getElementById('task-list').addEventListener('change', (e) => {
                if(e.target.classList.contains('status-sel')) {
                    const t = tasks.find(x => x.id == e.target.dataset.id);
                    if(t) {
                        const val = e.target.value;
                        if(e.target.dataset.type === 'backup') t.statusBackup = val;
                        if(e.target.dataset.type === 'analise') {
                            t.statusAnalise = val;
                            if(val === 'Conclu√≠da') { if(!t.completedAt) t.completedAt = new Date().toISOString(); } 
                            else { t.completedAt = null; }
                        }
                        refreshUI();
                    }
                }
            });

            document.getElementById('task-list').addEventListener('click', (e) => {
                const tId = e.target.dataset.id;
                if(e.target.classList.contains('del-btn')) { if(confirm('Excluir?')) { tasks=tasks.filter(t=>t.id!=tId); refreshUI(); } }
                if(e.target.classList.contains('archive-btn')) { const idx = tasks.findIndex(t=>t.id==tId); if(idx>-1) { archivedTasks.push(tasks[idx]); tasks.splice(idx,1); refreshUI(); showNotification('Arquivado.'); } }
                if(e.target.classList.contains('toggle-btn')) { const t=tasks.find(x=>x.id==tId); if(t){t.isExpanded=!t.isExpanded; refreshUI();} }
                if(e.target.classList.contains('edit-oc-btn')) {
                    const t=tasks.find(x=>x.id==tId);
                    if(t) {
                        document.getElementById('ocorrencia-task-id').value = t.id;
                        const lst = document.getElementById('ocorrencia-list'); lst.innerHTML='';
                        (t.ocorrencias||[]).forEach(o => renderOcorrenciaItemInModal(o, lst));
                        populateCategorySelect(document.getElementById('add-ocorrencia-categoria'));
                        document.getElementById('ocorrencia-modal').classList.remove('hidden');
                    }
                }
            });

            // Modal Ocorr√™ncias
            document.getElementById('ocorrencia-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const t=tasks.find(x=>x.id==document.getElementById('ocorrencia-task-id').value);
                if(t) {
                    t.ocorrencias = Array.from(document.querySelectorAll('.occ-data-item')).map(x=>JSON.parse(x.dataset.json));
                    refreshUI(); document.getElementById('ocorrencia-modal').classList.add('hidden');
                }
            });
            document.getElementById('add-ocorrencia-btn').addEventListener('click', () => {
                const cat = document.getElementById('add-ocorrencia-categoria').value;
                const desc = document.getElementById('add-ocorrencia-desc').value;
                if(desc) renderOcorrenciaItemInModal({categoria:cat, desc:desc, horarioInicial:document.getElementById('add-horario-inicial').value, horarioFinal:document.getElementById('add-horario-final').value}, document.getElementById('ocorrencia-list'));
                document.getElementById('add-ocorrencia-desc').value='';
            });

            // Arquivamento Semanal
            document.getElementById('archive-week-confirm-btn').addEventListener('click', () => {
                const w = parseInt(document.getElementById('archive-week-input').value);
                const toArch = tasks.filter(t => t.semanaDeTrabalho === w);
                if(toArch.length && confirm(`Arquivar ${toArch.length} an√°lises?`)) {
                    archivedTasks.push(...toArch);
                    tasks = tasks.filter(t => t.semanaDeTrabalho !== w);
                    refreshUI(); document.getElementById('archive-week-modal').classList.add('hidden'); showNotification('Arquivado.');
                } else if(!toArch.length) showNotification('Nada encontrado.');
            });

            document.getElementById('archive-week-btn').addEventListener('click', () => { document.getElementById('archive-week-input').value = getWeekNumber(new Date()) - 1 || 52; showModal('archive-week-modal'); });

            // Relat√≥rios
            const initCharts = () => {
                const ctx = document.getElementById('ocorrenciasChart').getContext('2d');
                ocorrenciasChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Ocorr√™ncias', data: [], backgroundColor: '#f59e0b', borderRadius: 6 }] }, options: { responsive:true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#334155', drawBorder:false } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
                new Chart(document.getElementById('periodChart'), { type: 'bar', data: {labels:[], datasets:[{data:[]}]} });
                new Chart(document.getElementById('periodCategoryChart'), { type: 'doughnut', data: {labels:[], datasets:[{data:[]}]} });
            };

            // Run
            checkAndRunAutoArchive();
            initCharts();
            refreshUI();
        });
    </script>
</body>
</html>