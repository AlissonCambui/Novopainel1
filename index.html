
<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento - Acesso Seguro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configurações Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { orange: '#f26324', yellow: '#f7b41e', dark: '#1e293b' }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Ícones -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .card-transition { transition: transform 0.2s, box-shadow 0.2s; }
        .card-transition:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #f26324; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-slate-100 font-sans antialiased min-h-screen flex flex-col transition-colors duration-300 overflow-x-hidden">

    <!-- ================================================================== -->
    <!-- TELA DE LOGIN (PORTARIA) -->
    <!-- ================================================================== -->
    <section id="login-view" class="fixed inset-0 z-50 bg-slate-100 dark:bg-slate-900 flex flex-col items-center justify-center p-4 transition-opacity duration-500">
        <div class="absolute top-4 right-4 flex gap-2">
             <button onclick="App.openModalUI('cloud-config-modal')" class="text-slate-400 hover:text-brand-orange transition p-2" title="Configuração Técnica">
                <i class="ph ph-gear text-2xl"></i>
            </button>
        </div>

        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-brand-orange animate-fade-in flex flex-col">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 bg-orange-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-brand-orange text-3xl shadow-inner">
                    <i class="ph ph-user-focus"></i>
                </div>
            </div>
            
            <div class="text-center mb-6">
                <h1 class="text-2xl font-extrabold tracking-tight select-none text-brand-orange uppercase">
                    Painel de Monitoramento
                </h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Acesso Seguro</p>
            </div>

            <!-- FORMULÁRIO DE LOGIN -->
            <div id="login-form-container" class="space-y-4">
                <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg mb-4">
                    <button id="tab-login" class="flex-1 py-2 text-xs font-bold rounded-md bg-white dark:bg-slate-600 text-brand-orange shadow-sm transition-all" onclick="App.toggleAuthMode('login')">Entrar</button>
                    <button id="tab-register" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 transition-all" onclick="App.toggleAuthMode('register')">Primeiro Acesso</button>
                </div>

                <div id="auth-title" class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Acesso ao Sistema</div>

                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Nome Completo</label>
                    <div class="relative">
                        <i class="ph ph-user absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="text" id="login-username" class="w-full pl-10 pr-4 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition uppercase" placeholder="EX: LUIZ SILVA">
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label id="lbl-password" class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Sua Senha</label>
                    </div>
                    <div class="relative">
                        <i class="ph ph-lock absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="password" id="login-password" class="w-full pl-10 pr-4 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition" placeholder="••••••••">
                    </div>
                </div>

                <div id="auth-error-msg" class="hidden text-red-500 text-xs text-center bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-100 dark:border-red-800 flex items-center justify-center gap-2">
                    <i class="ph ph-warning-circle"></i> <span id="error-text-content">Erro ao autenticar.</span>
                </div>

                <button id="action-btn" type="button" class="w-full bg-brand-orange hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-orange-500/30 flex items-center justify-center gap-2">
                    Acessar Painel
                </button>
            </div>

            <div id="login-loading" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-3"></div>
                <p class="text-xs text-slate-400 animate-pulse">Validando acesso...</p>
            </div>

            <p class="mt-6 text-[10px] text-center text-slate-400 leading-relaxed">
                <span id="conn-status-icon" class="text-green-500 font-bold flex items-center justify-center gap-1"><i class="ph ph-shield-check"></i> Conexão Segura</span>
                <span id="system-status">Inicializando...</span>
            </p>
        </div>
    </section>

    <!-- ================================================================== -->
    <!-- PAINEL PRINCIPAL (DASHBOARD) -->
    <!-- ================================================================== -->
    <div id="dashboard-view" class="hidden flex-col min-h-screen w-full">
        
        <!-- Navbar -->
        <nav class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-40 border-b dark:border-slate-700">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="text-xl font-extrabold tracking-tight select-none flex items-center gap-1 cursor-pointer" onclick="window.location.reload()">
                        <i class="ph ph-video-camera text-brand-orange"></i>
                        <span class="hidden md:inline text-brand-orange">Painel de Monitoramento</span>
                    </div>
                    <span id="app-mode-badge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-bold uppercase tracking-wider flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 animate-pulse"></div> Conectando...
                    </span>
                </div>
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="text-right hidden lg:block mr-2">
                        <p class="text-xs text-slate-500 dark:text-slate-400 capitalize" id="current-date">...</p>
                    </div>
                    <button id="admin-panel-btn" onclick="App.openAdminPanel()" class="hidden bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-brand-orange p-2 rounded-lg transition relative" title="Painel do Administrador">
                        <i class="ph ph-lock-key text-lg"></i>
                        <div id="admin-indicator" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white dark:border-slate-800"></div>
                    </button>
                    <button onclick="App.openMyAccountModal()" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 hover:bg-brand-orange hover:text-white px-3 py-1.5 rounded-lg transition group">
                         <div class="hidden md:block leading-tight text-right">
                            <p class="text-[10px] uppercase font-bold opacity-70">Olá,</p>
                            <p id="user-display-name" class="text-xs font-bold uppercase truncate max-w-[100px]">Utilizador</p>
                        </div>
                        <div id="user-avatar" class="w-8 h-8 rounded-full bg-white text-brand-orange flex items-center justify-center font-bold text-sm border border-slate-200 dark:border-slate-600 shadow-sm group-hover:text-brand-orange">U</div>
                    </button>
                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                    <button id="theme-toggle" class="hidden md:flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                        <i class="ph ph-sun"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- BANNER DE ERRO DE CONEXÃO -->
        <div id="db-error-banner" class="hidden bg-red-500 text-white p-4 text-center shadow-lg">
            <p class="font-bold flex items-center justify-center gap-2">
                <i class="ph ph-warning-circle text-xl"></i>
                Acesso ao Banco de Dados Bloqueado!
            </p>
            <p class="text-xs mt-1 opacity-90">Verifique a conexão de internet ou permissões.</p>
            <button onclick="window.location.reload()" class="mt-2 bg-white text-red-500 px-4 py-1 rounded text-xs font-bold hover:bg-slate-100 transition">
                Tentar Novamente
            </button>
        </div>

        <!-- CONTEÚDO PRINCIPAL -->
        <div class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow animate-fade-in flex flex-col">
            
            <!-- HEADER DA PÁGINA COM ABAS -->
            <header class="mb-6">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Painel de Monitoramento</h1>
                        <p id="welcome-msg" class="text-slate-600 dark:text-slate-400 mt-1 text-sm">Gerencie as suas ocorrências com segurança.</p>
                    </div>
                    <div id="sync-status" class="text-xs font-mono text-slate-400 flex items-center gap-1 hidden">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="sync-text" class="hidden md:inline">Sincronizando...</span>
                    </div>
                </div>

                <!-- MENU DE ABAS (NOVO) -->
                <div class="mt-6 flex gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg w-full md:w-auto inline-flex overflow-x-auto">
                    <button onclick="App.switchMainView('monitoring')" id="btn-view-monitoring" class="flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all bg-white dark:bg-slate-600 text-brand-orange shadow-sm flex items-center gap-2 justify-center whitespace-nowrap">
                        <i class="ph ph-video-camera"></i> Monitoramento
                    </button>
                    <button onclick="App.switchMainView('productivity')" id="btn-view-productivity" class="flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white flex items-center gap-2 justify-center whitespace-nowrap">
                        <i class="ph ph-chart-line-up"></i> Produtividade
                    </button>
                    <!-- NOVA ABA RELATÓRIOS -->
                    <button onclick="App.switchMainView('reports')" id="btn-view-reports" class="flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white flex items-center gap-2 justify-center whitespace-nowrap">
                        <i class="ph ph-file-text"></i> Relatórios
                    </button>
                </div>
            </header>

            <!-- ======================================================= -->
            <!-- VIEW: MONITORAMENTO (Telas originais) -->
            <!-- ======================================================= -->
            <div id="view-monitoring" class="flex-col gap-6">
                
                <!-- KPIs -->
                <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-4">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Ativas</h3>
                        <p id="total-solicitacoes" class="text-3xl font-bold text-slate-800 dark:text-white">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-amber-600 dark:text-amber-500">Backups Pend.</h3>
                        <p id="backups-pendentes" class="text-3xl font-bold text-amber-500">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-emerald-600 dark:text-emerald-400">Análises Concluídas</h3>
                        <p id="analises-concluidas" class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">0</p>
                        <p class="text-xs text-slate-400 text-right">Estatística Semanal</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-red-600 dark:text-red-400">Ocorrências</h3>
                        <p id="total-ocorrencias-semana" class="text-3xl font-bold text-red-500">0</p>
                        <p class="text-xs text-slate-400 text-right">Estatística Semanal</p>
                    </div>
                    <!-- CARD MÉDIA -->
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 card-transition">
                        <h3 class="text-xs font-bold uppercase text-purple-600 dark:text-purple-400">Média (Oc/Análise)</h3>
                        <p id="media-ocorrencias" class="text-3xl font-bold text-purple-500">0.0</p>
                        <p class="text-xs text-slate-400 text-right">Por Concluída</p>
                    </div>
                </section>

                <!-- Toolbar -->
                <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-4 border border-slate-100 dark:border-slate-700">
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                            <input type="text" id="filtro-condominio" placeholder="Buscar condomínio..." class="pl-3 w-full lg:w-64 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none transition">
                            <select id="filtro-analise" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                                <option value="">Status Análise: Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Em Análise">Em Análise</option>
                                <option value="Concluída">Concluída</option>
                            </select>
                            <select id="filtro-backup" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                                <option value="">Status Backup: Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluído">Concluído</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3 w-full lg:w-auto justify-end">
                            <button id="add-task-btn" class="bg-brand-orange hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2 shadow-lg shadow-orange-500/20">
                                <i class="ph ph-plus-circle text-lg"></i> Nova Análise
                            </button>
                            
                            <div class="relative" id="actions-menu-container">
                                <button id="actions-menu-btn" class="bg-slate-100 dark:bg-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-white flex items-center gap-2 transition-colors">
                                    Ações <i class="ph ph-caret-down"></i>
                                </button>
                                <div id="actions-menu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-100 dark:border-slate-700 z-50 overflow-hidden">
                                    <div class="border-t border-slate-100 dark:border-slate-700 my-0"></div>
                                    <button id="excel-import-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-200 transition-colors">
                                        <i class="ph ph-file-csv text-lg text-green-600"></i> Importar (Excel)
                                    </button>
                                    <button id="archive-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                        <i class="ph ph-archive-box text-lg text-purple-500"></i> Arquivo Morto
                                    </button>
                                    <div class="border-t border-slate-100 dark:border-slate-700 my-0"></div>
                                    <button id="export-data-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                        <i class="ph ph-download-simple text-lg text-slate-500"></i> Backup Local (JSON)
                                    </button>
                                    <button id="import-data-btn" class="flex items-center gap-2 w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                        <i class="ph ph-upload-simple text-lg text-slate-500"></i> Restaurar Backup (JSON)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Lista de Tarefas -->
                <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- JS preenche aqui -->
                </main>
                
                <!-- Gráficos -->
                <section class="mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h2 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="ph ph-map-pin"></i> Ocorrências por Local</h2>
                        <div class="chart-container"><canvas id="ocorrenciasChart"></canvas></div>
                    </div>
                </section>
            </div>

            <!-- ======================================================= -->
            <!-- VIEW: PRODUTIVIDADE -->
            <!-- ======================================================= -->
            <div id="view-productivity" class="hidden flex-col gap-6 animate-fade-in">
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Coluna da Esquerda: Formulário e Tabela -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        
                        <!-- Card de Input -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <h2 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2 text-brand-orange">
                                <i class="ph ph-plus-square"></i> Registro Diário/Semanal
                            </h2>
                            <form onsubmit="App.addProductivityEntry(event)" class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Semana</label>
                                    <input type="text" id="prod-input-ref" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Ex: 42" required>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-1" title="Dias Visualizados">Dias (Vis.)</label>
                                        <input type="number" id="prod-input-dias" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none text-center font-bold text-blue-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">PDV</label>
                                        <input type="number" id="prod-input-pdv" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none text-center font-bold text-orange-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">OC</label>
                                        <input type="number" id="prod-input-oc" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none text-center font-bold text-red-600" required>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 mt-2">
                                     <button type="submit" id="btn-save-prod" class="flex-1 bg-brand-orange text-white font-bold py-2 rounded hover:bg-orange-700 transition shadow-lg">
                                        Adicionar Registro
                                    </button>
                                    <button type="button" id="btn-cancel-prod" onclick="App.cancelProductivityEdit()" class="hidden px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white font-bold hover:bg-slate-300 transition">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Tabela de Dados -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden flex-grow">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-300">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">Semana</th>
                                        <th scope="col" class="px-2 py-3 text-center">Dias</th>
                                        <th scope="col" class="px-2 py-3 text-center">PDV</th>
                                        <th scope="col" class="px-2 py-3 text-center">OC</th>
                                        <th scope="col" class="px-2 py-3"></th>
                                    </tr>
                                </thead>
                                <tbody id="productivity-table-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Coluna da Direita: Gráfico e Estatísticas -->
                    <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col">
                         <h2 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="ph ph-chart-line-up"></i> Evolução da Produtividade</h2>
                         <p class="text-xs text-slate-500 mb-4">Acompanhamento de Dias Visualizados vs. Ocorrências Geradas.</p>
                         
                         <!-- NOVO PAINEL DE ESTATÍSTICAS -->
                         <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800 text-center">
                                <p class="text-[10px] uppercase font-bold text-blue-500">Total Dias</p>
                                <p id="kpi-total-dias" class="text-2xl font-extrabold text-blue-700 dark:text-blue-400">0</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-800 text-center">
                                <p class="text-[10px] uppercase font-bold text-red-500">Total Ocorrências</p>
                                <p id="kpi-total-oc" class="text-2xl font-extrabold text-red-700 dark:text-red-400">0</p>
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border border-purple-100 dark:border-purple-800 text-center">
                                <p class="text-[10px] uppercase font-bold text-purple-500">Média (OC/Dia)</p>
                                <p id="kpi-media" class="text-2xl font-extrabold text-purple-700 dark:text-purple-400">0.00</p>
                            </div>
                         </div>

                         <div class="chart-container flex-grow relative" style="height: 400px;">
                             <canvas id="productivityChart"></canvas>
                         </div>
                    </div>
                </div>
            </div>

            <!-- ======================================================= -->
            <!-- VIEW: RELATÓRIOS (Nova Aba Inteligente) -->
            <!-- ======================================================= -->
            <div id="view-reports" class="hidden flex-col gap-6 animate-fade-in">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-4 flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div>
                        <h2 class="text-lg font-bold dark:text-white flex items-center gap-2"><i class="ph ph-files text-brand-orange"></i> Relatórios Detalhados</h2>
                        <p class="text-xs text-slate-500">Análise profunda por PDV/Condomínio</p>
                    </div>
                    <div class="w-full md:w-72">
                        <select id="report-condo-select" onchange="App.generateReport(this.value)" class="w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none">
                            <option value="">Selecione um Condomínio...</option>
                            <!-- Preenchido via JS -->
                        </select>
                    </div>
                </div>

                <!-- Conteúdo do Relatório (Inicialmente Oculto) -->
                <div id="report-content" class="hidden flex-col gap-6">
                    <!-- KPIs do Relatório - SIMPLIFICADO -->
                    <div class="flex justify-center mb-4">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700 text-center w-full max-w-md transform hover:scale-105 transition-transform duration-300">
                            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ph ph-warning-circle text-3xl text-red-500"></i>
                            </div>
                            <h3 class="text-sm font-bold uppercase text-slate-500 dark:text-slate-400 mb-2">Total de Ocorrências</h3>
                            <p id="rep-total-oc" class="text-5xl font-extrabold text-red-600 dark:text-red-500">0</p>
                            <p class="text-xs text-slate-400 mt-2">Histórico acumulado neste local</p>
                        </div>
                    </div>

                    <!-- Gráfico Único -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="text-lg font-bold mb-6 dark:text-white flex items-center gap-2"><i class="ph ph-calendar-check text-brand-orange"></i> Mapa de Calor: Ocorrências por Dia da Semana</h3>
                        <div class="chart-container h-80">
                            <canvas id="reportDayChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Estado Vazio -->
                <div id="report-empty" class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="ph ph-magnifying-glass text-6xl mb-4 opacity-20"></i>
                    <p class="text-sm">Selecione um condomínio acima para gerar o relatório.</p>
                </div>
            </div>

            <footer class="text-center text-xs text-slate-400 py-4 mt-auto border-t dark:border-slate-700">
                <p id="footer-msg"><i class="ph ph-hard-drives"></i> Modo Local. Seus dados estão salvos apenas neste dispositivo.</p>
                <p class="mt-1">© 2025 Painel de Monitoramento - Sistema Seguro - v25.1 (Relatórios Simplificados)</p>
            </footer>
        </div>
    </div>

    <!-- MODAIS (Inalterados) -->
    <div id="my-account-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm border dark:border-slate-700 shadow-2xl">
             <div class="flex justify-between items-start mb-4">
                 <div>
                     <h2 class="text-lg font-bold dark:text-white">Minha Conta</h2>
                     <p id="account-modal-name" class="text-sm text-slate-500 uppercase"></p>
                 </div>
                 <div class="w-10 h-10 rounded-full bg-brand-orange text-white flex items-center justify-center font-bold text-lg">U</div>
             </div>
             
             <div class="space-y-2">
                 <button onclick="App.openChangePasswordModal()" class="w-full flex items-center gap-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 transition text-slate-700 dark:text-white">
                     <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="ph ph-key"></i></div>
                     <div class="text-left">
                         <p class="text-sm font-bold">Alterar Senha</p>
                         <p class="text-[10px] text-slate-500">Defina uma nova senha de acesso</p>
                     </div>
                 </button>
                 
                 <button onclick="App.logout()" class="w-full flex items-center gap-3 p-3 rounded-lg bg-red-50 dark:bg-red-900/10 hover:bg-red-100 dark:hover:bg-red-900/20 transition text-red-600">
                     <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="ph ph-sign-out"></i></div>
                     <div class="text-left">
                         <p class="text-sm font-bold">Sair do Sistema</p>
                         <p class="text-[10px] opacity-70">Encerrar sessão atual</p>
                     </div>
                 </button>
             </div>
             
             <button onclick="document.getElementById('my-account-modal').classList.add('hidden')" class="w-full mt-4 py-2 text-xs text-slate-400 hover:text-slate-600">Fechar</button>
        </div>
    </div>
    
    <!-- Modais restantes (Admin, Cloud, Task, Ocorrencia, etc) mantidos -->
    <div id="admin-panel-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl border dark:border-slate-700 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-4">
                <h2 class="text-xl font-bold dark:text-white flex items-center gap-2"><i class="ph ph-users-three text-brand-orange"></i> Gestão de Equipe</h2>
                <button onclick="document.getElementById('admin-panel-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 text-2xl transition">&times;</button>
            </div>
            <div class="mb-6 bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border border-slate-200 dark:border-slate-600">
                <h3 class="text-sm font-bold text-slate-700 dark:text-white mb-3 flex items-center gap-2"><i class="ph ph-user-plus text-blue-500"></i> Autorizar Novo Acesso</h3>
                <div class="flex flex-col gap-2">
                    <input type="text" id="new-user-name" class="w-full p-3 rounded border dark:bg-slate-800 dark:border-slate-600 dark:text-white text-sm uppercase focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome Completo do Funcionário">
                    <button onclick="App.authorizeNewUser()" class="bg-blue-600 text-white py-2.5 rounded text-sm font-bold hover:bg-blue-700 transition shadow-sm">
                        Autorizar Cadastro
                    </button>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 leading-tight">* O funcionário deverá acessar a aba "Primeiro Acesso" para criar a própria senha.</p>
            </div>
            <div class="flex-grow overflow-y-auto pr-1">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">Equipe Autorizada</h3>
                <ul id="admin-users-list" class="space-y-2 text-sm"></ul>
            </div>
        </div>
    </div>

    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[80]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm border border-red-200 dark:border-red-900 shadow-2xl text-center">
             <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="ph ph-trash"></i>
             </div>
             <h2 class="text-lg font-bold dark:text-white mb-2">Excluir Análise?</h2>
             <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">
                 Esta ação moverá a análise para o histórico de exclusão.
             </p>
             <div class="flex gap-2 justify-center">
                 <button onclick="App.closeModalUI('delete-confirmation-modal')" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white font-bold text-sm transition-colors">Cancelar</button>
                 <button onclick="App.confirmDeleteTask()" class="px-4 py-2 rounded bg-red-500 text-white font-bold text-sm hover:bg-red-600 shadow-lg transition-colors">Sim, Excluir</button>
             </div>
        </div>
    </div>

    <div id="change-password-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[65]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm border dark:border-slate-700 shadow-2xl">
             <h2 class="text-lg font-bold mb-1 dark:text-white flex items-center gap-2"><i class="ph ph-lock-key-open text-brand-orange"></i> Alterar Senha</h2>
             <p class="text-xs text-slate-500 mb-4">Digite sua nova senha pessoal abaixo.</p>
             <input type="password" id="new-password-input" class="w-full p-3 border rounded mb-4 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Nova Senha (mín. 6 dígitos)">
             <div class="flex justify-end gap-2">
                 <button onclick="document.getElementById('change-password-modal').classList.add('hidden')" class="px-4 py-2 rounded text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 text-sm">Cancelar</button>
                 <button onclick="App.changeUserPassword()" class="px-4 py-2 rounded bg-brand-orange text-white font-bold hover:bg-orange-700 text-sm shadow-md">Salvar Nova Senha</button>
             </div>
        </div>
    </div>
    
    <div id="cloud-config-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg border dark:border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-2 dark:text-white flex items-center gap-2"><i class="ph ph-cloud-gear text-blue-500"></i> Instalação do Banco de Dados</h2>
            <textarea id="firebase-config-input" rows="8" class="w-full p-3 text-xs font-mono bg-slate-100 dark:bg-slate-900 border rounded dark:text-white dark:border-slate-600 outline-none resize-none mb-4" readonly placeholder="Configuração embutida no código."></textarea>
            <div class="flex justify-between items-center">
                <button onclick="document.getElementById('cloud-config-modal').classList.add('hidden')" class="text-slate-500 hover:text-slate-700 text-sm">Fechar</button>
                <div class="flex gap-2">
                    <button id="reset-cloud-btn" class="px-4 py-2 rounded border border-red-200 text-red-500 hover:bg-red-50 text-sm">Redefinir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md border dark:border-slate-700 shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 dark:text-white" id="task-modal-title">Nova Análise</h2>
            <form id="task-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Condomínio</label>
                    <input type="text" id="form-condominio" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Data</label>
                    <input type="date" id="form-data-analise" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Semana (Opcional)</label>
                    <input type="text" id="form-semana" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Ex: Semana 47">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Observações</label>
                    <textarea id="form-observacoes" class="w-full border rounded p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-brand-orange outline-none" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-brand-orange text-white font-bold hover:bg-orange-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ocorrencia-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl h-[90vh] flex flex-col border dark:border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-white">Ocorrências: <span id="modal-condo-name" class="text-brand-orange"></span></h2>
                <button id="ocorrencia-cancel-btn" class="text-slate-400 hover:text-red-500 text-2xl transition-colors">&times;</button>
            </div>
            <div id="ocorrencia-list" class="flex-grow overflow-y-auto mb-4 space-y-2 p-2 bg-slate-50 dark:bg-slate-900 rounded border dark:border-slate-700 shadow-inner"></div>
            <div class="pt-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2">
                    <select id="add-ocorrencia-categoria" class="md:col-span-4 border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none"></select>
                    <input type="text" id="add-ocorrencia-desc" placeholder="Descrição da ocorrência..." class="md:col-span-8 border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">Início</label>
                        <input type="time" id="add-horario-inicial" step="1" class="border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none">
                    </div>
                    <div class="flex flex-col">
                         <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">Fim</label>
                         <input type="time" id="add-horario-final" step="1" class="border rounded p-2 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="add-ocorrencia-btn" class="flex-1 bg-orange-100 text-brand-orange font-bold py-2 rounded hover:bg-orange-200 transition-colors border border-orange-200">+ Adicionar Item</button>
                    <button id="save-ocorrencias-btn" class="flex-1 bg-brand-orange text-white font-bold py-2 rounded hover:bg-orange-700 transition-colors shadow-lg shadow-orange-500/20">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div id="excel-import-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl border dark:border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-2 dark:text-white">Importar Dados (Excel)</h2>
            <p class="text-xs text-slate-500 mb-4">Cole as linhas do Excel aqui para importar em massa.</p>
            <textarea id="excel-paste-area" rows="10" class="w-full p-3 text-sm font-mono bg-slate-100 dark:bg-slate-900 border rounded dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-brand-orange outline-none" placeholder="Cole os dados aqui..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button id="excel-import-close-btn" class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-white transition-colors">Cancelar</button>
                <button id="process-import-btn" class="px-4 py-2 rounded bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition-colors">Processar Dados</button>
            </div>
        </div>
    </div>
    
    <div id="archive-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[75]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl border dark:border-slate-700">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-2">
                <div class="flex items-center gap-3">
                    <h2 class="text-2xl font-bold dark:text-white flex items-center gap-2">
                        <i class="ph ph-archive-box"></i> Arquivo Morto
                        <span id="archive-count-badge" class="text-sm bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-white px-2 py-0.5 rounded-full ml-2">0</span>
                    </h2>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.recoverLostData()" class="text-xs font-bold text-blue-500 hover:text-white hover:bg-blue-500 border border-blue-500 px-3 py-1.5 rounded transition-all flex items-center gap-1 shadow-sm" title="Buscar em backups locais">
                        <i class="ph ph-magnifying-glass"></i> Buscar em Backups
                    </button>
                    <button id="archive-close-btn" class="text-2xl text-slate-400 hover:text-slate-600 ml-2">&times;</button>
                </div>
            </div>
            
            <input type="text" id="archive-search" placeholder="Pesquisar no arquivo..." class="mb-3 w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white outline-none focus:ring-2 focus:ring-brand-orange">
            <div id="archive-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
        </div>
    </div>

    <div id="recovery-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[90]">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl border-2 border-blue-500 dark:border-blue-700">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-2">
                <h2 class="text-xl font-bold dark:text-white flex items-center gap-2 text-blue-600 dark:text-blue-400">
                    <i class="ph ph-shield-check text-2xl"></i> Cofre de Segurança
                </h2>
                <button onclick="App.closeModalUI('recovery-modal')" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg mb-4 text-xs text-blue-800 dark:text-blue-200 border border-blue-100 dark:border-blue-800">
                <i class="ph ph-info"></i> Estes itens foram encontrados nos backups internos do seu navegador mas não estão na lista principal.
            </div>
            <input type="text" id="recovery-search" placeholder="Pesquisar no cofre (Nome do condomínio...)" class="mb-3 w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
            <div id="recovery-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
        </div>
    </div>

    <!-- Toast Notificação -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center gap-2">
        <i class="ph ph-check-circle text-green-400 text-xl"></i>
        <span id="toast-msg">Ação realizada</span>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".json">
    <input type="hidden" id="ocorrencia-current-task-id">

    <!-- SCRIPT TYPE MODULE PARA FIREBASE & APP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, onAuthStateChanged, initializeAuth, browserLocalPersistence, updatePassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, deleteDoc, collection, getDocs, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIG
        const myConfig = {
            apiKey: "AIzaSyC7uyQ7Xeu1WfnHbV4-KcngMsPKv5l6QmM",
            authDomain: "painel-de-monitoramento-411b7.firebaseapp.com",
            projectId: "painel-de-monitoramento-411b7",
            storageBucket: "painel-de-monitoramento-411b7.firebasestorage.app",
            messagingSenderId: "638200796920",
            appId: "1:638200796920:web:8d668d52af2355b1c14d0d"
        };

        let auth, db, appFirebase;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const App = {
            data: {
                tasks: [],
                archived: [],
                productivity: [],
                recoveryList: [],
                deletedHistory: [],
                categories: ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Defeito Técnico', 'Procedimento Incorreto', 'Outros'],
                mode: 'cloud', 
                authMode: 'login',
                currentView: 'monitoring',
                user: null,
                isLoading: false,
                adminEmail: 'alisson.cambui@vendperto.local',
                editingId: null,
                pendingDeleteId: null,
                editingTaskId: null,
                editingProductivityId: null
            },
            charts: {},
            statusColors: {
                'Pendente': 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-400',
                'Em Andamento': 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-400',
                'Em Análise': 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-400',
                'Concluído': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400',
                'Concluída': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400',
            },

            // --- MÉTODOS AUXILIARES ---
            
            setupTheme() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            setupDate() {
                const dateEl = document.getElementById('current-date');
                if (dateEl) {
                    dateEl.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                }
            },

            setupCharts() {
                 if (typeof Chart === 'undefined') return; 
                 
                 const isDark = document.documentElement.classList.contains('dark');
                 Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
                 Chart.defaults.font.family = "'Inter', sans-serif";
                 Chart.defaults.scale.grid.color = isDark ? '#334155' : '#e2e8f0'; 
                 Chart.defaults.scale.grid.borderColor = 'transparent'; 

                 // --- GRÁFICO 1: Ocorrências por Local ---
                 const c1 = document.getElementById('ocorrenciasChart');
                 if(c1) {
                     const ctx1 = c1.getContext('2d');
                     const grad1 = ctx1.createLinearGradient(0, 0, 0, 300);
                     grad1.addColorStop(0, '#f97316'); 
                     grad1.addColorStop(1, '#ea580c'); 

                     this.charts.oc = new Chart(ctx1, { 
                        type: 'bar', 
                        data: {
                            labels:[], 
                            datasets:[{
                                label: 'Ocorrências', 
                                data:[], 
                                backgroundColor: grad1, 
                                borderRadius: 6,
                                barPercentage: 0.6, 
                                categoryPercentage: 0.8
                            }]
                        }, 
                        options: {
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } }, 
                            scales: {
                                y: { beginAtZero: true, ticks: { font: { size: 11 } }, grid: { borderDash: [4, 4] } },
                                x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } }
                            }
                        }
                     });
                 }

                 // --- GRÁFICO 2: Produtividade ---
                 const c2 = document.getElementById('productivityChart');
                 if(c2) {
                     const ctx2 = c2.getContext('2d');
                     const gradLine = ctx2.createLinearGradient(0, 0, 0, 400);
                     gradLine.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); 
                     gradLine.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                     this.charts.prod = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Dias Visualizados',
                                    data: [],
                                    type: 'line',
                                    borderColor: '#3b82f6', 
                                    backgroundColor: gradLine,
                                    borderWidth: 3,
                                    pointBackgroundColor: '#ffffff',
                                    pointBorderColor: '#3b82f6',
                                    pointRadius: 4,
                                    fill: true, 
                                    tension: 0.4, 
                                    yAxisID: 'y',
                                    order: 1
                                },
                                {
                                    label: 'Ocorrências (OC)',
                                    data: [],
                                    backgroundColor: '#ef4444', 
                                    borderRadius: 4,
                                    yAxisID: 'y1',
                                    order: 2
                                },
                                {
                                    label: 'PDV',
                                    data: [],
                                    backgroundColor: '#10b981', 
                                    borderRadius: 4,
                                    hidden: true,
                                    yAxisID: 'y1',
                                    order: 3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { legend: { position: 'top', align: 'end' } },
                            scales: {
                                x: { grid: { display: false } },
                                y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Dias' }, grid: { borderDash: [4, 4] } },
                                y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Qtd.' }, grid: { display: false } }
                            }
                        }
                     });
                 }

                 // --- GRÁFICO 3: Relatório Dias da Semana ---
                 const c3 = document.getElementById('reportDayChart');
                 if(c3) {
                     const ctx3 = c3.getContext('2d');
                     const grad3 = ctx3.createLinearGradient(0, 0, 0, 250);
                     grad3.addColorStop(0, '#8b5cf6'); 
                     grad3.addColorStop(1, '#6366f1'); 

                     this.charts.reportDay = new Chart(ctx3, {
                         type: 'bar',
                         data: {
                             labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                             datasets: [{
                                 label: 'Ocorrências',
                                 data: [0,0,0,0,0,0,0],
                                 backgroundColor: grad3,
                                 borderRadius: 4,
                                 barThickness: 20
                             }]
                         },
                         options: {
                             responsive: true,
                             maintainAspectRatio: false,
                             plugins: { legend: { display: false } },
                             scales: {
                                 y: { beginAtZero: true, grid: { borderDash: [4, 4] } },
                                 x: { grid: { display: false } }
                             }
                         }
                     });
                 }
            },
            
            setupEvents() {
                const addListener = (id, event, handler) => { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); };
                
                ['filtro-condominio', 'filtro-backup', 'filtro-analise'].forEach(id => addListener(id, 'input', () => App.render()));
                
                addListener('add-task-btn', 'click', () => { 
                    App.data.editingTaskId = null;
                    document.getElementById('task-modal-title').textContent = "Nova Análise";
                    document.getElementById('task-form').reset(); 
                    document.getElementById('form-data-analise').value = new Date().toISOString().split('T')[0];
                    App.openModalUI('task-modal'); 
                });
                addListener('cancel-btn', 'click', () => App.closeModalUI('task-modal'));
                addListener('task-form', 'submit', (e) => { 
                    e.preventDefault(); 
                    App.saveTaskFromForm();
                });
                
                addListener('actions-menu-btn', 'click', (e) => { e.stopPropagation(); document.getElementById('actions-menu').classList.toggle('hidden'); });
                document.body.addEventListener('click', () => { const m = document.getElementById('actions-menu'); if(m) m.classList.add('hidden'); });
                
                addListener('cloud-config-btn', 'click', () => App.openModalUI('cloud-config-modal'));
                addListener('reset-cloud-btn', 'click', () => { if(confirm('Redefinir configuração?')) App.resetToLocal(); });
                
                addListener('excel-import-btn', 'click', () => App.openModalUI('excel-import-modal'));
                addListener('excel-import-close-btn', 'click', () => App.closeModalUI('excel-import-modal'));
                addListener('process-import-btn', 'click', () => App.processExcel());
                
                addListener('archive-btn', 'click', (e) => { 
                    if(e) e.stopPropagation(); 
                    document.getElementById('actions-menu').classList.add('hidden'); 
                    document.getElementById('archive-search').value = ''; 
                    App.renderArchiveList(); 
                    App.openModalUI('archive-modal'); 
                });
                addListener('archive-close-btn', 'click', () => App.closeModalUI('archive-modal'));
                addListener('archive-search', 'input', () => App.renderArchiveList());
                addListener('recovery-search', 'input', () => App.renderRecoveryList());

                addListener('export-data-btn', 'click', () => App.exportData());
                addListener('import-data-btn', 'click', () => document.getElementById('file-input').click());
                addListener('file-input', 'change', (e) => { 
                    if(e.target.files[0]) { 
                        const r = new FileReader(); 
                        r.onload = ev => { 
                            try {
                                const j = JSON.parse(ev.target.result); 
                                App.data.tasks=j.tasks||[]; 
                                App.data.archived=j.archived||[]; 
                                if(j.productivity) App.data.productivity = j.productivity;
                                App.saveData(); 
                                App.showToast('Restaurado'); 
                                setTimeout(()=>window.location.reload(), 500); 
                            } catch(e) { alert("Erro ao ler arquivo."); }
                        }; 
                        r.readAsText(e.target.files[0]); 
                    } 
                });

                addListener('add-ocorrencia-btn', 'click', () => App.addOccurrence());
                addListener('save-ocorrencias-btn', 'click', () => { App.saveData(); App.closeModalUI('ocorrencia-modal'); App.showToast('Salvo'); });
                addListener('ocorrencia-cancel-btn', 'click', () => { App.closeModalUI('ocorrencia-modal'); App.resetOcorrenciaForm(); });

                addListener('theme-toggle', 'click', () => { 
                    document.documentElement.classList.toggle('dark'); 
                    localStorage.theme = document.documentElement.classList.contains('dark')?'dark':'light'; 
                    App.updateCharts(); 
                });
            },

            // --- CONTROLE DE ABAS ---
            switchMainView(viewName) {
                this.data.currentView = viewName;
                const btnMon = document.getElementById('btn-view-monitoring');
                const btnProd = document.getElementById('btn-view-productivity');
                const btnRep = document.getElementById('btn-view-reports');
                
                const viewMon = document.getElementById('view-monitoring');
                const viewProd = document.getElementById('view-productivity');
                const viewRep = document.getElementById('view-reports');

                const activeStyle = "flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all bg-white dark:bg-slate-600 text-brand-orange shadow-sm flex items-center gap-2 justify-center whitespace-nowrap";
                const inactiveStyle = "flex-1 md:flex-none px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white flex items-center gap-2 justify-center whitespace-nowrap";

                btnMon.className = inactiveStyle;
                btnProd.className = inactiveStyle;
                if(btnRep) btnRep.className = inactiveStyle;

                viewMon.classList.remove('flex'); viewMon.classList.add('hidden');
                viewProd.classList.remove('flex'); viewProd.classList.add('hidden');
                if(viewRep) { viewRep.classList.remove('flex'); viewRep.classList.add('hidden'); }

                if (viewName === 'monitoring') {
                    btnMon.className = activeStyle;
                    viewMon.classList.remove('hidden');
                    viewMon.classList.add('flex');
                    this.updateCharts(); 
                } else if (viewName === 'productivity') {
                    btnProd.className = activeStyle;
                    viewProd.classList.remove('hidden');
                    viewProd.classList.add('flex');
                    this.renderProductivityChart();
                } else if (viewName === 'reports') {
                    btnRep.className = activeStyle;
                    viewRep.classList.remove('hidden');
                    viewRep.classList.add('flex');
                    this.populateReportDropdown();
                }
            },

            // --- LÓGICA DE RELATÓRIOS ---
            
            populateReportDropdown() {
                const select = document.getElementById('report-condo-select');
                if (!select) return;

                const allTasks = [...this.data.tasks, ...this.data.archived];
                const uniqueNames = [...new Set(allTasks.map(t => t.condominio.trim().toUpperCase()))].sort();
                
                select.innerHTML = '<option value="">Selecione um Condomínio...</option>';
                uniqueNames.forEach(name => {
                    if(name) select.innerHTML += `<option value="${name}">${name}</option>`;
                });
            },

            generateReport(condoName) {
                const content = document.getElementById('report-content');
                const emptyState = document.getElementById('report-empty');
                
                if (!condoName) {
                    content.classList.add('hidden');
                    content.classList.remove('flex');
                    emptyState.classList.remove('hidden');
                    return;
                }

                content.classList.remove('hidden');
                content.classList.add('flex');
                emptyState.classList.add('hidden');

                const allTasks = [...this.data.tasks, ...this.data.archived];
                const condoTasks = allTasks.filter(t => t.condominio.trim().toUpperCase() === condoName.toUpperCase());
                
                let totalOc = 0;
                const dayOfWeekCounts = [0,0,0,0,0,0,0]; // Dom - Sab

                condoTasks.forEach(t => {
                    if(t.dataAnalise) {
                         const [y, m, d] = t.dataAnalise.split('-');
                         const dateObj = new Date(y, m-1, d);
                         const day = dateObj.getDay(); 
                         dayOfWeekCounts[day] += (t.ocorrencias ? t.ocorrencias.length : 0);
                    }

                    if (t.ocorrencias && t.ocorrencias.length > 0) {
                        totalOc += t.ocorrencias.length;
                    }
                });

                document.getElementById('rep-total-oc').textContent = totalOc;

                this.updateReportCharts(dayOfWeekCounts);
            },

            updateReportCharts(dayCounts) {
                if (this.charts.reportDay) {
                    this.charts.reportDay.data.datasets[0].data = dayCounts;
                    this.charts.reportDay.update();
                }
            },

            // --- LÓGICA DE PRODUTIVIDADE (Mantida) ---
            addProductivityEntry(e) {
                e.preventDefault();
                const ref = document.getElementById('prod-input-ref').value;
                const dias = parseInt(document.getElementById('prod-input-dias').value);
                const pdv = parseInt(document.getElementById('prod-input-pdv').value);
                const oc = parseInt(document.getElementById('prod-input-oc').value);

                if (!ref || isNaN(dias)) return;

                if (this.data.editingProductivityId) {
                    const index = this.data.productivity.findIndex(p => p.id === this.data.editingProductivityId);
                    if (index > -1) {
                        this.data.productivity[index] = {
                            ...this.data.productivity[index],
                            ref: ref, dias: dias, pdv: pdv || 0, oc: oc || 0
                        };
                        this.showToast('Registro atualizado!');
                    }
                    this.cancelProductivityEdit();
                } else {
                    const entry = {
                        id: crypto.randomUUID(),
                        ref: ref, dias: dias, pdv: pdv || 0, oc: oc || 0,
                        createdAt: new Date().toISOString()
                    };
                    this.data.productivity.unshift(entry);
                    this.showToast('Registro adicionado!');
                    
                    document.getElementById('prod-input-ref').value = '';
                    document.getElementById('prod-input-dias').value = '';
                    document.getElementById('prod-input-pdv').value = '';
                    document.getElementById('prod-input-oc').value = '';
                }

                this.saveData();
                this.renderProductivityTable();
                this.renderProductivityChart();
            },

            editProductivityEntry(id) {
                const item = this.data.productivity.find(p => p.id === id);
                if (!item) return;
                this.data.editingProductivityId = id;
                document.getElementById('prod-input-ref').value = item.ref;
                document.getElementById('prod-input-dias').value = item.dias;
                document.getElementById('prod-input-pdv').value = item.pdv;
                document.getElementById('prod-input-oc').value = item.oc;
                const btn = document.getElementById('btn-save-prod');
                btn.textContent = "Salvar Alterações";
                btn.classList.remove('bg-brand-orange', 'hover:bg-orange-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                document.getElementById('btn-cancel-prod').classList.remove('hidden');
                document.getElementById('view-productivity').scrollIntoView({ behavior: 'smooth' });
            },

            cancelProductivityEdit() {
                this.data.editingProductivityId = null;
                document.getElementById('prod-input-ref').value = '';
                document.getElementById('prod-input-dias').value = '';
                document.getElementById('prod-input-pdv').value = '';
                document.getElementById('prod-input-oc').value = '';
                const btn = document.getElementById('btn-save-prod');
                btn.textContent = "Adicionar Registro";
                btn.classList.add('bg-brand-orange', 'hover:bg-orange-700');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                document.getElementById('btn-cancel-prod').classList.add('hidden');
            },

            removeProductivityEntry(id) {
                if(confirm('Remover este registro?')) {
                    if (this.data.editingProductivityId === id) this.cancelProductivityEdit();
                    this.data.productivity = this.data.productivity.filter(p => p.id !== id);
                    this.saveData();
                    this.renderProductivityTable();
                    this.renderProductivityChart();
                }
            },

            getSortedProductivity() {
                return [...this.data.productivity].sort((a, b) => {
                    const getVal = (str) => { const num = parseInt(str.replace(/\D/g, '')); return isNaN(num) ? 0 : num; };
                    const valA = getVal(a.ref); const valB = getVal(b.ref);
                    if (valA === 0 && valB === 0) return a.ref.localeCompare(b.ref);
                    return valA - valB;
                });
            },

            renderProductivityTable() {
                const tbody = document.getElementById('productivity-table-body');
                if(!tbody) return;
                if (this.data.productivity.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-3 text-center text-xs text-slate-400">Nenhum registro ainda.</td></tr>'; return; }
                const sortedData = this.getSortedProductivity();
                tbody.innerHTML = sortedData.map(p => `
                    <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 transition ${this.data.editingProductivityId === p.id ? 'bg-blue-50 dark:bg-blue-900/20' : ''}">
                        <td class="px-4 py-3 font-bold text-slate-900 dark:text-white">${p.ref}</td>
                        <td class="px-2 py-3 text-center text-blue-600 font-bold">${p.dias}</td>
                        <td class="px-2 py-3 text-center text-slate-500">${p.pdv}</td>
                        <td class="px-2 py-3 text-center text-red-500 font-bold">${p.oc}</td>
                        <td class="px-2 py-3 text-right flex justify-end gap-1">
                            <button onclick="App.editProductivityEntry('${p.id}')" class="text-blue-400 hover:text-blue-600 p-1"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button onclick="App.removeProductivityEntry('${p.id}')" class="text-slate-400 hover:text-red-500 p-1"><i class="ph ph-trash text-lg"></i></button>
                        </td>
                    </tr>`).join('');
            },

            updateProductivityStats() {
                const data = this.data.productivity;
                const totalDias = data.reduce((acc, curr) => acc + (parseInt(curr.dias)||0), 0);
                const totalOC = data.reduce((acc, curr) => acc + (parseInt(curr.oc)||0), 0);
                const media = totalDias > 0 ? (totalOC / totalDias).toFixed(2) : "0.00";
                const elDias = document.getElementById('kpi-total-dias');
                const elOC = document.getElementById('kpi-total-oc');
                const elMedia = document.getElementById('kpi-media');
                if(elDias) elDias.textContent = totalDias;
                if(elOC) elOC.textContent = totalOC;
                if(elMedia) elMedia.textContent = media;
            },

            renderProductivityChart() {
                if (!this.charts.prod) return;
                this.updateProductivityStats();
                const sortedData = this.getSortedProductivity();
                this.charts.prod.data.labels = sortedData.map(p => p.ref);
                this.charts.prod.data.datasets[0].data = sortedData.map(p => p.dias);
                this.charts.prod.data.datasets[1].data = sortedData.map(p => p.oc);
                this.charts.prod.data.datasets[2].data = sortedData.map(p => p.pdv);
                this.charts.prod.update();
            },

            // --- INIT ---
            async init() {
                if(typeof __app_id !== 'undefined') appId = __app_id; 

                this.setupTheme();
                this.setupDate();
                this.setupCharts();
                this.setupEvents(); 
                
                const savedUser = localStorage.getItem('mon_user');
                this.loadDataLocal(); 

                if (savedUser) {
                    try {
                        this.data.user = JSON.parse(savedUser);
                        if (this.data.user.name === 'ALISSON CAMBUI' || this.data.user.email === this.data.adminEmail) this.data.user.isAdmin = true;
                        this.updateUserInfo(this.data.user);
                        this.toggleAuthMode('login'); 
                        this.switchToDashboardView();
                    } catch(e) { console.error(e); localStorage.removeItem('mon_user'); }
                }

                this.initFirebase(myConfig);
                if (!this.data.user) this.toggleAuthMode('login');
            },

            getTodayString() {
                const now = new Date();
                const offset = now.getTimezoneOffset();
                const local = new Date(now.getTime() - (offset * 60 * 1000));
                return local.toISOString().split('T')[0];
            },
            
            updateCharts() {
                 if(this.charts.oc) {
                     const counts = {}; 
                     this.data.tasks.forEach(t => { 
                         if(t.ocorrencias?.length) counts[t.condominio] = (counts[t.condominio]||0)+t.ocorrencias.length; 
                     });
                     const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
                     this.charts.oc.data.labels = sorted.map(x=>x[0]); 
                     this.charts.oc.data.datasets[0].data = sorted.map(x=>x[1]); 
                     this.charts.oc.update();
                 }
                 this.renderProductivityChart();
            },

            toggleAuthMode(mode) {
                this.data.authMode = mode;
                const loginBtn = document.getElementById('tab-login');
                const regBtn = document.getElementById('tab-register');
                const actionBtn = document.getElementById('action-btn');
                const title = document.getElementById('auth-title');
                const errorMsg = document.getElementById('auth-error-msg');
                const passLabel = document.getElementById('lbl-password');
                
                if (errorMsg) errorMsg.classList.add('hidden');

                if (mode === 'login') {
                    loginBtn.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white dark:bg-slate-600 text-brand-orange shadow-sm transition-all";
                    regBtn.className = "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 transition-all";
                    actionBtn.textContent = "Acessar Painel";
                    title.textContent = "Entrar no Sistema";
                    if (passLabel) passLabel.textContent = "Sua Senha"; 
                    actionBtn.onclick = () => App.loginWithUser();
                } else {
                    regBtn.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white dark:bg-slate-600 text-brand-orange shadow-sm transition-all";
                    loginBtn.className = "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 transition-all";
                    actionBtn.textContent = "Criar Minha Senha";
                    title.textContent = "Primeiro Acesso";
                    if (passLabel) passLabel.textContent = "Crie uma Senha"; 
                    actionBtn.onclick = () => App.registerWithUser();
                }
            },

            openModalUI(id) { document.getElementById(id).classList.remove('hidden'); },
            closeModalUI(id) { document.getElementById(id).classList.add('hidden'); },
            openMyAccountModal() { document.getElementById('my-account-modal').classList.remove('hidden'); },
            openForgotPasswordHelp() { document.getElementById('forgot-password-help-modal').classList.remove('hidden'); },
            openAdminPanel() { 
                if (this.data.user && this.data.user.isAdmin) {
                     this.openModalUI('admin-panel-modal');
                     this.loadAuthorizedUsers();
                } else {
                    alert("Acesso restrito a administradores.");
                }
            },
            
            switchToLoginView() { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('dashboard-view').classList.add('hidden'); },
            switchToDashboardView() { 
                document.getElementById('login-view').classList.add('hidden'); 
                document.getElementById('dashboard-view').classList.remove('hidden'); 
                document.getElementById('dashboard-view').classList.add('flex'); 
                setTimeout(() => {
                    this.updateCharts();
                    this.renderProductivityTable(); 
                }, 100); 
            },
            
            // FIREBASE INIT
            async initFirebase(config) {
                try {
                    appFirebase = initializeApp(config);
                    auth = getAuth(appFirebase);
                    db = getFirestore(appFirebase);
                    try { await enableIndexedDbPersistence(db); } catch (err) {}
                    if (!auth.currentUser) { await signInAnonymously(auth).catch(e => console.warn("Anon fail", e)); }
                    onAuthStateChanged(auth, (user) => {
                        this.data.firebaseUser = user;
                        if (user) {
                            document.getElementById('system-status').textContent = "Conectado";
                            if (this.data.user && this.data.user.uid) { this.subscribeToUserData(this.data.user.uid); }
                        }
                    });
                } catch(e) { console.error("Falha Firebase Total", e); }
            },
            
            subscribeToUserData(uid) {
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_records', 'app_user_data_' + uid);
                onSnapshot(userDocRef, { includeMetadataChanges: true }, (docSnap) => {
                    const syncStatusEl = document.getElementById('app-mode-badge');
                    if (docSnap.metadata.fromCache) {
                        syncStatusEl.className = "text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded font-bold uppercase tracking-wider flex items-center gap-1";
                        syncStatusEl.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-yellow-500"></div> Modo Offline (Cache)`;
                    } else {
                        syncStatusEl.className = "text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold uppercase tracking-wider flex items-center gap-1";
                        syncStatusEl.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Online (Nuvem)`;
                    }

                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        const localShadow = localStorage.getItem('mon_shadow_archive_latest');
                        let cloudArchived = d.archived || [];
                        if (localShadow) {
                            try {
                                const shadowArr = JSON.parse(localShadow);
                                if (shadowArr.length > cloudArchived.length) cloudArchived = shadowArr;
                            } catch(e){}
                        }

                        if (d.tasks) this.data.tasks = d.tasks;
                        this.data.archived = cloudArchived;
                        if (d.deletedHistory) this.data.deletedHistory = d.deletedHistory;
                        if (d.productivity) this.data.productivity = d.productivity; 
                        this.saveToLocalStorageCache();
                        document.getElementById('sync-status').classList.remove('hidden');
                        document.getElementById('sync-text').textContent = "Sincronizado";
                        this.autoArchive();
                        this.render();
                        this.renderProductivityTable(); 
                        this.updateCharts();
                        // Atualiza o dropdown se estiver na aba de relatórios
                        if (this.data.currentView === 'reports') this.populateReportDropdown();
                    }
                }, (error) => { console.error("Firestore Error:", error); document.getElementById('db-error-banner').classList.remove('hidden'); });
            },

            // --- AUTO ARQUIVAMENTO (CORRIGIDO) ---
            autoArchive() {
                const now = new Date();
                const offset = now.getTimezoneOffset();
                const localNow = new Date(now.getTime() - (offset * 60 * 1000));
                const day = localNow.getUTCDay(); 
                const diffToMon = (day + 6) % 7; 
                const mondayCurrentWeek = new Date(localNow);
                mondayCurrentWeek.setUTCDate(localNow.getUTCDate() - diffToMon);
                mondayCurrentWeek.setUTCHours(0,0,0,0);
                const limitCurrentWeekStr = mondayCurrentWeek.toISOString().split('T')[0];
                const mondayRetrasada = new Date(mondayCurrentWeek);
                mondayRetrasada.setUTCDate(mondayRetrasada.getUTCDate() - 7); 
                const limitOldStr = mondayRetrasada.toISOString().split('T')[0];
                let changed = false;
                const active = [];
                this.data.tasks.forEach(t => {
                    if (!t.dataAnalise) { active.push(t); return; }
                    if (t.manualRestore) { active.push(t); return; }
                    if (t.dataAnalise < limitOldStr) {
                        this.data.archived.push(t);
                        this.backupToShadow(t); 
                        changed = true;
                        return;
                    }
                    active.push(t);
                });
                if (changed) {
                    this.data.tasks = active;
                    this.saveData();
                    this.showToast('Auto-arquivamento: Painel limpo.');
                }
            },
            
            backupToShadow(item) {
                 try {
                     const raw = localStorage.getItem('mon_shadow_archive_latest');
                     let arr = raw ? JSON.parse(raw) : [];
                     if(!Array.isArray(arr)) arr = [];
                     if(!arr.find(x => x.id === item.id)) {
                         arr.push(item);
                         localStorage.setItem('mon_shadow_archive_latest', JSON.stringify(arr));
                     }
                 } catch(e) {}
            },
            
            generateEmail(name) { return `${name.trim().toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.]/g, '')}@vendperto.local`; },
            
            async loginWithUser() { 
                const errorMsg = document.getElementById('auth-error-msg');
                errorMsg.classList.add('hidden'); 
                if(!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                const name = document.getElementById('login-username').value.trim().toUpperCase();
                const pass = document.getElementById('login-password').value;
                if(!name || !pass) { errorMsg.innerHTML = "Preencha nome e senha."; errorMsg.classList.remove('hidden'); return; }
                const email = this.generateEmail(name);
                const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
                document.getElementById('login-loading').classList.remove('hidden');
                document.getElementById('login-form-container').classList.add('hidden');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        if (userData.password === pass) {
                            let isAdmin = userData.isAdmin || false;
                            if (userData.name === 'ALISSON CAMBUI' || userData.email === this.data.adminEmail) isAdmin = true;
                            this.data.user = { ...userData, uid: safeId, displayName: userData.name, isAdmin: isAdmin };
                            localStorage.setItem('mon_user', JSON.stringify(this.data.user));
                            this.updateUserInfo(this.data.user);
                            this.switchToDashboardView();
                            this.subscribeToUserData(safeId);
                        } else { throw new Error("Senha incorreta."); }
                    } else { throw new Error("Utilizador não encontrado. Use a aba 'Primeiro Acesso'."); }
                } catch(e) {
                    document.getElementById('login-loading').classList.add('hidden');
                    document.getElementById('login-form-container').classList.remove('hidden');
                    errorMsg.classList.remove('hidden');
                    errorMsg.innerHTML = e.message || "Erro de conexão.";
                }
            },

            async registerWithUser() {
                const name = document.getElementById('login-username').value.trim().toUpperCase();
                const pass = document.getElementById('login-password').value;
                if (!name || !pass) return alert('Preencha nome e senha para o primeiro acesso.');
                if (pass.length < 6) return alert('A senha deve ter 6 dígitos ou mais.');
                const email = this.generateEmail(name);
                const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                         const data = docSnap.data();
                         if (data.password && data.password.length > 0) return alert('Utilizador já cadastrado. Faça login.');
                         await updateDoc(docRef, { password: pass, registeredAt: new Date().toISOString() });
                         alert('Senha cadastrada com sucesso! Faça login.');
                         this.toggleAuthMode('login');
                    } else {
                        await setDoc(docRef, { name: name, email: email, password: pass, isAdmin: false, createdAt: new Date().toISOString() });
                        alert('Cadastro realizado! Faça login.');
                        this.toggleAuthMode('login');
                    }
                } catch (e) { console.error(e); alert('Erro ao registrar: ' + e.message); }
            },

            async authorizeNewUser() {
                const nameInput = document.getElementById('new-user-name');
                const name = nameInput.value.trim().toUpperCase();
                if (!name) return alert('Digite o nome.');
                const email = this.generateEmail(name);
                const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    await setDoc(docRef, { name: name, email: email, password: '', authorized: true, isAdmin: false, createdAt: new Date().toISOString() }, { merge: true });
                    nameInput.value = '';
                    this.loadAuthorizedUsers();
                    alert('Autorizado com sucesso.');
                } catch (e) { alert('Erro: ' + e.message); }
            },
            
            async loadAuthorizedUsers() {
                try {
                     const q = collection(db, 'artifacts', appId, 'public', 'data', 'auth_users');
                     const querySnapshot = await getDocs(q);
                     const list = document.getElementById('admin-users-list');
                     list.innerHTML = '';
                     querySnapshot.forEach((doc) => {
                         const u = doc.data();
                         list.innerHTML += `
                            <li class="flex justify-between items-center border-b dark:border-slate-700 py-2">
                                <div>
                                    <p class="font-bold dark:text-white">${u.name}</p>
                                    <p class="text-[10px] text-slate-400">${u.email}</p>
                                </div>
                                <span class="text-xs ${u.password ? 'text-green-500' : 'text-amber-500'} font-bold">${u.password ? 'Ativo' : 'Pendente'}</span>
                            </li>`;
                     });
                } catch(e) { console.error("Erro ao listar users", e); }
            },

            openChangePasswordModal() { document.getElementById('change-password-modal').classList.remove('hidden'); },
            
            async changeUserPassword() {
                const newPass = document.getElementById('new-password-input').value;
                if (!newPass || newPass.length < 6) return alert("Mínimo 6 caracteres.");
                try {
                    const safeId = this.data.user.uid;
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'auth_users', 'app_users_' + safeId);
                    await updateDoc(docRef, { password: newPass });
                    alert("Senha alterada com sucesso.");
                    this.closeModalUI('change-password-modal');
                } catch(e) { alert("Erro ao alterar senha."); }
            },
            
            async logout() { this.data.user = null; localStorage.removeItem('mon_user'); this.switchToLoginView(); },
            
            updateUserInfo(u) { 
                let displayName = u.name || 'Utilizador';
                if (u.isAdmin) displayName += ' (ADMIN)';
                document.getElementById('user-display-name').textContent = displayName; 
                document.getElementById('account-modal-name').textContent = displayName;
                if (u.isAdmin) document.getElementById('admin-panel-btn').classList.remove('hidden');
            },
            
            resetToLocal() { localStorage.removeItem('mon_firebase_config'); window.location.reload(); },
            
            async saveData() { 
                 const cleanTasks = JSON.parse(JSON.stringify(this.data.tasks));
                 const cleanArchived = JSON.parse(JSON.stringify(this.data.archived));
                 const cleanProd = JSON.parse(JSON.stringify(this.data.productivity));
                 this.saveToLocalStorageCache();
                 if (cleanTasks.length > 0 || cleanArchived.length > 0) {
                     localStorage.setItem('mon_safe_backup', JSON.stringify({t: cleanTasks, a: cleanArchived}));
                 }
                 if (this.data.mode === 'cloud' && this.data.user) {
                    try {
                        const safeId = this.data.user.uid;
                        const dataRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_records', 'app_user_data_' + safeId);
                        await setDoc(dataRef, { 
                            tasks: cleanTasks, archived: cleanArchived, deletedHistory: this.data.deletedHistory,
                            productivity: cleanProd, lastUpdate: new Date().toISOString(), ownerEmail: this.data.user.email 
                        }, { merge: true });
                    } catch(e) { console.error("Erro save cloud", e); }
                 }
                 this.render(); 
                 this.updateCharts();
            },
            
            saveToLocalStorageCache() { 
                localStorage.setItem('mon_tasks', JSON.stringify(this.data.tasks)); 
                localStorage.setItem('mon_archived', JSON.stringify(this.data.archived)); 
                localStorage.setItem('mon_prod', JSON.stringify(this.data.productivity)); 
            },
            
            loadDataLocal() { 
                try { 
                    const t = localStorage.getItem('mon_tasks'); if(t) this.data.tasks = JSON.parse(t); 
                    const a = localStorage.getItem('mon_archived'); if(a) this.data.archived = JSON.parse(a);
                    const p = localStorage.getItem('mon_prod'); if(p) this.data.productivity = JSON.parse(p);
                    if (!this.data.archived) this.data.archived = []; 
                    if (!this.data.productivity) this.data.productivity = [];
                    this.render(); 
                } catch(e){} 
            },
            
            addTask(task) {
                const t = { 
                    id: crypto.randomUUID(), ...task, 
                    dataAnalise: task.dataAnalise || new Date().toISOString().split('T')[0],
                    statusBackup: 'Pendente', statusAnalise: 'Pendente', ocorrencias: [], createdAt: new Date().toISOString() 
                };
                this.data.tasks.unshift(t);
                this.saveData();
                this.showToast('Análise criada!');
            },

            editTask(id) {
                const task = this.data.tasks.find(t => t.id === id);
                if (!task) return;
                this.data.editingTaskId = id;
                document.getElementById('task-modal-title').textContent = "Editar Análise";
                document.getElementById('form-condominio').value = task.condominio;
                document.getElementById('form-data-analise').value = task.dataAnalise;
                document.getElementById('form-semana').value = task.semana || '';
                document.getElementById('form-observacoes').value = task.observacoes || '';
                App.openModalUI('task-modal');
            },

            saveTaskFromForm() {
                const id = this.data.editingTaskId;
                const newData = {
                    condominio: document.getElementById('form-condominio').value,
                    dataAnalise: document.getElementById('form-data-analise').value,
                    semana: document.getElementById('form-semana').value,
                    observacoes: document.getElementById('form-observacoes').value
                };
                if (id) {
                    const task = this.data.tasks.find(t => t.id === id);
                    if (task) { Object.assign(task, newData); this.showToast('Análise atualizada!'); }
                } else { this.addTask(newData); }
                this.saveData();
                this.closeModalUI('task-modal');
            },
            
            addOccurrence() {
                const cat = document.getElementById('add-ocorrencia-categoria').value;
                const desc = document.getElementById('add-ocorrencia-desc').value;
                const ini = document.getElementById('add-horario-inicial').value;
                const fim = document.getElementById('add-horario-final').value;
                if (!desc) return alert("Descreva a ocorrência.");
                const taskId = document.getElementById('ocorrencia-current-task-id').value;
                const task = this.data.tasks.find(t => t.id === taskId);
                if (task) {
                    if (!task.ocorrencias) task.ocorrencias = [];
                    if (this.data.editingId) {
                        const oc = task.ocorrencias.find(o => o.id === this.data.editingId);
                        if (oc) { oc.categoria = cat; oc.descricao = desc; oc.inicio = ini; oc.fim = fim; this.showToast('Item atualizado!'); }
                        this.data.editingId = null; this.resetOcorrenciaFormUI();
                    } else {
                        task.ocorrencias.push({ id: crypto.randomUUID(), categoria: cat, descricao: desc, inicio: ini, fim: fim });
                        this.showToast('Item adicionado!');
                    }
                    this.saveData(); 
                    this.renderOcorrenciasList(task);
                    document.getElementById('add-ocorrencia-desc').value = '';
                    document.getElementById('add-horario-inicial').value = '';
                    document.getElementById('add-horario-final').value = '';
                }
            },

            prepareEditOcorrencia(taskId, ocId) {
                const task = this.data.tasks.find(t => t.id === taskId);
                if (!task) return;
                const oc = task.ocorrencias.find(o => o.id === ocId);
                if (!oc) return;
                document.getElementById('add-ocorrencia-categoria').value = oc.categoria;
                document.getElementById('add-ocorrencia-desc').value = oc.descricao;
                document.getElementById('add-horario-inicial').value = oc.inicio || '';
                document.getElementById('add-horario-final').value = oc.fim || '';
                this.data.editingId = ocId;
                const btn = document.getElementById('add-ocorrencia-btn');
                btn.innerHTML = `<i class="ph ph-floppy-disk text-lg"></i> Salvar Edição`;
                btn.className = "flex-1 bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition-colors shadow-lg";
            },

            resetOcorrenciaForm() {
                 this.data.editingId = null;
                 document.getElementById('add-ocorrencia-desc').value = '';
                 document.getElementById('add-horario-inicial').value = '';
                 document.getElementById('add-horario-final').value = '';
                 this.resetOcorrenciaFormUI();
            },

            resetOcorrenciaFormUI() {
                const btn = document.getElementById('add-ocorrencia-btn');
                btn.innerHTML = `+ Adicionar Item`;
                btn.className = "flex-1 bg-orange-100 text-brand-orange font-bold py-2 rounded hover:bg-orange-200 transition-colors border border-orange-200";
            },

            processExcel() {
                const text = document.getElementById('excel-paste-area').value;
                if (!text) return alert("Cole os dados do Excel.");
                const regex = /Semana\s*(\d{1,2})\s*?(\d{2}\/\d{2}\/\d{4})(.*?)(?=Semana\s*\d+|$)/gs;
                let match; let count = 0;
                while ((match = regex.exec(text)) !== null) {
                    const semanaNum = match[1].trim();
                    const dataRaw = match[2].trim();
                    const resto = match[3].trim(); 
                    let finalDate = dataRaw;
                    try { const [d, m, y] = dataRaw.split('/'); finalDate = `${y}-${m}-${d}`; } catch (e) {}
                    let condominio = "Desconhecido"; let statusAnalise = "Pendente"; let numOcorrencias = 0; let statusRaw = "";
                    const pivotMatch = resto.match(/(\d*)\s*([A-Z][a-z\u00C0-\u00FF]+)/);
                    if (pivotMatch) {
                        const endOfCondoIndex = pivotMatch.index;
                        condominio = resto.substring(0, endOfCondoIndex).trim();
                        const ocStr = pivotMatch[1]; 
                        const endOfNameIndex = endOfCondoIndex + pivotMatch[0].length;
                        statusRaw = resto.substring(endOfNameIndex).trim();
                        if (ocStr) numOcorrencias = parseInt(ocStr, 10);
                        if (numOcorrencias > 0 || statusRaw.toLowerCase().includes('finalizado') || statusRaw.toLowerCase().includes('conclu')) { statusAnalise = 'Concluída'; } else { statusAnalise = 'Pendente'; }
                    } else { condominio = resto; }
                    const historyIndex = this.data.deletedHistory.findIndex(t => t.condominio.toLowerCase() === condominio.toLowerCase() && t.dataAnalise === finalDate);
                    if (historyIndex > -1) {
                         const restoredTask = this.data.deletedHistory[historyIndex];
                         this.data.deletedHistory.splice(historyIndex, 1);
                         this.data.tasks.push(restoredTask);
                         count++; continue; 
                    }
                    const existingIndex = this.data.tasks.findIndex(t => t.condominio.toLowerCase() === condominio.toLowerCase() && t.dataAnalise === finalDate);
                    const novasOcorrencias = [];
                    if (numOcorrencias > 0) {
                        for(let i=0; i<numOcorrencias; i++) {
                            novasOcorrencias.push({ id: crypto.randomUUID(), categoria: 'Outros', descricao: 'Ocorrência Importada (Verificar detalhes)', inicio: '', fim: '' });
                        }
                    }
                    if (existingIndex > -1) {
                        const task = this.data.tasks[existingIndex];
                        if (numOcorrencias > 0 && (!task.ocorrencias || task.ocorrencias.length === 0)) { task.ocorrencias = novasOcorrencias; task.statusAnalise = 'Concluída'; }
                        if (statusAnalise === 'Concluída' && task.statusAnalise !== 'Concluída') { task.statusAnalise = 'Concluída'; }
                        task.semana = `Semana ${semanaNum}`;
                        count++;
                    } else {
                        this.data.tasks.push({ 
                            id: crypto.randomUUID(), condominio: condominio, dataAnalise: finalDate, semana: `Semana ${semanaNum}`, 
                            observacoes: statusRaw ? `Status original: ${statusRaw}` : '', statusBackup: 'Pendente', 
                            statusAnalise: statusAnalise, ocorrencias: novasOcorrencias, createdAt: new Date().toISOString() 
                        });
                        count++;
                    }
                }
                this.saveData(); 
                this.closeModalUI('excel-import-modal'); 
                if (count === 0) { alert("Nenhum dado novo encontrado."); } else { this.showToast(`${count} análises processadas.`); }
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
            },
            
            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ tasks: this.data.tasks, archived: this.data.archived, productivity: this.data.productivity }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", "backup_painel_" + new Date().toISOString().split('T')[0] + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            // --- LISTAGEM DE ARQUIVOS BLINDADA COM RECUPERAÇÃO ---
            renderArchiveList() {
                 if (!Array.isArray(this.data.archived)) this.data.archived = []; 
                 const list = document.getElementById('archive-list');
                 const searchInput = document.getElementById('archive-search');
                 const search = searchInput ? searchInput.value.toLowerCase() : '';
                 const countBadge = document.getElementById('archive-count-badge');
                 if(countBadge) countBadge.textContent = this.data.archived.length;
                 const filtered = this.data.archived.filter(t => (t.condominio || '').toLowerCase().includes(search));
                 if (filtered.length === 0) {
                     list.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-8 text-slate-400">
                            <i class="ph ph-tray text-3xl mb-2 opacity-50"></i>
                            <p class="text-xs mb-4">Nenhum item encontrado.</p>
                            <button onclick="App.recoverLostData()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded text-xs font-bold hover:bg-blue-200 transition flex items-center gap-2">
                                <i class="ph ph-life-buoy"></i> Tentar Recuperar Dados Perdidos
                            </button>
                        </div>`;
                     return;
                 }
                 list.innerHTML = filtered.map(t => {
                    let dateDisplay = '-';
                    try { if (t.dataAnalise && t.dataAnalise.includes('-')) { dateDisplay = this.formatDate(t.dataAnalise); } else { dateDisplay = t.dataAnalise || 'Data n/d'; } } catch(e) { dateDisplay = 'Erro Data'; }
                    return `
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-900 rounded border dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <div>
                            <p class="font-bold text-sm dark:text-white uppercase">${t.condominio || 'Sem Nome'}</p>
                            <p class="text-[10px] text-slate-500 flex items-center gap-1"><i class="ph ph-calendar"></i> ${dateDisplay} <span class="mx-1">•</span> ${t.semana || '-'}</p>
                        </div>
                        <button onclick="App.restoreTask('${t.id}')" class="flex items-center gap-1 text-green-600 hover:text-white hover:bg-green-600 text-[10px] font-bold border border-green-200 dark:border-green-900 px-3 py-1.5 rounded transition-all shadow-sm">
                            <i class="ph ph-arrow-u-up-left"></i> Restaurar
                        </button>
                    </div>`
                 }).join('');
            },
            
            recoverLostData() {
                const candidates = new Map();
                const process = (key) => {
                    try {
                        const raw = localStorage.getItem(key); if (!raw) return; const parsed = JSON.parse(raw);
                        let arr = []; if (Array.isArray(parsed)) arr = parsed; else if (parsed.a) arr = parsed.a.concat(parsed.t || []); 
                        arr.forEach(t => { if (t && t.id) candidates.set(t.id, t); });
                    } catch(e) { console.error("Error reading " + key, e); }
                };
                process('mon_archived'); process('mon_tasks'); process('mon_safe_backup'); process('mon_shadow_archive_latest');
                const currentIds = new Set([...this.data.tasks.map(t => t.id), ...this.data.archived.map(t => t.id)]);
                this.data.recoveryList = [];
                for (const [id, task] of candidates) { if (!currentIds.has(id)) this.data.recoveryList.push(task); }
                if (this.data.recoveryList.length === 0) { alert("Nenhum dado perdido foi encontrado nos backups locais."); } else { this.openModalUI('recovery-modal'); this.renderRecoveryList(); }
            },

            renderRecoveryList() {
                const list = document.getElementById('recovery-list');
                const search = document.getElementById('recovery-search').value.toLowerCase();
                const filtered = this.data.recoveryList.filter(t => (t.condominio || '').toLowerCase().includes(search));
                if (filtered.length === 0) { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Nenhum item correspondente encontrado.</p>'; return; }
                list.innerHTML = filtered.map(t => `
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-900 rounded border border-blue-100 dark:border-blue-900 hover:shadow-md transition-all">
                        <div>
                            <p class="font-bold text-sm dark:text-white uppercase text-blue-900 dark:text-blue-100">${t.condominio || 'Sem Nome'}</p>
                            <p class="text-[10px] text-slate-500 flex items-center gap-1"><i class="ph ph-calendar"></i> ${this.formatDate(t.dataAnalise)} <span class="mx-1">•</span> ${t.semana || '-'}</p>
                        </div>
                        <button onclick="App.restoreSingleFromRecovery('${t.id}')" class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-2 rounded shadow-lg transition-colors">
                            <i class="ph ph-download-simple"></i> Recuperar Este
                        </button>
                    </div>`).join('');
            },

            restoreSingleFromRecovery(id) {
                const idx = this.data.recoveryList.findIndex(t => t.id === id);
                if (idx > -1) {
                    const item = this.data.recoveryList[idx];
                    this.data.recoveryList.splice(idx, 1);
                    item.manualRestore = true; item.carimboSemanaAtual = true; 
                    this.data.tasks.unshift(item);
                    this.saveData(); this.renderRecoveryList(); this.render(); 
                    this.showToast('Item recuperado com sucesso!');
                    if (this.data.recoveryList.length === 0) this.closeModalUI('recovery-modal');
                }
            },
            
            restoreTask(id) {
                const idx = this.data.archived.findIndex(t => t.id === id);
                if (idx > -1) {
                    const t = this.data.archived.splice(idx, 1)[0];
                    t.manualRestore = true; 
                    if (t.statusAnalise === 'Concluída') { t.carimboSemanaAtual = false; this.showToast('Restaurado para Consulta'); } else { t.carimboSemanaAtual = true; this.showToast('Restaurado: Contabilizando na Meta'); }
                    this.data.tasks.unshift(t);
                    this.saveData(); this.renderArchiveList(); 
                }
            },
            
            requestDeleteTask(id) {
                this.data.pendingDeleteId = id;
                document.getElementById('delete-confirmation-modal').classList.remove('hidden');
            },

            confirmDeleteTask() {
                const id = this.data.pendingDeleteId;
                if(!id) return;
                const task = this.data.tasks.find(t => t.id === id);
                if (task) { if(!this.data.deletedHistory) this.data.deletedHistory = []; this.data.deletedHistory.push(task); }
                this.data.tasks = this.data.tasks.filter(t => t.id !== id);
                this.saveData();
                this.closeModalUI('delete-confirmation-modal');
                this.data.pendingDeleteId = null;
                this.showToast('Análise excluída (pode ser restaurada)');
            },
            
            archiveTask(id) {
                const idx = this.data.tasks.findIndex(t => t.id === id);
                if (idx > -1) {
                    const t = this.data.tasks.splice(idx, 1)[0];
                    if (!this.data.archived) this.data.archived = []; 
                    this.data.archived.push(t);
                    localStorage.setItem('mon_shadow_archive_latest', JSON.stringify(this.data.archived));
                    this.saveData();
                }
            },

            openOcorrenciaModal(id) {
                document.getElementById('ocorrencia-current-task-id').value = id;
                const t = this.data.tasks.find(x => x.id === id);
                if(!t) return;
                document.getElementById('modal-condo-name').textContent = t.condominio;
                const sel = document.getElementById('add-ocorrencia-categoria');
                sel.innerHTML = this.data.categories.map(c => `<option>${c}</option>`).join('');
                this.renderOcorrenciasList(t);
                this.openModalUI('ocorrencia-modal');
            },
            
            renderOcorrenciasList(task) {
                const list = document.getElementById('ocorrencia-list');
                if (!task.ocorrencias || task.ocorrencias.length === 0) { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Nenhuma ocorrência registrada.</p>'; return; }
                const sortedOcs = [...task.ocorrencias].sort((a,b) => (a.inicio || '').localeCompare(b.inicio || ''));
                list.innerHTML = sortedOcs.map((o, idx) => `
                    <div class="p-3 bg-white dark:bg-slate-800 rounded border dark:border-slate-700 mb-2 shadow-sm flex justify-between items-center group hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                        <div class="flex items-center gap-3 overflow-hidden">
                             <div class="flex flex-col items-center min-w-[60px]">
                                 <span class="text-xs font-bold text-slate-700 dark:text-white font-mono bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded border dark:border-slate-600">${o.inicio || '--:--'}</span>
                                 <span class="text-[9px] font-bold text-slate-400 mt-0.5">até ${o.fim || '--:--'}</span>
                             </div>
                             <div class="border-l pl-3 dark:border-slate-700">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold uppercase text-brand-orange bg-orange-50 dark:bg-orange-900/30 px-1.5 py-0.5 rounded border border-orange-100 dark:border-orange-900">${o.categoria}</span>
                                </div>
                                <p class="text-sm dark:text-white truncate max-w-[200px] md:max-w-xs text-slate-600" title="${o.descricao}">${o.descricao}</p>
                             </div>
                        </div>
                        <div class="flex gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                            <button onclick="App.prepareEditOcorrencia('${task.id}', '${o.id}')" class="p-2 text-blue-400 hover:bg-blue-50 rounded hover:text-blue-600"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button onclick="App.removeOcorrencia('${task.id}', '${o.id}')" class="p-2 text-red-400 hover:bg-red-50 rounded hover:text-red-600"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </div>`).join('');
            },
            
            removeOcorrencia(taskId, ocId) {
                const t = this.data.tasks.find(x => x.id === taskId);
                if (t) {
                    t.ocorrencias = t.ocorrencias.filter(o => o.id !== ocId);
                    this.saveData(); 
                    this.renderOcorrenciasList(t);
                }
            },

            updateStatus(id, field, val) {
                const t = this.data.tasks.find(x => x.id === id);
                if (t) { 
                    if (field === 'statusAnalise' && t.manualRestore && val !== 'Concluída') { t.carimboSemanaAtual = true; }
                    t[field] = val; 
                    this.saveData(); 
                }
            },

            formatDate(dateStr) {
                if(!dateStr) return '-';
                try {
                    const [y, m, d] = dateStr.split('-');
                    const date = new Date(y, m - 1, d);
                    const week = date.toLocaleDateString('pt-BR', { weekday: 'long' });
                    const weekCap = week.charAt(0).toUpperCase() + week.slice(1);
                    return `${d}/${m}/${y} • ${weekCap}`;
                } catch(e) { return dateStr; }
            },

            render() { 
                const list = document.getElementById('task-list');
                const fCondo = document.getElementById('filtro-condominio').value.toLowerCase();
                const fAnalise = document.getElementById('filtro-analise').value;
                const fBackup = document.getElementById('filtro-backup').value;

                const filtered = this.data.tasks.filter(t => {
                    return t.condominio.toLowerCase().includes(fCondo) &&
                           (fAnalise === '' || t.statusAnalise === fAnalise) &&
                           (fBackup === '' || t.statusBackup === fBackup);
                });
                
                document.getElementById('total-solicitacoes').textContent = this.data.tasks.length;
                document.getElementById('backups-pendentes').textContent = this.data.tasks.filter(t => t.statusBackup === 'Pendente').length;
                
                const statTasks = this.data.tasks.filter(t => !t.manualRestore || t.carimboSemanaAtual);
                const concluidasStat = statTasks.filter(t => t.statusAnalise === 'Concluída').length;
                document.getElementById('analises-concluidas').textContent = concluidasStat;
                
                const totalOcStat = statTasks.reduce((acc, t) => acc + (t.ocorrencias?.length||0), 0);
                document.getElementById('total-ocorrencias-semana').textContent = totalOcStat;
                
                const concStat = statTasks.filter(t => t.statusAnalise === 'Concluída').length;
                document.getElementById('media-ocorrencias').textContent = concStat > 0 ? (totalOcStat / concStat).toFixed(1) : "0.0";
                
                const prodTotalEl = document.getElementById('produtividade-total');
                if(prodTotalEl) prodTotalEl.textContent = concStat + this.data.archived.length;

                list.innerHTML = filtered.map(t => {
                    const ocCount = t.ocorrencias ? t.ocorrencias.length : 0;
                    const optionsAnalise = ['Pendente', 'Em Análise', 'Concluída'].map(opt => `<option value="${opt}" ${t.statusAnalise === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    const optionsBackup = ['Pendente', 'Em Andamento', 'Concluído'].map(opt => `<option value="${opt}" ${t.statusBackup === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    return `
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border border-slate-100 dark:border-slate-700 card-transition relative group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-lg text-slate-800 dark:text-white uppercase tracking-tight">${t.condominio}</h3>
                                    ${t.manualRestore ? `<span class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-bold uppercase border border-purple-200" title="Restaurado Manualmente">RESTAURADO</span>` : ''}
                                    <button onclick="App.editTask('${t.id}')" class="text-blue-400 hover:text-blue-600" title="Editar Dados"><i class="ph ph-pencil-simple"></i></button>
                                </div>
                                <p class="text-xs text-slate-500 flex items-center gap-1"><i class="ph ph-calendar"></i> ${this.formatDate(t.dataAnalise)} <span class="bg-slate-100 dark:bg-slate-700 px-1.5 rounded ml-2">${t.semana||'-'}</span></p>
                                ${t.carimboSemanaAtual ? `<div class="mt-2 inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 font-bold uppercase w-full"><i class="ph ph-stamp text-lg"></i> Contabilizar na Semana Atual</div>` : ''}
                            </div>
                            <div class="flex gap-1">
                                <button onclick="App.openOcorrenciaModal('${t.id}')" class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-brand-orange hover:bg-orange-100 dark:hover:bg-orange-900/40 transition relative">
                                    <i class="ph ph-list-checks text-xl"></i>
                                    ${ocCount > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold shadow-sm">${ocCount}</span>` : ''}
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Análise</label>
                                <select onchange="App.updateStatus('${t.id}', 'statusAnalise', this.value)" class="w-full text-xs font-bold rounded p-1.5 border dark:border-slate-600 dark:bg-slate-700 outline-none ${this.statusColors[t.statusAnalise]}">
                                    ${optionsAnalise}
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Backup</label>
                                <select onchange="App.updateStatus('${t.id}', 'statusBackup', this.value)" class="w-full text-xs font-bold rounded p-1.5 border dark:border-slate-600 dark:bg-slate-700 outline-none ${this.statusColors[t.statusBackup]}">
                                    ${optionsBackup}
                                </select>
                            </div>
                        </div>
                        ${t.observacoes ? `<p class="text-xs text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900 p-2 rounded mb-3 italic border-l-2 border-slate-300 dark:border-slate-600 line-clamp-2">"${t.observacoes}"</p>` : ''}
                        <div class="flex justify-end gap-2 mt-2 pt-3 border-t dark:border-slate-700 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button onclick="App.archiveTask('${t.id}')" class="text-xs text-purple-500 hover:text-purple-700 font-bold flex items-center gap-1"><i class="ph ph-archive"></i> Arquivar</button>
                             <button onclick="App.requestDeleteTask('${t.id}')" class="text-xs text-red-400 hover:text-red-600 font-bold ml-2 flex items-center gap-1"><i class="ph ph-trash"></i> Excluir</button>
                        </div>
                    </div>`}).join('');
            }
        };
        
        window.App = App; 
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
