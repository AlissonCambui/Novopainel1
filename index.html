<!DOCTYPE html>
<html lang="pt-BR" class="dark"> <!-- CLASSE 'dark' PERMANENTE AQUI -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento de Minimercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        /* CSS Personalizado Original */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .details-content.hidden {
            display: none;
        }
        .toggle-details-btn svg {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-details-btn.collapsed svg {
            transform: rotate(180deg);
        }
        .ocorrencia-item.editing .view-mode { display: none; }
        .ocorrencia-item:not(.editing) .edit-mode { display: none; }
        
        /* Garante que o modal fique acima de tudo */
        .z-50 { z-index: 50; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
             <!-- BOTÃO DE TEMA REMOVIDO PARA FIXAR NO TEMA ESCURO -->
            <div class="text-4xl font-extrabold mb-2 tracking-tight" style="font-family: 'Arial Black', Arial, sans-serif;">
                <span style="color: #f26324;">vend</span><span style="color: #f7b41e;">Perto</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-slate-100">Painel de Monitoramento</h1>
            <p class="text-slate-600 dark:text-slate-400 mt-2">Controle de backups, análises e ocorrências de minimercados.</p>
        </header>

        <section id="dashboard-resumo" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Solicitações Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-orange-600 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Backups Pendentes</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Análises Pendentes</h3>
                <p id="analises-pendentes" class="text-3xl font-bold text-red-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Ocorrências (Semana)</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-slate-700 mt-1 dark:text-slate-100">0</p>
            </div>
        </section>

        <section id="weekly-productivity" class="mb-8">
             <div class="bg-white p-4 rounded-xl shadow-md text-center max-w-sm mx-auto dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Produtividade Semanal (Ocorrências / Análise)</h3>
                <p id="produtividade-semanal" class="text-3xl font-bold text-emerald-600 mt-1">N/A</p>
                <p class="text-xs text-slate-400 mt-1">Média da semana atual</p>
            </div>
        </section>


        <section class="bg-white p-4 rounded-xl shadow-md mb-8 dark:bg-slate-800 dark:shadow-xl">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4 flex-grow">
                    <input type="text" id="filtro-condominio" placeholder="Filtrar por condomínio..." class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 flex-grow md:flex-grow-0 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    <input type="date" id="filtro-data" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    <input type="number" id="filtro-semana" placeholder="Semana (Ex: 43)" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 w-32 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    <select id="filtro-backup" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Backup (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluído">Concluído</option>
                    </select>
                    <select id="filtro-analise" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Análise (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Análise">Em Análise</option>
                        <option value="Concluída">Concluída</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="expand-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Expandir</button>
                        <button id="collapse-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Recolher</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button id="add-task-btn" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors w-full sm:w-auto flex-grow">
                        + Adicionar
                    </button>
                    <div class="relative inline-block text-left" id="actions-menu-container">
                        <button type="button" id="actions-menu-btn" class="inline-flex justify-center w-full rounded-lg border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-100 focus:ring-orange-500 dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600 dark:hover:bg-slate-600">
                            Ações
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="actions-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20 dark:bg-slate-700 dark:ring-slate-600">
                            <div class="py-1">
                                <button id="priority-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Prioridades</button>
                                <button id="planner-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Planejar Semana</button>
                                <button id="period-analysis-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Análise por Período</button>
                                <button id="annual-report-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Análise Anual</button>
                                <button id="pdv-dashboard-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Painel do PDV</button>
                                <div class="border-t border-slate-100 my-1 dark:border-slate-600"></div>
                                <button id="bulk-add-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Importar Planilha</button>
                                <button id="category-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Categorias</button>
                                <button id="rename-condo-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Renomear</button>
                                <button id="archive-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Arquivar</button>
                                <button id="restore-btn" class="w-full text-left text-orange-700 font-bold block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Restaurar Backup</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Tarefas aqui -->
        </main>
        
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-center mb-8 text-slate-800 dark:text-slate-100">Ocorrências da Semana (por Condomínio)</h2>
            <div class="flex justify-center">
                <div class="bg-white p-4 rounded-xl shadow-md w-full lg:w-1/2 dark:bg-slate-800 dark:shadow-xl">
                     <div class="chart-container">
                        <canvas id="ocorrenciasChart"></canvas>
                     </div>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAIS -->

    <!-- Modal Adicionar -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova Análise</h2>
            <form id="task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Condomínio</label>
                        <div class="relative">
                            <input type="text" id="form-condominio" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" required autocomplete="off">
                            <div id="autocomplete-list" class="absolute z-10 w-full bg-white border border-slate-300 rounded-lg mt-1 hidden max-h-40 overflow-y-auto shadow-lg dark:bg-slate-700 dark:border-slate-600"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data</label>
                        <input type="date" id="form-data-analise" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" required>
                    </div>
                </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Semana (Nº)</label>
                    <input type="number" id="form-semana-trabalho" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                 </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Observações</label>
                    <textarea id="form-observacoes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></textarea>
                 </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ocorrências -->
    <div id="ocorrencia-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Registrar Ocorrências</h2>
            <form id="ocorrencia-form" class="flex-grow flex flex-col min-h-0">
                <input type="hidden" id="ocorrencia-task-id">
                <div id="ocorrencia-list" class="flex-grow overflow-y-auto pr-2 -mr-2 mb-4 space-y-3"></div>
                
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <h3 class="font-semibold mb-2 text-sm text-slate-600 dark:text-slate-300">Nova Ocorrência</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Categoria</label>
                            <select id="add-ocorrencia-categoria" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></select>
                         </div>
                        <div>
                           <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Descrição</label>
                           <input type="text" id="add-ocorrencia-desc" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Início</label>
                            <input type="time" id="add-horario-inicial" step="1" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Fim</label>
                            <input type="time" id="add-horario-final" step="1" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                    </div>
                     <div class="mt-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="add-ocorrencia-inconclusiva" class="h-4 w-4 text-orange-600 border-gray-300 rounded-lg focus:ring-orange-500">
                            <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">Inconclusiva</span>
                        </label>
                    </div>
                     <button type="button" id="add-ocorrencia-btn" class="mt-3 w-full bg-orange-100 text-orange-800 font-semibold px-4 py-2 rounded-lg hover:bg-orange-200 text-sm dark:bg-orange-900 dark:text-orange-100 dark:hover:bg-orange-800">+ Adicionar à Lista</button>
                </div>
                <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                    <button type="button" id="ocorrencia-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-700">Salvar Tudo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modais Secundários - ATUALIZADO IMPORTAR PLANILHA -->
    <div id="bulk-add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Importar Planilha</h2>
            <p class="text-sm text-slate-600 mb-4 dark:text-slate-300">Cole os dados do Excel. A ordem esperada das colunas é:<br>
            <strong>Semana | Data | Unidade | OC | Colaborador | Status</strong></p>
            <form id="bulk-add-form">
                <textarea id="bulk-input-area" rows="10" class="w-full border border-slate-300 rounded-lg p-2 mb-4 text-xs font-mono dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" placeholder="Cole aqui (ex: Semana 47	16/11/2025	ALPHAVIEW	8	Joao Silva	Finalizado)"></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" id="bulk-cancel-btn" class="bg-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-orange-700">Processar e Importar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="restore-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm text-center dark:bg-slate-800 dark:shadow-xl"><h2 class="text-xl font-bold text-red-600 mb-2">Atenção!</h2><p class="text-slate-600 dark:text-slate-300">Substituir dados atuais?</p><div class="mt-4 flex justify-center gap-4"><button id="restore-confirm-cancel-btn" class="bg-slate-200 px-4 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Cancelar</button><button id="restore-confirm-proceed-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Sim</button></div></div></div>
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm text-center dark:bg-slate-800 dark:shadow-xl"><p id="notification-message" class="mb-4 text-lg text-slate-700 dark:text-slate-300"></p><button id="notification-close-btn" class="bg-orange-600 text-white px-6 py-2 rounded-lg">OK</button></div></div>
    
    <!-- MODAL ANÁLISE POR PERÍODO (COMPLETO) -->
    <div id="period-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl h-5/6 flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análise por Período</h2>
                <button id="period-analysis-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4 mb-4 dark:border-slate-700">
                <div>
                    <label for="period-start-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data de Início</label>
                    <input type="date" id="period-start-date" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="period-end-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data de Fim</label>
                    <input type="date" id="period-end-date" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div class="flex items-end">
                    <button id="generate-report-btn" class="bg-orange-600 text-white font-semibold w-full px-4 py-2 rounded-lg hover:bg-orange-700">Gerar Relatório</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Analisar por:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="analysis_type" value="dataAnalise" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500" checked>
                        <span class="ml-2 text-sm text-slate-700 dark:text-slate-300">Data da Análise</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="analysis_type" value="dataConclusao" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                        <span class="ml-2 text-sm text-slate-700 dark:text-slate-300">Data da Conclusão</span>
                    </label>
                </div>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
                <button data-period="today" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Hoje</button>
                <button data-period="yesterday" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Ontem</button>
                <button data-period="this-week" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Esta Semana</button>
                <button data-period="last-week" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Semana Passada</button>
                <button data-period="this-month" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Este Mês</button>
                <button data-period="last-month" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Mês Passado</button>
            </div>

            <div id="period-results-content" class="flex-grow overflow-y-auto hidden">
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-100 p-4 rounded-xl text-center dark:bg-slate-700">
                        <h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400">Dias (Análises)</h3>
                        <p id="period-dias" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-xl text-center dark:bg-slate-700">
                        <h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400">PDV (Condomínios)</h3>
                        <p id="period-pdv" class="text-3xl font-bold text-orange-500 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-xl text-center dark:bg-slate-700">
                        <h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400">OC (Ocorrências)</h3>
                        <p id="period-oc" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                </section>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-900">
                        <h3 class="text-center font-semibold mb-4">Ocorrências por Categoria</h3>
                        <div class="chart-container" style="height: 250px; max-height: 250px;">
                            <canvas id="periodCategoryChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-900">
                        <h3 class="text-center font-semibold mb-4">Ocorrências por Condomínio</h3>
                        <div class="chart-container" style="height: 250px; max-height: 250px;">
                            <canvas id="periodChart"></canvas>
                        </div>
                    </div>
                </div>
                 <div class="mt-6">
                    <h3 class="font-semibold mb-2 text-lg">Lista de Análises no Período</h3>
                    <ul id="period-task-list" class="space-y-2 max-h-40 overflow-y-auto pr-2 bg-slate-50 p-2 rounded-lg dark:bg-slate-900"></ul>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Outros Modais -->
    <div id="annual-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-6xl h-5/6 flex flex-col dark:bg-slate-800 dark:shadow-xl"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Relatório Anual</h2><button id="annual-report-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button></div><div class="flex-grow overflow-y-auto"><section class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-slate-100 p-4 rounded-xl text-center dark:bg-slate-700"><h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400">Total de Análises (Ano)</h3><p id="annual-total-analises" class="text-3xl font-bold text-orange-600 mt-1">0</p></div><div class="bg-slate-100 p-4 rounded-xl text-center dark:bg-slate-700"><h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400">Ocorrências (Ano)</h3><p id="annual-total-ocorrencias" class="text-3xl font-bold text-red-600 mt-1">0</p></div></section><div class="mt-4 chart-container"><canvas id="annualReportChart_Monthly"></canvas></div></div></div></div>
    <div id="priority-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-2xl h-5/6 flex flex-col dark:bg-slate-800 dark:shadow-xl"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Prioridades</h2><button id="priority-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button></div><ul id="priority-task-list" class="flex-grow overflow-y-auto space-y-2"></ul></div></div>
    <div id="planner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-lg flex flex-col dark:bg-slate-800 dark:shadow-xl"><h2 class="text-2xl font-bold mb-4">Planejador</h2><form id="planner-form"><input type="number" id="planner-week-number" class="w-full border p-2 rounded-lg mb-4 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" placeholder="Semana Nº"><div id="planner-list-container" class="h-64 overflow-y-auto border p-2 rounded-lg mb-4"></div><div class="flex justify-end gap-2"><button type="button" id="planner-cancel-btn" class="bg-slate-200 px-4 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Cancelar</button></div></form></div></div>
    <div id="pdv-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-4xl h-5/6 flex flex-col dark:bg-slate-800 dark:shadow-xl"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Painel PDV</h2><button id="pdv-dashboard-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button></div><div id="pdv-content" class="flex-grow overflow-y-auto"><div class="chart-container mb-4"><canvas id="pdvTrendChart"></canvas></div></div></div></div>
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800 dark:shadow-xl"><h2 class="text-2xl font-bold mb-4">Categorias</h2><div id="category-list-container" class="h-40 overflow-y-auto border p-2 mb-4 rounded-lg"></div><button id="category-close-btn" class="w-full bg-slate-200 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Fechar</button></div></div>
    <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800 dark:shadow-xl"><h2 class="text-2xl font-bold mb-4">Renomear</h2><form id="rename-form"><label>Antigo</label><select id="form-old-name" class="w-full border p-2 rounded-lg mb-4 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></select><label>Novo</label><input type="text" id="form-new-name" class="w-full border p-2 rounded-lg mb-4 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"><div class="flex justify-end gap-2"><button type="button" id="rename-cancel-btn" class="bg-slate-200 px-4 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Cancelar</button><button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-lg">Salvar</button></div></form></div></div>
    <div id="archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800 dark:shadow-xl"><h2 class="text-2xl font-bold mb-4">Arquivar</h2><form id="archive-form"><div class="space-y-2 mb-4"><button type="button" id="view-archive-btn" class="w-full bg-slate-500 text-white px-4 py-2 rounded-lg mb-4">Ver Arquivo</button><div class="flex gap-2"><button type="button" id="archive-cancel-btn" class="bg-slate-200 w-full px-4 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Cancelar</button></div></div></form></div></div>
    
    <!-- Modal Arquivados -->
    <div id="view-archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análises Arquivadas</h2>
                <button id="view-archive-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
             <div class="mb-4">
                <input type="text" id="archive-search-input" placeholder="Buscar em arquivadas..." class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
             </div>
            <div id="view-archive-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-lg min-h-[200px] dark:bg-slate-900">
                <p class="text-center text-slate-500">Nenhuma análise arquivada.</p>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                 <button id="view-archive-close-footer-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <input type="file" id="restore-input" class="hidden" accept=".json">

    <script>
        // Objeto de classes CSS para os status
        const statusClasses = {
            'Pendente': 'bg-amber-100 text-amber-600',
            'Em Andamento': 'bg-orange-100 text-orange-600',
            'Em Análise': 'bg-orange-100 text-orange-600',
            'Concluído': 'bg-emerald-100 text-emerald-600',
            'Concluída': 'bg-emerald-100 text-emerald-600',
            'Não visualizar': 'bg-slate-100 text-slate-500'
        };

        // Variáveis Chart.js - Declaradas para escopo global
        let ocorrenciasChart, annualMonthlyChart, pdvTrendChart, periodChart, periodCategoryChart;

        // --- FUNÇÕES DE LAYOUT E CHARTS (Convertidas para function declaration para garantir hoisting) ---
        
        function updateChartsTheme() {
            // Como o tema agora é fixo (dark), definimos as cores fixas para dark mode
            const isDark = true; 
            const fontColor = '#f1f5f9'; // slate-100 

            const commonOptions = {
                scales: {
                    y: {
                        ticks: { color: fontColor },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        title: { color: fontColor }
                    },
                    x: {
                        ticks: { color: fontColor },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        title: { color: fontColor }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: fontColor }
                    }
                }
            };

            // Aplicar opções a todos os gráficos
            if (ocorrenciasChart) { Object.assign(ocorrenciasChart.options, commonOptions); ocorrenciasChart.update(); }
            if (annualMonthlyChart) { Object.assign(annualMonthlyChart.options, commonOptions); annualMonthlyChart.update(); }
            if (pdvTrendChart) { Object.assign(pdvTrendChart.options, commonOptions); pdvTrendChart.update(); }
            if (periodChart) { Object.assign(periodChart.options, commonOptions); periodChart.update(); }
            if (periodCategoryChart) { Object.assign(periodCategoryChart.options.plugins.legend.labels, { color: fontColor }); periodCategoryChart.update(); }
        }

        function setupCharts() {
            const ctx = document.getElementById('ocorrenciasChart').getContext('2d');
            ocorrenciasChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(249, 115, 22, 0.6)' }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
            
            const annualCtx = document.getElementById('annualReportChart_Monthly').getContext('2d');
            annualMonthlyChart = new Chart(annualCtx, {
                type: 'bar', data: { labels: ['Jan','Fev','Mar'], datasets: [{ label: 'Mensal', data: [0,0,0], backgroundColor: 'red' }] }, options: { maintainAspectRatio: false }
            });

            const pdvCtx = document.getElementById('pdvTrendChart').getContext('2d');
            pdvTrendChart = new Chart(pdvCtx, {
                type: 'line', data: { labels: [], datasets: [{ label: 'Tendência', data: [] }] }, options: { maintainAspectRatio: false }
            });

            const periodCtx = document.getElementById('periodChart').getContext('2d');
            periodChart = new Chart(periodCtx, {
                type: 'bar', data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(249, 115, 22, 0.6)' }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            const periodCategoryCtx = document.getElementById('periodCategoryChart').getContext('2d');
            periodCategoryChart = new Chart(periodCategoryCtx, {
                type: 'pie', data: { labels: [], datasets: [{ label: 'Ocorrências por Categoria', data: [], backgroundColor: ['#ea580c', '#f97316', '#f7b41e', '#fbbf24', '#fcd34d', '#fed7aa', '#ffedd5'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
            let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
            let categories = JSON.parse(localStorage.getItem('monitoramentoCategorias')) || ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Outros'];

            // --- FUNÇÕES DE UTILIDADE E HANDLERS ---
            // As funções principais aqui dentro também foram convertidas para function declaration.

            const saveTasks = () => {
                localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            };

            const showNotification = (message) => {
                document.getElementById('notification-message').textContent = message;
                document.getElementById('notification-modal').classList.remove('hidden');
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString + 'T00:00:00');
                date.setDate(date.getDate() + 1); // Ajuste simples fuso
                return date.toLocaleDateString('pt-BR');
            };
            
            const formatDateForInput = (date) => date.toISOString().split('T')[0];

            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            const populateCategorySelect = (selectElement, selectedValue = '') => {
                selectElement.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === selectedValue) option.selected = true;
                    selectElement.appendChild(option);
                });
            };

            const renderOcorrenciaItemInModal = (ocor, container) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ocorrencia-item p-3 bg-slate-100 rounded-lg dark:bg-slate-700';
                itemDiv.innerHTML = `<p class="font-semibold text-slate-800 dark:text-slate-100">${ocor.categoria}: ${ocor.desc}</p><p class="text-sm text-slate-500 dark:text-slate-400">Horário: ${ocor.horarioInicial} - ${ocor.horarioFinal}</p>`;
                container.appendChild(itemDiv);
            };
            
            function handleTaskSubmit(e) {
                e.preventDefault();
                const condominio = document.getElementById('form-condominio').value;
                const dataAnalise = document.getElementById('form-data-analise').value;
                
                // FIX 1: Verificação de duplicidade
                const isDuplicate = tasks.some(t => 
                    t.condominio === condominio && t.dataAnalise === dataAnalise
                );

                if (isDuplicate) {
                    showNotification(`Análise para ${condominio} em ${formatDate(dataAnalise)} já existe.`);
                    return; 
                }

                const newTask = {
                    id: Date.now(),
                    condominio: condominio,
                    dataAnalise: dataAnalise,
                    semanaDeTrabalho: parseInt(document.getElementById('form-semana-trabalho').value) || 0,
                    observacoes: document.getElementById('form-observacoes').value,
                    statusBackup: 'Pendente',
                    statusAnalise: 'Pendente',
                    ocorrencia: 'Pendente',
                    isExpanded: true,
                    ocorrencias: []
                };
                tasks.unshift(newTask);
                refreshUI();
                document.getElementById('task-modal').classList.add('hidden');
                showNotification('Nova análise adicionada.');
            }

            // --- NOVO HANDLER PARA IMPORTAÇÃO EM MASSA (PLANILHA) ---
            function handleBulkAddSubmit(e) {
                e.preventDefault();
                const inputArea = document.getElementById('bulk-input-area').value.trim();
                if (!inputArea) {
                    showNotification('Cole os dados da planilha na área de texto.');
                    return;
                }

                const lines = inputArea.split('\n').filter(line => line.trim().length > 0);
                const newTasks = [];
                let ignoredCount = 0;

                // Regex para lidar com separação por tabulação ou múltiplos espaços
                const lineSeparatorRegex = /\s{2,}|\t/g;

                lines.forEach((line, index) => {
                    // Tenta dividir por tabulação primeiro (padrão de copy/paste de planilhas)
                    let parts = line.split('\t');
                    
                    // Se a separação por tabulação não funcionar, tenta por múltiplos espaços
                    if (parts.length < 5) { // Esperamos pelo menos Semana, Data, Unidade, Colaborador, Status
                       parts = line.split(lineSeparatorRegex);
                    }
                    
                    // Limpar espaços nas extremidades de cada parte
                    parts = parts.map(p => p.trim()).filter(p => p.length > 0);
                    
                    // Se o cabeçalho for detectado, ignorar
                    if (parts[0] && parts[0].toLowerCase().includes('semana') && parts[1] && parts[1].toLowerCase().includes('dia')) {
                        return; 
                    }
                    
                    // Estrutura esperada: [Semana | Dia a visualizar | Unidade | OC | Colaborador | Status]
                    // Índice 0: Semana
                    // Índice 1: Data
                    // Índice 2: Unidade (Condomínio)
                    // Índice 3: OC (Opcional)
                    // Índice 4: Colaborador
                    // Índice 5: Status

                    if (parts.length < 5) {
                        ignoredCount++;
                        return;
                    }

                    const semanaRaw = parts[0] || '';
                    const dataRaw = parts[1] || '';
                    const unidadeRaw = parts[2] || '';
                    // OC é o terceiro ou o quarto campo, dependendo se Colaborador está junto
                    let ocRaw = '';
                    let colaboradorRaw = '';
                    let statusRaw = 'Pendente';
                    
                    if (parts.length === 6) { // Todos os 6 campos presentes
                        ocRaw = parts[3] || '';
                        colaboradorRaw = parts[4] || '';
                        statusRaw = parts[5] || 'Pendente';
                    } else if (parts.length === 5) { // OC está ausente ou fundido na Unidade
                        // Se o campo 3 é um número (OC), assumimos 5 campos sendo: [Semana, Data, Unidade, Colaborador, Status]
                        // Se o campo 3 NÃO é um número, é Colaborador, e 4 é Status
                        
                        // Dado o formato do seu paste, a Unidade pode ter fundido OC e Colaborador
                        // Vamos tentar ser flexíveis, mas garantir os mais importantes: Condomínio, Data, Status.
                        
                        // Tentativa: Partes 3, 4 e 5 são OC, Colaborador e Status (pode haver deslocamento)
                        // Para o seu padrão (Semana 47 16/11/2025 COLORS ALTO DA LAPA Alisson Desconectado) -> 5 campos:
                        // [Semana 47] [16/11/2025] [COLORS ALTO DA LAPA] [Alisson] [Desconectado]
                        // Aqui, OC está faltando e Colaborador está no índice 3 e Status no 4.
                        
                        // Para o seu padrão (Semana 47 24/10/2025 HIGH GARDEN COSMOPOLITAN 4 Alisson Finalizado) -> 6 campos:
                        // [Semana 47] [24/10/2025] [HIGH GARDEN COSMOPOLITAN] [4] [Alisson] [Finalizado]
                        
                        // Ajustando a leitura para 5 ou 6 campos:
                        if (parts.length >= 5) {
                            if (parts.length === 6) {
                                ocRaw = parts[3];
                                colaboradorRaw = parts[4];
                                statusRaw = parts[5];
                            } else { // parts.length === 5
                                // Assumindo que OC está vazio e Colaborador e Status estão no final
                                ocRaw = ''; // O campo 3 (parts[3]) é o Colaborador
                                colaboradorRaw = parts[3];
                                statusRaw = parts[4];
                            }
                        }
                    } else { // Caso não se encaixe em 5 ou 6 (ex: 4 campos)
                         ignoredCount++;
                         return;
                    }
                    
                    // Se o campo 'OC' for lido como Colaborador por engano, limpamos
                    if (ocRaw && isNaN(parseInt(ocRaw))) ocRaw = '';


                    let isoDate = '';
                    if (dataRaw.includes('/')) {
                        const [d, m, y] = dataRaw.split('/');
                        if(d && m && y) isoDate = `${y}-${m}-${d}`;
                    } else {
                        isoDate = new Date().toISOString().split('T')[0];
                    }

                    // Prevenção de duplicidade
                    const isDuplicate = tasks.some(t => 
                        t.condominio === unidadeRaw.trim() && t.dataAnalise === isoDate
                    );

                    if (isDuplicate) {
                        ignoredCount++;
                        console.warn(`Duplicidade ignorada na linha ${index + 2}: ${unidadeRaw.trim()} em ${isoDate}`);
                        return;
                    }

                    const semanaMatch = semanaRaw.match(/\d+/);
                    const semanaNum = semanaMatch ? parseInt(semanaMatch[0]) : 0;

                    let stAnalise = 'Pendente';
                    let stBackup = 'Pendente';
                    let hasOcorrencia = 'Não';
                    
                    const stLower = statusRaw.toLowerCase().trim();

                    if (stLower.includes('finalizado')) {
                        stAnalise = 'Concluída';
                        stBackup = 'Concluído';
                    } else if (stLower.includes('desconectado') || stLower.includes('sem gravação') || stLower.includes('sem imagem')) {
                        stBackup = 'Pendente';
                        stAnalise = 'Pendente'; // Ou um status específico se houver
                    }

                    let ocorrenciasList = [];
                    if (ocRaw && ocRaw.trim().length > 0 && parseInt(ocRaw) > 0) {
                        hasOcorrencia = 'Sim';
                        // A descrição completa (OC e Colaborador) é mantida apenas na lista de Ocorrências (Modal).
                        ocorrenciasList.push({
                            categoria: 'Importado (Planilha)',
                            desc: `OC Nº ${ocRaw} - Colaborador: ${colaboradorRaw}`,
                            horarioInicial: '00:00',
                            horarioFinal: '00:00'
                        });
                    }

                    newTasks.push({
                        id: Date.now() + index,
                        condominio: unidadeRaw.trim(),
                        dataAnalise: isoDate,
                        semanaDeTrabalho: semanaNum,
                        // As observações são **vazias** por padrão, forçando o card a ficar limpo.
                        observacoes: '', 
                        statusBackup: stBackup,
                        statusAnalise: stAnalise,
                        ocorrencia: hasOcorrencia,
                        isExpanded: true,
                        ocorrencias: ocorrenciasList
                    });
                });

                if (newTasks.length > 0) {
                    tasks.unshift(...newTasks);
                    refreshUI();
                    document.getElementById('bulk-add-modal').classList.add('hidden');
                    document.getElementById('bulk-input-area').value = '';
                    showNotification(`${newTasks.length} importados. (${ignoredCount} linhas ignoradas)`);
                } else {
                    showNotification('Nenhum dado válido encontrado. Verifique a formatação.');
                }
            }

            // ... (Funções omitidas por brevidade) ...

            function updateDashboard() {
                const filteredTasks = tasks.filter(t => t.statusAnalise !== 'Arquivado');
                
                document.getElementById('total-solicitacoes').textContent = filteredTasks.length;
                document.getElementById('backups-pendentes').textContent = filteredTasks.filter(t => t.statusBackup === 'Pendente').length;
                document.getElementById('analises-pendentes').textContent = filteredTasks.filter(t => t.statusAnalise === 'Pendente').length;
                
                const completedThisWeek = filteredTasks.filter(t => t.statusAnalise === 'Concluída');
                const totalOccurrencesWeek = completedThisWeek.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                document.getElementById('total-ocorrencias-semana').textContent = totalOccurrencesWeek;
                
                const prodElement = document.getElementById('produtividade-semanal');
                if (prodElement) prodElement.textContent = completedThisWeek.length > 0 ? (totalOccurrencesWeek / completedThisWeek.length).toFixed(1) : '0.0';
            }

            function updateCharts() {
                const dataByCondo = tasks.reduce((acc, task) => {
                    if (task.ocorrencia === 'Sim' && task.ocorrencias) {
                        if (!acc[task.condominio]) acc[task.condominio] = 0;
                        acc[task.condominio] += task.ocorrencias.length;
                    }
                    return acc;
                }, {});
                
                const labels = Object.keys(dataByCondo);
                const data = Object.values(dataByCondo);
                
                if (ocorrenciasChart) {
                    ocorrenciasChart.data.labels = labels;
                    ocorrenciasChart.data.datasets[0].data = data;
                    ocorrenciasChart.update();
                }
            }

            function renderTasks() {
                const filtroCond = document.getElementById('filtro-condominio').value.toLowerCase();
                const filtroBackup = document.getElementById('filtro-backup').value;
                const filtroAnalise = document.getElementById('filtro-analise').value;

                let filteredTasks = tasks.filter(task => 
                    task.condominio.toLowerCase().includes(filtroCond)
                );
                
                // Aplicação dos filtros de status
                if (filtroBackup) {
                    filteredTasks = filteredTasks.filter(task => task.statusBackup === filtroBackup);
                }
                if (filtroAnalise) {
                    filteredTasks = filteredTasks.filter(task => task.statusAnalise === filtroAnalise);
                }

                const taskList = document.getElementById('task-list');
                taskList.innerHTML = '';

                if(filteredTasks.length === 0) {
                    taskList.innerHTML = `<p class="text-slate-500 text-center col-span-full">Nenhuma tarefa encontrada.</p>`;
                    return;
                }

                filteredTasks.forEach(task => {
                    const card = document.createElement('div');
                    let borderSideColor = '#f59e0b'; 
                    if (task.statusAnalise === 'Em Análise') borderSideColor = '#f97316';
                    if (task.statusAnalise === 'Concluída') borderSideColor = '#10b981';

                    // Card rounded-xl
                    card.className = 'bg-white p-4 rounded-xl shadow-md border-l-4 dark:bg-slate-800 dark:shadow-xl';
                    card.style.borderLeftColor = borderSideColor;
                    
                    const ocorrenciaCount = task.ocorrencias ? task.ocorrencias.length : 0;
                    const ocorrenciaBadge = ocorrenciaCount > 0 ? `<div class="mt-1"><span class="px-2 py-0.5 text-xs font-bold text-red-700 bg-red-100 rounded-lg border border-red-300 dark:bg-red-900 dark:text-red-100 dark:border-red-700">OCs: ${ocorrenciaCount}</span></div>` : '';

                    const isCollapsed = !task.isExpanded;
                    let detailsButtonHTML = '';
                    
                    if (task.statusAnalise === 'Pendente' || task.statusAnalise === 'Em Análise' || task.statusAnalise === 'Concluída') {
                         const buttonText = task.statusAnalise === 'Concluída' ? 'Ver/Editar Ocorrências' : 'Registrar Ocorrências';
                         detailsButtonHTML = `<button data-id="${task.id}" class="edit-ocorrencia-btn mt-4 w-full bg-slate-200 text-slate-800 font-bold py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">${buttonText}</button>`;
                    }
                    
                    let cleanObsGeral = '';
                    // Exibir Obs Geral APENAS se o campo 'observacoes' for preenchido manualmente
                    if (task.observacoes && task.observacoes.trim().length > 0) {
                         cleanObsGeral = `
                            <div class="mt-4 border-t pt-2 space-y-2 dark:border-slate-700">
                                <p class="text-sm font-semibold text-slate-600 dark:text-slate-300">Obs. Geral:</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${task.observacoes}</p>
                            </div>
                        `;
                    }

                    // REMOVIDO: ocorrenciaDetailsHTML não será mais renderizado aqui, garantindo a limpeza.

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg flex-1">${task.condominio}</h3>
                            <div class="flex items-center gap-2">
                                <button data-id="${task.id}" class="archive-single-btn text-slate-400 hover:text-orange-600 font-bold text-lg" title="Arquivar">&#128450;</button>
                                <button data-id="${task.id}" class="delete-task-btn text-slate-400 hover:text-red-600 font-bold text-lg" title="Excluir">&times;</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Data: <strong>${formatDate(task.dataAnalise)}</strong></p>
                                ${ocorrenciaBadge} <!-- Display Fix: Ocorrência count -->
                            </div>
                            <button data-id="${task.id}" class="toggle-details-btn p-1 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-100">
                                ${isCollapsed ? '&#9660;' : '&#9650;'}
                            </button>
                        </div>
                        <div class="${isCollapsed ? 'hidden' : ''} mt-4 details-content">
                            <div class="space-y-3 text-sm mt-4">
                                <div class="flex justify-between items-center text-sm mb-1"><span class="font-semibold text-slate-600 dark:text-slate-300">Backup:</span> <select data-id="${task.id}" data-type="backup" class="status-select border-none text-right font-semibold text-sm rounded-lg p-1 ${statusClasses[task.statusBackup]}"><option value="Pendente" ${task.statusBackup === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Andamento" ${task.statusBackup === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option><option value="Concluído" ${task.statusBackup === 'Concluído' ? 'selected' : ''}>Concluído</option></select></div>
                                <div class="flex justify-between items-center text-sm"><span class="font-semibold text-slate-600 dark:text-slate-300">Análise:</span> <select data-id="${task.id}" data-type="analise" class="status-select border-none text-right font-semibold text-sm rounded-lg p-1 ${statusClasses[task.statusAnalise]}"><option value="Pendente" ${task.statusAnalise === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Análise" ${task.statusAnalise === 'Em Análise' ? 'selected' : ''}>Em Análise</option><option value="Concluída" ${task.statusAnalise === 'Concluída' ? 'selected' : ''}>Concluída</option></select></div>
                            </div>
                            ${cleanObsGeral} <!-- Apenas Obs Geral se preenchida manualmente -->
                            ${detailsButtonHTML}
                        </div>
                    `;
                    taskList.appendChild(card);
                });
            }

            function refreshUI() {
                saveTasks();
                renderTasks();
                updateDashboard();
                updateCharts();
                updateChartsTheme(); // Garante o tema escuro nos gráficos
            }

            // --- LISTENERS ---

            // Filtros (Adicionado listener de change para filtros de status)
            document.getElementById('filtro-condominio').addEventListener('input', refreshUI);
            document.getElementById('filtro-backup').addEventListener('change', refreshUI); 
            document.getElementById('filtro-analise').addEventListener('change', refreshUI); 
            
            document.getElementById('expand-all-btn').addEventListener('click', () => { tasks.forEach(t => t.isExpanded = true); refreshUI(); });
            document.getElementById('collapse-all-btn').addEventListener('click', () => { tasks.forEach(t => t.isExpanded = false); refreshUI(); });

            // Modal Adicionar Tarefa
            document.getElementById('add-task-btn').addEventListener('click', () => {
                document.getElementById('task-form').reset();
                document.getElementById('form-data-analise').value = formatDateForInput(new Date());
                document.getElementById('task-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('task-modal').classList.add('hidden'));
            document.getElementById('task-form').addEventListener('submit', handleTaskSubmit);
            
            // Modal Importar (Novo Listener)
            document.getElementById('bulk-add-form').addEventListener('submit', handleBulkAddSubmit);

            // Menu Ações
            const actionsMenu = document.getElementById('actions-menu');
            document.getElementById('actions-menu-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                actionsMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (!document.getElementById('actions-menu-container').contains(event.target)) {
                    actionsMenu.classList.add('hidden');
                }
            });

            // Botões do Menu de Ações
            const menuMap = {
                'bulk-add-btn': 'bulk-add-modal',
                'category-btn': 'category-modal',
                'rename-condo-btn': 'rename-modal',
                'archive-btn': 'archive-modal',
                'period-analysis-btn': 'period-analysis-modal',
                'annual-report-btn': 'annual-report-modal',
                'priority-btn': 'priority-modal',
                'planner-btn': 'planner-modal',
                'pdv-dashboard-btn': 'pdv-dashboard-modal'
            };

            Object.keys(menuMap).forEach(btnId => {
                document.getElementById(btnId).addEventListener('click', () => {
                    actionsMenu.classList.add('hidden');
                    document.getElementById(menuMap[btnId]).classList.remove('hidden');
                });
            });

            // Fechamento de Modais Secundários
            const closeMap = {
                'bulk-cancel-btn': 'bulk-add-modal',
                'category-close-btn': 'category-modal',
                'rename-cancel-btn': 'rename-modal',
                'archive-cancel-btn': 'archive-modal',
                'period-analysis-close-btn': 'period-analysis-modal',
                'annual-report-close-btn': 'annual-report-modal',
                'priority-close-btn': 'priority-modal',
                'planner-cancel-btn': 'planner-modal',
                'pdv-dashboard-close-btn': 'pdv-dashboard-modal',
                'view-archive-close-btn': 'view-archive-modal',
                'view-archive-close-footer-btn': 'view-archive-modal',
                'restore-confirm-cancel-btn': 'restore-confirm-modal',
                'notification-close-btn': 'notification-modal'
            };

            Object.keys(closeMap).forEach(btnId => {
                document.getElementById(btnId).addEventListener('click', () => {
                    document.getElementById(closeMap[btnId]).classList.add('hidden');
                });
            });

            // Listeners de Relatório
            // ... (necessário reintroduzir listeners aqui se as funções de relatório forem mantidas) ...

            // Ação Ver Arquivos
            document.getElementById('view-archive-btn').addEventListener('click', () => {
                document.getElementById('archive-modal').classList.add('hidden');
                document.getElementById('view-archive-modal').classList.remove('hidden');
                const archiveContainer = document.getElementById('view-archive-list-container');
                archiveContainer.innerHTML = archivedTasks.length 
                    ? archivedTasks.map(t => `<div class="p-2 border-b">${t.condominio} - ${t.dataAnalise}</div>`).join('')
                    : '<p class="text-center text-slate-500">Vazio</p>';
            });


            // Delegação de Eventos na Lista de Tarefas
            document.getElementById('task-list').addEventListener('click', (e) => {
                const target = e.target;
                const deleteBtn = target.closest('.delete-task-btn');
                const archiveBtn = target.closest('.archive-single-btn');
                const toggleBtn = target.closest('.toggle-details-btn');
                const editOcBtn = target.closest('.edit-ocorrencia-btn');

                if (deleteBtn) {
                    if (confirm('Excluir análise?')) {
                        tasks = tasks.filter(t => t.id != deleteBtn.dataset.id);
                        refreshUI();
                    }
                } else if (archiveBtn) {
                    if (confirm('Arquivar análise?')) {
                        const idx = tasks.findIndex(t => t.id == archiveBtn.dataset.id);
                        if(idx > -1) {
                            archivedTasks.push(tasks[idx]);
                            tasks.splice(idx, 1);
                            refreshUI();
                            showNotification('Análise arquivada.');
                        }
                    }
                } else if (toggleBtn) {
                    const t = tasks.find(x => x.id == toggleBtn.dataset.id);
                    if(t) { t.isExpanded = !t.isExpanded; refreshUI(); }
                } else if (editOcBtn) {
                    const t = tasks.find(x => x.id == editOcBtn.dataset.id);
                    if(t) {
                        document.getElementById('ocorrencia-task-id').value = t.id;
                        const list = document.getElementById('ocorrencia-list');
                        list.innerHTML = '';
                        (t.ocorrencias || []).forEach(oc => renderOcorrenciaItemInModal(oc, list));
                        populateCategorySelect(document.getElementById('add-ocorrencia-categoria'));
                        
                        document.getElementById('add-ocorrencia-desc').value = ''; 
                        document.getElementById('ocorrencia-modal').classList.remove('hidden');
                    }
                }
            });

            // Mudança de Status (Selects)
            document.getElementById('task-list').addEventListener('change', (e) => {
                if (e.target.classList.contains('status-select')) {
                    const id = e.target.dataset.id;
                    const type = e.target.dataset.type;
                    const task = tasks.find(t => t.id == id);
                    if (task) {
                        if (type === 'backup') task.statusBackup = e.target.value;
                        if (type === 'analise') task.statusAnalise = e.target.value;
                        refreshUI();
                    }
                }
            });

            // Modal Ocorrências - Adicionar Item
            document.getElementById('add-ocorrencia-btn').addEventListener('click', () => {
                const desc = document.getElementById('add-ocorrencia-desc').value;
                const cat = document.getElementById('add-ocorrencia-categoria').value;
                const ini = document.getElementById('add-horario-inicial').value;
                const fim = document.getElementById('add-horario-final').value;
                
                if (desc) {
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-orange-50 border border-orange-200 rounded-lg mb-2 new-occ-item dark:bg-orange-900 dark:border-orange-800 dark:text-orange-100';
                    item.dataset.json = JSON.stringify({ categoria: cat, desc: desc, horarioInicial: ini, horarioFinal: fim });
                    item.innerHTML = `<strong>${cat}</strong>: ${desc} <span class="text-xs">(${ini} - ${fim})</span>`;
                    document.getElementById('ocorrencia-list').appendChild(item);
                    
                    document.getElementById('add-ocorrencia-desc').value = '';
                    document.getElementById('add-horario-inicial').value = '';
                    document.getElementById('add-horario-final').value = '';
                }
            });

            // Modal Ocorrências - Salvar Tudo
            document.getElementById('ocorrencia-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const taskId = document.getElementById('ocorrencia-task-id').value;
                const task = tasks.find(t => t.id == taskId);
                if (task) {
                    const newItems = Array.from(document.querySelectorAll('.new-occ-item')).map(el => JSON.parse(el.dataset.json));
                    if (!task.ocorrencias) task.ocorrencias = [];
                    task.ocorrencias.push(...newItems);
                    
                    task.ocorrencia = task.ocorrencias.length > 0 ? 'Sim' : 'Não';
                    refreshUI();
                    document.getElementById('ocorrencia-modal').classList.add('hidden');
                }
            });
            
            document.getElementById('ocorrencia-cancel-btn').addEventListener('click', () => document.getElementById('ocorrencia-modal').classList.add('hidden'));

            // Inicialização
            setupCharts();
            refreshUI();
        });
    </script>
</body>
</html>