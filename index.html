<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento de Minimercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#37c0a0', 
                            hover: '#2a9d82',   
                            light: 'rgba(55, 192, 160, 0.1)' 
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .details-content.hidden { display: none; }
        .toggle-details-btn svg { transition: transform 0.2s ease-in-out; }
        .toggle-details-btn.collapsed svg { transform: rotate(180deg); }
        .z-50 { z-index: 50; }
        .z-60 { z-index: 60; }
        .z-70 { z-index: 70; }
        .occ-actions { opacity: 1; }
        /* Estilos específicos do Analytics */
        .analytics-card { transition: all 0.3s ease; }
        .analytics-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 flex flex-col min-h-screen">

    <div class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-slate-100">Painel de Monitoramento</h1>
            <p class="text-slate-600 dark:text-slate-400 mt-2">Controle de backups, análises e ocorrências de minimercados.</p>
        </header>

        <!-- Resumo do Dashboard -->
        <section id="dashboard-resumo" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Solicitações Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-brand mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">PDVs Visualizados</h3>
                <p id="total-pdvs-unicos" class="text-3xl font-bold text-blue-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Backups Pendentes</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Análises Pendentes</h3>
                <p id="analises-pendentes" class="text-3xl font-bold text-red-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center dark:bg-slate-800 dark:shadow-xl">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Ocorrências (Semana)</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-slate-700 mt-1 dark:text-slate-100">0</p>
            </div>
        </section>

        <!-- Filtros e Ações -->
        <section class="bg-white p-4 rounded-xl shadow-md mb-8 dark:bg-slate-800 dark:shadow-xl">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4 flex-grow">
                    <input type="text" id="filtro-condominio" placeholder="Filtrar por condomínio..." class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand flex-grow md:flex-grow-0 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    
                    <input type="date" id="filtro-data" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    
                    <select id="filtro-dia-semana" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Dia da Semana (Todos)</option>
                        <option value="1">Segunda-feira</option>
                        <option value="2">Terça-feira</option>
                        <option value="3">Quarta-feira</option>
                        <option value="4">Quinta-feira</option>
                        <option value="5">Sexta-feira</option>
                        <option value="6">Sábado</option>
                        <option value="0">Domingo</option>
                    </select>

                    <input type="number" id="filtro-semana" placeholder="Semana (Ex: 43)" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand w-32 bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    
                    <select id="filtro-backup" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Backup (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluído">Concluído</option>
                    </select>
                    <select id="filtro-analise" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-brand bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="">Análise (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Análise">Em Análise</option>
                        <option value="Concluída">Concluída</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="expand-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Expandir</button>
                        <button id="collapse-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Recolher</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button id="add-task-btn" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover transition-colors w-full sm:w-auto flex-grow">
                        + Adicionar
                    </button>
                    <div class="relative inline-block text-left" id="actions-menu-container">
                        <button type="button" id="actions-menu-btn" class="inline-flex justify-center w-full rounded-lg border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-100 focus:ring-brand dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600 dark:hover:bg-slate-600">
                            Ações
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="actions-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20 dark:bg-slate-700 dark:ring-slate-600">
                            <div class="py-1">
                                <button id="bulk-add-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Importar Planilha</button>
                                <button id="open-analytics-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600 font-semibold text-brand">Analytics de Produtividade</button>
                                <button id="completed-report-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Relatório Concluídas</button>
                                <button id="detailed-pdv-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Análise Detalhada PDV</button>
                                <button id="archive-btn" class="w-full text-left block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600">Arquivar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Tarefas -->
        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Cards Renderizados via JS -->
        </main>
        
        <!-- Gráficos -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-center mb-8 text-slate-800 dark:text-slate-100">Ocorrências da Semana (por Condomínio)</h2>
            <div class="flex justify-center">
                <div class="bg-white p-4 rounded-xl shadow-md w-full lg:w-1/2 dark:bg-slate-800 dark:shadow-xl">
                     <div class="chart-container">
                        <canvas id="ocorrenciasChart"></canvas>
                     </div>
                </div>
            </div>
             <div id="weekly-productivity" class="mt-8">
                 <div class="bg-white p-4 rounded-xl shadow-md text-center max-w-sm mx-auto dark:bg-slate-800 dark:shadow-xl">
                    <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Produtividade Semanal (Ocorrências / Análise)</h3>
                    <p id="produtividade-semanal" class="text-3xl font-bold text-emerald-600 mt-1">N/A</p>
                    <p class="text-xs text-slate-400 mt-1">Média da semana atual</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Indicador de Versão no Rodapé -->
    <footer class="p-4 text-center text-xs text-slate-400 dark:text-slate-600">
        v3.5 (Com Analytics Integrado)
    </footer>

    <!-- MODAIS EXISTENTES -->
    <!-- (Mantidos: task-modal, ocorrencia-modal, bulk-add-modal, etc.) -->

    <!-- [INÍCIO] NOVO MODAL: ANALYTICS E RELATÓRIO PDV -->
    <div id="analytics-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-0 hidden z-70">
        <div class="bg-slate-100 w-full h-full md:h-[95vh] md:w-[95vw] md:rounded-xl overflow-hidden flex flex-col dark:bg-slate-900 shadow-2xl">
            <!-- Header Analytics -->
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    <h2 class="text-xl font-bold">Analytics & Importação (Beta)</h2>
                </div>
                <div class="flex gap-2">
                    <button id="analytics-back-to-input-btn" class="hidden px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white transition-colors">Nova Importação</button>
                    <button id="analytics-close-btn" class="p-2 hover:bg-slate-700 rounded-full transition-colors text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
            </div>

            <!-- Corpo Analytics -->
            <div class="flex-grow overflow-y-auto bg-slate-50 dark:bg-slate-900 p-4 md:p-6" id="analytics-body">
                
                <!-- 1. TELA DE IMPORTAÇÃO (INPUT) -->
                <div id="analytics-input-view" class="max-w-4xl mx-auto animate-fade-in">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-slate-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            Importar Dados (Novo Formato)
                        </h2>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 dark:bg-blue-900/20 dark:border-blue-700">
                            <h3 class="font-bold text-blue-800 dark:text-blue-200 text-sm">Instruções:</h3>
                            <p class="text-xs text-blue-700 dark:text-blue-300 mt-1">
                                Copie as linhas da planilha de produtividade (colunas: Data Vis, Data Prod, Cód, Unidade, OC, Operador, Obs).<br>
                                O sistema identificará automaticamente as colunas.
                            </p>
                        </div>

                        <textarea id="analytics-raw-input" class="w-full h-64 p-4 border border-slate-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-brand focus:border-transparent mb-4 whitespace-pre dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" placeholder="Cole aqui seus dados... Exemplo: 16/04/2025  15/04/2025  346  RESIDENCIAL TERRACO  1  1  7  Dayane  ..."></textarea>

                        <div class="flex gap-3 justify-end">
                            <button id="analytics-load-example-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">Carregar Exemplo</button>
                            <button id="analytics-process-btn" class="bg-brand hover:bg-brand-hover text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-transform hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                                Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 2. TELA DE DASHBOARD (RESULTADOS) -->
                <div id="analytics-dashboard-view" class="hidden space-y-6">
                    
                    <!-- Filtro de Semanas -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 class="text-lg font-bold text-slate-800 dark:text-slate-100">Dashboard de Produtividade</h1>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Análise de dados importados</p>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <span class="text-sm text-slate-500 dark:text-slate-400">Filtrar Semana:</span>
                            <select id="analytics-week-filter" class="flex-grow md:w-64 p-2 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 text-sm focus:ring-2 focus:ring-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                <option value="all">Todas as Semanas</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cards de KPI -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 analytics-card">
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase">Monitoramentos</p>
                            <h3 id="kpi-visitas" class="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-1">0</h3>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 analytics-card">
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase">Ocorrências (OC)</p>
                            <h3 id="kpi-ocs" class="text-2xl font-bold text-red-600 mt-1">0</h3>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 analytics-card">
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase">Falhas Técnicas</p>
                            <h3 id="kpi-issues" class="text-2xl font-bold text-orange-500 mt-1">0</h3>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 analytics-card">
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase">PDV Crítico</p>
                            <h3 id="kpi-critical-pdv" class="text-lg font-bold text-slate-800 dark:text-slate-100 mt-1 truncate">N/A</h3>
                            <p id="kpi-critical-count" class="text-xs text-red-500 font-bold">0 OCs</p>
                        </div>
                    </div>

                    <!-- ALERTA DE SPAM (RISCO) -->
                    <div id="analytics-spam-section" class="hidden bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-red-200 dark:border-red-800 overflow-hidden">
                        <div class="bg-gradient-to-r from-red-600 to-orange-600 p-3 flex justify-between items-center text-white">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                <div>
                                    <h3 class="text-sm font-bold">Sugestões de Prioridade (Spam de Alerta)</h3>
                                    <p class="text-[10px] text-red-100 opacity-90">Locais com alto índice de furto sem análise recente (>5 dias).</p>
                                </div>
                            </div>
                            <span id="spam-count-badge" class="bg-white/20 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                        </div>
                        <div id="spam-list-container" class="p-3 bg-slate-50 dark:bg-slate-900 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto">
                            <!-- Items inseridos via JS -->
                        </div>
                    </div>

                    <!-- GRÁFICOS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4">Top 5 PDVs (Ocorrências)</h3>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="chart-top-pdvs"></canvas>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4">Ocorrências por Dia da Semana</h3>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="chart-days-week"></canvas>
                            </div>
                        </div>
                         <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 lg:col-span-2">
                            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4">Produtividade por Operador</h3>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="chart-operators"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- TABELA DE PICOS MENSAIS -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
                            <h3 class="text-sm font-bold text-slate-800 dark:text-slate-100">Picos Mensais (Top 10)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left text-slate-500 dark:text-slate-400">
                                <thead class="bg-slate-50 dark:bg-slate-900 font-medium">
                                    <tr>
                                        <th class="px-4 py-2">PDV</th>
                                        <th class="px-4 py-2">Mês Crítico</th>
                                        <th class="px-4 py-2 text-center">OCs no Mês</th>
                                    </tr>
                                </thead>
                                <tbody id="table-peaks-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
    <!-- [FIM] NOVO MODAL -->

    <div id="pdv-detailed-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-60">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl flex flex-col dark:bg-slate-800 dark:shadow-xl max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100">Análise Detalhada por PDV</h2>
                <button id="pdv-detailed-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Selecione o Condomínio:</label>
                <select id="pdv-analysis-select" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    <option value="">Escolha um PDV...</option>
                </select>
            </div>
            <div id="pdv-analysis-results" class="hidden flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-brand-light p-4 rounded-xl text-center border border-brand-light">
                        <h3 class="text-sm font-bold text-brand-dark uppercase tracking-wider">Dia Crítico</h3>
                        <p id="pdv-critical-day" class="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-2">-</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Maior incidência de ocorrências</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl text-center border border-red-100 dark:bg-red-900/20 dark:border-red-800/30">
                        <h3 class="text-sm font-bold text-red-600 uppercase tracking-wider dark:text-red-400">Horário Crítico</h3>
                        <p id="pdv-critical-time" class="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-2">-</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Pico de atividade suspeita</p>
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-900 border border-slate-200 dark:border-slate-700 mb-4">
                    <h3 class="text-center font-semibold mb-4 text-slate-700 dark:text-slate-300">Ocorrências por Dia da Semana</h3>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="pdvAnalysisChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="mt-auto flex justify-end pt-4 border-t border-slate-200 dark:border-slate-700">
                <button id="pdv-detailed-footer-close-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-60">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center dark:bg-slate-800 dark:shadow-xl border border-slate-200 dark:border-slate-700">
            <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-brand mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2" id="confirm-modal-title">Tem certeza?</h2>
            <p class="text-slate-600 dark:text-slate-300 mb-6 text-sm" id="confirm-modal-msg">Essa ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-modal-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 flex-1">Cancelar</button>
                <button id="confirm-modal-yes-btn" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover flex-1">Sim, confirmar</button>
            </div>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova Análise</h2>
            <form id="task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Condomínio</label>
                        <div class="relative">
                            <input type="text" id="form-condominio" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" required autocomplete="off">
                            <div id="autocomplete-list" class="absolute z-10 w-full bg-white border border-slate-300 rounded-lg mt-1 hidden max-h-40 overflow-y-auto shadow-lg dark:bg-slate-700 dark:border-slate-600"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data</label>
                        <input type="date" id="form-data-analise" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" required>
                    </div>
                </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Semana (Nº)</label>
                    <input type="number" id="form-semana-trabalho" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                 </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Observações</label>
                    <textarea id="form-observacoes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:ring-brand focus:border-brand dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></textarea>
                 </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ocorrencia-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Ocorrências</h2>
            <form id="ocorrencia-form" class="flex-grow flex flex-col min-h-0">
                <input type="hidden" id="ocorrencia-task-id">
                
                <div class="flex-grow overflow-y-auto mb-4 bg-slate-50 rounded-lg p-2 dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                    <div id="ocorrencia-list" class="space-y-2"></div>
                </div>
                
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <h3 class="font-semibold mb-2 text-sm text-slate-600 dark:text-slate-300">Adicionar / Editar Item</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Categoria</label>
                            <select id="add-ocorrencia-categoria" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"></select>
                         </div>
                        <div>
                           <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Descrição</label>
                           <input type="text" id="add-ocorrencia-desc" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Início</label>
                            <input type="time" id="add-horario-inicial" step="1" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300">Fim</label>
                            <input type="time" id="add-horario-final" step="1" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-1 px-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                    </div>
                     <div class="mt-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="add-ocorrencia-inconclusiva" class="h-4 w-4 text-brand border-gray-300 rounded focus:ring-brand dark:bg-slate-700 dark:border-slate-600">
                            <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">Inconclusiva</span>
                        </label>
                    </div>
                     <button type="button" id="add-ocorrencia-btn" class="mt-3 w-full bg-brand-light text-brand-dark font-semibold px-4 py-2 rounded-lg hover:bg-slate-200 text-sm border border-brand-light">+ Adicionar à Lista</button>
                </div>
                <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                    <button type="button" id="ocorrencia-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-hover">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg dark:bg-slate-800 dark:shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Importar Planilha</h2>
            <p class="text-sm text-slate-600 mb-4 dark:text-slate-300">Cole os dados do Excel. Formato:<br><strong>Semana | Data | Unidade | OC | Colaborador | Status</strong></p>
            <form id="bulk-add-form">
                <textarea id="bulk-input-area" rows="10" class="w-full border border-slate-300 rounded-lg p-2 mb-4 text-xs font-mono dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" placeholder="Cole aqui..."></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" id="bulk-cancel-btn" class="bg-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Cancelar</button>
                    <button type="submit" class="bg-brand text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-brand-hover">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="completed-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl h-5/6 flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100">Relatório de Análises Concluídas</h2>
                <button id="completed-report-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
            <div class="mb-4">
                 <input type="text" id="completed-report-search" placeholder="Filtrar relatório (nome, data)..." class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
            </div>
            <div class="flex-grow overflow-y-auto bg-slate-50 p-4 rounded-lg dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100 dark:bg-slate-700 dark:text-slate-400 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3 rounded-tl-lg">Condomínio</th>
                            <th scope="col" class="px-4 py-3">Data</th>
                            <th scope="col" class="px-4 py-3 text-center">Ocorrências</th>
                            <th scope="col" class="px-4 py-3 text-right rounded-tr-lg">Status</th>
                        </tr>
                    </thead>
                    <tbody id="completed-report-list"></tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end gap-3">
                 <button id="export-report-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                    Copiar Relatório
                 </button>
                 <button id="completed-report-footer-close-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[70]"><div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm text-center dark:bg-slate-800 dark:shadow-xl"><p id="notification-message" class="mb-4 text-lg text-slate-700 dark:text-slate-300"></p><button id="notification-close-btn" class="bg-brand text-white px-6 py-2 rounded-lg">OK</button></div></div>
    
    <div id="archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800 dark:shadow-xl"><h2 class="text-2xl font-bold mb-4">Arquivar</h2><form id="archive-form"><div class="space-y-2 mb-4"><button type="button" id="view-archive-btn" class="w-full bg-slate-500 text-white px-4 py-2 rounded-lg mb-4">Ver Arquivo</button><div class="flex gap-2"><button type="button" id="archive-cancel-btn" class="bg-slate-200 w-full px-4 py-2 rounded-lg dark:bg-slate-700 dark:text-slate-100">Cancelar</button></div></div></form></div></div>
    
    <div id="view-archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análises Arquivadas</h2>
                <button id="view-archive-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold dark:text-slate-300 dark:hover:text-slate-100">&times;</button>
            </div>
             <div class="mb-4">
                <input type="text" id="archive-search-input" placeholder="Buscar em arquivadas..." class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
             </div>
            <div id="view-archive-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-lg min-h-[200px] dark:bg-slate-900">
                <p class="text-center text-slate-500">Nenhuma análise arquivada.</p>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                 <button id="view-archive-close-footer-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <input type="file" id="restore-input" class="hidden" accept=".json">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CORREÇÃO 1: Início correto do bloco try
            try {
                console.log("Painel de Monitoramento v3.5 - Analytics Integrado"); 

                // --- 1. VARIÁVEIS GLOBAIS ---
                let ocorrenciasChart;
                let pdvAnalysisChart;
                // Variáveis dos Gráficos do Analytics
                let chartTopPdvs, chartDaysWeek, chartOperators;
                // Variável para dados do Analytics Importados
                let analyticsData = null; 

                let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
                let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
                let categories = JSON.parse(localStorage.getItem('monitoramentoCategorias')) || ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Outros'];
                let currentEditingTaskOcorrencias = [];

                const statusClasses = {
                    'Pendente': 'bg-amber-100 text-amber-600',
                    'Em Andamento': 'bg-orange-100 text-orange-600',
                    'Em Análise': 'bg-orange-100 text-orange-600',
                    'Concluído': 'bg-emerald-100 text-emerald-600',
                    'Concluída': 'bg-emerald-100 text-emerald-600',
                    'Não visualizar': 'bg-slate-100 text-slate-500'
                };
                
                // Exemplo para Analytics
                const analyticsExampleData = `16/04/2025\t15/04/2025\t346\tRESIDENCIAL TERRACO\t1\t1\t7\tDayane\t
28/03/2025\t29/04/2025\t281\tSKY PAULICEIA\t1\t1\t0\tMarcelo\tcamera 1 não possui gravação
17/04/2025\t30/04/2025\t168\tMORADAS DA FLORA\t1\t1\t1\tDayane\tVisualizado por Vitória
24/04/2025\t30/04/2025\t286\tSPAZIO MARESIAS\t1\t1\t6\tJoao Pablo\t
29/03/2025\t30/04/2025\t275\tMUNDI GUARULHOS\t1\t1\t2\tMarcelo\t
28/03/2025\t29/04/2025\t245\tFLORESTA CAMPO LIMPO\t1\t1\t3\tMarcelo\tCamera 2 corrompeu às 09h00`;


                // --- 2. FUNÇÕES DO SISTEMA PRINCIPAL ---

                function saveTasks() {
                    localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                    localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
                }

                function showNotification(message) {
                    const elMsg = document.getElementById('notification-message');
                    const elModal = document.getElementById('notification-modal');
                    if (elMsg && elModal) {
                        elMsg.textContent = message;
                        elModal.classList.remove('hidden');
                    }
                }

                function formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const parts = dateString.split('-');
                    if(parts.length === 3) {
                        return `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }
                    return dateString;
                }
                
                function formatDateForInput(date) { 
                    const offset = date.getTimezoneOffset() * 60000; 
                    const localISOTime = (new Date(date - offset)).toISOString().slice(0, 10);
                    return localISOTime;
                }

                function getDayName(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T12:00:00');
                    if(isNaN(date.getTime())) return '';
                    const dayName = date.toLocaleDateString('pt-BR', { weekday: 'long' });
                    return dayName.charAt(0).toUpperCase() + dayName.slice(1);
                }
                
                function populateCategorySelect(selectElement) {
                    if (!selectElement) return;
                    selectElement.innerHTML = '';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        selectElement.appendChild(option);
                    });
                }

                // CORREÇÃO 2: Implementação da função que faltava
                function populatePdvAnalysisSelect() {
                    const select = document.getElementById('pdv-analysis-select');
                    if (!select) return;
                    select.innerHTML = '<option value="">Escolha um PDV...</option>';
                    
                    // Une condomínios ativos e arquivados para listar todos
                    const allCondos = [...tasks, ...archivedTasks].map(t => t.condominio.trim());
                    // Remove duplicatas e ordena
                    const uniqueCondos = [...new Set(allCondos)].sort();

                    uniqueCondos.forEach(name => {
                        if(name) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            select.appendChild(option);
                        }
                    });
                }

                function getCondoHighRiskCount(name) {
                    const all = [...tasks, ...archivedTasks];
                    return all
                        .filter(t => t.condominio.trim().toLowerCase() === name.trim().toLowerCase())
                        .reduce((count, t) => {
                            if (t.ocorrencias && t.ocorrencias.length >= 3) {
                                return count + 1;
                            }
                            return count;
                        }, 0);
                }

                function exportCompletedReport() {
                    const completed = tasks.filter(t => t.statusAnalise === 'Concluída');
                    completed.sort((a, b) => a.condominio.localeCompare(b.condominio));

                    if (completed.length === 0) {
                        showNotification('Não há análises concluídas para exportar.');
                        return;
                    }

                    let report = `*RELATÓRIO DE ANÁLISES CONCLUÍDAS - ${new Date().toLocaleDateString('pt-BR')}*\n`;
                    report += `--------------------------------------------------\n\n`;

                    completed.forEach((task, index) => {
                        report += `*${index + 1}. ${task.condominio}* - ${formatDate(task.dataAnalise)} (${getDayName(task.dataAnalise)})\n`;
                        
                        if (task.ocorrencias && task.ocorrencias.length > 0) {
                            report += `🚨 *Ocorrências:* ${task.ocorrencias.length}\n`;
                            task.ocorrencias.forEach((oc, idx) => {
                                const inconcl = oc.inconclusiva ? ' (INCONCLUSIVA)' : '';
                                report += `   - [${oc.categoria}] ${oc.desc} (${oc.horarioInicial} - ${oc.horarioFinal})${inconcl}\n`;
                            });
                        } else {
                            report += `✅ Sem ocorrências registradas.\n`;
                        }
                        
                        if (task.observacoes) {
                            report += `📝 *Obs:* ${task.observacoes}\n`;
                        }
                        report += `\n--------------------------------------------------\n\n`;
                    });

                    const el = document.createElement('textarea');
                    el.value = report;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    
                    showNotification('Relatório completo copiado para a área de transferência!');
                }

                function renderCompletedReport() {
                    const tbody = document.getElementById('completed-report-list');
                    const search = document.getElementById('completed-report-search').value.toLowerCase();
                    
                    const completed = tasks.filter(t => 
                        t.statusAnalise === 'Concluída' && 
                        (t.condominio.toLowerCase().includes(search) || t.dataAnalise.includes(search))
                    );

                    completed.sort((a, b) => a.condominio.localeCompare(b.condominio));

                    tbody.innerHTML = '';

                    if (completed.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-center">Nenhuma análise concluída encontrada.</td></tr>`;
                        return;
                    }

                    completed.forEach(t => {
                        const ocCount = t.ocorrencias ? t.ocorrencias.length : 0;
                        const row = `
                            <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                <td class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap dark:text-white">${t.condominio}</td>
                                <td class="px-4 py-3">${formatDate(t.dataAnalise)}</td>
                                <td class="px-4 py-3 text-center">${ocCount}</td>
                                <td class="px-4 py-3 text-right text-emerald-500 font-bold">Concluída</td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                }

                function updateDashboard() {
                    const ft = tasks.filter(t => t.statusAnalise !== 'Arquivado');
                    
                    const elTotal = document.getElementById('total-solicitacoes');
                    if (elTotal) elTotal.textContent = ft.length;
                    
                    const elUniquePdv = document.getElementById('total-pdvs-unicos');
                    if (elUniquePdv) {
                        const concludedTasks = ft.filter(t => t.statusAnalise === 'Concluída');
                        const uniquePdvs = new Set(concludedTasks.map(t => t.condominio.trim())).size;
                        elUniquePdv.textContent = uniquePdvs;
                    }

                    const elBackups = document.getElementById('backups-pendentes');
                    if (elBackups) elBackups.textContent = ft.filter(t => t.statusBackup === 'Pendente').length;
                    
                    const elAnalises = document.getElementById('analises-pendentes');
                    if (elAnalises) elAnalises.textContent = ft.filter(t => t.statusAnalise === 'Pendente').length;
                    
                    const ct = ft.filter(t => t.statusAnalise === 'Concluída');
                    const totOc = ct.reduce((acc, t) => acc + (t.ocorrencias ? t.ocorrencias.length : 0), 0);
                    
                    const elOcorrencias = document.getElementById('total-ocorrencias-semana');
                    if (elOcorrencias) elOcorrencias.textContent = totOc;
                    
                    const elProd = document.getElementById('produtividade-semanal');
                    if (elProd) elProd.textContent = ct.length > 0 ? (totOc / ct.length).toFixed(1) : '0.0';
                }

                function updateCharts() {
                    const dataByCondo = tasks.reduce((acc, task) => {
                        if (task.ocorrencia === 'Sim' && task.ocorrencias) {
                            if (!acc[task.condominio]) acc[task.condominio] = 0;
                            acc[task.condominio] += task.ocorrencias.length;
                        }
                        return acc;
                    }, {});
                    
                    const labels = Object.keys(dataByCondo);
                    const data = Object.values(dataByCondo);
                    
                    if (ocorrenciasChart) {
                        ocorrenciasChart.data.labels = labels;
                        ocorrenciasChart.data.datasets[0].data = data;
                        ocorrenciasChart.update();
                    }
                }
                
                function updateChartsTheme() {
                    const isDark = true; 
                    const fontColor = '#f1f5f9'; 
                    const commonOptions = { scales: { y: { ticks: { color: fontColor }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, title: { color: fontColor } }, x: { ticks: { color: fontColor }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, title: { color: fontColor } } }, plugins: { legend: { labels: { color: fontColor } } } };
                    if (ocorrenciasChart) { Object.assign(ocorrenciasChart.options, commonOptions); ocorrenciasChart.update(); }
                }

                function renderTasks() {
                    const list = document.getElementById('task-list');
                    if (!list) return;
                    
                    const filtroCond = document.getElementById('filtro-condominio').value.toLowerCase();
                    const filtroBackup = document.getElementById('filtro-backup').value;
                    const filtroAnalise = document.getElementById('filtro-analise').value;
                    const filtroData = document.getElementById('filtro-data').value;
                    const filtroSemana = document.getElementById('filtro-semana').value;
                    const filtroDiaSemana = document.getElementById('filtro-dia-semana').value;

                    let filtered = tasks.filter(t => t.condominio.toLowerCase().includes(filtroCond));
                    
                    if (filtroBackup) filtered = filtered.filter(t => t.statusBackup === filtroBackup);
                    if (filtroAnalise) filtered = filtered.filter(t => t.statusAnalise === filtroAnalise);
                    if (filtroData) filtered = filtered.filter(t => t.dataAnalise === filtroData);
                    if (filtroSemana) filtered = filtered.filter(t => t.semanaDeTrabalho == filtroSemana);
                    
                    if (filtroDiaSemana !== "") {
                        filtered = filtered.filter(t => {
                            if (!t.dataAnalise) return false;
                            const d = new Date(t.dataAnalise + 'T12:00:00');
                            return d.getDay().toString() === filtroDiaSemana;
                        });
                    }

                    filtered.sort((a, b) => a.condominio.localeCompare(b.condominio));

                    list.innerHTML = '';
                    if(filtered.length === 0) { list.innerHTML = `<p class="text-slate-500 text-center col-span-full">Nenhuma tarefa encontrada.</p>`; return; }

                    filtered.forEach(task => {
                        const card = document.createElement('div');
                        let color = task.statusAnalise === 'Concluída' ? '#10b981' : (task.statusAnalise === 'Em Análise' ? '#f97316' : '#f59e0b');
                        card.className = 'bg-white p-4 rounded-xl shadow-md border-l-4 dark:bg-slate-800 dark:shadow-xl';
                        card.style.borderLeftColor = color;
                        
                        const ocCount = task.ocorrencias ? task.ocorrencias.length : 0;
                        const badge = ocCount > 0 ? `<div class="mt-1"><span class="px-2 py-0.5 text-xs font-bold text-red-700 bg-red-100 rounded-lg border border-red-300 dark:bg-red-900 dark:text-red-100 dark:border-red-700">OCs: ${ocCount}</span></div>` : '';
                        
                        const highRiskDays = getCondoHighRiskCount(task.condominio);
                        let riskBadge = '';
                        if (highRiskDays > 0) {
                            riskBadge = `<span class="ml-2 text-lg" title="PDV Crítico">🔥</span>`;
                        }

                        const isCollapsed = !task.isExpanded;
                        let editBtnHTML = (task.statusAnalise !== 'Arquivado') ? `<button data-id="${task.id}" class="edit-ocorrencia-btn mt-4 w-full bg-slate-200 text-slate-800 font-bold py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">${task.statusAnalise === 'Concluída' ? 'Ver/Editar Ocorrências' : 'Registrar Ocorrências'}</button>` : '';
                        let obsHTML = task.observacoes ? `<div class="mt-4 border-t pt-2 space-y-2 dark:border-slate-700"><p class="text-sm font-semibold text-slate-600 dark:text-slate-300">Obs:</p><p class="text-sm text-slate-500 dark:text-slate-400">${task.observacoes}</p></div>` : '';

                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg flex-1 flex items-center flex-wrap">
                                    ${task.condominio}
                                    ${riskBadge}
                                </h3>
                                <div class="flex items-center gap-2">
                                    <button data-id="${task.id}" class="archive-single-btn text-slate-400 hover:text-brand font-bold text-lg p-1" title="Arquivar"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></button>
                                    <button data-id="${task.id}" class="delete-task-btn text-slate-400 hover:text-red-600 font-bold text-lg p-1" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">
                                        Data: <strong>${formatDate(task.dataAnalise)}</strong> 
                                        <span class="text-xs text-slate-400 ml-1 font-semibold">(${getDayName(task.dataAnalise)})</span>
                                    </p>
                                    ${badge}
                                </div>
                                <button data-id="${task.id}" class="toggle-details-btn p-1 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-100">${isCollapsed ? '&#9660;' : '&#9650;'}</button>
                            </div>
                            <div class="${isCollapsed ? 'hidden' : ''} mt-4 details-content">
                                <div class="space-y-3 text-sm mt-4">
                                    <div class="flex justify-between items-center text-sm mb-1"><span class="font-semibold text-slate-600 dark:text-slate-300">Backup:</span> <select data-id="${task.id}" data-type="backup" class="status-select border-none text-right font-semibold text-sm rounded-lg p-1 ${statusClasses[task.statusBackup]}"><option value="Pendente" ${task.statusBackup === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Andamento" ${task.statusBackup === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option><option value="Concluído" ${task.statusBackup === 'Concluído' ? 'selected' : ''}>Concluído</option></select></div>
                                    <div class="flex justify-between items-center text-sm"><span class="font-semibold text-slate-600 dark:text-slate-300">Análise:</span> <select data-id="${task.id}" data-type="analise" class="status-select border-none text-right font-semibold text-sm rounded-lg p-1 ${statusClasses[task.statusAnalise]}"><option value="Pendente" ${task.statusAnalise === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Análise" ${task.statusAnalise === 'Em Análise' ? 'selected' : ''}>Em Análise</option><option value="Concluída" ${task.statusAnalise === 'Concluída' ? 'selected' : ''}>Concluída</option></select></div>
                                </div>
                                ${obsHTML}
                                ${editBtnHTML}
                            </div>
                        `;
                        list.appendChild(card);
                    });
                }

                function renderArchivedList() {
                    const container = document.getElementById('view-archive-list-container');
                    const filter = document.getElementById('archive-search-input').value.toLowerCase();
                    const filtered = archivedTasks.filter(t => t.condominio.toLowerCase().includes(filter) || (t.dataAnalise && t.dataAnalise.includes(filter)));

                    if (filtered.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-500 mt-4">Nenhuma análise arquivada.</p>';
                        return;
                    }

                    container.innerHTML = filtered.map(t => `
                        <div class="flex justify-between items-center p-3 border-b border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                            <div>
                                <p class="font-bold text-slate-700 dark:text-slate-200">${t.condominio}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${formatDate(t.dataAnalise)}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-id="${t.id}" class="unarchive-btn text-xs font-semibold bg-orange-100 text-orange-700 px-3 py-1.5 rounded-lg hover:bg-orange-200 dark:bg-orange-900 dark:text-orange-100 dark:hover:bg-orange-800 transition-colors">Desarquivar</button>
                                <button data-id="${t.id}" class="delete-archive-btn text-xs font-semibold bg-red-100 text-red-700 px-3 py-1.5 rounded-lg hover:bg-red-200 dark:bg-red-900 dark:text-red-100 dark:hover:bg-red-800 transition-colors">Excluir</button>
                            </div>
                        </div>
                    `).join('');
                }

                function renderModalOcorrenciasList() {
                    const list = document.getElementById('ocorrencia-list');
                    list.innerHTML = '';
                    if (currentEditingTaskOcorrencias.length === 0) {
                        list.innerHTML = '<p class="text-center text-sm text-slate-500 py-4">Nenhuma ocorrência registrada.</p>';
                        return;
                    }
                    currentEditingTaskOcorrencias.forEach((ocor, index) => {
                        const div = document.createElement('div');
                        div.className = 'ocorrencia-item-row p-3 bg-white border border-slate-200 rounded-lg flex justify-between items-center group dark:bg-slate-800 dark:border-slate-700';
                        
                        const inconclusivaBadge = ocor.inconclusiva 
                            ? `<span class="ml-2 text-[10px] font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded-full border border-red-200 dark:bg-red-900 dark:text-red-100 dark:border-red-800">INCONCLUSIVA</span>` 
                            : '';

                        div.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-bold text-sm text-slate-800 dark:text-slate-100 flex items-center flex-wrap">
                                    ${ocor.categoria}
                                    ${inconclusivaBadge}
                                </p>
                                <p class="text-xs text-slate-600 dark:text-slate-400">${ocor.desc}</p>
                                <p class="text-xs text-slate-400 dark:text-slate-500 font-mono mt-1">${ocor.horarioInicial} - ${ocor.horarioFinal}</p>
                            </div>
                            <div class="flex gap-2 occ-actions">
                                <button type="button" data-index="${index}" class="edit-item-btn text-blue-500 hover:text-blue-700" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                                <button type="button" data-index="${index}" class="delete-item-btn text-red-500 hover:text-red-700" title="Remover"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }

                function handleTaskSubmit(e) {
                    e.preventDefault();
                    const condominio = document.getElementById('form-condominio').value;
                    const dataAnalise = document.getElementById('form-data-analise').value;
                    if (tasks.some(t => t.condominio === condominio && t.dataAnalise === dataAnalise)) {
                        showNotification('Análise já existe.'); return; 
                    }
                    tasks.unshift({
                        id: Date.now(),
                        condominio: condominio,
                        dataAnalise: dataAnalise,
                        semanaDeTrabalho: parseInt(document.getElementById('form-semana-trabalho').value) || 0,
                        observacoes: document.getElementById('form-observacoes').value,
                        statusBackup: 'Pendente', statusAnalise: 'Pendente', ocorrencia: 'Pendente', isExpanded: true, ocorrencias: []
                    });
                    refreshUI();
                    document.getElementById('task-modal').classList.add('hidden');
                    showNotification('Nova análise adicionada.');
                }

                function handleBulkAddSubmit(e) {
                    e.preventDefault();
                    const inputArea = document.getElementById('bulk-input-area').value.trim();
                    if (!inputArea) { showNotification('Cole os dados.'); return; }
                    const lines = inputArea.split('\n').filter(line => line.trim().length > 0);
                    const newTasks = [];
                    let ignoredCount = 0;

                    lines.forEach((line, index) => {
                        const lineLower = line.toLowerCase();
                        if ((lineLower.includes('semana') || lineLower.includes('data')) && (lineLower.includes('unidade') || lineLower.includes('status'))) return;

                        let parts = line.split(/\s{2,}|\t/).map(p => p.trim()).filter(p => p.length > 0);
                        if (parts.length < 5) { ignoredCount++; return; }
                        
                        let unidadeRaw = parts[2] || '';
                        let statusRaw = parts[parts.length - 1] || 'Pendente';
                        let isoDate = '';
                        if (parts[1] && parts[1].includes('/')) {
                            const [d, m, y] = parts[1].split('/');
                            if (d && m && y) isoDate = `${y}-${m}-${d}`;
                        } else {
                            isoDate = new Date().toISOString().split('T')[0];
                        }

                        const existsInDb = tasks.some(t => t.condominio.toLowerCase().trim() === unidadeRaw.toLowerCase().trim() && t.dataAnalise === isoDate);
                        const existsInBatch = newTasks.some(t => t.condominio.toLowerCase().trim() === unidadeRaw.toLowerCase().trim() && t.dataAnalise === isoDate);

                        if (existsInDb || existsInBatch) { ignoredCount++; return; }

                        newTasks.push({
                            id: Date.now() + index,
                            condominio: unidadeRaw,
                            dataAnalise: isoDate,
                            semanaDeTrabalho: parseInt(parts[0].replace(/\D/g,'')) || 0,
                            observacoes: '',
                            statusBackup: statusRaw.toLowerCase().includes('finalizado') ? 'Concluído' : 'Pendente',
                            statusAnalise: statusRaw.toLowerCase().includes('finalizado') ? 'Concluída' : 'Pendente',
                            ocorrencia: 'Não', isExpanded: true, ocorrencias: []
                        });
                    });

                    if (newTasks.length > 0) { 
                        tasks.unshift(...newTasks); refreshUI(); 
                        document.getElementById('bulk-add-modal').classList.add('hidden'); 
                        document.getElementById('bulk-input-area').value = ''; 
                        showNotification(`${newTasks.length} análises importadas. (${ignoredCount} duplicadas/ignoradas)`); 
                    } else {
                        showNotification('Nenhum dado importado.');
                    }
                }

                function generatePdvReport(pdvName) {
                    if (!pdvName) return;

                    const allTasks = [...tasks, ...archivedTasks].filter(t => t.condominio.trim() === pdvName);
                    
                    if (allTasks.length === 0) return;

                    const daysCount = {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; 
                    const hoursCount = {};

                    allTasks.forEach(t => {
                        if (t.ocorrencias && t.ocorrencias.length > 0) {
                            if (t.dataAnalise) {
                                const d = new Date(t.dataAnalise + 'T12:00:00');
                                const dayIndex = d.getDay();
                                daysCount[dayIndex] += t.ocorrencias.length; 
                            }

                            t.ocorrencias.forEach(oc => {
                                if (oc.horarioInicial) {
                                    const hour = parseInt(oc.horarioInicial.split(':')[0]);
                                    if (!isNaN(hour)) {
                                        hoursCount[hour] = (hoursCount[hour] || 0) + 1;
                                    }
                                }
                            });
                        }
                    });

                    let maxDay = -1;
                    let maxDayCount = -1;
                    for (let d = 0; d <= 6; d++) {
                        if (daysCount[d] > maxDayCount) {
                            maxDayCount = daysCount[d];
                            maxDay = d;
                        }
                    }
                    const dayNames = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
                    document.getElementById('pdv-critical-day').textContent = maxDayCount > 0 ? dayNames[maxDay] : "N/A";

                    let maxHour = -1;
                    let maxHourCount = -1;
                    Object.keys(hoursCount).forEach(h => {
                        if (hoursCount[h] > maxHourCount) {
                            maxHourCount = hoursCount[h];
                            maxHour = h;
                        }
                    });
                    document.getElementById('pdv-critical-time').textContent = maxHourCount > 0 ? `${maxHour}h - ${parseInt(maxHour)+1}h` : "N/A";

                    const ctx = document.getElementById('pdvAnalysisChart').getContext('2d');
                    
                    if (pdvAnalysisChart) {
                        pdvAnalysisChart.destroy();
                    }

                    pdvAnalysisChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: dayNames,
                            datasets: [{
                                label: 'Total de Ocorrências',
                                data: [0, 1, 2, 3, 4, 5, 6].map(d => daysCount[d]),
                                backgroundColor: 'rgba(55, 192, 160, 0.6)',
                                borderColor: '#37c0a0',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });

                    document.getElementById('pdv-analysis-results').classList.remove('hidden');
                }

                function setupCharts() {
                    const el = document.getElementById('ocorrenciasChart');
                    if(!el) return;
                    const ctx = el.getContext('2d');
                    ocorrenciasChart = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(55, 192, 160, 0.6)' }] },
                        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                }

                function showConfirm(title, msg, callback) {
                    const confirmModal = document.getElementById('custom-confirm-modal');
                    const confirmTitle = document.getElementById('confirm-modal-title');
                    const confirmMsg = document.getElementById('confirm-modal-msg');
                    const confirmYesBtn = document.getElementById('confirm-modal-yes-btn');
                    const confirmCancelBtn = document.getElementById('confirm-modal-cancel-btn');

                    confirmTitle.textContent = title;
                    confirmMsg.textContent = msg;
                    
                    const newYesBtn = confirmYesBtn.cloneNode(true);
                    confirmYesBtn.parentNode.replaceChild(newYesBtn, confirmYesBtn);
                    
                    const newCancelBtn = confirmCancelBtn.cloneNode(true);
                    confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);

                    newYesBtn.addEventListener('click', () => {
                        if (callback) callback();
                        confirmModal.classList.add('hidden');
                    });

                    newCancelBtn.addEventListener('click', () => {
                        confirmModal.classList.add('hidden');
                    });

                    confirmModal.classList.remove('hidden');
                }

                function refreshUI() {
                    saveTasks();
                    renderTasks();
                    updateDashboard();
                    updateCharts();
                }

                // --- 3. NOVA LÓGICA DE ANALYTICS (Mesclada) ---

                function getWeekInfo(dateStr) {
                    if (!dateStr) return null;
                    const parts = dateStr.split('/');
                    if (parts.length !== 3) return null;
                    
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    const date = new Date(year, month, day);
                    if (isNaN(date.getTime())) return null;

                    const dayOfWeek = date.getDay();
                    const startOfWeek = new Date(date);
                    startOfWeek.setDate(date.getDate() - dayOfWeek);
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);

                    const fmt = d => `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}`;
                    
                    return {
                        key: startOfWeek.getTime(),
                        label: `Semana ${fmt(startOfWeek)} a ${fmt(endOfWeek)}`,
                        startDate: startOfWeek
                    };
                }

                function processAnalyticsData() {
                    const rawInput = document.getElementById('analytics-raw-input').value;
                    if (!rawInput.trim()) { showNotification("Insira dados antes de gerar."); return; }

                    try {
                        const rows = rawInput.trim().split('\n');
                        const parsed = rows.map((row, index) => {
                            let cols = row.split('\t');
                            if (cols.length < 5) return null;

                            const dataVisualizacao = cols[0]?.trim();
                            const dataProdutividade = cols[1]?.trim();
                            const pdvNome = cols[3]?.trim();
                            const ocorrencias = parseInt(cols[6]?.trim()) || 0;
                            
                            let operadorRaw = cols[7]?.trim() || '';
                            const operador = operadorRaw.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                            const obs = cols[8]?.trim() || '';

                            if (dataVisualizacao.toLowerCase().includes('data') || pdvNome.toLowerCase().includes('unidade') || !pdvNome) return null;

                            const weekInfo = getWeekInfo(dataProdutividade);

                            return {
                                id: index,
                                dataVis: dataVisualizacao,
                                dataProd: dataProdutividade,
                                weekKey: weekInfo ? weekInfo.key : 0,
                                weekLabel: weekInfo ? weekInfo.label : 'Data Inválida',
                                pdv: pdvNome,
                                oc: ocorrencias,
                                operador: operador,
                                obs: obs,
                                hasIssue: obs.toLowerCase().match(/(corrompido|sem gravação|cortes|travando|off|desconectad|problema)/)
                            };
                        }).filter(i => i !== null);

                        if (parsed.length === 0) { showNotification("Nenhum dado válido identificado."); return; }
                        
                        analyticsData = parsed;
                        updateAnalyticsUI('all');
                        
                        // Troca de view
                        document.getElementById('analytics-input-view').classList.add('hidden');
                        document.getElementById('analytics-dashboard-view').classList.remove('hidden');
                        document.getElementById('analytics-back-to-input-btn').classList.remove('hidden');
                        
                    } catch (err) {
                        console.error(err);
                        showNotification("Erro ao processar dados.");
                    }
                }

                function updateAnalyticsUI(selectedWeekKey) {
                    if (!analyticsData) return;

                    // 1. Popular filtro de semanas
                    const weeksMap = new Map();
                    analyticsData.forEach(item => { if (item.weekKey !== 0) weeksMap.set(item.weekKey, item.weekLabel); });
                    const weeks = Array.from(weeksMap.entries()).sort((a,b) => a[0] - b[0]);
                    
                    const select = document.getElementById('analytics-week-filter');
                    const currentVal = select.value;
                    select.innerHTML = '<option value="all">Todas as Semanas</option>';
                    weeks.forEach(([key, label]) => {
                        const opt = document.createElement('option');
                        opt.value = key;
                        opt.textContent = label;
                        select.appendChild(opt);
                    });
                    // Tenta manter a seleção se possível, ou usa o argumento
                    if(selectedWeekKey !== undefined) select.value = selectedWeekKey;
                    else select.value = currentVal || 'all';

                    // 2. Filtrar dados
                    const filterVal = select.value;
                    const filtered = filterVal === 'all' ? analyticsData : analyticsData.filter(i => i.weekKey == filterVal);

                    // 3. KPIs
                    const totalVis = filtered.length;
                    const totalOc = filtered.reduce((acc, c) => acc + c.oc, 0);
                    const totalIssues = filtered.filter(i => i.hasIssue).length;

                    document.getElementById('kpi-visitas').textContent = totalVis;
                    document.getElementById('kpi-ocs').textContent = totalOc;
                    document.getElementById('kpi-issues').textContent = totalIssues;

                    // 4. Rankings (PDV, Dia, Operador)
                    const pdvStats = {};
                    const opStats = {};
                    const dayStats = { 'Domingo':0, 'Segunda-feira':0, 'Terça-feira':0, 'Quarta-feira':0, 'Quinta-feira':0, 'Sexta-feira':0, 'Sábado':0 };

                    filtered.forEach(item => {
                        pdvStats[item.pdv] = (pdvStats[item.pdv] || 0) + item.oc;
                        if(item.operador) opStats[item.operador] = (opStats[item.operador] || 0) + item.oc;
                        
                        if (item.oc > 0 && item.dataProd) {
                            const parts = item.dataProd.split('/');
                            if(parts.length===3) {
                                const dt = new Date(parts[2], parts[1]-1, parts[0]);
                                if(!isNaN(dt)) {
                                    const dName = dt.toLocaleDateString('pt-BR', { weekday: 'long' });
                                    const dCap = dName.charAt(0).toUpperCase() + dName.slice(1);
                                    if(dayStats[dCap] !== undefined) dayStats[dCap] += item.oc;
                                }
                            }
                        }
                    });

                    // Top PDV KPI
                    const sortedPdvs = Object.entries(pdvStats).sort((a,b) => b[1] - a[1]);
                    if (sortedPdvs.length > 0) {
                        document.getElementById('kpi-critical-pdv').textContent = sortedPdvs[0][0];
                        document.getElementById('kpi-critical-count').textContent = sortedPdvs[0][1] + ' OCs';
                    } else {
                        document.getElementById('kpi-critical-pdv').textContent = 'N/A';
                        document.getElementById('kpi-critical-count').textContent = '0 OCs';
                    }

                    // 5. Spam / Risco (Baseado em TODOS os dados, não só filtro)
                    let maxTs = 0;
                    const pdvRiskMap = {};
                    analyticsData.forEach(item => {
                         if (item.dataProd) {
                            const parts = item.dataProd.split('/');
                            const dt = new Date(parts[2], parts[1]-1, parts[0]);
                            if (!isNaN(dt) && dt.getTime() > maxTs) maxTs = dt.getTime();
                             
                            if (!pdvRiskMap[item.pdv]) pdvRiskMap[item.pdv] = { name: item.pdv, total: 0, lastTs: 0 };
                            pdvRiskMap[item.pdv].total += item.oc;
                            if (!isNaN(dt) && dt.getTime() > pdvRiskMap[item.pdv].lastTs) pdvRiskMap[item.pdv].lastTs = dt.getTime();
                        }
                    });
                    
                    const spamList = Object.values(pdvRiskMap)
                        .map(p => ({ ...p, daysInactive: Math.floor((maxTs - p.lastTs) / (86400000)) }))
                        .filter(p => p.total >= 3 && p.daysInactive >= 5)
                        .sort((a,b) => b.total - a.total);

                    const spamContainer = document.getElementById('spam-list-container');
                    const spamBadge = document.getElementById('spam-count-badge');
                    spamContainer.innerHTML = '';
                    if (spamList.length > 0) {
                        document.getElementById('analytics-spam-section').classList.remove('hidden');
                        spamBadge.textContent = spamList.length;
                        spamList.forEach(p => {
                            const el = document.createElement('div');
                            el.className = 'bg-white border-l-4 border-red-500 p-2 rounded shadow-sm text-xs flex justify-between items-center';
                            el.innerHTML = `<div><strong>${p.name}</strong><br><span class="text-slate-500">Inativo há ${p.daysInactive} dias</span></div><div class="text-right font-bold text-red-600">${p.total} OCs</div>`;
                            spamContainer.appendChild(el);
                        });
                    } else {
                        document.getElementById('analytics-spam-section').classList.add('hidden');
                    }

                    // 6. Atualizar Gráficos Chart.js
                    updateAnalyticsCharts(sortedPdvs.slice(0,5), dayStats, opStats);

                    // 7. Tabela Picos Mensais
                    const pdvMonths = {};
                    analyticsData.forEach(item => {
                         if (item.oc > 0 && item.dataProd) {
                            const parts = item.dataProd.split('/');
                            if(parts.length===3) {
                                const mKey = `${parts[2]}-${parts[1]}`;
                                const dt = new Date(parts[2], parts[1]-1, 1);
                                const mName = dt.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                                if(!pdvMonths[item.pdv]) pdvMonths[item.pdv] = {};
                                if(!pdvMonths[item.pdv][mKey]) pdvMonths[item.pdv][mKey] = { name: mName, count: 0 };
                                pdvMonths[item.pdv][mKey].count += item.oc;
                            }
                        }
                    });
                    
                    const peaks = Object.keys(pdvMonths).map(pdv => {
                        const months = Object.values(pdvMonths[pdv]);
                        if(months.length === 0) return null;
                        const peak = months.reduce((max, c) => c.count > max.count ? c : max, months[0]);
                        return { name: pdv, month: peak.name, count: peak.count };
                    }).filter(i => i!==null).sort((a,b) => b.count - a.count).slice(0,10);

                    const peakBody = document.getElementById('table-peaks-body');
                    peakBody.innerHTML = '';
                    peaks.forEach(p => {
                        peakBody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50"><td class="px-4 py-2 font-medium">${p.name}</td><td class="px-4 py-2 text-blue-600 font-bold uppercase">${p.month}</td><td class="px-4 py-2 text-center"><span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold">${p.count}</span></td></tr>`);
                    });
                }

                function updateAnalyticsCharts(topPdvs, dayStats, opStats) {
                    // Helper para destruir charts antigos
                    const destroy = (chart) => { if(chart) chart.destroy(); }
                    destroy(chartTopPdvs); destroy(chartDaysWeek); destroy(chartOperators);

                    // 1. Top PDVs
                    const ctxPdv = document.getElementById('chart-top-pdvs').getContext('2d');
                    chartTopPdvs = new Chart(ctxPdv, {
                        type: 'bar',
                        data: {
                            labels: topPdvs.map(i => i[0]),
                            datasets: [{ label: 'Ocorrências', data: topPdvs.map(i => i[1]), backgroundColor: '#ef4444', borderRadius: 4 }]
                        },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });

                    // 2. Dias da Semana
                    const daysOrder = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
                    const ctxDays = document.getElementById('chart-days-week').getContext('2d');
                    chartDaysWeek = new Chart(ctxDays, {
                        type: 'bar',
                        data: {
                            labels: daysOrder,
                            datasets: [{ label: 'Volume', data: daysOrder.map(d => dayStats[d]), backgroundColor: '#3b82f6', borderRadius: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });

                    // 3. Operadores
                    const sortedOps = Object.entries(opStats).sort((a,b) => b[1] - a[1]).slice(0, 15); // Top 15
                    const ctxOps = document.getElementById('chart-operators').getContext('2d');
                    chartOperators = new Chart(ctxOps, {
                        type: 'bar',
                        data: {
                            labels: sortedOps.map(i => i[0]),
                            datasets: [{ label: 'OCs Captadas', data: sortedOps.map(i => i[1]), backgroundColor: '#10b981', borderRadius: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }


                // --- 4. LISTENERS E INICIALIZAÇÃO ---

                document.getElementById('filtro-condominio').addEventListener('input', refreshUI);
                document.getElementById('filtro-data').addEventListener('change', refreshUI); 
                document.getElementById('filtro-semana').addEventListener('input', refreshUI);
                document.getElementById('filtro-dia-semana').addEventListener('change', refreshUI); 
                document.getElementById('filtro-backup').addEventListener('change', refreshUI); 
                document.getElementById('filtro-analise').addEventListener('change', refreshUI); 
                
                document.getElementById('expand-all-btn').addEventListener('click', () => { tasks.forEach(t => t.isExpanded = true); refreshUI(); });
                document.getElementById('collapse-all-btn').addEventListener('click', () => { tasks.forEach(t => t.isExpanded = false); refreshUI(); });
                document.getElementById('add-task-btn').addEventListener('click', () => {
                    document.getElementById('task-form').reset();
                    document.getElementById('form-data-analise').value = formatDateForInput(new Date());
                    document.getElementById('task-modal').classList.remove('hidden');
                });
                document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('task-modal').classList.add('hidden'));
                document.getElementById('task-form').addEventListener('submit', handleTaskSubmit);
                document.getElementById('bulk-add-form').addEventListener('submit', handleBulkAddSubmit);
                
                const actionsMenu = document.getElementById('actions-menu');
                document.getElementById('actions-menu-btn').addEventListener('click', (e) => { e.stopPropagation(); actionsMenu.classList.toggle('hidden'); });
                document.addEventListener('click', (event) => { if (!document.getElementById('actions-menu-container').contains(event.target)) actionsMenu.classList.add('hidden'); });
                
                const modals = { 
                    'bulk-add-btn': 'bulk-add-modal', 
                    'archive-btn': 'archive-modal',
                    'completed-report-btn': 'completed-report-modal',
                    'detailed-pdv-btn': 'pdv-detailed-modal',
                    'open-analytics-btn': 'analytics-modal'
                };
                
                Object.keys(modals).forEach(k => {
                    const el = document.getElementById(k);
                    if(el) {
                        el.addEventListener('click', () => { 
                            actionsMenu.classList.add('hidden'); 
                            document.getElementById(modals[k]).classList.remove('hidden');
                            
                            if (k === 'completed-report-btn') {
                                document.getElementById('completed-report-search').value = '';
                                renderCompletedReport();
                            }
                            if (k === 'detailed-pdv-btn') {
                                populatePdvAnalysisSelect();
                                document.getElementById('pdv-analysis-results').classList.add('hidden');
                                if(pdvAnalysisChart) pdvAnalysisChart.destroy();
                            }
                        });
                    }
                });
                
                // Analytics Listeners
                document.getElementById('analytics-load-example-btn').addEventListener('click', () => {
                    document.getElementById('analytics-raw-input').value = analyticsExampleData;
                });
                document.getElementById('analytics-process-btn').addEventListener('click', processAnalyticsData);
                document.getElementById('analytics-back-to-input-btn').addEventListener('click', () => {
                    document.getElementById('analytics-input-view').classList.remove('hidden');
                    document.getElementById('analytics-dashboard-view').classList.add('hidden');
                    document.getElementById('analytics-back-to-input-btn').classList.add('hidden');
                });
                document.getElementById('analytics-close-btn').addEventListener('click', () => document.getElementById('analytics-modal').classList.add('hidden'));
                document.getElementById('analytics-week-filter').addEventListener('change', (e) => updateAnalyticsUI(e.target.value));

                // Outros Listeners
                const reportSearch = document.getElementById('completed-report-search');
                if (reportSearch) reportSearch.addEventListener('input', renderCompletedReport);

                const exportReportBtn = document.getElementById('export-report-btn');
                if(exportReportBtn) exportReportBtn.addEventListener('click', exportCompletedReport);

                const pdvSelect = document.getElementById('pdv-analysis-select');
                if(pdvSelect) {
                    pdvSelect.addEventListener('change', (e) => {
                        generatePdvReport(e.target.value);
                    });
                }
                
                const closePdvModalBtn = document.getElementById('pdv-detailed-close-btn');
                if(closePdvModalBtn) closePdvModalBtn.addEventListener('click', () => document.getElementById('pdv-detailed-modal').classList.add('hidden'));
                
                const closePdvFooterBtn = document.getElementById('pdv-detailed-footer-close-btn');
                if(closePdvFooterBtn) closePdvFooterBtn.addEventListener('click', () => document.getElementById('pdv-detailed-modal').classList.add('hidden'));

                const closeIds = ['bulk-cancel-btn', 'archive-cancel-btn', 'view-archive-close-btn', 'view-archive-close-footer-btn', 'notification-close-btn', 'ocorrencia-cancel-btn', 'completed-report-close-btn', 'completed-report-footer-close-btn'];
                closeIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener('click', () => el.closest('.fixed').classList.add('hidden'));
                });

                document.getElementById('view-archive-btn').addEventListener('click', () => {
                    document.getElementById('archive-modal').classList.add('hidden');
                    document.getElementById('view-archive-modal').classList.remove('hidden');
                    document.getElementById('archive-search-input').value = '';
                    renderArchivedList();
                });
                document.getElementById('archive-search-input').addEventListener('input', renderArchivedList);
                
                document.getElementById('view-archive-list-container').addEventListener('click', (e) => {
                    const unarchiveBtn = e.target.closest('.unarchive-btn');
                    const deleteArchiveBtn = e.target.closest('.delete-archive-btn');

                    if (unarchiveBtn) {
                        const id = unarchiveBtn.dataset.id;
                        showConfirm('Desarquivar', 'Restaurar esta análise para o quadro principal?', () => {
                            const index = archivedTasks.findIndex(t => t.id == id);
                            if (index > -1) {
                                const taskToRestore = archivedTasks[index];
                                archivedTasks.splice(index, 1);
                                tasks.unshift(taskToRestore); 
                                saveTasks();
                                refreshUI(); 
                                renderArchivedList(); 
                                showNotification('Análise restaurada.');
                            }
                        });
                    } else if (deleteArchiveBtn) {
                        const id = deleteArchiveBtn.dataset.id;
                        showConfirm('Excluir do Arquivo', 'Excluir permanentemente esta análise?', () => {
                            archivedTasks = archivedTasks.filter(t => t.id != id);
                            saveTasks();
                            renderArchivedList();
                        });
                    }
                });

                document.getElementById('task-list').addEventListener('click', (e) => {
                    const target = e.target;
                    const delBtn = target.closest('.delete-task-btn');
                    const archBtn = target.closest('.archive-single-btn');
                    const toggleBtn = target.closest('.toggle-details-btn');
                    const editOcBtn = target.closest('.edit-ocorrencia-btn');

                    if (delBtn) {
                        showConfirm('Excluir Análise', 'Tem certeza que deseja excluir esta análise?', () => {
                            tasks = tasks.filter(t => t.id != delBtn.dataset.id);
                            refreshUI();
                            showNotification('Análise excluída.');
                        });
                    } else if (archBtn) {
                        showConfirm('Arquivar Análise', 'Mover esta análise para o arquivo?', () => {
                            const idx = tasks.findIndex(t => t.id == archBtn.dataset.id);
                            if(idx > -1) {
                                archivedTasks.push(tasks[idx]);
                                tasks.splice(idx, 1);
                                refreshUI();
                                showNotification('Análise arquivada.');
                            }
                        });
                    } else if (toggleBtn) {
                        const t = tasks.find(x => x.id == toggleBtn.dataset.id);
                        if(t) { t.isExpanded = !t.isExpanded; refreshUI(); }
                    } else if (editOcBtn) {
                        const t = tasks.find(x => x.id == editOcBtn.dataset.id);
                        if(t) {
                            document.getElementById('ocorrencia-task-id').value = t.id;
                            const list = document.getElementById('ocorrencia-list');
                            list.innerHTML = '';
                            currentEditingTaskOcorrencias = JSON.parse(JSON.stringify(t.ocorrencias || []));
                            renderModalOcorrenciasList();
                            populateCategorySelect(document.getElementById('add-ocorrencia-categoria'));
                            document.getElementById('add-ocorrencia-desc').value = ''; 
                            document.getElementById('ocorrencia-modal').classList.remove('hidden');
                        }
                    }
                });

                document.getElementById('task-list').addEventListener('change', (e) => {
                    if (e.target.classList.contains('status-select')) {
                        const t = tasks.find(x => x.id == e.target.dataset.id);
                        if (t) {
                            if (e.target.dataset.type === 'backup') t.statusBackup = e.target.value;
                            if (e.target.dataset.type === 'analise') t.statusAnalise = e.target.value;
                            refreshUI();
                        }
                    }
                });

                document.getElementById('add-ocorrencia-btn').addEventListener('click', () => {
                    const desc = document.getElementById('add-ocorrencia-desc').value;
                    const cat = document.getElementById('add-ocorrencia-categoria').value;
                    const ini = document.getElementById('add-horario-inicial').value;
                    const fim = document.getElementById('add-horario-final').value;
                    const isInconclusiva = document.getElementById('add-ocorrencia-inconclusiva').checked;
                    
                    if (desc) {
                        currentEditingTaskOcorrencias.push({ 
                            categoria: cat, 
                            desc: desc, 
                            horarioInicial: ini, 
                            horarioFinal: fim,
                            inconclusiva: isInconclusiva 
                        });
                        renderModalOcorrenciasList();
                        
                        document.getElementById('add-ocorrencia-desc').value = '';
                        document.getElementById('add-horario-inicial').value = '';
                        document.getElementById('add-horario-final').value = '';
                        document.getElementById('add-ocorrencia-inconclusiva').checked = false;
                    }
                });

                document.getElementById('ocorrencia-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const taskId = document.getElementById('ocorrencia-task-id').value;
                    const task = tasks.find(t => t.id == taskId);
                    if (task) {
                        task.ocorrencias = [...currentEditingTaskOcorrencias];
                        task.ocorrencia = task.ocorrencias.length > 0 ? 'Sim' : 'Não';
                        refreshUI();
                        document.getElementById('ocorrencia-modal').classList.add('hidden');
                        showNotification('Ocorrências atualizadas com sucesso.');
                    }
                });
                
                document.getElementById('ocorrencia-cancel-btn').addEventListener('click', () => document.getElementById('ocorrencia-modal').classList.add('hidden'));
                
                document.getElementById('ocorrencia-list').addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-item-btn');
                    const editBtn = e.target.closest('.edit-item-btn');

                    if (deleteBtn) {
                        const index = parseInt(deleteBtn.dataset.index);
                        currentEditingTaskOcorrencias.splice(index, 1);
                        renderModalOcorrenciasList();
                    } else if (editBtn) {
                        const index = parseInt(editBtn.dataset.index);
                        const item = currentEditingTaskOcorrencias[index];
                        document.getElementById('add-ocorrencia-categoria').value = item.categoria;
                        document.getElementById('add-ocorrencia-desc').value = item.desc;
                        document.getElementById('add-horario-inicial').value = item.horarioInicial;
                        document.getElementById('add-horario-final').value = item.horarioFinal;
                        document.getElementById('add-ocorrencia-inconclusiva').checked = item.inconclusiva || false;
                        currentEditingTaskOcorrencias.splice(index, 1);
                        renderModalOcorrenciasList();
                    }
                });

                // Lógica de Autocomplete Adicionada
                const condoInput = document.getElementById('form-condominio');
                const autoList = document.getElementById('autocomplete-list');

                if (condoInput && autoList) {
                    condoInput.addEventListener('input', function() {
                        const val = this.value.toLowerCase();
                        autoList.innerHTML = '';
                        if (!val) {
                            autoList.classList.add('hidden');
                            return;
                        }

                        // Busca histórico de condomínios já cadastrados
                        const history = [...new Set([...tasks, ...archivedTasks].map(t => t.condominio))];
                        const matches = history.filter(h => h.toLowerCase().includes(val));

                        if (matches.length > 0) {
                            autoList.classList.remove('hidden');
                            matches.forEach(m => {
                                const div = document.createElement('div');
                                div.className = "p-2 hover:bg-slate-100 cursor-pointer text-sm dark:hover:bg-slate-600 dark:text-slate-100";
                                div.textContent = m;
                                div.addEventListener('click', () => {
                                    condoInput.value = m;
                                    autoList.classList.add('hidden');
                                });
                                autoList.appendChild(div);
                            });
                        } else {
                            autoList.classList.add('hidden');
                        }
                    });

                    document.addEventListener('click', (e) => {
                        if (e.target !== condoInput) {
                            autoList.classList.add('hidden');
                        }
                    });
                }

                // Inicialização
                setupCharts();
                refreshUI();

            } catch (error) {
                console.error("Erro crítico na inicialização:", error);
                alert("Ocorreu um erro ao carregar o painel. Verifique o console para mais detalhes. Erro: " + error.message);
            }
        });
    </script>
</body>
</html>